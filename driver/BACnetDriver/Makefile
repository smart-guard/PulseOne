# =============================================================================
# BACnetDriver Plugin Makefile
# BACnet Building Automation Protocol Driver
# =============================================================================

# ì»´íŒŒì¼ëŸ¬ ë° í”Œë˜ê·¸ ì„¤ì •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -O2 -fPIC -DBACNET_STACK
INCLUDES = -I./include -I/usr/local/include -I/usr/local/include/bacnet

# í”Œë«í¼ë³„ ì„¤ì •
ifeq ($(OS),Windows_NT)
    TARGET = BACnetDriver.dll
    LDFLAGS = -shared -Wl,--out-implib,BACnetDriver.lib
    LIBS = -lbacnet -lws2_32 -lpthread
    RM = del /Q
    MKDIR = mkdir
    SHARED_EXT = dll
else
    UNAME_S := $(shell uname -s)
    ifeq ($(UNAME_S),Linux)
        TARGET = BACnetDriver.so
        LDFLAGS = -shared -fPIC
        LIBS = -lbacnet -lpthread -lm
        RM = rm -f
        MKDIR = mkdir -p
        SHARED_EXT = so
    endif
endif

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
OBJ_DIR = obj
PLUGIN_DIR = ../plugins
DIST_DIR = ../dist

# ì†ŒìŠ¤ íŒŒì¼ë“¤
SOURCES = $(wildcard $(SRC_DIR)/*.cpp)
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(OBJ_DIR)/%.o)

# BACnet íŠ¹í™” ì»´íŒŒì¼ í”Œë˜ê·¸
BACNET_CFLAGS = -DBIG_ENDIAN=0 -DBACNET_STACK_VERSION="1.0.0" \
                -DPRINT_ENABLED=1 -DBACAPP_ALL -DBACFILE \
                -DINTRINSIC_REPORTING -DBACNET_TIME_MASTER \
                -DBACNET_PROPERTY_LISTS=1

# ê¸°ë³¸ íƒ€ê²Ÿ
.PHONY: all build clean install test debug release help deps

all: build

# ë¹Œë“œ íƒ€ê²Ÿ
build: $(PLUGIN_DIR)/$(TARGET)

$(PLUGIN_DIR)/$(TARGET): $(OBJECTS) | $(PLUGIN_DIR)
	@echo "ğŸ”— Linking BACnetDriver plugin: $(TARGET)"
	$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(LIBS)
	@echo "âœ… BACnetDriver plugin built successfully: $@"
	@echo "ğŸ“ File info:"
	@ls -la $@
	@file $@
	@echo "ğŸ“‹ Dependencies:"
	@ldd $@ 2>/dev/null | grep -E "(bacnet|pthread)" || echo "Dependencies check skipped"

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo "ğŸ”¨ Compiling BACnetDriver: $<"
	$(CXX) $(CXXFLAGS) $(BACNET_CFLAGS) $(INCLUDES) -c $< -o $@

# ë””ë ‰í† ë¦¬ ìƒì„±
$(OBJ_DIR):
	$(MKDIR) $(OBJ_DIR)

$(PLUGIN_DIR):
	$(MKDIR) $(PLUGIN_DIR)

$(DIST_DIR):
	$(MKDIR) $(DIST_DIR)

# ë””ë²„ê·¸ ë¹Œë“œ
debug: CXXFLAGS += -g -DDEBUG -O0 -DBACNET_DEBUG -DDEBUG_ENABLED=1
debug: build

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ  
release: CXXFLAGS += -O3 -DNDEBUG -DBACNET_OPTIMIZED
release: build

# ì„¤ì¹˜ (ì‹œìŠ¤í…œ í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬)
install: build | $(DIST_DIR)
	@echo "ğŸ“¦ Installing BACnetDriver plugin..."
	cp $(PLUGIN_DIR)/$(TARGET) $(DIST_DIR)/
	@echo "âœ… BACnetDriver installed to $(DIST_DIR)/"

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ
test: build
	@echo "ğŸ§ª Testing BACnetDriver plugin..."
	@if [ -f "$(PLUGIN_DIR)/$(TARGET)" ]; then \
		echo "âœ… BACnetDriver plugin file exists"; \
		echo "ğŸ“‹ Size: $$(stat --format=%s $(PLUGIN_DIR)/$(TARGET) 2>/dev/null || echo 'unknown') bytes"; \
		echo "ğŸ“‹ Symbols:"; \
		nm -D $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(CreateDriver|DestroyDriver|GetPluginInfo)" || echo "Symbols check..."; \
		echo "ğŸ“‹ BACnet Dependencies:"; \
		ldd $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(bacnet)" || echo "BACnet lib may be static"; \
		echo "ğŸ“‹ Core Dependencies:"; \
		ldd $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(pthread|libc)" || echo "Core libs linked"; \
	else \
		echo "âŒ BACnetDriver plugin build failed"; \
		exit 1; \
	fi

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ Cleaning BACnetDriver build files..."
	$(RM) $(OBJ_DIR)/*.o 2>/dev/null || true
	$(RM) $(PLUGIN_DIR)/$(TARGET) 2>/dev/null || true
	@echo "âœ… BACnetDriver clean completed"

# ì™„ì „ ì •ë¦¬
distclean: clean
	@echo "ğŸ§¹ Deep cleaning BACnetDriver..."
	$(RM) -r $(OBJ_DIR) 2>/dev/null || true

# ì˜ì¡´ì„± í™•ì¸
deps:
	@echo "ğŸ” Checking BACnetDriver dependencies..."
	@echo "ğŸ“¦ BACnet Stack:"
	@pkg-config --exists bacnet && echo "  âœ… bacnet: $$(pkg-config --modversion bacnet)" || echo "  âš ï¸  bacnet: pkg-config not available"
	@echo "ğŸ“¦ Header files:"
	@[ -d /usr/local/include/bacnet ] && echo "  âœ… BACnet headers: Found in /usr/local/include/bacnet" || echo "  âŒ BACnet headers: Not found"
	@[ -f /usr/local/include/bacnet/bacnet.h ] && echo "  âœ… bacnet.h: Found" || echo "  âŒ bacnet.h: Not found"
	@[ -f /usr/local/include/bacnet/config.h ] && echo "  âœ… config.h: Found" || echo "  âŒ config.h: Not found"
	@echo "ğŸ“¦ Library files:"
	@[ -f /usr/local/lib/libbacnet.so ] && echo "  âœ… libbacnet.so: Found" || echo "  âŒ libbacnet.so: Not found"
	@[ -f /usr/local/lib/libbacnet.a ] && echo "  âœ… libbacnet.a: Found" || echo "  âŒ libbacnet.a: Not found"
	@echo "ğŸ“¦ Compiler:"
	@$(CXX) --version | head -1

# BACnet íŠ¹í™” í…ŒìŠ¤íŠ¸
bacnet-test: build
	@echo "ğŸ§ª BACnet-specific testing..."
	@echo "ğŸ“‹ Checking BACnet symbol exports:"
	@nm -D $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -i bacnet || echo "No BACnet symbols visible (may be static)"
	@echo "ğŸ“‹ Checking standard BACnet functions:"
	@nm $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(Device_Object|Read_Property|Who_Is)" | head -5 || echo "BACnet functions compiled in"

# BACnet ë„¤íŠ¸ì›Œí¬ ìŠ¤ìº” í…ŒìŠ¤íŠ¸ (ì„ íƒì )
bacnet-scan-test:
	@echo "ğŸ” BACnet Network Scan Test"
	@echo "â„¹ï¸  This would perform Who-Is broadcast scan"
	@echo "â„¹ï¸  Implement with actual BACnet network discovery"

# BACnet ê°ì²´ ì½ê¸° í…ŒìŠ¤íŠ¸
bacnet-read-test:
	@echo "ğŸ“– BACnet Object Read Test"
	@echo "â„¹ï¸  This would test reading BACnet objects"
	@echo "â„¹ï¸  Example: Analog Input, Binary Output, etc."

# ë„ì›€ë§
help:
	@echo "ğŸ› ï¸  BACnetDriver Plugin Build System"
	@echo ""
	@echo "Targets:"
	@echo "  build          - Build the BACnet driver plugin (default)"
	@echo "  debug          - Build with debug symbols and BACnet debugging"
	@echo "  release        - Build optimized release version"
	@echo "  install        - Install to dist directory"
	@echo "  test           - Build and test plugin"
	@echo "  bacnet-test    - BACnet-specific symbol testing"
	@echo "  bacnet-scan-test    - Network discovery testing"
	@echo "  bacnet-read-test    - Object reading testing"
	@echo "  clean          - Remove build files"
	@echo "  distclean      - Remove all generated files"
	@echo "  deps           - Check BACnet dependencies"
	@echo "  help           - Show this help"
	@echo ""
	@echo "BACnet Features:"
	@echo "  - BACnet/IP protocol support"
	@echo "  - Device discovery (Who-Is/I-Am)"
	@echo "  - Object property reading/writing"
	@echo "  - Change of Value (COV) subscriptions"
	@echo "  - Alarm and event handling"
	@echo "  - Trending and logging"
	@echo ""
	@echo "Supported Object Types:"
	@echo "  - Analog Input/Output/Value"
	@echo "  - Binary Input/Output/Value"
	@echo "  - Multi-state Input/Output/Value"
	@echo "  - Device Objects"
	@echo "  - Schedule Objects"
	@echo "  - Calendar Objects"
	@echo ""
	@echo "Platform: $(if $(filter Windows_NT,$(OS)),Windows,$(UNAME_S))"
	@echo "Target: $(TARGET)"
	@echo "Libraries: BACnet Stack"

# ìƒì„¸ ì •ë³´
info:
	@echo "ğŸ“‹ BACnetDriver Plugin Build Information"
	@echo "========================================"
	@echo "Target: $(TARGET)"
	@echo "Sources: $(SOURCES)"
	@echo "Objects: $(OBJECTS)"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "BACnet Flags: $(BACNET_CFLAGS)"
	@echo "Includes: $(INCLUDES)"
	@echo "Libraries: $(LIBS)"
	@echo "Output: $(PLUGIN_DIR)/$(TARGET)"
	@echo ""
	@echo "BACnet Configuration:"
	@echo "  Protocol: BACnet/IP (UDP Port 47808)"
	@echo "  Services: Read/Write Property, COV, Alarms"
	@echo "  Objects: All standard BACnet objects"
	@echo "  Security: Optional BACnet/SC support"

# BACnet ì„¤ì • í™•ì¸
bacnet-config:
	@echo "ğŸ”§ BACnet Stack Configuration"
	@echo "=============================="
	@echo "ğŸ“‹ Compile-time settings:"
	@echo "  BIG_ENDIAN: 0 (Little Endian)"
	@echo "  PRINT_ENABLED: 1 (Debug printing)"
	@echo "  BACAPP_ALL: Enabled (All application layer)"
	@echo "  BACFILE: Enabled (File services)"
	@echo "  INTRINSIC_REPORTING: Enabled (Alarms)"
	@echo "  BACNET_TIME_MASTER: Enabled (Time sync)"
	@echo "  BACNET_PROPERTY_LISTS: Enabled (Property lists)"
	@echo ""
	@echo "ğŸ“‹ Network settings:"
	@echo "  Default Port: 47808"
	@echo "  Max APDU: 1476 bytes"
	@echo "  Max Objects: Unlimited"
	@echo "  Device ID Range: 0-4194302"