# =============================================================================
# ModbusDriver Plugin Makefile (í–¥ìƒëœ ë²„ì „)
# ê¸°ì¡´ driver/ModbusDriver/Makefileì„ ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”
# =============================================================================

# ì»´íŒŒì¼ëŸ¬ ë° í”Œë˜ê·¸ ì„¤ì •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -O2 -fPIC
INCLUDES = -I./include -I/usr/local/include

# í”Œë«í¼ë³„ ì„¤ì •
ifeq ($(OS),Windows_NT)
    TARGET = ModbusDriver.dll
    LDFLAGS = -shared -Wl,--out-implib,ModbusDriver.lib
    LIBS = -lmodbus -lws2_32 -lpthread
    RM = del /Q
    MKDIR = mkdir
    SHARED_EXT = dll
else
    UNAME_S := $(shell uname -s)
    ifeq ($(UNAME_S),Linux)
        TARGET = ModbusDriver.so
        LDFLAGS = -shared -fPIC
        LIBS = -lmodbus -lpthread
        RM = rm -f
        MKDIR = mkdir -p
        SHARED_EXT = so
    endif
endif

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
OBJ_DIR = obj
PLUGIN_DIR = ../plugins
DIST_DIR = ../dist

# ì†ŒìŠ¤ íŒŒì¼ë“¤ (ìë™ ê°ì§€)
SOURCES = $(wildcard $(SRC_DIR)/*.cpp)
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(OBJ_DIR)/%.o)

# ê¸°ë³¸ íƒ€ê²Ÿ
.PHONY: all build clean install test debug release help

all: build

# ë¹Œë“œ íƒ€ê²Ÿ
build: $(PLUGIN_DIR)/$(TARGET)

$(PLUGIN_DIR)/$(TARGET): $(OBJECTS) | $(PLUGIN_DIR)
	@echo "ğŸ”— Linking plugin: $(TARGET)"
	$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(LIBS)
	@echo "âœ… Plugin built successfully: $@"
	@echo "ğŸ“ File info:"
	@ls -la $@
	@file $@
	@echo "ğŸ“‹ Dependencies:"
	@ldd $@ 2>/dev/null | head -5 || echo "N/A"

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo "ğŸ”¨ Compiling: $<"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë””ë ‰í† ë¦¬ ìƒì„±
$(OBJ_DIR):
	$(MKDIR) $(OBJ_DIR)

$(PLUGIN_DIR):
	$(MKDIR) $(PLUGIN_DIR)

$(DIST_DIR):
	$(MKDIR) $(DIST_DIR)

# ë””ë²„ê·¸ ë¹Œë“œ
debug: CXXFLAGS += -g -DDEBUG -O0
debug: build

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ  
release: CXXFLAGS += -O3 -DNDEBUG
release: build

# ì„¤ì¹˜ (ì‹œìŠ¤í…œ í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬)
install: build | $(DIST_DIR)
	@echo "ğŸ“¦ Installing plugin..."
	cp $(PLUGIN_DIR)/$(TARGET) $(DIST_DIR)/
	@echo "âœ… Plugin installed to $(DIST_DIR)/"

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ
test: build
	@echo "ğŸ§ª Testing plugin..."
	@if [ -f "$(PLUGIN_DIR)/$(TARGET)" ]; then \
		echo "âœ… Plugin file exists"; \
		echo "ğŸ“‹ Size: $$(stat --format=%s $(PLUGIN_DIR)/$(TARGET) 2>/dev/null || echo 'unknown') bytes"; \
		echo "ğŸ“‹ Symbols:"; \
		nm -D $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(CreateDriver|DestroyDriver|GetPluginInfo)" || echo "No symbols found"; \
		echo "ğŸ“‹ Dependencies:"; \
		ldd $(PLUGIN_DIR)/$(TARGET) 2>/dev/null | grep -E "(modbus|pthread)" || echo "Basic deps only"; \
	else \
		echo "âŒ Plugin build failed"; \
		exit 1; \
	fi

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ Cleaning build files..."
	$(RM) $(OBJ_DIR)/*.o 2>/dev/null || true
	$(RM) $(PLUGIN_DIR)/$(TARGET) 2>/dev/null || true
	@echo "âœ… Clean completed"

# ì™„ì „ ì •ë¦¬
distclean: clean
	@echo "ğŸ§¹ Deep cleaning..."
	$(RM) -r $(OBJ_DIR) 2>/dev/null || true
	$(RM) -r $(PLUGIN_DIR) 2>/dev/null || true
	$(RM) -r $(DIST_DIR) 2>/dev/null || true

# ì˜ì¡´ì„± í™•ì¸
deps:
	@echo "ğŸ” Checking dependencies..."
	@echo "ğŸ“¦ Required libraries:"
	@pkg-config --exists libmodbus && echo "  âœ… libmodbus: $$(pkg-config --modversion libmodbus)" || echo "  âŒ libmodbus: Not found"
	@echo "ğŸ“¦ Compiler:"
	@$(CXX) --version | head -1
	@echo "ğŸ“¦ Include paths:"
	@echo "  $(INCLUDES)"

# ë„ì›€ë§
help:
	@echo "ğŸ› ï¸  ModbusDriver Plugin Build System"
	@echo ""
	@echo "Targets:"
	@echo "  build    - Build the plugin (default)"
	@echo "  debug    - Build with debug symbols"
	@echo "  release  - Build optimized release"
	@echo "  install  - Install to dist directory"
	@echo "  test     - Build and test plugin"
	@echo "  clean    - Remove build files"
	@echo "  distclean- Remove all generated files"
	@echo "  deps     - Check dependencies"
	@echo "  help     - Show this help"
	@echo ""
	@echo "Platform: $(if $(filter Windows_NT,$(OS)),Windows,$(UNAME_S))"
	@echo "Target: $(TARGET)"
	@echo "Sources: $(words $(SOURCES)) files"

# ìƒì„¸ ì •ë³´
info:
	@echo "ğŸ“‹ ModbusDriver Plugin Build Information"
	@echo "=================================="
	@echo "Target: $(TARGET)"
	@echo "Sources: $(SOURCES)"
	@echo "Objects: $(OBJECTS)"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Includes: $(INCLUDES)"
	@echo "Libs: $(LIBS)"
	@echo "Output: $(PLUGIN_DIR)/$(TARGET)"