# =============================================================================
# core/export-gateway/Makefile - PulseOne Export Gateway (ÌÅ¨Î°úÏä§ÌîåÎû´Ìèº)
# üî• v3.1 - Paho MQTT C++ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏßÄÏõê Ï∂îÍ∞Ä
# =============================================================================

# ÌîåÎû´Ìèº Í∞êÏßÄ
UNAME := $(shell uname -s 2>/dev/null || echo Windows)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
endif

# Include directories
INCLUDES = -Iinclude -Isrc -I../shared/include
# Compiler flags
CFLAGS = $(INCLUDES) -std=c11 -Wall -Wextra -O2 -fPIC
CXXFLAGS = $(INCLUDES) -std=c++17 -Wall -Wextra -O2 -fPIC

# Ïª¥ÌååÏùºÎü¨ ÏÑ§Ï†ï
CXX = g++
CC = gcc

# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏßÄÏõê
ifeq ($(CROSS_COMPILE_WINDOWS),1)
    CXX = x86_64-w64-mingw32-g++-posix
    CC = x86_64-w64-mingw32-gcc-posix
    CXXFLAGS += -DWIN32 -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DCURL_STATICLIB -DDBLIB_STATIC -DLOGLIB_STATIC
    CFLAGS += -DWIN32 -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DCURL_STATICLIB -DDBLIB_STATIC -DLOGLIB_STATIC
    IS_WINDOWS := 1
    PLATFORM := Windows-Cross
    MINGW_PREFIX = /usr/x86_64-w64-mingw32
    INCLUDES += -I$(MINGW_PREFIX)/include
    EXE_SUFFIX = .exe
    LIB_SUFFIX = .a
else ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1
    CFLAGS += -DPULSEONE_WINDOWS=1
    EXE_SUFFIX = .exe
    LIB_SUFFIX = .a
else
    CXXFLAGS += -DPULSEONE_LINUX=1
    CFLAGS += -DPULSEONE_LINUX=1
    EXE_SUFFIX =
    LIB_SUFFIX = .a
endif

# ÎîîÎ≤ÑÍ∑∏/Î¶¥Î¶¨Ï¶à ÌîåÎûòÍ∑∏
ifeq ($(BUILD_TYPE),Debug)
    CXXFLAGS += -g -O0 -fno-omit-frame-pointer
    CXXFLAGS += -DPULSEONE_DEBUG=1
else
    CXXFLAGS += -DNDEBUG -O2
    CXXFLAGS += -DPULSEONE_DEBUG=0
endif

# =============================================================================
# ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞
# =============================================================================

EXPORT_GATEWAY_DIR = $(shell pwd)
PROJECT_ROOT = $(shell dirname $(shell dirname $(EXPORT_GATEWAY_DIR)))
SHARED_DIR = $(PROJECT_ROOT)/core/shared

SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
BIN_DIR = bin

SHARED_INCLUDE_DIR = $(SHARED_DIR)/include
SHARED_LIB_DIR = $(SHARED_DIR)/lib

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ
# =============================================================================

HAS_SHARED := $(shell [ -d "$(SHARED_LIB_DIR)" ] && [ -f "$(SHARED_LIB_DIR)/libpulseone-common$(LIB_SUFFIX)" ] && echo "1" || echo "0")
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# üî• hiredis Í∞êÏßÄ
HAS_HIREDIS := $(shell pkg-config --exists hiredis 2>/dev/null && echo "1" || echo "0")
ifeq ($(HAS_HIREDIS),0)
    HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
endif

HAS_HTTPLIB := $(shell echo '\#include <httplib.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# üî• libcurl ÏûêÎèô Í∞êÏßÄ
HAS_CURL := $(shell pkg-config --exists libcurl 2>/dev/null && echo "1" || echo "0")
ifeq ($(HAS_CURL),0)
    HAS_CURL := $(shell echo '#include <curl/curl.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
endif

# OpenSSL Í∞êÏßÄ (S3 ÏÑúÎ™ÖÏö©)
HAS_OPENSSL := $(shell pkg-config --exists openssl 2>/dev/null && echo "1" || echo "0")
ifeq ($(HAS_OPENSSL),0)
    HAS_OPENSSL := $(shell echo '\#include <openssl/sha.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
endif

# üî• libpqxx Í∞êÏßÄ (DBLib ÏùòÏ°¥ÏÑ±)
HAS_PQXX := $(shell pkg-config --exists libpqxx 2>/dev/null && echo "1" || echo "0")

# üî• Paho MQTT C++ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ (v3.1 Ï∂îÍ∞Ä)
ifeq ($(CROSS_COMPILE_WINDOWS),1)
    HAS_PAHO_MQTT := $(shell [ -f $(MINGW_PREFIX)/include/mqtt/async_client.h ] && echo "1" || echo "0")
else
    HAS_PAHO_MQTT := $(shell [ -f /usr/include/mqtt/async_client.h ] && echo "1" || echo "0")
endif

# üî• 1ÏàúÏúÑ: Shared ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÉÅÏÑ∏ include
ifneq ($(wildcard $(SHARED_INCLUDE_DIR)),)
    INCLUDES = -I$(SHARED_INCLUDE_DIR) \
               -I$(SHARED_INCLUDE_DIR)/Platform \
               -I$(SHARED_INCLUDE_DIR)/Common \
               -I$(SHARED_INCLUDE_DIR)/Utils \
               -I$(SHARED_INCLUDE_DIR)/Database \
               -I$(SHARED_INCLUDE_DIR)/Database/Entities \
               -I$(SHARED_INCLUDE_DIR)/Database/Repositories \
               -I$(SHARED_INCLUDE_DIR)/Alarm \
               -I$(SHARED_INCLUDE_DIR)/Export \
               -I$(SHARED_INCLUDE_DIR)/Client \
               -I$(SHARED_INCLUDE_DIR)/Security \
               -I$(SHARED_INCLUDE_DIR)/Data \
               -I$(SHARED_DIR)/modules/DbLib/include \
               -I$(SHARED_DIR)/modules/LogLib/include
endif

# üî• 2ÏàúÏúÑ: Î°úÏª¨ include
INCLUDES += -I$(INCLUDE_DIR)
# INCLUDES += -I$(PROJECT_ROOT)/core/collector/include

# üî• 3ÏàúÏúÑ: ÏãúÏä§ÌÖú include (Linux/MacÏóêÏÑúÎßå Ìò∏ÌôòÏÑ± ÏúÑÌï¥ Ïú†ÏßÄ)
ifneq ($(CROSS_COMPILE_WINDOWS),1)
    INCLUDES += -I/usr/local/include
endif

# üî• 4ÏàúÏúÑ: pkg-config Í∏∞Î∞ò include (hiredis, curl, openssl Îì±)
# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏãúÏóêÎäî ÏãúÏä§ÌÖú pkg-config ÏÇ¨Ïö© ÏûêÏ†ú (Ìò∏Ïä§Ìä∏ Ìó§Îçî Ïú†Ï∂ú Î∞©ÏßÄ)
ifneq ($(CROSS_COMPILE_WINDOWS),1)
    ifeq ($(HAS_HIREDIS),1)
        INCLUDES += $(shell pkg-config --cflags hiredis 2>/dev/null)
    endif
    ifeq ($(HAS_CURL),1)
        INCLUDES += $(shell pkg-config --cflags libcurl 2>/dev/null)
    endif
    ifeq ($(HAS_OPENSSL),1)
        INCLUDES += $(shell pkg-config --cflags openssl 2>/dev/null)
    endif
else
    # Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏãúÏóêÎäî Î™ÖÏãúÏ†ÅÏù∏ MinGW Í≤ΩÎ°úÎßå ÏÇ¨Ïö©
    INCLUDES += -I$(MINGW_PREFIX)/include
endif

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎßÅÌÅ¨
# =============================================================================

# Shared ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§ (ÏùòÏ°¥ÏÑ± ÏàúÏÑú Ï§ëÏöî!)
SHARED_LIBS =
ifeq ($(HAS_SHARED),1)
    CXXFLAGS += -DHAS_SHARED_LIBS=1
    SHARED_LIBS = -L$(SHARED_LIB_DIR)
    SHARED_LIBS += -lpulseone-alarm
    SHARED_LIBS += -lpulseone-export
    SHARED_LIBS += -lpulseone-data
    SHARED_LIBS += -lpulseone-database  
    SHARED_LIBS += -lpulseone-dblib
    SHARED_LIBS += -lpulseone-client
    SHARED_LIBS += -lpulseone-common
    SHARED_LIBS += -lpulseone-security
    SHARED_LIBS += -L/usr/local/lib
endif

# Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§
UTILITY_LIBS =

# üî• hiredis ÎßÅÌÅ¨
ifeq ($(HAS_HIREDIS),1)
    HIREDIS_LIBS := $(shell pkg-config --libs hiredis 2>/dev/null)
    ifneq ($(HIREDIS_LIBS),)
        UTILITY_LIBS += $(HIREDIS_LIBS)
        CXXFLAGS += -DHAVE_REDIS=1
        $(info ‚úÖ hiredis found via pkg-config)
    else
        UTILITY_LIBS += /usr/local/lib/libhiredis.so.1.1.0
        CXXFLAGS += -DHAVE_REDIS=1
        $(info ‚úÖ hiredis found (direct link))
    endif
else
    $(info ‚ö†Ô∏è  hiredis not found - Redis features disabled)
endif

# üî• libcurl ÎßÅÌÅ¨
ifeq ($(HAS_CURL),1)
    CURL_LIBS := $(shell pkg-config --libs libcurl 2>/dev/null)
    ifneq ($(CURL_LIBS),)
        UTILITY_LIBS += $(CURL_LIBS)
        CXXFLAGS += -DHAS_CURL=1
        $(info ‚úÖ libcurl found via pkg-config)
    else
        UTILITY_LIBS += -lcurl
        CXXFLAGS += -DHAS_CURL=1
        $(info ‚úÖ libcurl found (direct link))
    endif
else
    $(info ‚ö†Ô∏è  libcurl not found - HTTP/S3 features disabled)
endif

# üî• OpenSSL ÎßÅÌÅ¨ (S3 ÏÑúÎ™ÖÏö©)
ifeq ($(HAS_OPENSSL),1)
    OPENSSL_LIBS := $(shell pkg-config --libs openssl 2>/dev/null)
    ifneq ($(OPENSSL_LIBS),)
        UTILITY_LIBS += $(OPENSSL_LIBS)
        CXXFLAGS += -DHAS_OPENSSL=1
        $(info ‚úÖ OpenSSL found via pkg-config)
    else
        UTILITY_LIBS += -lssl -lcrypto
        CXXFLAGS += -DHAS_OPENSSL=1
        $(info ‚úÖ OpenSSL found (direct link))
    endif
else
    $(info ‚ö†Ô∏è  OpenSSL not found - S3 signature features disabled)
endif

# üî• Paho MQTT C++ ÎßÅÌÅ¨ (v3.1 Ï∂îÍ∞Ä - CollectorÏôÄ ÎèôÏùº)
# üî• Paho MQTT C++ ÎßÅÌÅ¨ (v3.1 Ï∂îÍ∞Ä - CollectorÏôÄ ÎèôÏùº)
# Linker order matters: -lpaho-mqttpp3 must come before -lpaho-mqtt3a
ifeq ($(HAS_PAHO_MQTT),1)
    ifeq ($(IS_WINDOWS),1)
        UTILITY_LIBS += -lpaho-mqttpp3-static -lpaho-mqtt3a
    else
        UTILITY_LIBS += -lpaho-mqttpp3 -lpaho-mqtt3a
    endif
    CXXFLAGS += -DHAS_PAHO_MQTT=1
    $(info ‚úÖ Paho MQTT C++ found and linked)
else
    $(info ‚ö†Ô∏è  Paho MQTT C++ not found - MQTT features disabled)
    # Do NOT force HAS_PAHO_MQTT=1 here if library is missing
endif

ifeq ($(HAS_HTTPLIB),1)
    CXXFLAGS += -DHAS_HTTPLIB=1
endif

ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON=1
endif

# üî• Í∏∞Î≥∏ ÏãúÏä§ÌÖú ÎùºÏù¥Î∏åÎü¨Î¶¨ (SQLite3 Ï∂îÍ∞Ä!)
ifeq ($(IS_WINDOWS),1)
    BASIC_LIBS = -lpthread -lstdc++ -lm -lsqlite3
    PLATFORM_LIBS = -lws2_32 -lwsock32 -liphlpapi -lodbc32 -lodbccp32 -lcrypt32 -ladvapi32 -lwldap32 -lrpcrt4 -luuid
else
    BASIC_LIBS = -lpthread -lm -ldl -lsqlite3
    ifeq ($(HAS_PQXX),1)
        BASIC_LIBS += -lpqxx
    endif
    ifeq ($(PLATFORM),Linux)
        BASIC_LIBS += -lmariadb
    endif
    PLATFORM_LIBS =
endif

# üî• ÏµúÏ¢Ö ÎßÅÌÅ¨ ÏàúÏÑú
LDFLAGS = $(SHARED_LIBS) $(UTILITY_LIBS) $(BASIC_LIBS) $(PLATFORM_LIBS)

# ÏÉâÏÉÅ Ï†ïÏùò
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ÏÜåÏä§ ÌååÏùº Î∞è Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº (v3.0 - Event ÎîîÎ†âÌÜ†Î¶¨)
# =============================================================================

# üÜï Event ÎîîÎ†âÌÜ†Î¶¨ (EventSubscriber - Î≤îÏö© Ïù¥Î≤§Ìä∏ Íµ¨ÎèÖÏûê) ‚úÖ
EVENT_SOURCES = $(wildcard $(SRC_DIR)/Event/*.cpp)
EVENT_OBJECTS = $(EVENT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üÜï Gateway Model ÎîîÎ†âÌÜ†Î¶¨
MODEL_SOURCES = $(wildcard $(SRC_DIR)/Gateway/Model/*.cpp)
MODEL_OBJECTS = $(MODEL_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üÜï Gateway Service ÎîîÎ†âÌÜ†Î¶¨
SERVICE_SOURCES = $(wildcard $(SRC_DIR)/Gateway/Service/*.cpp)
SERVICE_OBJECTS = $(SERVICE_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üÜï Gateway Target ÎîîÎ†âÌÜ†Î¶¨
TARGET_SOURCES = $(wildcard $(SRC_DIR)/Gateway/Target/*.cpp)
TARGET_OBJECTS = $(TARGET_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üÜï Schedule ÎîîÎ†âÌÜ†Î¶¨ (ScheduledExporter)
SCHEDULE_SOURCES = $(wildcard $(SRC_DIR)/Schedule/*.cpp)
SCHEDULE_OBJECTS = $(SCHEDULE_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üîÑ Transform ÎîîÎ†âÌÜ†Î¶¨ (PayloadTransformer)
TRANSFORM_SOURCES = $(wildcard $(SRC_DIR)/Transform/*.cpp)
TRANSFORM_OBJECTS = $(TRANSFORM_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üîå CSP ÎîîÎ†âÌÜ†Î¶¨ (DynamicTargetManager, MqttTargetHandler Îì±)
CSP_SOURCES = $(wildcard $(SRC_DIR)/CSP/*.cpp)
CSP_OBJECTS = $(CSP_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üì§ Export ÎîîÎ†âÌÜ†Î¶¨
EXPORT_SOURCES = $(wildcard $(SRC_DIR)/Export/*.cpp)
EXPORT_OBJECTS = $(EXPORT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# üõ†Ô∏è Utils ÎîîÎ†âÌÜ†Î¶¨
UTILS_CXX_SOURCES = $(wildcard $(SRC_DIR)/Utils/*.cpp)
UTILS_C_SOURCES = $(wildcard $(SRC_DIR)/Utils/*.c)
UTILS_OBJECTS = $(UTILS_CXX_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o) \
                $(UTILS_C_SOURCES:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)

# üìå Main ÌååÏùº
MAIN_SOURCES = $(SRC_DIR)/main.cpp
MAIN_OBJECT = $(BUILD_DIR)/main.o

# üì¶ Ï†ÑÏ≤¥ Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº (EVENT_OBJECTSÎ°ú Î≥ÄÍ≤Ω) ‚úÖ
ALL_OBJECTS = $(EVENT_OBJECTS) $(MODEL_OBJECTS) $(SERVICE_OBJECTS) $(TARGET_OBJECTS) $(SCHEDULE_OBJECTS) $(TRANSFORM_OBJECTS) $(CSP_OBJECTS) $(EXPORT_OBJECTS) $(UTILS_OBJECTS) $(MAIN_OBJECT)

# üéØ ÏµúÏ¢Ö Ïã§Ìñâ ÌååÏùº
TARGET = $(BIN_DIR)/export-gateway$(EXE_SUFFIX)

# =============================================================================
# ÌÖåÏä§Ìä∏ ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞
# =============================================================================

TEST_DIR = tests
TEST_BUILD_DIR = build/tests
TEST_BIN_DIR = bin/tests

TEST_SOURCES = $(wildcard $(TEST_DIR)/*.cpp)
TEST_OBJECTS = $(TEST_SOURCES:$(TEST_DIR)/%.cpp=$(TEST_BUILD_DIR)/%.o)
TEST_EXECUTABLES = $(TEST_SOURCES:$(TEST_DIR)/%.cpp=$(TEST_BIN_DIR)/%)

# =============================================================================
# Î©îÏù∏ ÌÉÄÍ≤üÎì§
# =============================================================================

.PHONY: all clean clean-all run test test-mqtt check-libs debug-vars

# Í∏∞Î≥∏ ÌÉÄÍ≤ü
all: check-libs $(TARGET)
	@echo -e "$(GREEN)‚úÖ Build completed: $(TARGET)$(NC)"

# ÏµúÏ¢Ö ÎßÅÌÅ¨
$(TARGET): $(ALL_OBJECTS) | $(BIN_DIR)
	@echo -e "$(BLUE)üîó Linking $@$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(LDFLAGS) -o $@
	@echo -e "$(GREEN)‚úÖ Export Gateway v3.1 built successfully!$(NC)"
	@echo -e "$(GREEN)   EventSubscriber: Î≤îÏö© Ïù¥Î≤§Ìä∏ Íµ¨ÎèÖÏûê$(NC)"
	@echo -e "$(GREEN)   MqttTargetHandler: Paho MQTT C++ ÏßÄÏõê$(NC)"

# ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
$(BUILD_DIR) $(BIN_DIR) $(TEST_BUILD_DIR) $(TEST_BIN_DIR):
	@mkdir -p $@

# Ïª¥ÌååÏùº Í∑úÏπô
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	mkdir -p $(dir $@)
	@echo -e "$(YELLOW)‚öôÔ∏è  Compiling $< [$(PLATFORM)]$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c | $(BUILD_DIR)
	mkdir -p $(dir $@)
	@echo -e "$(YELLOW)‚öôÔ∏è  Compiling C source $< [$(PLATFORM)]$(NC)"
	$(CC) $(CFLAGS) -I$(INCLUDE_DIR) -c $< -o $@

# =============================================================================
# Ïú†Ìã∏Î¶¨Ìã∞
# =============================================================================

# ‚úÖ clean (ÎπåÎìú ÌååÏùºÎßå ÏÇ≠Ï†ú)
clean:
	@echo -e "$(YELLOW)üßπ Cleaning build files...$(NC)"
	@find $(BUILD_DIR) -type f -name '*.o' -delete 2>/dev/null || true
	@find $(BIN_DIR) -type f -delete 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Clean completed$(NC)"

# ‚úÖ clean-all (ÎîîÎ†âÌÜ†Î¶¨ÍπåÏßÄ ÏÇ≠Ï†ú)
clean-all:
	@echo -e "$(YELLOW)üßπ Deep cleaning...$(NC)"
	@rm -rf $(BUILD_DIR) $(BIN_DIR) 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Deep clean completed$(NC)"

# ‚úÖ run (Ïã§Ìñâ)
run: $(TARGET)
	@echo -e "$(BLUE)üöÄ Running Export Gateway v3.1...$(NC)"
	@$(TARGET)

# ‚úÖ check-libs (ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôïÏù∏)
check-libs:
	@echo -e "$(BLUE)üîç Checking PulseOne Shared Libraries [$(PLATFORM)]...$(NC)"
	@echo "Shared lib directory: $(SHARED_LIB_DIR)"
	@echo "HAS_SHARED: $(HAS_SHARED)"
	@echo "HAS_HIREDIS: $(HAS_HIREDIS)"
	@echo "HAS_CURL: $(HAS_CURL)"
	@echo "HAS_OPENSSL: $(HAS_OPENSSL)"
	@echo "HAS_PAHO_MQTT: $(HAS_PAHO_MQTT)"
ifeq ($(HAS_SHARED),1)
	@echo -e "Shared libs:"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-security$(LIB_SUFFIX)" ] && echo -e "  libpulseone-security: ‚úÖ" || echo -e "  libpulseone-security: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-common$(LIB_SUFFIX)" ] && echo -e "  libpulseone-common: ‚úÖ" || echo -e "  libpulseone-common: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-database$(LIB_SUFFIX)" ] && echo -e "  libpulseone-database: ‚úÖ" || echo -e "  libpulseone-database: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-client$(LIB_SUFFIX)" ] && echo -e "  libpulseone-client: ‚úÖ" || echo -e "  libpulseone-client: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-data$(LIB_SUFFIX)" ] && echo -e "  libpulseone-data: ‚úÖ" || echo -e "  libpulseone-data: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-export$(LIB_SUFFIX)" ] && echo -e "  libpulseone-export: ‚úÖ" || echo -e "  libpulseone-export: ‚ùå"
	@[ -f "$(SHARED_LIB_DIR)/libpulseone-alarm$(LIB_SUFFIX)" ] && echo -e "  libpulseone-alarm: ‚úÖ" || echo -e "  libpulseone-alarm: ‚ùå"
	@echo -e "$(GREEN)‚úÖ HAS_SHARED_LIBS=1 - LogManager available$(NC)"
else
	@echo -e "$(YELLOW)‚ö†Ô∏è  Shared libraries not found$(NC)"
	@echo -e "$(YELLOW)‚ö†Ô∏è  Build will continue without shared libraries$(NC)"
endif
	@echo -e "$(GREEN)‚úÖ Shared libraries checked$(NC)"

# ‚úÖ debug-vars (ÎîîÎ≤ÑÍπÖÏö© Î≥ÄÏàò Ï∂úÎ†•)
debug-vars:
	@echo "=== Platform Info ==="
	@echo "PLATFORM: $(PLATFORM)"
	@echo "IS_WINDOWS: $(IS_WINDOWS)"
	@echo "EXE_SUFFIX: $(EXE_SUFFIX)"
	@echo ""
	@echo "=== Directories ==="
	@echo "PROJECT_ROOT: $(PROJECT_ROOT)"
	@echo "SHARED_DIR: $(SHARED_DIR)"
	@echo "SHARED_LIB_DIR: $(SHARED_LIB_DIR)"
	@echo ""
	@echo "=== Library Detection ==="
	@echo "HAS_SHARED: $(HAS_SHARED)"
	@echo "HAS_HIREDIS: $(HAS_HIREDIS)"
	@echo "HAS_CURL: $(HAS_CURL)"
	@echo "HAS_OPENSSL: $(HAS_OPENSSL)"
	@echo "HAS_PAHO_MQTT: $(HAS_PAHO_MQTT)"
	@echo ""
	@echo "=== Source Files (v3.1) ==="
	@echo "EVENT_SOURCES: $(EVENT_SOURCES)"
	@echo "SCHEDULE_SOURCES: $(SCHEDULE_SOURCES)"
	@echo "TRANSFORM_SOURCES: $(TRANSFORM_SOURCES)"
	@echo "CSP_SOURCES: $(CSP_SOURCES)"
	@echo "EXPORT_SOURCES: $(EXPORT_SOURCES)"
	@echo "UTILS_SOURCES: $(UTILS_SOURCES)"
	@echo "MAIN_SOURCES: $(MAIN_SOURCES)"
	@echo ""
	@echo "=== Object Files ==="
	@echo "EVENT_OBJECTS: $(EVENT_OBJECTS)"
	@echo "SCHEDULE_OBJECTS: $(SCHEDULE_OBJECTS)"
	@echo "TRANSFORM_OBJECTS: $(TRANSFORM_OBJECTS)"
	@echo "CSP_OBJECTS: $(CSP_OBJECTS)"
	@echo ""
	@echo "=== Total ==="
	@echo "ALL_OBJECTS count: $(words $(ALL_OBJECTS))"
	@echo ""
	@echo "=== Flags ==="
	@echo "CXXFLAGS: $(CXXFLAGS)"
	@echo "INCLUDES: $(INCLUDES)"
	@echo "LDFLAGS: $(LDFLAGS)"

# =============================================================================
# ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏßÄÏõê
# =============================================================================

windows-cross:
	@echo -e "$(YELLOW)üîß Building for Windows (cross-compile)...$(NC)"
	$(MAKE) CROSS_COMPILE_WINDOWS=1 all

# =============================================================================
# ÌÖåÏä§Ìä∏ ÌÉÄÍ≤üÎì§
# =============================================================================

test: $(TEST_BIN_DIR)/test_integration
	@echo -e "$(BLUE)üß™ Running integration tests...$(NC)"
	@$(TEST_BIN_DIR)/test_integration

# üî• MQTT Ìï∏Îì§Îü¨ ÌÖåÏä§Ìä∏ (Îã®ÏúÑ ÌÖåÏä§Ìä∏ Makefile Ìò∏Ï∂ú)
test-mqtt:
	@echo -e "$(BLUE)üß™ Running MQTT handler tests...$(NC)"
	@$(MAKE) -C tests/unit test-mqtt

# üî• Paho MQTT C++ ÏÑ§Ïπò (Ubuntu/Debian)
install-paho-mqtt:
	@echo -e "$(BLUE)üì¶ Installing Paho MQTT C++ library...$(NC)"
	@apt-get update && apt-get install -y \
		libpaho-mqttpp-dev libpaho-mqttpp3-1 \
		libpaho-mqtt-dev libpaho-mqtt1.3
	@echo -e "$(GREEN)‚úÖ Paho MQTT C++ installed$(NC)"
	@echo -e "$(YELLOW)üí° Run 'make clean && make' to rebuild with MQTT support$(NC)"

$(TEST_BIN_DIR)/test_integration: $(TEST_BUILD_DIR)/test_integration.o $(filter-out $(MAIN_OBJECT), $(ALL_OBJECTS)) | $(TEST_BIN_DIR)
	@echo -e "$(BLUE)üîó Linking test_integration$(NC)"
	@$(CXX) $^ $(LDFLAGS) -o $@

$(TEST_BUILD_DIR)/%.o: $(TEST_DIR)/%.cpp | $(TEST_BUILD_DIR)
	@echo -e "$(YELLOW)‚öôÔ∏è  Compiling test $<...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ÌäπÏàò ÌÉÄÍ≤üÎì§
# =============================================================================

.PHONY: install uninstall help version install-paho-mqtt

install:
	@echo -e "$(BLUE)üì¶ Installing Export Gateway v3.1...$(NC)"
	@mkdir -p /usr/local/bin
	@cp $(TARGET) /usr/local/bin/
	@chmod +x /usr/local/bin/export-gateway$(EXE_SUFFIX)
	@echo -e "$(GREEN)‚úÖ Installation completed$(NC)"

uninstall:
	@echo -e "$(YELLOW)üóëÔ∏è  Uninstalling Export Gateway...$(NC)"
	@rm -f /usr/local/bin/export-gateway$(EXE_SUFFIX)
	@echo -e "$(GREEN)‚úÖ Uninstallation completed$(NC)"

version:
	@echo "PulseOne Export Gateway v3.1"
	@echo "EventSubscriber: Î≤îÏö© Redis Pub/Sub Ïù¥Î≤§Ìä∏ Íµ¨ÎèÖÏûê"
	@echo "ScheduledExporter: Ïä§ÏºÄÏ§Ñ Í∏∞Î∞ò Îç∞Ïù¥ÌÑ∞ Export"
	@echo "MqttTargetHandler: Paho MQTT C++ (CollectorÏôÄ ÎèôÏùº)"
	@echo "Platform: $(PLATFORM)"

help:
	@echo "PulseOne Export Gateway v3.1 - Makefile Commands"
	@echo ""
	@echo "Build Commands:"
	@echo "  make              - Build the project"
	@echo "  make clean        - Clean build files (keep directories)"
	@echo "  make clean-all    - Deep clean (remove directories)"
	@echo "  make run          - Build and run"
	@echo ""
	@echo "Test Commands:"
	@echo "  make test         - Run integration tests"
	@echo "  make test-mqtt    - Run MQTT handler unit tests"
	@echo ""
	@echo "Install Commands:"
	@echo "  make install-paho-mqtt - Install Paho MQTT C++ library"
	@echo "  make install      - Install to /usr/local/bin"
	@echo "  make uninstall    - Uninstall from /usr/local/bin"
	@echo ""
	@echo "Utility Commands:"
	@echo "  make check-libs   - Check library dependencies"
	@echo "  make debug-vars   - Show build variables"
	@echo "  make version      - Show version info"
	@echo ""
	@echo "Platform: $(PLATFORM)"
	@echo "Target: $(TARGET)"
	@echo ""
	@echo "v3.1 Changes:"
	@echo "  - Paho MQTT C++ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏßÄÏõê Ï∂îÍ∞Ä"
	@echo "  - MqttTargetHandler: CollectorÏôÄ ÎèôÏùºÌïú async_client ÏÇ¨Ïö©"
	@echo "  - HAS_PAHO_MQTT ÏûêÎèô Í∞êÏßÄ"