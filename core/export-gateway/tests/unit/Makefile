# =============================================================================
# Makefile for Circuit Breaker Unit Test
# =============================================================================

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2

# ê²½ë¡œ ì„¤ì • (ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ì¡°ì •)
INCLUDE_DIRS = -I../../include \
               -I../../../shared/include \
               -I../../../database/include

# ì†ŒìŠ¤ íŒŒì¼ ê²½ë¡œ (export-gateway ê¸°ì¤€)
FAILUREPROTECTOR_SRC = ../../src/CSP/FailureProtector.cpp
LOGMANAGER_SRC = ../../../shared/src/Utils/LogManager.cpp

# ë¼ì´ë¸ŒëŸ¬ë¦¬
LIBS = -lpthread

# ë¹Œë“œ ë””ë ‰í† ë¦¬
BIN_DIR = bin
BUILD_DIR = build

# íƒ€ê²Ÿ
TARGET = $(BIN_DIR)/test_circuit_breaker
TEST_SRC = test_circuit_breaker.cpp

.PHONY: all test clean check help

all: $(TARGET)

# ì‹¤ì œ ë¹Œë“œ
$(TARGET): $(TEST_SRC) | $(BIN_DIR) $(BUILD_DIR)
	@echo "ğŸ”¨ Building Circuit Breaker test..."
	$(CXX) $(CXXFLAGS) $(INCLUDE_DIRS) \
		$(TEST_SRC) \
		$(FAILUREPROTECTOR_SRC) \
		$(LOGMANAGER_SRC) \
		-o $(TARGET) $(LIBS)
	@echo "âœ… Build complete: $(TARGET)"

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BIN_DIR) $(BUILD_DIR):
	@mkdir -p $@

# ë¹Œë“œ & ì‹¤í–‰
test: $(TARGET)
	@echo ""
	@echo "ğŸ§ª Running Circuit Breaker tests..."
	@echo ""
	@$(TARGET)

# ë¹ ë¥¸ ì»´íŒŒì¼ & ì‹¤í–‰ (ì„ì‹œ ë””ë ‰í† ë¦¬)
quick: $(TEST_SRC)
	@echo "ğŸš€ Quick compile & test..."
	@$(CXX) $(CXXFLAGS) $(INCLUDE_DIRS) \
		$(TEST_SRC) \
		$(FAILUREPROTECTOR_SRC) \
		$(LOGMANAGER_SRC) \
		-o /tmp/test_cb $(LIBS)
	@echo ""
	@/tmp/test_cb

# íŒŒì¼ ì¡´ì¬ í™•ì¸
check:
	@echo "ğŸ“ Checking source files..."
	@echo -n "  FailureProtector.cpp: "
	@test -f $(FAILUREPROTECTOR_SRC) && echo "âœ… Found" || echo "âŒ Not found"
	@echo -n "  LogManager.cpp: "
	@test -f $(LOGMANAGER_SRC) && echo "âœ… Found" || echo "âŒ Not found"
	@echo -n "  test_circuit_breaker.cpp: "
	@test -f $(TEST_SRC) && echo "âœ… Found" || echo "âŒ Not found"

# ì •ë¦¬
clean:
	@rm -rf $(BIN_DIR) $(BUILD_DIR)
	@rm -f /tmp/test_cb
	@echo "âœ… Clean complete"

# ë„ì›€ë§
help:
	@echo "Usage:"
	@echo "  make        - Build test"
	@echo "  make test   - Build and run test"
	@echo "  make quick  - Quick compile & run"
	@echo "  make check  - Check if source files exist"
	@echo "  make clean  - Clean"