# core/export-gateway/Dockerfile.dev - PulseOne Export Gateway 개발 환경
FROM gcc:12

# 기본 패키지 설치 (redis-tools 추가!)
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libsqlite3-dev sqlite3 \
    curl git pkg-config \
    wget unzip vim nano \
    libssl-dev uuid-dev \
    libcurl4-openssl-dev \
    tree htop procps \
    redis-tools \
    && rm -rf /var/lib/apt/lists/*

# httplib 헤더 다운로드
RUN mkdir -p /usr/local/include && \
    wget -O /usr/local/include/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.14.1/httplib.h && \
    chmod 644 /usr/local/include/httplib.h

# nlohmann/json 설치
RUN echo "Installing nlohmann/json..." && \
    cd /tmp && \
    git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DJSON_BuildTests=OFF && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/json

# hiredis (Redis 클라이언트) 설치
RUN echo "Installing hiredis..." && \
    cd /tmp && \
    git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_SSL=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/hiredis

# libcurl 설정 확인
RUN echo "libcurl version:" && curl-config --version

# AWS SDK를 위한 기본 준비 (향후 확장용)
RUN echo "AWS SDK preparation complete"

# 컴파일러 환경 설정
ENV CC=gcc CXX=g++
ENV CFLAGS="-std=c11 -Wall -Wextra"
ENV CXXFLAGS="-std=c++17 -Wall -Wextra"

# Bash 프롬프트 설정
RUN echo 'export PS1="\[\033[01;36m\]\u@export-gateway\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "🌐 PulseOne Export Gateway Development Environment"' >> /root/.bashrc && \
    echo 'echo "================================================="' >> /root/.bashrc && \
    echo 'echo "Installed libraries:"' >> /root/.bashrc && \
    echo 'echo " ✅ httplib (HTTP client)"' >> /root/.bashrc && \
    echo 'echo " ✅ nlohmann/json (JSON processing)"' >> /root/.bashrc && \
    echo 'echo " ✅ hiredis (Redis client)"' >> /root/.bashrc && \
    echo 'echo " ✅ libcurl (HTTP/HTTPS client)"' >> /root/.bashrc && \
    echo 'echo " ✅ redis-tools (Redis CLI)"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "Development focus:"' >> /root/.bashrc && \
    echo 'echo " 🎯 C# CSPGateway porting to C++"' >> /root/.bashrc && \
    echo 'echo " 📊 Alarm priority processing"' >> /root/.bashrc && \
    echo 'echo " ☁️ AWS S3 integration"' >> /root/.bashrc && \
    echo 'echo " 🔄 API retry logic"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

WORKDIR /app

CMD ["/bin/bash"]