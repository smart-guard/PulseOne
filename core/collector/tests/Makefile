# =============================================================================
# collector/tests/Makefile - Complete Enhanced Version with Step 7 REST API Backend Test
# ëª¨ë“  ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸ ë¡œê·¸ íŒŒì¼ ìë™ ìƒì„± ì§€ì› + Step 7 ì™„ì „ í†µí•©
# =============================================================================

# ì„±ëŠ¥ ìµœì í™” ì„¤ì •
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC) --output-sync=target

# í”Œë«í¼ ê°ì§€
UNAME := $(shell uname -s)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
    IS_LINUX := 1
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
    IS_LINUX := 0
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
    IS_LINUX := 0
endif

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ìºì‹œëœ ê²°ê³¼ ì‚¬ìš©)
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")
# Docker í™˜ê²½ì—ì„œ íŒŒì¼ì´ ìˆì–´ë„ shell ê¶Œí•œ ë¬¸ì œ ë“±ìœ¼ë¡œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª…ì‹œì  í™•ì¸ ì¶”ê°€ ë˜ëŠ” ê°•ì œ ì„¤ì • ê³ ë ¤
HAS_BACNET_STACK := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")
HAS_QUICKJS := 1
HAS_HTTPLIB := $(shell echo '\#include <httplib.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_CURL := $(shell pkg-config --exists libcurl && echo "1" || echo "0")
HAS_LIBMODBUS := $(shell pkg-config --exists libmodbus && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì • (í”Œë«í¼ë³„)
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE -DTEST_BUILD \
           -O1 -fno-omit-frame-pointer \
           -Wno-unused-but-set-variable -Wno-unused-variable \
           -Wno-unused-parameter \
           -fdiagnostics-color=always

# í”Œë«í¼ë³„ ì»´íŒŒì¼ í”Œë˜ê·¸ ì¶”ê°€
ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1 -DPULSEONE_LINUX=0 \
                -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX
    PLATFORM_LIBS = -lws2_32 -liphlpapi -lkernel32 -luser32
else
    CXXFLAGS += -DPULSEONE_WINDOWS=0 -DPULSEONE_LINUX=1
    PLATFORM_LIBS = -lbluetooth
    
    # macOS Specifics
    ifeq ($(UNAME),Darwin)
        INCLUDES += -I/opt/homebrew/opt/openssl@3/include
        PLATFORM_LIBS += -L/opt/homebrew/opt/openssl@3/lib
    endif
endif

# Modbus ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
# Modbus ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_LIBMODBUS),1)
    CXXFLAGS += -DHAVE_MODBUS $(shell pkg-config --cflags libmodbus)
    MODBUS_LIBS = $(shell pkg-config --libs libmodbus)
    LIBS += $(MODBUS_LIBS)
else
    # Fallback check
    CHECK_MODBUS := $(shell [ -f "/usr/include/modbus/modbus.h" ] || [ -f "/usr/local/include/modbus/modbus.h" ] || [ -f "/opt/homebrew/include/modbus/modbus.h" ] && echo "1" || echo "0")
    ifeq ($(CHECK_MODBUS),1)
        CXXFLAGS += -DHAVE_MODBUS -I/usr/include/modbus -I/usr/local/include/modbus -I/opt/homebrew/include/modbus
        MODBUS_LIBS = -lmodbus
        LIBS += $(MODBUS_LIBS)
    endif
endif

# ë””ë ‰í† ë¦¬ ì„¤ì •
OBJ_DIR = ./obj
BIN_DIR = ./bin
DATA_DIR = ./data
LOG_DIR = ./logs

# ê²½ë¡œ ì„¤ì •
PARENT_DIR = ..
INCLUDE_DIR = $(PARENT_DIR)/include
SRC_DIR = $(PARENT_DIR)/src
SHARED_DIR = $(PARENT_DIR)/../shared
SHARED_INCLUDE_DIR = $(SHARED_DIR)/include
SHARED_SRC_DIR = $(SHARED_DIR)/src

# Include ê²½ë¡œ
INCLUDES = -I$(SHARED_INCLUDE_DIR) \
           -I$(SHARED_DIR)/modules/LogLib/include \
           -I$(SHARED_DIR)/modules/DbLib/include \
           -I$(SHARED_INCLUDE_DIR)/Client \
           -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Scripting \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Drivers/OPCUA \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Storage \
           -I$(INCLUDE_DIR)/Client \
           -I./googletest/googletest/include \
           -I./googletest/googlemock/include

# Modbus ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1; echo $$?),0)
    MODBUS_LIBS = 
else
    MODBUS_LIBS = -lmodbus
    MODBUS_INCLUDES = $(shell pkg-config --cflags libmodbus 2>/dev/null || echo "")
    INCLUDES += $(MODBUS_INCLUDES)
endif

# MySQL ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
MYSQL_CONFIG := $(shell which mysql_config 2>/dev/null)
ifneq ($(MYSQL_CONFIG),)
    MYSQL_LIBS = $(shell mysql_config --libs)
    MYSQL_INCLUDES = $(shell mysql_config --include)
    INCLUDES += $(MYSQL_INCLUDES)
else
    MYSQL_LIBS = 
    CXXFLAGS += -DDISABLE_MYSQL_FEATURES
endif

ifeq ($(HAS_MQTT_CPP),1)
    MQTT_CPP_LIBS = -lpaho-mqttpp3
    CXXFLAGS += -DHAVE_MQTT_CPP
    INCLUDES += -I/usr/local/include
else
    MQTT_CPP_LIBS = 
endif

ifeq ($(HAS_MQTT_C),1)
    MQTT_C_LIBS = -lpaho-mqtt3c
    CXXFLAGS += -DHAVE_MQTT
else
    MQTT_C_LIBS = 
endif

# PostgreSQL ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpqxx >/dev/null 2>&1; echo $$?),0)
    PGSQL_LIBS = 
else
    PGSQL_LIBS = -lpqxx -lpq
endif

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_BACNET_STACK), 1)
    BACNET_LIBS = -lbacnet -lm
    BACNET_INCLUDES = -I/usr/local/include/bacnet
    INCLUDES += $(BACNET_INCLUDES)
    CXXFLAGS += -DHAS_BACNET_STACK=1
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
    BACNET_LIBS = 
endif

# Redis ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_HIREDIS),1)
    REDIS_LIBS = /usr/local/lib/libhiredis.so.1.1.0 -lssl -lcrypto
    CXXFLAGS += -DHAVE_REDIS
else
    REDIS_LIBS = 
endif

# JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# QuickJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_QUICKJS),1)
    # pkg-config might return -L/usr/local/lib which is incorrect for this environment
    QUICKJS_LIBS = -L/usr/local/lib/quickjs -lquickjs
    QUICKJS_INCLUDES = $(shell pkg-config --cflags quickjs 2>/dev/null || echo "-I/usr/local/include/quickjs -I/usr/local/include")
    INCLUDES += $(QUICKJS_INCLUDES)
    CXXFLAGS += -DHAS_QUICKJS=1
else
    QUICKJS_LIBS = 
    CXXFLAGS += -DHAS_QUICKJS=0
    $(warning QuickJS not found - Script alarms will be disabled)
endif

# HTTP ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_HTTPLIB),1)
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=1
    $(info âœ… Including HTTP support - REST API enabled)
else
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=0
    $(warning âš ï¸ httplib not available - REST API disabled)
endif

# CURL ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (Step 7ìš©)
ifeq ($(HAS_CURL),1)
    CURL_LIBS = -lcurl
    CURL_INCLUDES = $(shell pkg-config --cflags libcurl 2>/dev/null || echo "")
    INCLUDES += $(CURL_INCLUDES)
    CXXFLAGS += -DHAS_CURL=1
    $(info âœ… CURL support enabled - Step 7 REST API tests available)
else
    CURL_LIBS = 
    CXXFLAGS += -DHAS_CURL=0
    $(warning âš ï¸ libcurl not available - Step 7 tests will be disabled)
endif

# ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
BASIC_LIBS = -lpthread -lsqlite3 $(QUICKJS_LIBS) $(HTTP_LIBS) $(CURL_LIBS) -lm -ldl $(PLATFORM_LIBS)
OPTIONAL_LIBS = $(MODBUS_LIBS) $(MYSQL_LIBS) $(PGSQL_LIBS) $(MQTT_C_LIBS) $(MQTT_CPP_LIBS) $(BACNET_LIBS) $(REDIS_LIBS)
LIBS = $(BASIC_LIBS) $(OPTIONAL_LIBS)
TEST_LIBS = ./googletest/build-linux/lib/libgtest_main.a ./googletest/build-linux/lib/libgmock.a ./googletest/build-linux/lib/libgtest.a -lpthread

# ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘
# Shared Sources
SHARED_UTILS_SOURCES := $(wildcard $(SHARED_SRC_DIR)/Utils/*.cpp)
SHARED_SECURITY_SOURCES := $(wildcard $(SHARED_SRC_DIR)/Security/*.cpp)
SHARED_DATABASE_SOURCES := $(wildcard $(SHARED_SRC_DIR)/Database/*.cpp) \
                          $(wildcard $(SHARED_SRC_DIR)/Database/Entities/*.cpp) \
                          $(wildcard $(SHARED_SRC_DIR)/Database/Repositories/*.cpp)
SHARED_LOGGING_SOURCES := $(wildcard $(SHARED_SRC_DIR)/Logging/*.cpp)
LOGLIB_SOURCES := $(wildcard $(SHARED_DIR)/modules/LogLib/src/*.cpp)
DBLIB_SOURCES := $(wildcard $(SHARED_DIR)/modules/DbLib/src/*.cpp)
SHARED_PLATFORM_SOURCES := $(wildcard $(SHARED_SRC_DIR)/Platform/*.cpp)
SHARED_SECURITY_SOURCES := $(SHARED_SRC_DIR)/Security/SecretManager.cpp

# Collector ì „ìš© ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
# ì¤‘ë³µ ì œê±°: sharedì— ìˆëŠ” íŒŒì¼ë“¤ì€ collector/srcì—ì„œ ì œì™¸í•˜ê±°ë‚˜ shared ë²„ì „ì„ ìš°ì„ í•¨
UTILS_SOURCES := $(filter-out $(SHARED_UTILS_SOURCES),$(UTILS_SOURCES))

CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)
# sharedì™€ ê²¹ì¹˜ì§€ ì•ŠëŠ” collector ì „ìš© DB ì†ŒìŠ¤
COLLECTOR_ONLY_DB_SOURCES := $(SRC_DIR)/Database/RepositoryFactory.cpp
# SQLQueries.cpp ë“±ì€ sharedì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ collectorì—ë„ ì—†ìœ¼ë©´ ì œê±°
# ls ê²°ê³¼ collector/src/Database ì—ëŠ” ì•„ë¬´ .cpp ê°€ ì—†ìŒ
COLLECTOR_ONLY_DB_SOURCES := 

CLIENT_SOURCES := $(SHARED_SRC_DIR)/Client/RedisClientImpl.cpp \
                  $(SHARED_SRC_DIR)/Client/HttpClient.cpp \
                  $(SHARED_SRC_DIR)/Client/InfluxClientImpl.cpp
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Components/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/*.cpp)
STORAGE_SOURCES := $(wildcard $(SRC_DIR)/Storage/*.cpp)

ifeq ($(HAS_HTTPLIB),1)
    NETWORK_SOURCES := $(wildcard $(SRC_DIR)/Network/*.cpp)
    API_SOURCES := $(wildcard $(SRC_DIR)/Api/*.cpp)
else
    NETWORK_SOURCES :=
    API_SOURCES :=
endif

DRIVERS_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
ifneq ($(MODBUS_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif
ifeq ($(HAS_MQTT_CPP),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
endif
ifeq ($(HAS_BACNET_STACK),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif
ifneq ($(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp)
endif
ifneq ($(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp),)
    DRIVERS_SOURCES += $(SRC_DIR)/Drivers/OPCUA/OPCUADriver.cpp
endif
DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Ble/*.cpp)
DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Ros/*.cpp)
DRIVERS_SOURCES += $(SRC_DIR)/Drivers/Bacnet/BACnetDriver.cpp

# Duplicate rule removed, handled in step17-opcua-build section

PIPELINE_SOURCES = $(wildcard $(SRC_DIR)/Pipeline/*.cpp) $(wildcard $(SRC_DIR)/Pipeline/Stages/*.cpp)
ALARM_SOURCES := $(wildcard $(SRC_DIR)/Alarm/*.cpp)
VIRTUALPOINT_SOURCES := $(wildcard $(SRC_DIR)/VirtualPoint/*.cpp)
SCRIPTING_SOURCES := $(wildcard $(SRC_DIR)/Scripting/*.cpp)
PLATFORM_SOURCES := $(wildcard $(SRC_DIR)/Platform/*.cpp)
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

ALL_SOURCES = $(CORE_SOURCES) $(SHARED_UTILS_SOURCES) $(CONFIG_SOURCES) \
              $(SHARED_DATABASE_SOURCES) $(COLLECTOR_ONLY_DB_SOURCES) \
              $(SHARED_SECURITY_SOURCES) \
              $(CLIENT_SOURCES) $(WORKERS_SOURCES) \
              $(DRIVERS_SOURCES) $(PIPELINE_SOURCES) $(ALARM_SOURCES) \
              $(VIRTUALPOINT_SOURCES) $(SCRIPTING_SOURCES) $(NETWORK_SOURCES) $(API_SOURCES) \
              $(SHARED_PLATFORM_SOURCES) $(PLUGIN_SOURCES) $(STORAGE_SOURCES) \
              $(SHARED_LOGGING_SOURCES) $(LOGLIB_SOURCES) $(DBLIB_SOURCES) 

# í”ŒëŸ¬ê·¸ì¸ìš© ë“œë¼ì´ë²„ ì†ŒìŠ¤ (ë©”ì¸ ë°”ì´ë„ˆë¦¬ì—ì„œ ì œì™¸)
PLUGIN_DRIVERS_SOURCES := $(SRC_DIR)/Drivers/Mqtt/MqttDriver.cpp \
                          $(SRC_DIR)/Drivers/Bacnet/BACnetDriver.cpp \
                          $(SRC_DIR)/Drivers/OPCUA/OPCUADriver.cpp

# OPC UA C Source
OPCUA_C_SOURCE := $(SRC_DIR)/Drivers/OPCUA/open62541.c

# ë©”ì¸ ì½”ì–´ ì†ŒìŠ¤ (í”ŒëŸ¬ê·¸ì¸ ë“œë¼ì´ë²„ ì œì™¸)
CORE_SOURCES_ONLY := $(filter-out $(PLUGIN_DRIVERS_SOURCES),$(ALL_SOURCES))

# í—¤ë”ë§Œ ì¡´ì¬í•˜ëŠ” ì†ŒìŠ¤ë“¤ ì œì™¸ (ì»´íŒŒì¼ ëŒ€ìƒ ì•„ë‹˜)
HEADER_ONLY_SOURCES := $(SHARED_SRC_DIR)/Platform/PlatformCompat.cpp # ë§Œì•½ ì¡´ì¬í•œë‹¤ë©´
CORE_SOURCES_FINAL := $(filter-out $(HEADER_ONLY_SOURCES),$(CORE_SOURCES_ONLY))

COLLECTOR_OBJECTS = $(patsubst $(PARENT_DIR)/src/%.cpp,$(OBJ_DIR)/%.o,$(filter $(PARENT_DIR)/src/%,$(CORE_SOURCES_FINAL)))
SHARED_OBJECTS = $(patsubst $(SHARED_DIR)/src/%.cpp,$(OBJ_DIR)/shared/%.o,$(filter $(SHARED_DIR)/src/%,$(CORE_SOURCES_FINAL)))
MODULE_OBJECTS = $(patsubst $(SHARED_DIR)/modules/%.cpp,$(OBJ_DIR)/shared/modules/%.o,$(filter $(SHARED_DIR)/modules/%,$(CORE_SOURCES_FINAL)))

CORE_OBJECTS = $(COLLECTOR_OBJECTS) $(SHARED_OBJECTS) $(MODULE_OBJECTS)

# Plugin Driver Objects (for tests that need them linked statically)
PLUGIN_DRIVER_OBJECTS = $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(PLUGIN_DRIVERS_SOURCES)) \
                        $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(OPCUA_C_SOURCE))

# Plugin í…ŒìŠ¤íŠ¸ìš© ê°ì²´ (Worker, API, Network, Application ê´€ë ¨ ê°ì²´ ëª¨ë‘ ì œì™¸ - ìˆœìˆ˜ ë¡œë” í…ŒìŠ¤íŠ¸ìš©)
PLUGIN_TEST_CORE_OBJECTS = $(filter-out $(OBJ_DIR)/Workers/Protocol/% $(OBJ_DIR)/Workers/WorkerFactory.o $(OBJ_DIR)/Workers/WorkerManager.o $(OBJ_DIR)/Api/% $(OBJ_DIR)/Network/% $(OBJ_DIR)/Core/Application.o,$(CORE_OBJECTS))

# ê¸°ì¡´ ALL_OBJECTSëŠ” í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€í•˜ë˜, ë“œë¼ì´ë²„ í¬í•¨ ë²„ì „ìœ¼ë¡œ ì •ì˜ (í•„ìš”ì‹œ)
# í•˜ì§€ë§Œ ì´ì œ ëŒ€ë¶€ë¶„ì˜ í…ŒìŠ¤íŠ¸ê°€ CORE_OBJECTSë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
ALL_OBJECTS = $(CORE_OBJECTS)

TEST_OBJECTS = $(OBJ_DIR)/test_step1_config_connection.o \
               $(OBJ_DIR)/test_step2_database_entity.o \
               $(OBJ_DIR)/test_step3_protocol_worker.o \
               $(OBJ_DIR)/test_step4_driver_data_validation.o \
               $(OBJ_DIR)/test_step5_complete_db_integration_validation.o \
               $(OBJ_DIR)/test_step6_rest_api_worker_reload.o \
               $(OBJ_DIR)/test_step6_enhanced_pipeline.o \
               $(OBJ_DIR)/test_step7_rest_api_backend_complete.o \
               $(OBJ_DIR)/test_step8_driver_reconnection_data_flow.o \
               $(OBJ_DIR)/test_step9_scale_and_multi_protocol.o \
               $(OBJ_DIR)/test_step10_e2e_integration_recovery.o \
               $(OBJ_DIR)/test_step11_advanced_scenarios.o \
               $(OBJ_DIR)/test_step12_state_recovery_storage.o \
               $(OBJ_DIR)/test_plugin_loading.o \
               $(OBJ_DIR)/test_network_api.o \
               $(OBJ_DIR)/test_platform_compat.o \
               $(OBJ_DIR)/test_workermanager.o \
               $(OBJ_DIR)/test_vp_concurrency.o

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
PURPLE = \033[0;35m
CYAN = \033[0;36m
MAGENTA = \033[0;95m
NC = \033[0m

# =============================================================================
# ë¡œê·¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
# =============================================================================

# í˜„ì¬ ì‹œê°„ ìŠ¤íƒ¬í”„ ìƒì„±
TIMESTAMP := $(shell date '+%Y%m%d_%H%M%S')

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
create-log-dir:
	@mkdir -p $(LOG_DIR)

# ë¡œê·¸ íŒŒì¼ëª… ì •ì˜ (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
define get_log_filename
$(LOG_DIR)/$(1)_test_$(TIMESTAMP).log
endef

# ë¡œê·¸ ìš”ì•½ ìƒì„± í•¨ìˆ˜
define create_log_summary
	@echo "========================================" >> $(1)
	@echo "Test Summary for $(2)" >> $(1)
	@echo "Platform: $(PLATFORM)" >> $(1)
	@echo "Timestamp: $(shell date)" >> $(1)
	@echo "Log file: $(1)" >> $(1)
	@echo "========================================" >> $(1)
endef

# ë¡œê·¸ ë¶„ì„ í•¨ìˆ˜
define analyze_log
	@echo -e "$(CYAN)ğŸ“Š $(2) Test Analysis:$(NC)"
	@if [ -f "$(1)" ]; then \
		echo "ì„±ê³µí•œ í…ŒìŠ¤íŠ¸:"; \
		grep -c "PASSED\|âœ…\|ì„±ê³µ" $(1) || echo "0"; \
		echo "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:"; \
		grep -c "FAILED\|âŒ\|ì‹¤íŒ¨" $(1) || echo "0"; \
		echo "ì£¼ìš” ì˜¤ë¥˜:"; \
		grep -E "ERROR\|Exception\|ì˜¤ë¥˜" $(1) | head -3 || echo "ì˜¤ë¥˜ ì—†ìŒ"; \
		echo "ì „ì²´ ê²€ì¦ë¥ :"; \
		grep -o "[0-9]\+\.[0-9]\+%" $(1) | tail -1 || echo "N/A"; \
	else \
		echo "ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $(1)"; \
	fi
endef

# =============================================================================
# ë””ë ‰í† ë¦¬ ìë™ ìƒì„± ê·œì¹™
# =============================================================================

.DEFAULT_GOAL := help

# ê°•ì œ ë””ë ‰í† ë¦¬ ìƒì„±
.PHONY: create-dirs
create-dirs: create-log-dir
	@echo -e "$(BLUE)ğŸ—ï¸ Creating directories for $(PLATFORM)...$(NC)"
	@mkdir -p $(OBJ_DIR) $(BIN_DIR) $(DATA_DIR) $(LOG_DIR)
	@mkdir -p $(OBJ_DIR)/Core $(OBJ_DIR)/Utils $(OBJ_DIR)/Config 
	@mkdir -p $(OBJ_DIR)/Database $(OBJ_DIR)/Database/Entities $(OBJ_DIR)/Database/Repositories
	@mkdir -p $(OBJ_DIR)/Client $(OBJ_DIR)/Workers $(OBJ_DIR)/Workers/Base $(OBJ_DIR)/Workers/Protocol $(OBJ_DIR)/Workers/Components
	@mkdir -p $(OBJ_DIR)/Drivers $(OBJ_DIR)/Drivers/Common $(OBJ_DIR)/Drivers/Modbus $(OBJ_DIR)/Drivers/Mqtt $(OBJ_DIR)/Drivers/Bacnet
	@mkdir -p $(OBJ_DIR)/Pipeline $(OBJ_DIR)/Alarm $(OBJ_DIR)/VirtualPoint $(OBJ_DIR)/Scripting $(OBJ_DIR)/Plugin
	@mkdir -p $(OBJ_DIR)/Network $(OBJ_DIR)/Api $(OBJ_DIR)/Platform $(OBJ_DIR)/Storage
	@mkdir -p $(OBJ_DIR)/shared $(OBJ_DIR)/shared/Client
	@echo -e "$(GREEN)âœ… All directories created (including logs)$(NC)"

# =============================================================================
# ì»´íŒŒì¼ ê·œì¹™
# =============================================================================

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ê³µìœ  ì†ŒìŠ¤ ì»´íŒŒì¼ ê·œì¹™
$(OBJ_DIR)/shared/%.o: $(SHARED_SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for SHARED $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling SHARED $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ëª¨ë“ˆ ì†ŒìŠ¤ ì»´íŒŒì¼ ê·œì¹™ (LogLib, DbLib ë“±)
$(OBJ_DIR)/shared/modules/%.o: $(SHARED_DIR)/modules/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for MODULE $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling MODULE $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# C ì†ŒìŠ¤ ì»´íŒŒì¼ ê·œì¹™ (open62541 ë“±)
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling C source $< [$(PLATFORM)]$(NC)"
	@gcc -c $< -o $@ -std=c99 -I$(SRC_DIR)/Drivers/OPCUA $(INCLUDES)

# í…ŒìŠ¤íŠ¸ íŒŒì¼ ì»´íŒŒì¼ ê·œì¹™
$(OBJ_DIR)/test_step1_config_connection.o: test_step1_config_connection.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“‹ Compiling Step 1 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step2_database_entity.o: test_step2_database_entity.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ—„ï¸ Compiling Step 2 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step3_protocol_worker.o: test_step3_protocol_worker.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ‘· Compiling Step 3 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step4_driver_data_validation.o: test_step4_driver_data_validation.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”Œ Compiling Step 4 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step5_complete_db_integration_validation.o: test_step5_complete_db_integration_validation.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”„ Compiling Step 5 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step6_rest_api_worker_reload.o: test_step6_rest_api_worker_reload.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸŒ Compiling Step 6 RestAPI-WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step6_enhanced_pipeline.o: test_step6_enhanced_pipeline.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)âš¡ Compiling Step 6 Enhanced Pipeline Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step7_rest_api_backend_complete.o: test_step7_rest_api_backend_complete.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ¯ Compiling Step 7 Complete REST API Backend Test [$(PLATFORM)]...$(NC)"
ifeq ($(HAS_CURL),1)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@
else
	@echo -e "$(RED)âŒ Skipping Step 7 - libcurl not available$(NC)"
	@touch $@
endif

$(OBJ_DIR)/test_network_api.o: test_network_api.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸŒ Compiling Network Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_platform_compat.o: test_platform_compat.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ›¡ï¸ Compiling Platform Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_workermanager.o: test_workermanager.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ‘· Compiling WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step8_driver_reconnection_data_flow.o: test_step8_driver_reconnection_data_flow.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”Œ Compiling Step 8 Driver Reconnection Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step9_scale_and_multi_protocol.o: test_step9_scale_and_multi_protocol.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“ˆ Compiling Step 9 Scale and Multi-Protocol Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step10_e2e_integration_recovery.o: test_step10_e2e_integration_recovery.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“ˆ Compiling Step 10 End-to-End Integration Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step11_advanced_scenarios.o: test_step11_advanced_scenarios.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“ˆ Compiling Step 11 Advanced Scenarios Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step12_state_recovery_storage.o: test_step12_state_recovery_storage.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“ˆ Compiling Step 12 State Recovery & Storage Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step13_bacnet_read_write.o: test_step13_bacnet_read_write.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ“¡ Compiling Step 13 RW Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_plugin_loading.o: test_plugin_loading.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”Œ Compiling Plugin Loading Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_vp_concurrency.o: test_vp_concurrency.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”¥ Compiling VP Concurrency Stress Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_enrichment_stage.o: test_enrichment_stage.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ§ª Compiling Enrichment Stage Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_alarm_stage.o: test_alarm_stage.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ”” Compiling Alarm Stage Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
# =============================================================================

$(BIN_DIR)/test_step1: $(ALL_OBJECTS) $(OBJ_DIR)/test_step1_config_connection.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 1 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step1_config_connection.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 1 Test build completed!$(NC)"

$(BIN_DIR)/test_step2: $(ALL_OBJECTS) $(OBJ_DIR)/test_step2_database_entity.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 2 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step2_database_entity.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 2 Test build completed!$(NC)"

$(BIN_DIR)/test_step3: $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step3_protocol_worker.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 3 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step3_protocol_worker.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 3 Test build completed!$(NC)"

$(BIN_DIR)/test_step4: $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step4_driver_data_validation.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 4 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step4_driver_data_validation.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 4 Test build completed!$(NC)"

$(BIN_DIR)/test_step5: $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step5_complete_db_integration_validation.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 5 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step5_complete_db_integration_validation.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 5 Test build completed!$(NC)"

$(BIN_DIR)/test_step6: $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step6_rest_api_worker_reload.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 6 RestAPI-WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(PLUGIN_DRIVER_OBJECTS) $(OBJ_DIR)/test_step6_rest_api_worker_reload.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 6 RestAPI-WorkerManager Test build completed!$(NC)"

# Legacy rule removed to avoid conflict with new test_step6_pipeline definition

$(BIN_DIR)/test_step7: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_step7_rest_api_backend_complete.o
	@mkdir -p $(BIN_DIR)
ifeq ($(HAS_CURL),1)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 7 Complete REST API Backend Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_step7_rest_api_backend_complete.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 7 Complete REST API Backend Test build completed!$(NC)"
else
	@echo -e "$(YELLOW)âš ï¸ Step 7 Test skipped - libcurl not available$(NC)"
	@echo '#!/bin/bash' > $@
	@echo 'echo "Step 7 test requires libcurl - install with: apt install libcurl4-openssl-dev"' >> $@
	@echo 'exit 1' >> $@
	@chmod +x $@
endif

$(BIN_DIR)/test_network: $(ALL_OBJECTS) $(OBJ_DIR)/test_network_api.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Network Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_network_api.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Network Test build completed!$(NC)"

$(BIN_DIR)/test_platform: $(ALL_OBJECTS) $(OBJ_DIR)/test_platform_compat.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Platform Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_platform_compat.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Platform Test build completed!$(NC)"

$(BIN_DIR)/test_workermanager: $(ALL_OBJECTS) $(OBJ_DIR)/test_workermanager.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_workermanager.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… WorkerManager Test build completed!$(NC)"

$(BIN_DIR)/test_step8: $(ALL_OBJECTS) $(OBJ_DIR)/test_step8_driver_reconnection_data_flow.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 8 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step8_driver_reconnection_data_flow.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 8 Test build completed!$(NC)"

$(BIN_DIR)/test_step9: $(ALL_OBJECTS) $(OBJ_DIR)/test_step9_scale_and_multi_protocol.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 9 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step9_scale_and_multi_protocol.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 9 Test build completed!$(NC)"

$(BIN_DIR)/test_step10: $(ALL_OBJECTS) $(OBJ_DIR)/test_step10_e2e_integration_recovery.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 10 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step10_e2e_integration_recovery.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 10 Test build completed!$(NC)"

$(BIN_DIR)/test_step11: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_step11_advanced_scenarios.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 11 Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Step 11 Test build completed!$(NC)"

$(BIN_DIR)/test_step12: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_step12_performance_stress.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 12 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Step 12 Test build completed!$(NC)"

$(BIN_DIR)/test_vp_concurrency: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_vp_concurrency.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking VP Concurrency Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… VP Concurrency Test build completed!$(NC)"

vp-concurrency-test: create-dirs $(BIN_DIR)/test_vp_concurrency
	@echo -e "$(MAGENTA)ğŸš€ Running VP Concurrency Stress Test...$(NC)"
	@./$(BIN_DIR)/test_vp_concurrency

$(BIN_DIR)/test_enrichment_stage: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_enrichment_stage.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Enrichment Stage Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Enrichment Stage Test build completed!$(NC)"

enrichment-stage-test: create-dirs $(BIN_DIR)/test_enrichment_stage
	@echo -e "$(MAGENTA)ğŸš€ Running Enrichment Stage Test...$(NC)"
	@./$(BIN_DIR)/test_enrichment_stage

$(BIN_DIR)/test_alarm_stage: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_alarm_stage.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Alarm Stage Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Alarm Stage Test build completed!$(NC)"

alarm-stage-test: create-dirs $(BIN_DIR)/test_alarm_stage
	@echo -e "$(MAGENTA)ğŸš€ Running Alarm Stage Test...$(NC)"
	@./$(BIN_DIR)/test_alarm_stage

# Persistence Stage Test
$(OBJ_DIR)/test_persistence_stage.o: test_persistence_stage.cpp
	@mkdir -p $(dir $@)
	@echo -e "âš™ï¸ Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_persistence_stage: $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(OBJ_DIR)/test_persistence_stage.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Persistence Stage Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Persistence Stage Test build completed!$(NC)"

persistence-stage-test: create-dirs $(BIN_DIR)/test_persistence_stage
	@echo -e "$(MAGENTA)ğŸš€ Running Persistence Stage Test...$(NC)"
	@./$(BIN_DIR)/test_persistence_stage


# Step 13 Read/Write í…ŒìŠ¤íŠ¸
step13-rw-build: create-dirs $(BIN_DIR)/test_step13_rw

$(BIN_DIR)/test_step13_rw: $(ALL_OBJECTS) $(OBJ_DIR)/test_step13_bacnet_read_write.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 13 RW Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step13_bacnet_read_write.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 13 RW Test build completed!$(NC)"

step13-rw-test: step13-rw-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step13_rw))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 13 Read/Write Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)BACnet Read/Write Flow Verification$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 13 RW)
	@./$(BIN_DIR)/test_step13_rw 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 13 RW)
	@echo -e "$(GREEN)Step 13 RW Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 14 Object Compilation Rules
$(OBJ_DIR)/test_step14_mqtt_jsonpath.o: test_step14_mqtt_jsonpath.cpp
	@mkdir -p $(dir $@)
	@echo -e "âš™ï¸ Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step14_bacnet_schedule.o: test_step14_bacnet_schedule.cpp
	@mkdir -p $(dir $@)
	@echo -e "âš™ï¸ Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Step 14 Advanced Driver Features í…ŒìŠ¤íŠ¸
step14-advanced-build: create-dirs $(BIN_DIR)/test_step14_mqtt_jsonpath $(BIN_DIR)/test_step14_bacnet_schedule

$(BIN_DIR)/test_step14_mqtt_jsonpath: $(ALL_OBJECTS) $(OBJ_DIR)/test_step14_mqtt_jsonpath.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 14 MQTT JSONPath Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step14_mqtt_jsonpath.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -o $@

$(BIN_DIR)/test_step14_bacnet_schedule: $(ALL_OBJECTS) $(OBJ_DIR)/test_step14_bacnet_schedule.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 14 BACnet Schedule Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step14_bacnet_schedule.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 14 Advanced Features Test build completed!$(NC)"

step14-advanced-test: step14-advanced-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step14_advanced))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 14 Advanced Features Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)MQTT JSONPath Verification$(NC)"
	@./$(BIN_DIR)/test_step14_mqtt_jsonpath 2>&1 | tee -a $(LOG_FILE)
	@echo -e "$(CYAN)BACnet Schedule Verification$(NC)"
	@./$(BIN_DIR)/test_step14_bacnet_schedule 2>&1 | tee -a $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 14 Advanced)
	@echo -e "$(GREEN)Step 14 Advanced Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 15 Schedule Sync í…ŒìŠ¤íŠ¸
step15-sync-build: create-dirs $(BIN_DIR)/test_step15_sync

$(BIN_DIR)/test_step15_sync: $(ALL_OBJECTS) $(OBJ_DIR)/test_step15_schedule_sync.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 15 Schedule Sync Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step15_schedule_sync.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 15 Schedule Sync Test build completed!$(NC)"

step15-sync-test: step15-sync-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step15_sync))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 15 Schedule Sync Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 15 Sync)
	@./$(BIN_DIR)/test_step15_sync 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 15 Sync)
	@echo -e "$(GREEN)Step 15 Sync Test completed. Log saved: $(LOG_FILE)$(NC)"

$(OBJ_DIR)/test_step15_schedule_sync.o: test_step15_schedule_sync.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Step 16 BLE Beacon Test
step16-ble-build: create-dirs $(BIN_DIR)/test_step16_ble

$(BIN_DIR)/test_step16_ble: $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_beacon.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 16 BLE Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_beacon.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… Step 16 BLE Test build completed!$(NC)"

step16-ble-test: step16-ble-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step16_ble))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 16 BLE Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 16 BLE)
	@./$(BIN_DIR)/test_step16_ble 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 16 BLE)
	@echo -e "$(GREEN)Step 16 BLE Test completed. Log saved: $(LOG_FILE)$(NC)"

$(OBJ_DIR)/test_step16_ble_beacon.o: test_step16_ble_beacon.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Step 17 OPC UA Test
step17-opcua-build: create-dirs $(BIN_DIR)/test_step17_opcua

# Rule for open62541 C library (Amalgamation)
$(OBJ_DIR)/Drivers/OPCUA/open62541.o: $(SRC_DIR)/Drivers/OPCUA/open62541.c
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling open62541 (C) [$(PLATFORM)]...$(NC)"
	@gcc -std=c99 -I$(INCLUDE_DIR)/Drivers/OPCUA -c $< -o $@

$(BIN_DIR)/test_step17_opcua: $(ALL_OBJECTS) $(OBJ_DIR)/test_step17_opcua.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 17 OPC UA Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step17_opcua.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… Step 17 OPC UA Test build completed!$(NC)"

step17-opcua-test: step17-opcua-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step17_opcua))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 17 OPC UA Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 17 OPC UA)
	@./$(BIN_DIR)/test_step17_opcua 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 17 OPC UA)
	@echo -e "$(GREEN)Step 17 OPC UA Test completed. Log saved: $(LOG_FILE)$(NC)"

$(OBJ_DIR)/test_step17_opcua.o: test_step17_opcua.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_plugin_loading: $(OBJ_DIR)/test_plugin_loading.o $(PLUGIN_TEST_CORE_OBJECTS)
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Plugin Loading Test [$(PLATFORM)]...$(NC)"
	@$(CXX) -rdynamic $^ $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Plugin Loading Test build completed!$(NC)"

# Step 16.5 BLE Worker Test
step16-worker-build: create-dirs $(BIN_DIR)/test_step16_ble_worker

$(OBJ_DIR)/test_step16_ble_worker.o: test_step16_ble_worker.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_step16_ble_worker: $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_worker.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 16.5 BLE Worker Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_worker.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… Step 16.5 BLE Worker Test build completed!$(NC)"

step16-worker-test: step16-worker-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step16_ble_worker))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 16.5 BLE Worker Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 16.5 BLE Worker)
	@./$(BIN_DIR)/test_step16_ble_worker 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 16.5 BLE Worker)
	@echo -e "$(GREEN)Step 16.5 BLE Worker Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 16.5 BLE E2E Verification
step16-e2e-build: create-dirs $(BIN_DIR)/test_step16_ble_e2e

$(OBJ_DIR)/test_step16_ble_e2e.o: test_step16_ble_e2e.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_step16_ble_e2e: $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_e2e.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking BLE E2E Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step16_ble_e2e.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… BLE E2E Test build completed!$(NC)"

step16-e2e-test: step16-e2e-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step16_ble_e2e))
	@echo -e "$(MAGENTA)ğŸš€ Running BLE E2E Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),BLE E2E)
	@./$(BIN_DIR)/test_step16_ble_e2e 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),BLE E2E)
	@echo -e "$(GREEN)BLE E2E Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 17 OPC UA E2E Test
step17-e2e-build: create-dirs $(BIN_DIR)/test_step17_opcua_e2e

$(OBJ_DIR)/test_step17_opcua_e2e.o: test_step17_opcua_e2e.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_step17_opcua_e2e: $(ALL_OBJECTS) $(OBJ_DIR)/test_step17_opcua_e2e.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 17.5 E2E Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step17_opcua_e2e.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… Step 17.5 E2E Test build completed!$(NC)"

step17-e2e-test: step17-e2e-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step17_e2e))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 17.5 OPC UA E2E Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 17.5 OPC UA E2E)
	@./$(BIN_DIR)/test_step17_opcua_e2e 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 17.5 OPC UA E2E)
	@echo -e "$(GREEN)Step 17.5 OPC UA E2E Test completed. Log saved: $(LOG_FILE)$(NC)"

# =============================================================================
# í”ŒëŸ¬ê·¸ì¸ ë¹Œë“œ ê·œì¹™ (Shared Library .so ìƒì„±)
# =============================================================================

PLUGIN_DIR := $(BIN_DIR)/plugins

# í”ŒëŸ¬ê·¸ì¸ ê³µí†µ ì»´íŒŒì¼ í”Œë˜ê·¸
# -shared: ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±
# -fPIC: Position Independent Code (ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìˆ˜)
PLUGIN_CXXFLAGS := $(CXXFLAGS) -DBUILD_PLUGIN -shared -fPIC

# MQTT í”ŒëŸ¬ê·¸ì¸
mqtt-plugin: create-dirs
	@echo -e "$(CYAN)ğŸ“¦ Building MQTT plugin (.so)...$(NC)"
	@mkdir -p $(PLUGIN_DIR)
	@$(CXX) $(PLUGIN_CXXFLAGS) $(INCLUDES) \
		$(SRC_DIR)/Drivers/Mqtt/MqttDriver.cpp \
		$(SHARED_UTILS_SOURCES) \
		$(SHARED_SECURITY_SOURCES) \
		$(LIBS) -o $(PLUGIN_DIR)/MqttDriver.so

# BACnet í”ŒëŸ¬ê·¸ì¸
bacnet-plugin: create-dirs
	@echo -e "$(CYAN)ğŸ“¦ Building BACnet plugin (.so)...$(NC)"
	@mkdir -p $(PLUGIN_DIR)
	@$(CXX) $(PLUGIN_CXXFLAGS) $(INCLUDES) \
		$(SRC_DIR)/Drivers/Bacnet/BACnetDriver.cpp \
		$(SHARED_UTILS_SOURCES) \
		$(SHARED_SECURITY_SOURCES) \
		$(LIBS) -o $(PLUGIN_DIR)/BacnetDriver.so

# OPC-UA í”ŒëŸ¬ê·¸ì¸
opcua-plugin: create-dirs
	@echo -e "$(CYAN)ğŸ“¦ Building OPC-UA plugin (.so)...$(NC)"
	@mkdir -p $(PLUGIN_DIR)
	@$(CXX) $(PLUGIN_CXXFLAGS) $(INCLUDES) \
		$(SRC_DIR)/Drivers/OPCUA/OPCUADriver.cpp \
		$(SHARED_UTILS_SOURCES) \
		$(SHARED_SECURITY_SOURCES) \
		$(LIBS) -o $(PLUGIN_DIR)/OpcuaDriver.so

# Modbus í”ŒëŸ¬ê·¸ì¸
modbus-plugin: create-dirs
	@echo -e "$(CYAN)ğŸ“¦ Building Modbus plugin (.so)...$(NC)"
	@mkdir -p $(PLUGIN_DIR)
	@$(CXX) $(PLUGIN_CXXFLAGS) -DHAVE_MODBUS $(INCLUDES) \
		$(SRC_DIR)/Drivers/Modbus/ModbusDriver.cpp \
		$(SRC_DIR)/Drivers/Modbus/ModbusDiagnostics.cpp \
		$(SRC_DIR)/Drivers/Modbus/ModbusConnectionPool.cpp \
		$(SRC_DIR)/Drivers/Modbus/ModbusFailover.cpp \
		$(SRC_DIR)/Drivers/Modbus/ModbusPerformance.cpp \
		$(SHARED_UTILS_SOURCES) \
		$(LIBS) -lmodbus -o $(PLUGIN_DIR)/ModbusDriver.so

# BLE í”ŒëŸ¬ê·¸ì¸
ble-plugin: create-dirs
	@echo -e "$(CYAN)ğŸ“¦ Building BLE Beacon plugin (.so)...$(NC)"
	@mkdir -p $(PLUGIN_DIR)
	@$(CXX) $(PLUGIN_CXXFLAGS) $(INCLUDES) \
		$(SRC_DIR)/Drivers/Ble/BleBeaconDriver.cpp \
		$(SHARED_UTILS_SOURCES) \
		$(SHARED_SECURITY_SOURCES) \
		$(LIBS) -o $(PLUGIN_DIR)/BleBeaconDriver.so

plugins: mqtt-plugin bacnet-plugin opcua-plugin modbus-plugin
	@echo -e "$(GREEN)âœ… All plugins built successfully in $(PLUGIN_DIR)$(NC)"

# =============================================================================
# í–¥ìƒëœ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë¡œê·¸ í¬í•¨)
# =============================================================================

# Plugin Loading í…ŒìŠ¤íŠ¸ ë¹Œë“œ
plugin-test-build: create-dirs plugins $(BIN_DIR)/test_plugin_loading

# Plugin Loading í…ŒìŠ¤íŠ¸ ì‹¤í–‰
plugin-test: plugin-test-build
	$(eval LOG_FILE := $(call get_log_filename,plugin_loading))
	@echo -e "$(MAGENTA)ğŸš€ Running Plugin Loading Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Plugin Loading)
	@./$(BIN_DIR)/test_plugin_loading 2>&1 | tee $(LOG_FILE)
	$(call analyze_log,$(LOG_FILE),Plugin Loading)

# Step 1 í…ŒìŠ¤íŠ¸
step1-build: create-dirs $(BIN_DIR)/test_step1

step1-test: step1-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step1))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 1 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Configuration and Connection Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 1)
	@./$(BIN_DIR)/test_step1 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 1)
	@echo -e "$(GREEN)Step 1 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 2 í…ŒìŠ¤íŠ¸
step2-build: create-dirs $(BIN_DIR)/test_step2

step2-test: step2-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step2))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 2 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Database Entity Validation Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing Database-Entity mapping and CRUD operations$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 2)
	@./$(BIN_DIR)/test_step2 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 2)
	@echo -e "$(GREEN)Step 2 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 3 í…ŒìŠ¤íŠ¸
step3-build: create-dirs $(BIN_DIR)/test_step3

step3-test: step3-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step3))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 3 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Protocol Worker Property Validation Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing Worker creation and property mapping$(NC)"
	@echo -e "$(BLUE)Entity -> DeviceInfo -> Worker property validation$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 3)
	@./$(BIN_DIR)/test_step3 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 3)
	@echo -e "$(GREEN)Step 3 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 4 í…ŒìŠ¤íŠ¸
step4-build: create-dirs $(BIN_DIR)/test_step4

step4-test: step4-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step4))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 4 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Driver Data Validation Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing protocol drivers and data flow$(NC)"
	@echo -e "$(BLUE)Driver initialization and data validation$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 4)
	@./$(BIN_DIR)/test_step4 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 4)
	@echo -e "$(GREEN)Step 4 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 5 í…ŒìŠ¤íŠ¸
step5-build: create-dirs $(BIN_DIR)/test_step5

step5-test: step5-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step5))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 5 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Complete DB Integration Validation Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing complete end-to-end DB integration$(NC)"
	@echo -e "$(BLUE)DB alarm recovery â†’ Redis â†’ Backend validation$(NC)"
	@echo -e "$(BLUE)This test requires Redis server running$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 5)
	@PULSEONE_CONFIG_DIR=./config ./$(BIN_DIR)/test_step5 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 5)
	@echo -e "$(GREEN)Step 5 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 6 í…ŒìŠ¤íŠ¸ (ìƒˆë¡œìš´ RestAPI-WorkerManager í…ŒìŠ¤íŠ¸)
step6-build: create-dirs $(BIN_DIR)/test_step6

step6-test: step6-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step6))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 6 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)RestAPI â†’ WorkerManager Integration Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing RestAPI â†’ WorkerManager device reload flow$(NC)"
	@echo -e "$(BLUE)DB change â†’ API call â†’ Worker reload â†’ Redis update$(NC)"
	@echo -e "$(BLUE)This test requires Redis server running$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 6)
	@./$(BIN_DIR)/test_step6 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 6)
	@echo -e "$(GREEN)Step 6 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 6 Enhanced Pipeline í…ŒìŠ¤íŠ¸ (ê¸°ì¡´)
# Step 6 Enhanced Pipeline í…ŒìŠ¤íŠ¸ (ê¸°ì¡´)
step6-pipeline-build: create-dirs $(BIN_DIR)/test_step6_pipeline

$(OBJ_DIR)/test_step6_pipeline.o: test_step6_pipeline.cpp
	@mkdir -p $(dir $@)
	@echo -e "âš™ï¸ Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_step6_pipeline: $(OBJ_DIR)/test_step6_pipeline.o $(filter-out $(OBJ_DIR)/Main.o, $(ALL_OBJECTS)) $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 6 Pipeline Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(PLATFORM_LIBS) $(TEST_LIBS)
	@echo -e "$(GREEN)âœ… Step 6 Pipeline Test build completed!$(NC)"

step6-pipeline-test: step6-pipeline-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step6_pipeline))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 6 Enhanced Pipeline Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Enhanced Pipeline Test (Alarm + VirtualPoint)$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing alarm and virtual point pipeline$(NC)"
	@echo -e "$(BLUE)This test requires Redis server running$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 6 Pipeline)
	@./$(BIN_DIR)/test_step6_pipeline 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 6 Pipeline)
	@echo -e "$(GREEN)Step 6 Enhanced Pipeline Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 7 í…ŒìŠ¤íŠ¸ (ìƒˆë¡œìš´ ì™„ì „ í†µí•© í…ŒìŠ¤íŠ¸)
step7-build: create-dirs $(BIN_DIR)/test_step7

step7-test: step7-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step7))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 7 Complete Integration Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)REST API Backend Complete Integration Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
ifeq ($(HAS_CURL),1)
	@echo -e "$(BLUE)Testing complete API â†’ WorkerManager â†’ Hardware flow$(NC)"
	@echo -e "$(BLUE)DeviceApiCallbacks + HardwareApiCallbacks + WorkerManager$(NC)"
	@echo -e "$(BLUE)This test includes HTTP server on port 8081$(NC)"
	@echo -e "$(BLUE)No external dependencies required - fully self-contained$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 7)
	@./$(BIN_DIR)/test_step7 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 7)
	@echo -e "$(GREEN)Step 7 Complete Integration Test completed. Log saved: $(LOG_FILE)$(NC)"
else
	@echo -e "$(YELLOW)Step 7 requires libcurl - install with: apt install libcurl4-openssl-dev$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo "Step 7 skipped - libcurl not available" > $(LOG_FILE)
	@echo -e "$(YELLOW)Step 7 Complete Integration Test skipped. Log saved: $(LOG_FILE)$(NC)"
endif

# Step 8 í…ŒìŠ¤íŠ¸ (ë“œë¼ì´ë²„ ì—°ê²° ë° ë°ì´í„° í”Œë¡œìš°)
step8-build: create-dirs $(BIN_DIR)/test_step8

step8-test: step8-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step8))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 8 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Driver Reconnection and Data Pipeline Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing driver connectionìœ ì‹¤/ë³µêµ¬ ë° Redis íŒŒì´í”„ë¼ì¸$(NC)"
	@echo -e "$(BLUE)This test requires Redis server running$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 8)
	@./$(BIN_DIR)/test_step8 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 8)
	@echo -e "$(GREEN)Step 8 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 9 í…ŒìŠ¤íŠ¸
step9-build: create-dirs $(BIN_DIR)/test_step9

step9-test: step9-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step9))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 9 Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Scale and Multi-Protocol Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing system with multiple concurrent devices (TCP/RTU)$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 9)
	@./$(BIN_DIR)/test_step9 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 9)
	@echo -e "$(GREEN)Step 9 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 10 í…ŒìŠ¤íŠ¸
step10-build: create-dirs $(BIN_DIR)/test_step10

step10-test: step10-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step10))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 10 End-to-End Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)E2E Integration and Recovery Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing: Modbus -> Pipeline -> VP -> Alarm -> Recovery$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 10)
	@./$(BIN_DIR)/test_step10 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 10)
	@echo -e "$(GREEN)Step 10 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 11 í…ŒìŠ¤íŠ¸
step11-build: create-dirs $(BIN_DIR)/test_step11

step11-test: step11-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step11))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 11 Advanced Scenarios [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Advanced Alarm & Virtual Point Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing: Low Limit, Complex Script, VP Write$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 11)
	@./$(BIN_DIR)/test_step11 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 11)
	@echo -e "$(GREEN)Step 11 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Step 12 í…ŒìŠ¤íŠ¸
step12-build: create-dirs $(BIN_DIR)/test_step12

step12-test: step12-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step12))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 12 State Recovery & Storage [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Tiered State Recovery & Storage Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing: RDB Storage Differentiation, Warm Startup Recovery$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 12)
	@./$(BIN_DIR)/test_step12 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 12)
	@echo -e "$(GREEN)Step 12 Test completed. Log saved: $(LOG_FILE)$(NC)"

# Network í…ŒìŠ¤íŠ¸
network-build: create-dirs $(BIN_DIR)/test_network

network-test: network-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,network))
	@echo -e "$(MAGENTA)ğŸš€ Running Network Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)REST API Server Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing REST API server functionality$(NC)"
	@echo -e "$(BLUE)This test starts REST API server on port 8080$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Network)
	@./$(BIN_DIR)/test_network 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Network)
	@echo -e "$(GREEN)Network Test completed. Log saved: $(LOG_FILE)$(NC)"

# Platform í…ŒìŠ¤íŠ¸
platform-build: create-dirs $(BIN_DIR)/test_platform

platform-test: platform-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,platform))
	@echo -e "$(MAGENTA)ğŸš€ Running Platform Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Cross-Platform Compatibility Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Platform)
	@./$(BIN_DIR)/test_platform 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Platform)
	@echo -e "$(GREEN)Platform Test completed. Log saved: $(LOG_FILE)$(NC)"

# WorkerManager í…ŒìŠ¤íŠ¸
workermanager-build: create-dirs $(BIN_DIR)/test_workermanager

workermanager-test: workermanager-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,workermanager))
	@echo -e "$(MAGENTA)ğŸš€ Running WorkerManager Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)WorkerManager Singleton and Lifecycle Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),WorkerManager)
	@./$(BIN_DIR)/test_workermanager 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),WorkerManager)
	@echo -e "$(GREEN)WorkerManager Test completed. Log saved: $(LOG_FILE)$(NC)"

# =============================================================================
# ë¡œê·¸ ê´€ë¦¬ ìœ í‹¸ë¦¬í‹°
# =============================================================================

check-logs: create-log-dir
	@echo -e "$(BLUE)ğŸ“ Log Directory Status$(NC)"
	@echo -e "$(YELLOW)========================$(NC)"
	@echo "Log directory: $(LOG_DIR)"
	@echo "Total log files: $(shell find $(LOG_DIR) -name '*.log' 2>/dev/null | wc -l)"
	@echo ""
	@echo -e "$(CYAN)Recent log files:$(NC)"
	@ls -lt $(LOG_DIR)/*.log 2>/dev/null | head -10 || echo "No log files found"

logs-summary: create-log-dir
	@echo -e "$(BLUE)ğŸ“Š Latest Test Logs Summary$(NC)"
	@echo -e "$(YELLOW)=============================$(NC)"
	@for step in step1 step2 step3 step4 step5 step6 step6_pipeline step7 network platform workermanager; do \
		latest_log=$$(ls -t $(LOG_DIR)/$${step}_test_*.log 2>/dev/null | head -1); \
		if [ -n "$$latest_log" ]; then \
			echo -e "$(MAGENTA)$$step Test:$(NC)"; \
			echo "  File: $$latest_log"; \
			echo "  Size: $$(du -h $$latest_log | cut -f1)"; \
			echo "  Passed tests: $$(grep -c 'PASSED\|âœ…' $$latest_log 2>/dev/null || echo '0')"; \
			echo "  Failed tests: $$(grep -c 'FAILED\|âŒ' $$latest_log 2>/dev/null || echo '0')"; \
			echo ""; \
		fi; \
	done

clean-old-logs: create-log-dir
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning old log files (>7 days)...$(NC)"
	@find $(LOG_DIR) -name '*.log' -mtime +7 -delete 2>/dev/null || true
	@echo -e "$(GREEN)Old log files cleaned$(NC)"

clean-all-logs: create-log-dir
	@echo -e "$(RED)ğŸ—‘ï¸ Removing all log files...$(NC)"
	@rm -f $(LOG_DIR)/*.log 2>/dev/null || true
	@echo -e "$(GREEN)All log files removed$(NC)"

# =============================================================================
# í†µí•© ì‹¤í–‰
# =============================================================================

all-tests-build: create-dirs $(BIN_DIR)/test_step1 $(BIN_DIR)/test_step2 $(BIN_DIR)/test_step3 $(BIN_DIR)/test_step4 $(BIN_DIR)/test_step5 $(BIN_DIR)/test_step6 $(BIN_DIR)/test_step6_pipeline $(BIN_DIR)/test_step7 $(BIN_DIR)/test_network $(BIN_DIR)/test_platform $(BIN_DIR)/test_workermanager
	@echo -e "$(GREEN)âœ… All tests build completed for $(PLATFORM)!$(NC)"

all-tests-run: all-tests-build create-log-dir
	$(eval MASTER_LOG := $(LOG_DIR)/all_tests_$(TIMESTAMP).log)
	@echo -e "$(BLUE)ğŸš€ Running all tests with logging on $(PLATFORM)...$(NC)"
	@echo "Master log file: $(MASTER_LOG)"
	@echo "Individual test logs will be created in $(LOG_DIR)/"
	@echo ""
	@echo "========================================" > $(MASTER_LOG)
	@echo "All Tests Execution - $(PLATFORM)" >> $(MASTER_LOG)
	@echo "Started: $(shell date)" >> $(MASTER_LOG)
	@echo "Master Log: $(MASTER_LOG)" >> $(MASTER_LOG)
	@echo "========================================" >> $(MASTER_LOG)
	@echo ""
	@echo -e "$(YELLOW)Running tests in sequence...$(NC)"
	@$(MAKE) step1-test step2-test step3-test step4-test step5-test step6-test step7-test network-test platform-test workermanager-test
	@echo ""
	@echo "========================================" >> $(MASTER_LOG)
	@echo "All Tests Completed: $(shell date)" >> $(MASTER_LOG)
	@echo "========================================" >> $(MASTER_LOG)
	@echo -e "$(GREEN)ğŸ‰ All tests completed with logging!$(NC)"
	@echo -e "$(CYAN)Master log: $(MASTER_LOG)$(NC)"
	@$(MAKE) logs-summary

quick-test: workermanager-test platform-test step7-test
	@echo -e "$(GREEN)âœ… Quick test completed with logging$(NC)"

restapi-test: step6-test step7-test network-test
	@echo -e "$(GREEN)âœ… RestAPI integration tests completed$(NC)"

# =============================================================================
# ê¸°ì¡´ ìœ í‹¸ë¦¬í‹°ë“¤
# =============================================================================

clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning $(PLATFORM) build files...$(NC)"
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo -e "$(CYAN)Note: Log files preserved in $(LOG_DIR)/$(NC)"
	@echo -e "$(GREEN)âœ… Clean completed for $(PLATFORM)$(NC)"

clean-all: clean clean-all-logs
	@echo -e "$(GREEN)âœ… Complete clean (including logs) for $(PLATFORM)$(NC)"

status:
	@echo -e "$(BLUE)ğŸ—ï¸ Build Status for $(PLATFORM) (Enhanced Logging)$(NC)"
	@echo -e "$(YELLOW)================================================$(NC)"
	@echo "Platform: $(PLATFORM)"
	@echo "Windows: $(IS_WINDOWS), Linux: $(IS_LINUX)"
	@echo "Object files: $(words $(wildcard $(OBJ_DIR)/**/*.o)) / $(words $(ALL_OBJECTS))"
	@echo "Source files: $(words $(ALL_SOURCES))"
	@echo "Log directory: $(LOG_DIR)"
	@echo "Total log files: $(shell find $(LOG_DIR) -name '*.log' 2>/dev/null | wc -l)"
	@echo ""
	@echo "Library Support:"
	@echo "HTTP (httplib): $(if $(filter 1,$(HAS_HTTPLIB)),âœ… available,âŒ missing)"
	@echo "CURL: $(if $(filter 1,$(HAS_CURL)),âœ… available,âŒ missing)"
	@echo "JSON (nlohmann): $(if $(filter 1,$(HAS_NLOHMANN_JSON)),âœ… available,âŒ missing)"
	@echo "Redis (hiredis): $(if $(filter 1,$(HAS_HIREDIS)),âœ… available,âŒ missing)"
	@echo "MQTT C: $(if $(filter 1,$(HAS_MQTT_C)),âœ… available,âŒ missing)"
	@echo "MQTT C++: $(if $(filter 1,$(HAS_MQTT_CPP)),âœ… available,âŒ missing)"
	@echo "BACnet: $(if $(filter 1,$(HAS_BACNET_STACK)),âœ… available,âŒ missing)"
	@echo "QuickJS: $(if $(filter 1,$(HAS_QUICKJS)),âœ… available,âŒ missing)"
	@echo ""
	@echo "Binary Status:"
	@echo "Step 1: $(if $(wildcard $(BIN_DIR)/test_step1),âœ… exists,âŒ missing)"
	@echo "Step 2: $(if $(wildcard $(BIN_DIR)/test_step2),âœ… exists,âŒ missing)"
	@echo "Step 3: $(if $(wildcard $(BIN_DIR)/test_step3),âœ… exists,âŒ missing)"
	@echo "Step 4: $(if $(wildcard $(BIN_DIR)/test_step4),âœ… exists,âŒ missing)"
	@echo "Step 5: $(if $(wildcard $(BIN_DIR)/test_step5),âœ… exists,âŒ missing)"
	@echo "Step 6 RestAPI: $(if $(wildcard $(BIN_DIR)/test_step6),âœ… exists,âŒ missing)"
	@echo "Step 6 Pipeline: $(if $(wildcard $(BIN_DIR)/test_step6_pipeline),âœ… exists,âŒ missing)"
	@echo "Step 7 Complete: $(if $(wildcard $(BIN_DIR)/test_step7),âœ… exists,âŒ missing)"
	@echo "Network: $(if $(wildcard $(BIN_DIR)/test_network),âœ… exists,âŒ missing)"
	@echo "Platform: $(if $(wildcard $(BIN_DIR)/test_platform),âœ… exists,âŒ missing)"
	@echo "WorkerManager: $(if $(wildcard $(BIN_DIR)/test_workermanager),âœ… exists,âŒ missing)"
	@echo "Step 8: $(if $(wildcard $(BIN_DIR)/test_step8),âœ… exists,âŒ missing)"

debug-vars:
	@echo "SHARED_SRC_DIR: $(SHARED_SRC_DIR)"
	@echo "SHARED_LOGGING_SOURCES: $(SHARED_LOGGING_SOURCES)"
	@echo "SHARED_DATABASE_SOURCES: $(SHARED_DATABASE_SOURCES)"

help:
	@echo -e "$(BLUE)ğŸš€ PulseOne Enhanced Build System with Complete Step 7 Integration$(NC)"
	@echo -e "$(YELLOW)====================================================================$(NC)"
	@echo ""
	@echo -e "$(MAGENTA)ğŸ¯ Enhanced Features:$(NC)"
	@echo "  Current platform: $(PLATFORM)"
	@echo "  Auto-logging: All tests create timestamped log files"
	@echo "  Log directory: $(LOG_DIR)"
	@echo "  NEW: Step 7 Complete REST API Backend Integration Test"
	@echo "  CURL support: $(if $(filter 1,$(HAS_CURL)),âœ… enabled,âŒ disabled (install libcurl4-openssl-dev))"
	@echo ""
	@echo -e "$(GREEN)Step-by-Step Test Commands (with logging):$(NC)"
	@echo "  make step1-test   - Step 1: Configuration and connection test"
	@echo "  make step2-test   - Step 2: Database entity validation test"
	@echo "  make step3-test   - Step 3: Protocol worker property validation test"
	@echo "  make step4-test   - Step 4: Driver data validation test"
	@echo "  make step5-test   - Step 5: Complete DB integration validation test"
	@echo "  make step6-test   - Step 6: RestAPI â†’ WorkerManager integration test"
	@echo "  make step6-pipeline-test - Step 6: Enhanced alarm+virtualpoint pipeline test"
	@echo "  make step7-test   - Step 7: Complete REST API Backend Integration (NEW!)"
	@echo "  make network-test - Network: REST API server test"
	@echo "  make platform-test - Platform: Cross-platform compatibility test"
	@echo "  make workermanager-test - WorkerManager: Singleton and lifecycle test"
	@echo "  make step8-test   - Step 8: Driver reconnection and data pipeline test"
	@echo ""
	@echo -e "$(GREEN)Quick Build Commands:$(NC)"
	@echo "  make step1-build, step2-build, ..., step7-build"
	@echo "  make all-tests-build - Build all tests"
	@echo ""
	@echo -e "$(GREEN)Integrated Execution:$(NC)"
	@echo "  make all-tests-run - Run all tests with comprehensive logging"
	@echo "  make quick-test    - Run core tests (WorkerManager + Platform + Step7)"
	@echo "  make restapi-test  - Run RestAPI related tests (Step6 + Step7 + Network)"
	@echo ""
	@echo -e "$(CYAN)ğŸ—‚ï¸ Log Management:$(NC)"
	@echo "  make check-logs      - Check log directory status"
	@echo "  make logs-summary    - View summary of latest test logs"
	@echo "  make clean-old-logs  - Remove logs older than 7 days"
	@echo "  make clean-all-logs  - Remove all log files"
	@echo ""
	@echo -e "$(GREEN)Utility Commands:$(NC)"
	@echo "  make status       - Check build and log status"
	@echo "  make clean        - Clean build files (preserve logs)"
	@echo "  make clean-all    - Clean everything (including logs)"
	@echo "  make create-dirs  - Create all required directories"
	@echo ""
	@echo -e "$(CYAN)ğŸ’¡ Step 7 Complete REST API Backend Integration Features:$(NC)"
	@echo "  - Self-contained HTTP server (port 8081) - no external dependencies"
	@echo "  - DeviceApiCallbacks + HardwareApiCallbacks full integration"
	@echo "  - Worker lifecycle control (start/stop/pause/resume/restart)"
	@echo "  - Hardware control (digital/analog outputs, parameters)"
	@echo "  - System control APIs (stats, reload, reinitialization)"
	@echo "  - Concurrent request handling stress test"
	@echo "  - End-to-end integration flow validation"
	@echo "  - Comprehensive HTTP response validation"
	@echo ""
	@echo -e "$(YELLOW)ğŸ¯ Recommended Test Sequence:$(NC)"
	@echo "  1. make step7-test        - Most comprehensive test"
	@echo "  2. make restapi-test      - All REST API related tests"
	@echo "  3. make all-tests-run     - Complete system validation"
	@echo ""
	@echo -e "$(RED)âš ï¸ Dependencies for Step 7:$(NC)"
	@echo "  sudo apt install libcurl4-openssl-dev libgtest-dev nlohmann-json3-dev"

.PHONY: create-log-dir logs-summary check-logs clean-old-logs clean-all-logs \
        step1-test step2-test step3-test step4-test step5-test step6-test step6-pipeline-test step7-test step8-test step9-test \
        step10-test step11-test step12-test \
        network-test platform-test workermanager-test quick-test all-tests-run restapi-test \
        clean clean-all help status

# ìë™ ì¢…ì†ì„± ìƒì„±
-include $(ALL_OBJECTS:.o=.d) $(TEST_OBJECTS:.o=.d)

# Step 13 í…ŒìŠ¤íŠ¸
step13-build: create-dirs $(BIN_DIR)/test_step13

step13-test: step13-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step13))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 13 BACnet Discovery Verification [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)BACnet Discovery Persistence Test$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(BLUE)Testing: Discovery Callback -> RDB Persistence$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 13)
	@./$(BIN_DIR)/test_step13 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 13)
	@echo -e "$(GREEN)Step 13 Test completed. Log saved: $(LOG_FILE)$(NC)"

$(BIN_DIR)/test_step13: $(ALL_OBJECTS) $(OBJ_DIR)/test_step13_bacnet_discovery.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 13 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step13_bacnet_discovery.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Step 13 Test build completed!$(NC)"

$(OBJ_DIR)/test_step13_bacnet_discovery.o: test_step13_bacnet_discovery.cpp
	@mkdir -p $(OBJ_DIR)
	@echo -e "$(CYAN)ğŸ” Compiling Step 13 Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@
# Step 19: ROS Integration E2E Test
step19-e2e-build: create-dirs $(BIN_DIR)/test_step19_ros_e2e

$(OBJ_DIR)/test_step19_ros_e2e.o: test_step19_ros_e2e.cpp $(HEADERS)
	@echo -e "-e $(PURPLE)ğŸ”¨ Compiling Step 19 E2E Test...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c test_step19_ros_e2e.cpp -o $@

$(BIN_DIR)/test_step19_ros_e2e: $(OBJ_DIR)/test_step19_ros_e2e.o $(CORE_OBJECTS) $(OPCUA_C_OBJ) $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@echo -e "-e $(BLUE)ğŸ”— Linking Step 19 E2E Test [$(PLATFORM)]...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS) $(PLATFORM_LIBS) $(MODBUS_LIBS) $(MYSQL_LIBS) $(MQTT_CPP_LIBS) $(MQTT_C_LIBS) $(PGSQL_LIBS) $(BACNET_LIBS) $(REDIS_LIBS) $(QUICKJS_LIBS) $(CURL_LIBS) $(TEST_LIBS) -lsqlite3 -lbluetooth
	@echo -e "-e $(GREEN)âœ… Step 19 E2E Test build completed!$(NC)"

step19-e2e-test: step19-e2e-build create-log-dir
	@echo -e "-e $(CYAN)ğŸš€ Running Step 19 E2E Test (ROS Integration)...$(NC)"
	@$(BIN_DIR)/test_step19_ros_e2e > $(LOG_DIR)/step19_ros_e2e.log 2>&1 || (echo -e "-e $(RED)âŒ Step 19 Test Failed! Check logs at $(LOG_DIR)/step19_ros_e2e.log$(NC)"; cat $(LOG_DIR)/step19_ros_e2e.log; exit 1)
	@echo -e "-e $(GREEN)âœ… Step 19 Test Passed!$(NC)"

# =============================================================================
# Step 20: Dynamic ROS Mapping
# =============================================================================

step20-build: create-dirs $(BIN_DIR)/test_step20_ros_dynamic

$(OBJ_DIR)/test_step20_ros_dynamic.o: test_step20_ros_dynamic.cpp $(HEADERS)
	@echo -e "-e $(PURPLE)ğŸ”¨ Compiling Step 20 Test...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c test_step20_ros_dynamic.cpp -o $@

$(BIN_DIR)/test_step20_ros_dynamic: $(OBJ_DIR)/test_step20_ros_dynamic.o $(CORE_OBJECTS) $(OPCUA_C_OBJ) $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@echo -e "-e $(BLUE)ğŸ”— Linking Step 20 Test...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS) $(PLATFORM_LIBS) $(MODBUS_LIBS) $(MYSQL_LIBS) $(MQTT_CPP_LIBS) $(MQTT_C_LIBS) $(PGSQL_LIBS) $(BACNET_LIBS) $(REDIS_LIBS) $(QUICKJS_LIBS) $(CURL_LIBS) $(TEST_LIBS) -lsqlite3 -lbluetooth
	@echo -e "-e $(GREEN)âœ… Step 20 Test build completed!$(NC)"

step20-test: step20-build create-log-dir
	@echo -e "-e $(CYAN)ğŸš€ Running Step 20 Test (Dynamic ROS Topics)...$(NC)"
	@$(BIN_DIR)/test_step20_ros_dynamic > $(LOG_DIR)/step20_ros_dynamic.log 2>&1 || (echo -e "-e $(RED)âŒ Step 20 Test Failed! Check logs at $(LOG_DIR)/step20_ros_dynamic.log$(NC)"; cat $(LOG_DIR)/step20_ros_dynamic.log; exit 1)
	@echo -e "-e $(GREEN)âœ… Step 20 Test Passed!$(NC)"

# =============================================================================
# Step 21: ROS Recovery
# =============================================================================

step21-build: create-dirs $(BIN_DIR)/test_step21_ros_recovery

$(OBJ_DIR)/test_step21_ros_recovery.o: test_step21_ros_recovery.cpp $(HEADERS)
	@echo -e "-e $(PURPLE)ğŸ”¨ Compiling Step 21 Test...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c test_step21_ros_recovery.cpp -o $@

$(BIN_DIR)/test_step21_ros_recovery: $(OBJ_DIR)/test_step21_ros_recovery.o $(CORE_OBJECTS) $(OPCUA_C_OBJ) $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@echo -e "-e $(BLUE)ğŸ”— Linking Step 21 Test...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS) $(PLATFORM_LIBS) $(MODBUS_LIBS) $(MYSQL_LIBS) $(MQTT_CPP_LIBS) $(MQTT_C_LIBS) $(PGSQL_LIBS) $(BACNET_LIBS) $(REDIS_LIBS) $(QUICKJS_LIBS) $(CURL_LIBS) $(TEST_LIBS) -lsqlite3 -lbluetooth
	@echo -e "-e $(GREEN)âœ… Step 21 Test build completed!$(NC)"

step21-recovery: step21-build create-log-dir
	@echo -e "-e $(CYAN)ğŸš€ Running Step 21 Test (ROS Recovery)...$(NC)"
	@$(BIN_DIR)/test_step21_ros_recovery > $(LOG_DIR)/step21_ros_recovery.log 2>&1 || (echo -e "-e $(RED)âŒ Step 21 Test Failed! Check logs at $(LOG_DIR)/step21_ros_recovery.log$(NC)"; cat $(LOG_DIR)/step21_ros_recovery.log; exit 1)
	@echo -e "-e $(GREEN)âœ… Step 21 Test Passed!$(NC)"

# =============================================================================
# Step 22: Modbus String Address
# =============================================================================

step22-build: create-dirs $(BIN_DIR)/test_step22_modbus_string

$(OBJ_DIR)/test_step22_modbus_string.o: test_step22_modbus_string.cpp $(HEADERS)
	@echo -e "-e $(PURPLE)ğŸ”¨ Compiling Step 22 Test...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c test_step22_modbus_string.cpp -o $@

$(BIN_DIR)/test_step22_modbus_string: $(OBJ_DIR)/test_step22_modbus_string.o $(CORE_OBJECTS) $(OPCUA_C_OBJ) $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@echo -e "-e $(BLUE)ğŸ”— Linking Step 22 Test...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS) $(PLATFORM_LIBS) $(MODBUS_LIBS) $(MYSQL_LIBS) $(MQTT_CPP_LIBS) $(MQTT_C_LIBS) $(PGSQL_LIBS) $(BACNET_LIBS) $(REDIS_LIBS) $(QUICKJS_LIBS) $(CURL_LIBS) $(TEST_LIBS) -lsqlite3 -lbluetooth
	@echo -e "-e $(GREEN)âœ… Step 22 Test build completed!$(NC)"

step22-modbus-string: step22-build create-log-dir
	@echo -e "-e $(CYAN)ğŸš€ Running Step 22 Test (Modbus String Addresses)...$(NC)"
	@$(BIN_DIR)/test_step22_modbus_string > $(LOG_DIR)/step22_modbus_string.log 2>&1 || (echo -e "-e $(RED)âŒ Step 22 Test Failed! Check logs at $(LOG_DIR)/step22_modbus_string.log$(NC)"; cat $(LOG_DIR)/step22_modbus_string.log; exit 1)
	@echo -e "-e $(GREEN)âœ… Step 22 Test Passed!$(NC)"

# =============================================================================
# Step 23: Settings Reload & Redis Sync
# =============================================================================

step23-build: create-dirs $(BIN_DIR)/test_step23_settings_reload

$(OBJ_DIR)/test_step23_settings_reload.o: test_step23_settings_reload.cpp $(HEADERS)
	@echo -e "-e $(PURPLE)ğŸ”¨ Compiling Step 23 Test...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c test_step23_settings_reload.cpp -o $@

$(BIN_DIR)/test_step23_settings_reload: $(OBJ_DIR)/test_step23_settings_reload.o $(CORE_OBJECTS) $(OPCUA_C_OBJ) $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o
	@echo -e "-e $(BLUE)ğŸ”— Linking Step 23 Test...$(NC)"
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS) $(PLATFORM_LIBS) $(MODBUS_LIBS) $(MYSQL_LIBS) $(MQTT_CPP_LIBS) $(MQTT_C_LIBS) $(PGSQL_LIBS) $(BACNET_LIBS) $(REDIS_LIBS) $(QUICKJS_LIBS) $(CURL_LIBS) $(TEST_LIBS) -lsqlite3 -lbluetooth
	@echo -e "-e $(GREEN)âœ… Step 23 Test build completed!$(NC)"

step23-test: step23-build create-log-dir
	@echo -e "-e $(CYAN)ğŸš€ Running Step 23 Test (Settings Reload & Redis Sync)...$(NC)"
	@$(BIN_DIR)/test_step23_settings_reload > $(LOG_DIR)/step23_settings_reload.log 2>&1 || (echo -e "-e $(RED)âŒ Step 23 Test Failed! Check logs at $(LOG_DIR)/step23_settings_reload.log$(NC)"; cat $(LOG_DIR)/step23_settings_reload.log; exit 1)
	@echo -e "-e $(GREEN)âœ… Step 23 Test Passed!$(NC)"

# Step 24 Enhanced OPC UA Test
step24-opcua-build: create-dirs $(BIN_DIR)/test_step24_opcua_enhanced

$(OBJ_DIR)/test_step24_opcua_enhanced.o: test_step24_opcua_enhanced.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BIN_DIR)/test_step24_opcua_enhanced: $(ALL_OBJECTS) $(OBJ_DIR)/test_step24_opcua_enhanced.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o
	@mkdir -p $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Step 24 Enhanced OPC UA Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step24_opcua_enhanced.o $(OBJ_DIR)/Drivers/OPCUA/OPCUADriver.o $(OBJ_DIR)/Drivers/OPCUA/open62541.o $(OBJ_DIR)/Drivers/Bacnet/BACnetDriver.o $(OBJ_DIR)/Drivers/Mqtt/MqttDriver.o $(TEST_LIBS) $(LIBS) -lbluetooth -o $@
	@echo -e "$(GREEN)âœ… Step 24 Enhanced OPC UA Test build completed!$(NC)"

step24-test: step24-opcua-build create-log-dir
	$(eval LOG_FILE := $(call get_log_filename,step24_opcua))
	@echo -e "$(MAGENTA)ğŸš€ Running Step 24 Enhanced OPC UA Test [$(PLATFORM)]...$(NC)"
	$(call create_log_summary,$(LOG_FILE),Step 24 Enhanced OPC UA)
	@./$(BIN_DIR)/test_step24_opcua_enhanced 2>&1 | tee $(LOG_FILE)
	@echo -e "$(YELLOW)============================================$(NC)"
	$(call analyze_log,$(LOG_FILE),Step 24 Enhanced OPC UA)
	@echo -e "$(GREEN)Step 24 Enhanced OPC UA Test completed. Log saved: $(LOG_FILE)$(NC)"
# =============================================================================
