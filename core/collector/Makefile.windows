# =============================================================================
# PulseOne Collector - Windows í¬ë¡œìŠ¤ ì»´íŒŒì¼ Makefile (ìˆ˜ì •ë¨)
# =============================================================================

# ê¸°ë³¸ ì„¤ì •
CXX = x86_64-w64-mingw32-g++
CC = x86_64-w64-mingw32-gcc
CXXFLAGS = $(INCLUDES) -std=c++17 -Wall -Wextra -O0 -fPIC --param ggc-min-expand=0
CFLAGS = -Wall -O2 -DWIN32 -D_WIN32_WINNT=0x0A00
CXXFLAGS += -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DUNICODE -D_UNICODE
CXXFLAGS += -DHAS_MODBUS=1 -DHAS_MQTT=1 -DHAS_BACNET=1 -DHAS_QUICKJS=1 -DHAS_HTTPLIB=1 -DHAS_REDIS=1 -DHAS_JSON=1
CXXFLAGS += -DBACAPP_ALL -DBACAPP_REAL -DBACAPP_DOUBLE -DBACAPP_BOOLEAN -DBACAPP_UNSIGNED -DBACAPP_SIGNED -DBACAPP_ENUMERATED -DBACAPP_CHARACTER_STRING -DBACAPP_OBJECT_ID
CXXFLAGS += -DDBLIB_EXPORTS -DLOGLIB_EXPORTS

# ê²½ë¡œ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build-windows
BIN_DIR = bin-windows
MINGW_PREFIX = /usr/x86_64-w64-mingw32

# í¬í•¨ ê²½ë¡œ
CORE_ROOT = $(abspath $(CURDIR)/..)
SHARED_INCLUDE_DIR = $(CORE_ROOT)/shared/include
SHARED_MODULES_DIR = $(CORE_ROOT)/shared/modules
INCLUDES = -I$(SHARED_INCLUDE_DIR) \
           -I$(SHARED_INCLUDE_DIR)/Common \
           -I$(SHARED_INCLUDE_DIR)/Utils \
           -I$(SHARED_INCLUDE_DIR)/Platform \
           -I$(SHARED_INCLUDE_DIR)/Logging \
           -I$(SHARED_MODULES_DIR)/LogLib/include \
           -I$(SHARED_MODULES_DIR)/DbLib/include \
           -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Drivers/Modbus \
           -I$(INCLUDE_DIR)/Drivers/Bacnet \
           -I$(INCLUDE_DIR)/Drivers/OPCUA \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Storage \
           -I$(INCLUDE_DIR)/Client \
           -I$(MINGW_PREFIX)/include \
           -I$(SHARED_MODULES_DIR)/DbLib/include

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ
LDFLAGS = -L$(MINGW_PREFIX)/lib -static

# ğŸ”§ ìˆ˜ì •ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ìˆœì„œ (ì˜ì¡´ì„± ìˆœì„œëŒ€ë¡œ)
# ë†’ì€ ë ˆë²¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ â†’ ë‚®ì€ ë ˆë²¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìˆœì„œ
OPCUA_LIBS =
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libopen62541.a),)
    OPCUA_LIBS += -lopen62541
    PROTOCOL_LIBS += -lopen62541
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),)
    PROTOCOL_LIBS += -lmodbus
    CXXFLAGS += -DHAS_MODBUS=1
endif

# MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (ì˜¬ë°”ë¥¸ ìˆœì„œ)
MQTT_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),)
    MQTT_LIBS += -lpaho-mqttpp3-static
    CXXFLAGS += -DHAS_MQTT_CPP=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),)
    MQTT_LIBS += -lpaho-mqtt3a
    CXXFLAGS += -DHAS_MQTT_ASYNC=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),)
    MQTT_LIBS += -lpaho-mqtt3c
    CXXFLAGS += -DHAS_MQTT=1
endif

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬
BACNET_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),)
    BACNET_LIBS += -lbacnet
    CXXFLAGS += -DHAS_BACNET=1 -DHAS_BACNET_STACK=1
endif

# ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
OTHER_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libquickjs.a),)
    OTHER_LIBS += -lquickjs
    CXXFLAGS += -DHAVE_QUICKJS=1
endif

# httplib í—¤ë” íŒŒì¼ í™•ì¸ ë° ë§¤í¬ë¡œ ì •ì˜ ì¶”ê°€
ifneq ($(wildcard $(MINGW_PREFIX)/include/httplib.h),)
    CXXFLAGS += -DHAVE_HTTPLIB=1
endif

# ë°ì´í„°ë² ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬
DB_LIBS = -lsqlite3
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libhiredis.a),)
    DB_LIBS += -lhiredis
    CXXFLAGS += -DHAVE_REDIS=1
endif

# ğŸ”§ Windows ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì™„ì „í•œ ëª©ë¡)
WIN_LIBS = -lws2_32 -lwsock32 -liphlpapi -lrpcrt4 -luuid -lwinmm
WIN_LIBS += -lkernel32 -luser32 -ladvapi32 -lshell32 -lole32 -loleaut32
WIN_LIBS += -lcrypt32 -lsecur32 -lbcrypt -lncrypt -lodbc32 -lodbccp32 # Added ODBC for MSSQL

# ê¸°ë³¸ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬
SYS_LIBS = -lpthread -lstdc++ -lm -lgcc -lgcc_eh

# ğŸ”§ ì˜¬ë°”ë¥¸ ë§í‚¹ ìˆœì„œ (ì¤‘ìš”!)
# ì˜ì¡´ì„±ì´ ë†’ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¶€í„° ë‚®ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìˆœìœ¼ë¡œ
LIBS = $(PROTOCOL_LIBS) $(MQTT_LIBS) $(BACNET_LIBS) $(OTHER_LIBS) $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘
ALL_CPP_FILES = $(shell find $(SRC_DIR) -name "*.cpp")
SHARED_SRC_DIR = ../shared/src
SHARED_MODULE_DIR = ../shared/modules

# í•„ìš”í•œ ê³µìœ  ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘ (Database, Security, Logging, Utils, Client)
SHARED_SOURCES = $(SHARED_SRC_DIR)/Logging/LogManager.cpp \
                 $(SHARED_SRC_DIR)/Utils/ConfigManager.cpp \
                 $(SHARED_SRC_DIR)/Utils/RedisManager.cpp \
                 $(SHARED_SRC_DIR)/Security/SecretManager.cpp \
                 $(wildcard $(SHARED_SRC_DIR)/Database/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Database/Entities/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Database/Repositories/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Client/*.cpp) \
                 $(SHARED_SRC_DIR)/Event/EventSubscriber.cpp

SHARED_DBLIB_SOURCES = $(wildcard $(SHARED_MODULE_DIR)/DbLib/src/*.cpp)
SHARED_LOGLIB_SOURCES = $(wildcard $(SHARED_MODULE_DIR)/LogLib/src/*.cpp)

# ë“œë¼ì´ë²„ êµ¬í˜„ íŒŒì¼ ë° ê´€ë ¨ ì›Œì»¤ ì œì™¸ ëª©ë¡ (DLLë¡œ ë³„ë„ ë¹Œë“œë¨)
DRIVER_IMPLEMENTATIONS = $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Ros/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Ble/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/HttpRest/*.cpp) \
                         $(SRC_DIR)/Workers/Protocol/BACnetWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/BACnetDiscoveryService.cpp \
                         $(SRC_DIR)/Workers/Protocol/MQTTWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/OPCUAWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/ROSWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/BleBeaconWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/HttpRestWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/ModbusWorker.cpp

# í•„í„°ë§ ë¡œì§ (main.cpp ë° ê°œë³„ ë“œë¼ì´ë²„ DLL ì†ŒìŠ¤ ì œì™¸)
SOURCES = $(filter-out $(SRC_DIR)/main.cpp $(DRIVER_IMPLEMENTATIONS),$(ALL_CPP_FILES))
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# ê³µìœ  ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤ (ë””ë ‰í† ë¦¬ êµ¬ì¡° ìœ ì§€)
SHARED_OBJECTS = $(patsubst $(SHARED_SRC_DIR)/%.cpp,$(BUILD_DIR)/shared/%.o,$(SHARED_SOURCES))
DBLIB_OBJECTS = $(patsubst $(SHARED_MODULE_DIR)/DbLib/src/%.cpp,$(BUILD_DIR)/shared/modules/DbLib/%.o,$(SHARED_DBLIB_SOURCES))
LOGLIB_OBJECTS = $(patsubst $(SHARED_MODULE_DIR)/LogLib/src/%.cpp,$(BUILD_DIR)/shared/modules/LogLib/%.o,$(SHARED_LOGLIB_SOURCES))

ALL_CLEAN_SHARED_OBJECTS = $(SHARED_OBJECTS) $(DBLIB_OBJECTS) $(LOGLIB_OBJECTS)

MAIN_OBJECT = $(BUILD_DIR)/main.o

# íƒ€ê²Ÿ
TARGET = collector.exe
PLUGINS_DIR = $(BIN_DIR)/plugins

# ë“œë¼ì´ë²„ DLL ëª©ë¡
DRIVER_DLLS = $(PLUGINS_DIR)/modbus_driver.dll \
              $(PLUGINS_DIR)/bacnet_driver.dll \
              $(PLUGINS_DIR)/mqtt_driver.dll \
              $(PLUGINS_DIR)/opcua_driver.dll \
              $(PLUGINS_DIR)/ros_driver.dll \
              $(PLUGINS_DIR)/ble_driver.dll \
              $(PLUGINS_DIR)/httprest_driver.dll

# =============================================================================
# ë¹Œë“œ ê·œì¹™
# =============================================================================

.PHONY: all clean info check-libs rebuild plugins

# Import Library for EXE symbols (needed by DLLs on Windows)
IMPLIB = $(BIN_DIR)/libcollector.a

all: check-libs $(BIN_DIR)/$(TARGET) plugins

# ë“œë¼ì´ë²„ í”ŒëŸ¬ê·¸ì¸ ë¹Œë“œ (ê°œë³„ Makefile.windows í˜¸ì¶œ)
plugins: $(BIN_DIR)/$(TARGET)
	@echo "ğŸ”¨ Building Windows Driver Plugins..."
	@$(MAKE) -C src/Drivers/Modbus -f Makefile.windows
	@$(MAKE) -C src/Drivers/Bacnet -f Makefile.windows
	@$(MAKE) -C src/Drivers/OPCUA -f Makefile.windows
	@$(MAKE) -C src/Drivers/Mqtt -f Makefile.windows
	@$(MAKE) -C src/Drivers/Ble -f Makefile.windows
	@$(MAKE) -C src/Drivers/HttpRest -f Makefile.windows
	@$(MAKE) -C src/Drivers/Ros -f Makefile.windows
	@echo "âœ… Windows Driver Plugins built successfully!"

$(PLUGINS_DIR):
	@mkdir -p $(PLUGINS_DIR)

# (Individual driver DLL rules removed, now handled by sub-Makefiles)

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¡´ì¬ í™•ì¸
check-libs:
	@echo "ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸..."
	@echo "libmodbus: $(if $(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),âœ…,âŒ)"
	@echo "libpaho-mqtt3c: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),âœ…,âŒ)"
	@echo "libpaho-mqtt3a: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),âœ…,âŒ)"
	@echo "libpaho-mqttpp3-static: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),âœ…,âŒ)"
	@echo "libbacnet: $(if $(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),âœ…,âŒ)"
	@echo "libsqlite3: $(if $(wildcard $(MINGW_PREFIX)/lib/libsqlite3.a),âœ…,âŒ)"
	@echo ""

# ë©”ì¸ íƒ€ê²Ÿ
$(BIN_DIR)/$(TARGET): $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) | $(BIN_DIR)
	@echo "ğŸ”— Linking $(BIN_DIR)/$(TARGET)..."
	@echo "Link command:"
	echo "$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) $(DB_LIBS) $(OTHER_LIBS) $(WIN_LIBS) $(SYS_LIBS)"
	$(CXX) $(LDFLAGS) -Wl,--out-implib,$(IMPLIB) -Wl,--export-all-symbols -o $@ $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) $(DB_LIBS) $(OTHER_LIBS) $(WIN_LIBS) $(SYS_LIBS)
	@echo "âœ… Build completed: $@"
	@echo "File size: $$(du -h $@ | cut -f1)"

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„± (ë””ë ‰í† ë¦¬ë³„) - Drivers ë¦¬ì„œì¹˜ ì½”ë“œ ì œì™¸
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ê³µìœ  ì†ŒìŠ¤ ì»´íŒŒì¼ ê·œì¹™
$(BUILD_DIR)/shared/%.o: $(SHARED_SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling shared source $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ê³µìœ  ëª¨ë“ˆ ì»´íŒŒì¼ ê·œì¹™
$(BUILD_DIR)/shared/modules/DbLib/%.o: $(SHARED_MODULE_DIR)/DbLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling shared module DbLib $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/shared/modules/LogLib/%.o: $(SHARED_MODULE_DIR)/LogLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling shared module LogLib $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/shared/Security/%.o: $(SHARED_SRC_DIR)/Security/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling shared security $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# ì •ë³´ ì¶œë ¥
info:
	@echo "=== PulseOne Windows Build Configuration ==="
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Libraries: $(LIBS)"
	@echo "Source files: $(words $(ALL_CPP_FILES))"
	@echo "Object files: $(words $(OBJECTS))"

# ì²­ì†Œ
clean:
	@echo "ğŸ§¹ Cleaning..."
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "âœ… Clean completed"

# ì™„ì „ ì¬ë¹Œë“œ
rebuild: clean all

# ë””ë²„ê·¸ ì •ë³´
debug-libs:
	@echo "Protocol libs: $(PROTOCOL_LIBS)"
	@echo "MQTT libs: $(MQTT_LIBS)"
	@echo "BACnet libs: $(BACNET_LIBS)"
	@echo "DB libs: $(DB_LIBS)"
	@echo "Windows libs: $(WIN_LIBS)"
	@echo "System libs: $(SYS_LIBS)"
	@echo ""
	@echo "Final LIBS: $(LIBS)"

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸
check-symbols:
	@echo "ğŸ” MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸..."
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3c.a" ]; then \
		echo "libpaho-mqtt3c.a ì‹¬ë³¼:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3a.a" ]; then \
		echo "libpaho-mqtt3a.a ì‹¬ë³¼:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi