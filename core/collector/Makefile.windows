# =============================================================================
# PulseOne Collector - Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº Makefile (ÏàòÏ†ïÎê®)
# =============================================================================

# Í∏∞Î≥∏ ÏÑ§Ï†ï
CXX = x86_64-w64-mingw32-g++
CC = x86_64-w64-mingw32-gcc
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -DWIN32 -D_WIN32_WINNT=0x0601
CFLAGS = -Wall -O2 -DWIN32 -D_WIN32_WINNT=0x0601
CXXFLAGS += -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DUNICODE -D_UNICODE
CXXFLAGS += -DHAVE_MODBUS=1 -DHAVE_MQTT=1 -DHAVE_BACNET=1 -DHAVE_QUICKJS=1 -DHAVE_HTTPLIB=1 -DHAVE_REDIS=1 -DHAVE_JSON=1
CXXFLAGS += -DBACAPP_ALL -DBACAPP_REAL -DBACAPP_DOUBLE -DBACAPP_BOOLEAN -DBACAPP_UNSIGNED -DBACAPP_SIGNED -DBACAPP_ENUMERATED -DBACAPP_CHARACTER_STRING -DBACAPP_OBJECT_ID
CXXFLAGS += -DDBLIB_EXPORTS -DLOGLIB_EXPORTS

# Í≤ΩÎ°ú ÏÑ§Ï†ï
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build-windows
BIN_DIR = bin-windows
MINGW_PREFIX = /usr/x86_64-w64-mingw32

# Ìè¨Ìï® Í≤ΩÎ°ú
CORE_ROOT = $(abspath $(CURDIR)/..)
SHARED_INCLUDE_DIR = $(CORE_ROOT)/shared/include
SHARED_MODULES_DIR = $(CORE_ROOT)/shared/modules
INCLUDES = -I$(SHARED_INCLUDE_DIR) \
           -I$(SHARED_INCLUDE_DIR)/Common \
           -I$(SHARED_INCLUDE_DIR)/Utils \
           -I$(SHARED_INCLUDE_DIR)/Platform \
           -I$(SHARED_INCLUDE_DIR)/Logging \
           -I$(SHARED_MODULES_DIR)/LogLib/include \
           -I$(SHARED_MODULES_DIR)/DbLib/include \
           -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Drivers/Modbus \
           -I$(INCLUDE_DIR)/Drivers/Bacnet \
           -I$(INCLUDE_DIR)/Drivers/OPCUA \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Storage \
           -I$(INCLUDE_DIR)/Client \
           -I$(MINGW_PREFIX)/include

# ÎùºÏù¥Î∏åÎü¨Î¶¨ Í≤ΩÎ°ú
LDFLAGS = -L$(MINGW_PREFIX)/lib -static

# üîß ÏàòÏ†ïÎêú ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎßÅÌÇπ ÏàúÏÑú (ÏùòÏ°¥ÏÑ± ÏàúÏÑúÎåÄÎ°ú)
# ÎÜíÏùÄ Î†àÎ≤® ÎùºÏù¥Î∏åÎü¨Î¶¨ ‚Üí ÎÇÆÏùÄ Î†àÎ≤® ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏàúÏÑú
OPCUA_LIBS =
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libopen62541.a),)
    OPCUA_LIBS += -lopen62541
    PROTOCOL_LIBS += -lopen62541
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),)
    PROTOCOL_LIBS += -lmodbus
    CXXFLAGS += -DHAVE_MODBUS=1
endif

# MQTT ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§ (Ïò¨Î∞îÎ•∏ ÏàúÏÑú)
MQTT_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),)
    MQTT_LIBS += -lpaho-mqttpp3-static
    CXXFLAGS += -DHAVE_MQTT_CPP=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),)
    MQTT_LIBS += -lpaho-mqtt3a
    CXXFLAGS += -DHAVE_MQTT_ASYNC=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),)
    MQTT_LIBS += -lpaho-mqtt3c
    CXXFLAGS += -DHAVE_MQTT=1
endif

# BACnet ÎùºÏù¥Î∏åÎü¨Î¶¨
BACNET_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),)
    BACNET_LIBS += -lbacnet
    CXXFLAGS += -DHAVE_BACNET=1
endif

# Í∏∞ÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§
OTHER_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libquickjs.a),)
    OTHER_LIBS += -lquickjs
    CXXFLAGS += -DHAVE_QUICKJS=1
endif

# httplib Ìó§Îçî ÌååÏùº ÌôïÏù∏ Î∞è Îß§ÌÅ¨Î°ú Ï†ïÏùò Ï∂îÍ∞Ä
ifneq ($(wildcard $(MINGW_PREFIX)/include/httplib.h),)
    CXXFLAGS += -DHAVE_HTTPLIB=1
endif

# Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎùºÏù¥Î∏åÎü¨Î¶¨
DB_LIBS = -lsqlite3
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libhiredis.a),)
    DB_LIBS += -lhiredis
    CXXFLAGS += -DHAVE_REDIS=1
endif

# üîß Windows ÏãúÏä§ÌÖú ÎùºÏù¥Î∏åÎü¨Î¶¨ (ÏôÑÏ†ÑÌïú Î™©Î°ù)
WIN_LIBS = -lws2_32 -lwsock32 -liphlpapi -lrpcrt4 -luuid -lwinmm
WIN_LIBS += -lkernel32 -luser32 -ladvapi32 -lshell32 -lole32 -loleaut32
WIN_LIBS += -lcrypt32 -lsecur32 -lbcrypt -lncrypt -lodbc32 -lodbccp32 # Added ODBC for MSSQL

# Í∏∞Î≥∏ ÏãúÏä§ÌÖú ÎùºÏù¥Î∏åÎü¨Î¶¨
SYS_LIBS = -lpthread -lstdc++ -lm -lgcc -lgcc_eh

# üîß Ïò¨Î∞îÎ•∏ ÎßÅÌÇπ ÏàúÏÑú (Ï§ëÏöî!)
# ÏùòÏ°¥ÏÑ±Ïù¥ ÎÜíÏùÄ ÎùºÏù¥Î∏åÎü¨Î¶¨Î∂ÄÌÑ∞ ÎÇÆÏùÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏàúÏúºÎ°ú
LIBS = $(PROTOCOL_LIBS) $(MQTT_LIBS) $(BACNET_LIBS) $(OTHER_LIBS) $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# ÏÜåÏä§ ÌååÏùº ÏàòÏßë
ALL_CPP_FILES = $(shell find $(SRC_DIR) -name "*.cpp")
SHARED_SRC_DIR = ../shared/src
SHARED_MODULE_DIR = ../shared/modules

# ÌïÑÏöîÌïú Í≥µÏú† ÏÜåÏä§ ÌååÏùº ÏàòÏßë (Database, Security, Logging, Utils, Client)
SHARED_SOURCES = $(SHARED_SRC_DIR)/Logging/LogManager.cpp \
                 $(SHARED_SRC_DIR)/Utils/ConfigManager.cpp \
                 $(SHARED_SRC_DIR)/Utils/RedisManager.cpp \
                 $(SHARED_SRC_DIR)/Security/SecretManager.cpp \
                 $(wildcard $(SHARED_SRC_DIR)/Database/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Database/Entities/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Database/Repositories/*.cpp) \
                 $(wildcard $(SHARED_SRC_DIR)/Client/*.cpp)

SHARED_DBLIB_SOURCES = $(wildcard $(SHARED_MODULE_DIR)/DbLib/src/*.cpp)
SHARED_LOGLIB_SOURCES = $(wildcard $(SHARED_MODULE_DIR)/LogLib/src/*.cpp)

# ÎìúÎùºÏù¥Î≤Ñ Íµ¨ÌòÑ ÌååÏùº Î∞è Í¥ÄÎ†® ÏõåÏª§ Ï†úÏô∏ Î™©Î°ù (DLLÎ°ú Î≥ÑÎèÑ ÎπåÎìúÎê®)
DRIVER_IMPLEMENTATIONS = $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Ros/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/Ble/*.cpp) \
                         $(wildcard $(SRC_DIR)/Drivers/HttpRest/*.cpp) \
                         $(SRC_DIR)/Workers/Protocol/BACnetWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/BACnetDiscoveryService.cpp \
                         $(SRC_DIR)/Workers/Protocol/MQTTWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/OPCUAWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/ROSWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/BleBeaconWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/HttpRestWorker.cpp \
                         $(SRC_DIR)/Workers/Protocol/ModbusWorker.cpp

# ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ (main.cpp Î∞è Í∞úÎ≥Ñ ÎìúÎùºÏù¥Î≤Ñ DLL ÏÜåÏä§ Ï†úÏô∏)
SOURCES = $(filter-out $(SRC_DIR)/main.cpp $(DRIVER_IMPLEMENTATIONS),$(ALL_CPP_FILES))
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùºÎì§
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# Í≥µÏú† Ïò§Î∏åÏ†ùÌä∏ ÌååÏùºÎì§ (ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ Ïú†ÏßÄ)
SHARED_OBJECTS = $(patsubst $(SHARED_SRC_DIR)/%.cpp,$(BUILD_DIR)/shared/%.o,$(SHARED_SOURCES))
DBLIB_OBJECTS = $(patsubst $(SHARED_MODULE_DIR)/DbLib/src/%.cpp,$(BUILD_DIR)/shared/modules/DbLib/%.o,$(SHARED_DBLIB_SOURCES))
LOGLIB_OBJECTS = $(patsubst $(SHARED_MODULE_DIR)/LogLib/src/%.cpp,$(BUILD_DIR)/shared/modules/LogLib/%.o,$(SHARED_LOGLIB_SOURCES))

ALL_CLEAN_SHARED_OBJECTS = $(SHARED_OBJECTS) $(DBLIB_OBJECTS) $(LOGLIB_OBJECTS)

MAIN_OBJECT = $(BUILD_DIR)/main.o

# ÌÉÄÍ≤ü
TARGET = collector.exe
PLUGINS_DIR = $(BIN_DIR)/plugins

# ÎìúÎùºÏù¥Î≤Ñ DLL Î™©Î°ù
DRIVER_DLLS = $(PLUGINS_DIR)/modbus_driver.dll \
              $(PLUGINS_DIR)/bacnet_driver.dll \
              $(PLUGINS_DIR)/mqtt_driver.dll \
              $(PLUGINS_DIR)/opcua_driver.dll \
              $(PLUGINS_DIR)/ros_driver.dll \
              $(PLUGINS_DIR)/ble_driver.dll \
              $(PLUGINS_DIR)/httprest_driver.dll

# =============================================================================
# ÎπåÎìú Í∑úÏπô
# =============================================================================

.PHONY: all clean info check-libs rebuild plugins

# Import Library for EXE symbols (needed by DLLs on Windows)
IMPLIB = $(BIN_DIR)/libcollector.a

all: check-libs $(BIN_DIR)/$(TARGET) plugins

# ÎìúÎùºÏù¥Î≤Ñ ÌîåÎü¨Í∑∏Ïù∏ ÎπåÎìú (EXEÍ∞Ä ÏôÑÏ†ÑÌûà ÎßÅÌÅ¨Îêú Îí§ÏóêÎßå Ïã§ÌñâÎêòÎèÑÎ°ù Í∞ïÏ†ú)
plugins:
	$(MAKE) -f Makefile.windows $(BIN_DIR)/$(TARGET)
	$(MAKE) -f Makefile.windows $(PLUGINS_DIR) $(DRIVER_DLLS)

$(PLUGINS_DIR):
	@mkdir -p $(PLUGINS_DIR)

# 1. Modbus Driver DLL
MODBUS_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
$(PLUGINS_DIR)/modbus_driver.dll: $(MODBUS_DRV_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building Modbus DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ -lmodbus $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# 2. BACnet Driver DLL
BACNET_STACK_DIR = $(MINGW_PREFIX)/include/bacnet
BACNET_DRV_CPP_SOURCES = $(SRC_DIR)/Drivers/Bacnet/BACnetDriver.cpp \
                         $(SRC_DIR)/Drivers/Bacnet/BACnetBIPPort.cpp \
                         $(SRC_DIR)/Drivers/Bacnet/BACnetServiceManager.cpp \
                         $(SRC_DIR)/Drivers/Bacnet/BACnetStubs.cpp

# Detailed list of BACnet stack core files to ensure macro consistency
BACNET_DRV_C_SOURCES = $(BACNET_STACK_DIR)/basic/service/h_apdu.c \
                       $(BACNET_STACK_DIR)/basic/npdu/h_npdu.c \
                       $(BACNET_STACK_DIR)/basic/service/h_iam.c \
                       $(BACNET_STACK_DIR)/basic/service/s_rp.c \
                       $(BACNET_STACK_DIR)/basic/tsm/tsm.c \
                       $(BACNET_STACK_DIR)/npdu.c \
                       $(BACNET_STACK_DIR)/rp.c \
                       $(BACNET_STACK_DIR)/wp.c \
                       $(BACNET_STACK_DIR)/bacdcode.c \
                       $(BACNET_STACK_DIR)/bacapp.c \
                       $(BACNET_STACK_DIR)/bacstr.c \
                       $(BACNET_STACK_DIR)/bactext.c \
                       $(BACNET_STACK_DIR)/datetime.c \
                       $(BACNET_STACK_DIR)/indtext.c \
                       $(BACNET_STACK_DIR)/bacint.c \
                       $(BACNET_STACK_DIR)/bacreal.c \
                       $(BACNET_STACK_DIR)/bacerror.c \
                       $(BACNET_STACK_DIR)/bacprop.c \
                       $(BACNET_STACK_DIR)/bactimevalue.c \
                       $(BACNET_STACK_DIR)/bacaddr.c \
                       $(BACNET_STACK_DIR)/basic/sys/days.c \
                       $(BACNET_STACK_DIR)/basic/binding/address.c

# Compilation flags for C files
BACNET_DEFS = -DBACNET_STACK_USE_TSM=1 -DHAVE_BACNET_STACK=1 -DMAX_TSM_TRANSACTIONS=255 \
              -DBACAPP_ALL -DBACAPP_REAL -DBACAPP_DOUBLE -DBACAPP_BOOLEAN -DBACAPP_UNSIGNED \
              -DBACAPP_SIGNED -DBACAPP_ENUMERATED -DBACAPP_CHARACTER_STRING -DBACAPP_OBJECT_ID \
              -DBACAPP_BIT_STRING -DBACAPP_OCTET_STRING -DBACAPP_TIME -DBACAPP_DATE -DBACAPP_DATETIME \
              -DBACNET_USE_SIGNED=1 -DBACNET_USE_DOUBLE=1 -DBACNET_USE_OCTETSTRING=1 \
              -DBACNET_SVC_RP_A=1 -DBACNET_SVC_RP_B=1 -DBACNET_SVC_WP_A=1 -DBACNET_SVC_WP_B=1 \
              -DBACNET_SVC_RPM_A=1 -DBACNET_SVC_RPM_B=1 \
              -DBAC_ROUTING=0 -DHAVE_IPPORT=1

BACNET_C_FLAGS = $(CFLAGS) -include stdio.h -I$(BACNET_STACK_DIR)/basic/service -I$(BACNET_STACK_DIR)/basic/tsm $(BACNET_DEFS)

$(PLUGINS_DIR)/bacnet_driver.dll: $(BACNET_DRV_CPP_SOURCES) $(BACNET_DRV_C_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building BACnet DLL (Mixed C/C++)..."
	@mkdir -p build-windows/bacnet_objs
	@for f in $(BACNET_DRV_C_SOURCES); do \
		echo "  CC  $$f"; \
		$(CC) $(BACNET_C_FLAGS) $(INCLUDES) -c $$f -o build-windows/bacnet_objs/$$(basename $$f .c).o; \
	done
	@for f in $(BACNET_DRV_CPP_SOURCES); do \
		echo "  CXX $$f"; \
		$(CXX) $(CXXFLAGS) -fpermissive $(INCLUDES) -include src/Drivers/Bacnet/bacnet_minmax_fix.h \
			-I$(BACNET_STACK_DIR)/basic/service -I$(BACNET_STACK_DIR)/basic/tsm \
			$(BACNET_DEFS) \
			-c $$f -o build-windows/bacnet_objs/$$(basename $$f .cpp).o; \
	done
	$(CXX) -shared build-windows/bacnet_objs/*.o $(ALL_CLEAN_SHARED_OBJECTS) \
		$(IMPLIB) -o $@ $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS) -lbacnet

# 3. MQTT Driver DLL
MQTT_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
$(PLUGINS_DIR)/mqtt_driver.dll: $(MQTT_DRV_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building MQTT DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ $(MQTT_LIBS) $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# 4. OPCUA Driver DLL
OPCUA_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/OPCUA/*.cpp)
OPCUA_C_OBJECTS = $(BUILD_DIR)/Drivers/OPCUA/open62541.o

$(OPCUA_C_OBJECTS): $(SRC_DIR)/Drivers/OPCUA/open62541.c
	@mkdir -p $(@D)
	@echo "üî® Compiling OPCUA C source..."
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

$(PLUGINS_DIR)/opcua_driver.dll: $(OPCUA_DRV_SOURCES) $(OPCUA_C_OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building OPCUA DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# 5. ROS Driver DLL
ROS_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Ros/*.cpp)
$(PLUGINS_DIR)/ros_driver.dll: $(ROS_DRV_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building ROS DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# 6. BLE Driver DLL
BLE_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Ble/*.cpp)
$(PLUGINS_DIR)/ble_driver.dll: $(BLE_DRV_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building BLE DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# 7. HttpRest Driver DLL
HTTPREST_DRV_SOURCES = $(wildcard $(SRC_DIR)/Drivers/HttpRest/*.cpp)
$(PLUGINS_DIR)/httprest_driver.dll: $(HTTPREST_DRV_SOURCES) $(ALL_CLEAN_SHARED_OBJECTS) | $(PLUGINS_DIR)
	@echo "üî® Building HttpRest DLL..."
	$(CXX) $(CXXFLAGS) -shared $(INCLUDES) $^ $(IMPLIB) -o $@ $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# ÎùºÏù¥Î∏åÎü¨Î¶¨ Ï°¥Ïû¨ ÌôïÏù∏
check-libs:
	@echo "üîç ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôïÏù∏..."
	@echo "libmodbus: $(if $(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),‚úÖ,‚ùå)"
	@echo "libpaho-mqtt3c: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),‚úÖ,‚ùå)"
	@echo "libpaho-mqtt3a: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),‚úÖ,‚ùå)"
	@echo "libpaho-mqttpp3-static: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),‚úÖ,‚ùå)"
	@echo "libbacnet: $(if $(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),‚úÖ,‚ùå)"
	@echo "libsqlite3: $(if $(wildcard $(MINGW_PREFIX)/lib/libsqlite3.a),‚úÖ,‚ùå)"
	@echo ""

# Î©îÏù∏ ÌÉÄÍ≤ü
$(BIN_DIR)/$(TARGET): $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) | $(BIN_DIR)
	@echo "üîó Linking $(BIN_DIR)/$(TARGET)..."
	@echo "Link command:"
	echo "$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) $(DB_LIBS) $(OTHER_LIBS) $(WIN_LIBS) $(SYS_LIBS)"
	$(CXX) $(LDFLAGS) -Wl,--out-implib,$(IMPLIB) -Wl,--export-all-symbols -o $@ $(OBJECTS) $(ALL_CLEAN_SHARED_OBJECTS) $(MAIN_OBJECT) $(DB_LIBS) $(OTHER_LIBS) $(WIN_LIBS) $(SYS_LIBS)
	@echo "‚úÖ Build completed: $@"
	@echo "File size: $$(du -h $@ | cut -f1)"

# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº ÏÉùÏÑ± (ÎîîÎ†âÌÜ†Î¶¨Î≥Ñ) - Drivers Î¶¨ÏÑúÏπò ÏΩîÎìú Ï†úÏô∏
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "üî® Compiling $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Í≥µÏú† ÏÜåÏä§ Ïª¥ÌååÏùº Í∑úÏπô
$(BUILD_DIR)/shared/%.o: $(SHARED_SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "üî® Compiling shared source $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Í≥µÏú† Î™®Îìà Ïª¥ÌååÏùº Í∑úÏπô
$(BUILD_DIR)/shared/modules/DbLib/%.o: $(SHARED_MODULE_DIR)/DbLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "üî® Compiling shared module DbLib $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/shared/modules/LogLib/%.o: $(SHARED_MODULE_DIR)/LogLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "üî® Compiling shared module LogLib $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/shared/Security/%.o: $(SHARED_SRC_DIR)/Security/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "üî® Compiling shared security $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# Ï†ïÎ≥¥ Ï∂úÎ†•
info:
	@echo "=== PulseOne Windows Build Configuration ==="
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Libraries: $(LIBS)"
	@echo "Source files: $(words $(ALL_CPP_FILES))"
	@echo "Object files: $(words $(OBJECTS))"

# Ï≤≠ÏÜå
clean:
	@echo "üßπ Cleaning..."
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "‚úÖ Clean completed"

# ÏôÑÏ†Ñ Ïû¨ÎπåÎìú
rebuild: clean all

# ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥
debug-libs:
	@echo "Protocol libs: $(PROTOCOL_LIBS)"
	@echo "MQTT libs: $(MQTT_LIBS)"
	@echo "BACnet libs: $(BACNET_LIBS)"
	@echo "DB libs: $(DB_LIBS)"
	@echo "Windows libs: $(WIN_LIBS)"
	@echo "System libs: $(SYS_LIBS)"
	@echo ""
	@echo "Final LIBS: $(LIBS)"

# ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïã¨Î≥º ÌôïÏù∏
check-symbols:
	@echo "üîç MQTT ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïã¨Î≥º ÌôïÏù∏..."
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3c.a" ]; then \
		echo "libpaho-mqtt3c.a Ïã¨Î≥º:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3a.a" ]; then \
		echo "libpaho-mqtt3a.a Ïã¨Î≥º:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi