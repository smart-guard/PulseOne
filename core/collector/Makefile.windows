# =============================================================================
# PulseOne Collector - Windows í¬ë¡œìŠ¤ ì»´íŒŒì¼ Makefile (ìˆ˜ì •ë¨)
# =============================================================================

# ê¸°ë³¸ ì„¤ì •
CXX = x86_64-w64-mingw32-g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -DWIN32 -D_WIN32_WINNT=0x0601
CXXFLAGS += -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DUNICODE -D_UNICODE

# ê²½ë¡œ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build-windows
BIN_DIR = bin-windows
MINGW_PREFIX = /usr/x86_64-w64-mingw32

# í¬í•¨ ê²½ë¡œ
INCLUDES = -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Storage \
           -I$(INCLUDE_DIR)/Client \
           -I$(MINGW_PREFIX)/include

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ
LDFLAGS = -L$(MINGW_PREFIX)/lib -static

# ğŸ”§ ìˆ˜ì •ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ìˆœì„œ (ì˜ì¡´ì„± ìˆœì„œëŒ€ë¡œ)
# ë†’ì€ ë ˆë²¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ â†’ ë‚®ì€ ë ˆë²¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìˆœì„œ
PROTOCOL_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),)
    PROTOCOL_LIBS += -lmodbus
    CXXFLAGS += -DHAVE_MODBUS=1
endif

# MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (ì˜¬ë°”ë¥¸ ìˆœì„œ)
MQTT_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),)
    MQTT_LIBS += -lpaho-mqttpp3-static
    CXXFLAGS += -DHAVE_MQTT_CPP=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),)
    MQTT_LIBS += -lpaho-mqtt3a
    CXXFLAGS += -DHAVE_MQTT_ASYNC=1
endif
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),)
    MQTT_LIBS += -lpaho-mqtt3c
    CXXFLAGS += -DHAVE_MQTT=1
endif

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬
BACNET_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),)
    BACNET_LIBS += -lbacnet
    CXXFLAGS += -DHAVE_BACNET=1
endif

# ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
OTHER_LIBS = 
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libquickjs.a),)
    OTHER_LIBS += -lquickjs
    CXXFLAGS += -DHAVE_QUICKJS=1
endif

# httplib í—¤ë” íŒŒì¼ í™•ì¸ ë° ë§¤í¬ë¡œ ì •ì˜ ì¶”ê°€
ifneq ($(wildcard $(MINGW_PREFIX)/include/httplib.h),)
    CXXFLAGS += -DHAVE_HTTPLIB=1
endif

# ë°ì´í„°ë² ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬
DB_LIBS = -lsqlite3
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libhiredis.a),)
    DB_LIBS += -lhiredis
    CXXFLAGS += -DHAVE_REDIS=1
endif

# ğŸ”§ Windows ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì™„ì „í•œ ëª©ë¡)
WIN_LIBS = -lws2_32 -lwsock32 -liphlpapi -lrpcrt4 -luuid -lwinmm
WIN_LIBS += -lkernel32 -luser32 -ladvapi32 -lshell32 -lole32 -loleaut32
WIN_LIBS += -lcrypt32 -lsecur32 -lbcrypt -lncrypt  # ì•”í˜¸í™” ê´€ë ¨ ì¶”ê°€

# ê¸°ë³¸ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬
SYS_LIBS = -lpthread -lstdc++ -lm -lgcc -lgcc_eh

# ğŸ”§ ì˜¬ë°”ë¥¸ ë§í‚¹ ìˆœì„œ (ì¤‘ìš”!)
# ì˜ì¡´ì„±ì´ ë†’ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¶€í„° ë‚®ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìˆœìœ¼ë¡œ
LIBS = $(PROTOCOL_LIBS) $(MQTT_LIBS) $(BACNET_LIBS) $(OTHER_LIBS) $(DB_LIBS) $(WIN_LIBS) $(SYS_LIBS)

# ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘
ALL_CPP_FILES = $(shell find $(SRC_DIR) -name "*.cpp" -type f 2>/dev/null)
SOURCES = $(filter-out $(SRC_DIR)/main.cpp,$(ALL_CPP_FILES))
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJECT = $(BUILD_DIR)/main.o

# íƒ€ê²Ÿ
TARGET = collector.exe

# =============================================================================
# ë¹Œë“œ ê·œì¹™
# =============================================================================

.PHONY: all clean info check-libs rebuild

all: check-libs $(BIN_DIR)/$(TARGET)

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¡´ì¬ í™•ì¸
check-libs:
	@echo "ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸..."
	@echo "libmodbus: $(if $(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),âœ…,âŒ)"
	@echo "libpaho-mqtt3c: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),âœ…,âŒ)"
	@echo "libpaho-mqtt3a: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a),âœ…,âŒ)"
	@echo "libpaho-mqttpp3-static: $(if $(wildcard $(MINGW_PREFIX)/lib/libpaho-mqttpp3-static.a),âœ…,âŒ)"
	@echo "libbacnet: $(if $(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),âœ…,âŒ)"
	@echo "libsqlite3: $(if $(wildcard $(MINGW_PREFIX)/lib/libsqlite3.a),âœ…,âŒ)"
	@echo ""

# ë©”ì¸ íƒ€ê²Ÿ
$(BIN_DIR)/$(TARGET): $(OBJECTS) $(MAIN_OBJECT) | $(BIN_DIR)
	@echo "ğŸ”— Linking $(BIN_DIR)/$(TARGET)..."
	@echo "Link command:"
	@echo "$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(MAIN_OBJECT) $(LIBS)"
	@$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(MAIN_OBJECT) $(LIBS)
	@echo "âœ… Build completed: $@"
	@echo "File size: $$(du -h $@ | cut -f1)"

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„± (ë””ë ‰í† ë¦¬ë³„)
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "ğŸ”¨ Compiling $<..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# ì •ë³´ ì¶œë ¥
info:
	@echo "=== PulseOne Windows Build Configuration ==="
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Libraries: $(LIBS)"
	@echo "Source files: $(words $(ALL_CPP_FILES))"
	@echo "Object files: $(words $(OBJECTS))"

# ì²­ì†Œ
clean:
	@echo "ğŸ§¹ Cleaning..."
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "âœ… Clean completed"

# ì™„ì „ ì¬ë¹Œë“œ
rebuild: clean all

# ë””ë²„ê·¸ ì •ë³´
debug-libs:
	@echo "Protocol libs: $(PROTOCOL_LIBS)"
	@echo "MQTT libs: $(MQTT_LIBS)"
	@echo "BACnet libs: $(BACNET_LIBS)"
	@echo "DB libs: $(DB_LIBS)"
	@echo "Windows libs: $(WIN_LIBS)"
	@echo "System libs: $(SYS_LIBS)"
	@echo ""
	@echo "Final LIBS: $(LIBS)"

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸
check-symbols:
	@echo "ğŸ” MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸..."
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3c.a" ]; then \
		echo "libpaho-mqtt3c.a ì‹¬ë³¼:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi
	@if [ -f "$(MINGW_PREFIX)/lib/libpaho-mqtt3a.a" ]; then \
		echo "libpaho-mqtt3a.a ì‹¬ë³¼:"; \
		x86_64-w64-mingw32-nm $(MINGW_PREFIX)/lib/libpaho-mqtt3a.a | grep -E "(MQTTAsync_isConnected|MQTTAsync_setCallbacks)" | head -5; \
	fi