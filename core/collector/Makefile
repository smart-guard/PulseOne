# =============================================================================
# PulseOne Collector - ÏôÑÏ†ÑÌïú Makefile (ÎßÅÌÅ¨ ÏóêÎü¨ ÏàòÏ†ï ÏôÑÎ£å)
# =============================================================================

# Í∏∞Î≥∏ ÏÑ§Ï†ï
SHELL := /bin/bash
.DEFAULT_GOAL := help
MAKEFLAGS += --warn-undefined-variables --no-builtin-rules

# ÌîåÎû´Ìèº Í∞êÏßÄ
UNAME_S := $(shell uname -s)
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC)

# ÌîåÎû´ÌèºÎ≥Ñ ÏÑ§Ï†ï
ifeq ($(UNAME_S),Linux)
	PLATFORM := Linux
	IS_WINDOWS := 0
	IS_LINUX := 1
else ifeq ($(OS),Windows_NT)
	PLATFORM := Windows
	IS_WINDOWS := 1
	IS_LINUX := 0
else
	PLATFORM := $(UNAME_S)
	IS_WINDOWS := 0
	IS_LINUX := 0
endif

# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏßÄÏõê
ifeq ($(CROSS_COMPILE_WINDOWS),1)
	PLATFORM := Windows-Cross
	IS_WINDOWS := 1
	IS_LINUX := 0
	CXX := x86_64-w64-mingw32-g++
	MINGW_PREFIX := /usr/x86_64-w64-mingw32
endif

# =============================================================================
# ÎîîÎ†âÌÜ†Î¶¨ ÏÑ§Ï†ï
# =============================================================================

SRC_DIR := src
INCLUDE_DIR := include
BUILD_DIR := build
BIN_DIR := bin
DIST_DIR := dist
TARGET := pulseone-collector

# Shared ÎùºÏù¥Î∏åÎü¨Î¶¨ Í≤ΩÎ°ú
SHARED_BASE_DIR := /app/core/shared
SHARED_INCLUDE_DIR := $(SHARED_BASE_DIR)/include
SHARED_LIB_DIR := $(SHARED_BASE_DIR)/lib

# =============================================================================
# Ïª¥ÌååÏùºÎü¨ Î∞è ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
# =============================================================================

# Í∏∞Î≥∏ Ïª¥ÌååÏùºÎü¨
ifeq ($(CROSS_COMPILE_WINDOWS),1)
	CXX := x86_64-w64-mingw32-g++
else
	CXX := g++
endif

# Í≥µÌÜµ Ïª¥ÌååÏùº ÌîåÎûòÍ∑∏
CXXFLAGS := -std=c++17 -Wall -Wextra -O2 -fPIC
CXXFLAGS += -Wno-unused-parameter -Wno-unused-variable
CXXFLAGS += -fdiagnostics-color=always

# ÌîåÎû´ÌèºÎ≥Ñ ÌîåÎûòÍ∑∏
ifeq ($(IS_WINDOWS),1)
	CXXFLAGS += -DPULSEONE_WINDOWS=1 -DPULSEONE_LINUX=0
	CXXFLAGS += -DWIN32 -D_WIN32_WINNT=0x0601
	CXXFLAGS += -DWIN32_LEAN_AND_MEAN -DNOMINMAX
	ifeq ($(CROSS_COMPILE_WINDOWS),1)
		LDFLAGS := -L$(MINGW_PREFIX)/lib -static
	else
		LDFLAGS := -Wl,--gc-sections -static
	endif
else
	CXXFLAGS += -DPULSEONE_WINDOWS=0 -DPULSEONE_LINUX=1
	CXXFLAGS += -march=native -mtune=native
	LDFLAGS := -Wl,--gc-sections
endif

# ÎîîÎ≤ÑÍ∑∏/Î¶¥Î¶¨Ï¶à ÌîåÎûòÍ∑∏
ifeq ($(DEBUG),1)
	CXXFLAGS += -DDEBUG -g -O0 -fno-omit-frame-pointer
else
	CXXFLAGS += -DNDEBUG -O3 -flto
endif

# =============================================================================
# Include Í≤ΩÎ°ú ÏÑ§Ï†ï
# =============================================================================

# Shared ÎùºÏù¥Î∏åÎü¨Î¶¨ Include ÌôïÏù∏
HAS_SHARED := $(shell [ -d "$(SHARED_INCLUDE_DIR)" ] && echo "1" || echo "0")

# Í∏∞Î≥∏ Include Í≤ΩÎ°ú
INCLUDES := -I$(INCLUDE_DIR)
INCLUDES += -I$(INCLUDE_DIR)/Platform
INCLUDES += -I$(INCLUDE_DIR)/Common
INCLUDES += -I$(INCLUDE_DIR)/Utils
INCLUDES += -I$(INCLUDE_DIR)/Config
INCLUDES += -I$(INCLUDE_DIR)/Database
INCLUDES += -I$(INCLUDE_DIR)/Database/Entities
INCLUDES += -I$(INCLUDE_DIR)/Database/Repositories
INCLUDES += -I$(INCLUDE_DIR)/Client
INCLUDES += -I$(INCLUDE_DIR)/Workers
INCLUDES += -I$(INCLUDE_DIR)/Workers/Base
INCLUDES += -I$(INCLUDE_DIR)/Workers/Protocol
INCLUDES += -I$(INCLUDE_DIR)/Workers/Components
INCLUDES += -I$(INCLUDE_DIR)/Drivers
INCLUDES += -I$(INCLUDE_DIR)/Drivers/Common
INCLUDES += -I$(INCLUDE_DIR)/Pipeline
INCLUDES += -I$(INCLUDE_DIR)/Storage
INCLUDES += -I$(INCLUDE_DIR)/Alarm
INCLUDES += -I$(INCLUDE_DIR)/VirtualPoint
INCLUDES += -I$(INCLUDE_DIR)/Network
INCLUDES += -I$(INCLUDE_DIR)/Api

# Shared ÎùºÏù¥Î∏åÎü¨Î¶¨ Include (Ïö∞ÏÑ†ÏàúÏúÑ ÎÜíÏùå)
ifeq ($(HAS_SHARED),1)
	INCLUDES := -I$(SHARED_INCLUDE_DIR) $(INCLUDES)
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Platform
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Common
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Utils
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Database
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Database/Entities
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Database/Repositories
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Alarm
	INCLUDES += -I$(SHARED_INCLUDE_DIR)/Export
endif

# Ïô∏Î∂Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ Include
INCLUDES += -I/usr/local/include
INCLUDES += -I/usr/local/include/quickjs

# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùºÏö© Include
ifeq ($(CROSS_COMPILE_WINDOWS),1)
	INCLUDES += -I$(MINGW_PREFIX)/include
endif

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ Î∞è ÏÑ§Ï†ï
# =============================================================================

# ÎèôÏ†Å ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HTTPLIB := $(shell echo '\#include <httplib.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_QUICKJS := $(shell pkg-config --exists quickjs && echo "1" || echo "0")

# ÌîÑÎ°úÌÜ†ÏΩú ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ
HAS_MODBUS := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")
HAS_BACNET := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎßÅÌÇπ ÏÑ§Ï†ï (‚úÖ ÏàòÏ†ï: security Ï∂îÍ∞Ä)
# =============================================================================

# Í∏∞Î≥∏ ÏãúÏä§ÌÖú ÎùºÏù¥Î∏åÎü¨Î¶¨
ifeq ($(IS_WINDOWS),1)
	BASIC_LIBS := -lpthread -lstdc++ -lm
	PLATFORM_LIBS := -lws2_32 -lwsock32 -liphlpapi -lrpcrt4 -luuid
	PLATFORM_LIBS += -lwinmm -lkernel32 -luser32 -ladvapi32
else
	BASIC_LIBS := -lpthread -lsqlite3 -lm -ldl
	PLATFORM_LIBS :=
endif

# ‚úÖ Shared ÎùºÏù¥Î∏åÎü¨Î¶¨ (securityÎ•º common ÏïûÏóê Ï∂îÍ∞Ä)
ifeq ($(HAS_SHARED),1)
	SHARED_LIBS := -L$(SHARED_LIB_DIR)
	SHARED_LIBS += -lpulseone-alarm
	SHARED_LIBS += -lpulseone-database
	SHARED_LIBS += -lpulseone-client
	SHARED_LIBS += -lpulseone-export
	SHARED_LIBS += -lpulseone-security
	SHARED_LIBS += -lpulseone-common
	CXXFLAGS += -DHAS_SHARED_LIBS=1
else
	SHARED_LIBS :=
endif

# ÌîÑÎ°úÌÜ†ÏΩú ÎùºÏù¥Î∏åÎü¨Î¶¨
PROTOCOL_LIBS :=
ifeq ($(HAS_MODBUS),1)
	PROTOCOL_LIBS += -lmodbus
	CXXFLAGS += -DHAVE_MODBUS=1
endif

ifeq ($(HAS_MQTT_C),1)
	PROTOCOL_LIBS += -lpaho-mqtt3c
	CXXFLAGS += -DHAVE_MQTT=1
endif

ifeq ($(HAS_MQTT_CPP),1)
	PROTOCOL_LIBS += -lpaho-mqttpp3
	CXXFLAGS += -DHAVE_MQTT_CPP=1
endif

ifeq ($(HAS_BACNET),1)
	PROTOCOL_LIBS += -lbacnet
	CXXFLAGS += -DHAVE_BACNET=1
endif

# Ïú†Ìã∏Î¶¨Ìã∞ ÎùºÏù¥Î∏åÎü¨Î¶¨
UTILITY_LIBS :=
ifeq ($(HAS_HIREDIS),1)
	UTILITY_LIBS += -lhiredis
	CXXFLAGS += -DHAVE_REDIS=1
endif

ifeq ($(HAS_HTTPLIB),1)
	CXXFLAGS += -DHAVE_HTTPLIB=1
endif

ifeq ($(HAS_QUICKJS),1)
	# QuickJS ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏúÑÏπò ÏûêÎèô Í∞êÏßÄ
	QUICKJS_LIB_PATH := $(shell find /usr/local/lib -name "libquickjs.a" 2>/dev/null | head -1)
	ifneq ($(QUICKJS_LIB_PATH),)
		UTILITY_LIBS += $(QUICKJS_LIB_PATH)
	else
		# pkg-config ÏãúÎèÑ
		QUICKJS_LIBS := $(shell pkg-config --libs quickjs 2>/dev/null || echo "-lquickjs")
		UTILITY_LIBS += $(QUICKJS_LIBS)
	endif
	CXXFLAGS += -DHAVE_QUICKJS=1
endif

# ÏµúÏ¢Ö ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎßÅÌÇπ ÏàúÏÑú
LIBS := $(SHARED_LIBS) $(PROTOCOL_LIBS) $(UTILITY_LIBS) $(BASIC_LIBS) $(PLATFORM_LIBS)

# =============================================================================
# ÏÜåÏä§ ÌååÏùº ÏàòÏßë (‚úÖ ÏàòÏ†ï: ConfigManager Ï†úÏô∏)
# =============================================================================

# Core ÏÜåÏä§
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)

# ‚úÖ Utils ÏÜåÏä§ (ConfigManager.cpp Ï†úÏô∏ - sharedÏóêÏÑú ÏÇ¨Ïö©)
UTILS_SOURCES := $(filter-out $(SRC_DIR)/Utils/ConfigManager.cpp, $(wildcard $(SRC_DIR)/Utils/*.cpp))

CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)
PLATFORM_SOURCES := $(wildcard $(SRC_DIR)/Platform/*.cpp)

# Database ÏÜåÏä§
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp)
DATABASE_SOURCES += $(wildcard $(SRC_DIR)/Database/Entities/*.cpp)
DATABASE_SOURCES += $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# Client ÏÜåÏä§
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Workers ÏÜåÏä§
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp)
WORKERS_SOURCES += $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp)
WORKERS_SOURCES += $(wildcard $(SRC_DIR)/Workers/Components/*.cpp)
WORKERS_SOURCES += $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)
WORKERS_SOURCES += $(wildcard $(SRC_DIR)/Workers/WorkerManager.cpp)

# Pipeline Î∞è Storage
PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)
STORAGE_SOURCES := $(wildcard $(SRC_DIR)/Storage/*.cpp)

# Alarm Î∞è VirtualPoint
ALARM_SOURCES := $(wildcard $(SRC_DIR)/Alarm/*.cpp)
VIRTUALPOINT_SOURCES := $(wildcard $(SRC_DIR)/VirtualPoint/*.cpp)

# ÎìúÎùºÏù¥Î≤Ñ ÏÜåÏä§ (Ï°∞Í±¥Î∂Ä Ìè¨Ìï®)
DRIVERS_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)

ifeq ($(HAS_MODBUS),1)
	DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif

ifeq ($(HAS_MQTT_CPP),1)
	DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
endif

ifeq ($(HAS_BACNET),1)
	DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif

# ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞è API (Ï°∞Í±¥Î∂Ä Ìè¨Ìï®)
ifeq ($(HAS_HTTPLIB),1)
	NETWORK_SOURCES := $(wildcard $(SRC_DIR)/Network/*.cpp)
	API_SOURCES := $(wildcard $(SRC_DIR)/Api/*.cpp)
else
	NETWORK_SOURCES :=
	API_SOURCES :=
endif

# Ï†ÑÏ≤¥ ÏÜåÏä§ ÌååÏùº Î™©Î°ù
ALL_SOURCES := $(CORE_SOURCES) $(UTILS_SOURCES) $(CONFIG_SOURCES)
ALL_SOURCES += $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(WORKERS_SOURCES)
ALL_SOURCES += $(DRIVERS_SOURCES) $(PIPELINE_SOURCES) $(STORAGE_SOURCES)
ALL_SOURCES += $(ALARM_SOURCES) $(VIRTUALPOINT_SOURCES) $(PLATFORM_SOURCES)
ALL_SOURCES += $(NETWORK_SOURCES) $(API_SOURCES)

# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº
ALL_OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(ALL_SOURCES))
MAIN_OBJECT := $(BUILD_DIR)/main.o

# =============================================================================
# ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÏûêÎèô ÏÉùÏÑ±
# =============================================================================

BUILD_SUBDIRS := $(BUILD_DIR)/Core $(BUILD_DIR)/Utils $(BUILD_DIR)/Config
BUILD_SUBDIRS += $(BUILD_DIR)/Database $(BUILD_DIR)/Database/Entities $(BUILD_DIR)/Database/Repositories
BUILD_SUBDIRS += $(BUILD_DIR)/Client $(BUILD_DIR)/Workers $(BUILD_DIR)/Workers/Base
BUILD_SUBDIRS += $(BUILD_DIR)/Workers/Protocol $(BUILD_DIR)/Workers/Components
BUILD_SUBDIRS += $(BUILD_DIR)/Drivers $(BUILD_DIR)/Drivers/Common
BUILD_SUBDIRS += $(BUILD_DIR)/Drivers/Modbus $(BUILD_DIR)/Drivers/Mqtt $(BUILD_DIR)/Drivers/Bacnet
BUILD_SUBDIRS += $(BUILD_DIR)/Pipeline $(BUILD_DIR)/Storage $(BUILD_DIR)/Alarm
BUILD_SUBDIRS += $(BUILD_DIR)/VirtualPoint $(BUILD_DIR)/Network $(BUILD_DIR)/Api $(BUILD_DIR)/Platform

# =============================================================================
# ÏÉâÏÉÅ Ï†ïÏùò
# =============================================================================

GREEN := \033[0;32m
BLUE := \033[0;34m
YELLOW := \033[1;33m
RED := \033[0;31m
CYAN := \033[0;36m
NC := \033[0m

# =============================================================================
# Î©îÏù∏ ÌÉÄÍ≤üÎì§
# =============================================================================

# Ï†ÑÏ≤¥ ÎπåÎìú
all: check-env create-dirs $(TARGET)
	@echo -e "$(GREEN)‚úÖ Build completed for $(PLATFORM)!$(NC)"
	@echo -e "Binary: $(CYAN)$(BIN_DIR)/$(TARGET)$(NC)"
	@echo -e "Shared libraries: $(if $(HAS_SHARED),$(GREEN)‚úÖ enabled$(NC),$(YELLOW)‚ùå disabled$(NC))"
	@echo -e "Protocol libraries: $(CYAN)$(words $(shell echo $(PROTOCOL_LIBS) | tr ' ' '\n' | sort -u))$(NC) protocols"

# ÎîîÎ≤ÑÍ∑∏ ÎπåÎìú
debug:
	$(MAKE) DEBUG=1 all

# Î¶¥Î¶¨Ï¶à ÎπåÎìú
release:
	$(MAKE) DEBUG=0 all

# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº
windows-cross:
	@echo -e "$(YELLOW)üîß Building for Windows (cross-compile)...$(NC)"
	$(MAKE) CROSS_COMPILE_WINDOWS=1 all

# =============================================================================
# ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
# =============================================================================

create-dirs: | $(BUILD_DIR) $(BIN_DIR) $(DIST_DIR)
	@mkdir -p $(BUILD_SUBDIRS)

$(BUILD_DIR) $(BIN_DIR) $(DIST_DIR):
	@mkdir -p $@

# =============================================================================
# Ïª¥ÌååÏùº Í∑úÏπô
# =============================================================================

# Î©îÏù∏ Ïã§Ìñâ ÌååÏùº
$(TARGET): $(ALL_OBJECTS) $(MAIN_OBJECT) | $(BIN_DIR)
	@echo -e "$(BLUE)üîó Linking $(TARGET)...$(NC)"
	$(CXX) $(LDFLAGS) -o $(BIN_DIR)/$@ $(ALL_OBJECTS) $(MAIN_OBJECT) $(LIBS)
	@echo -e "$(GREEN)‚úÖ $(TARGET) built successfully!$(NC)"
	@echo -e "Size: $(CYAN)$(shell du -h $(BIN_DIR)/$(TARGET) 2>/dev/null | cut -f1 || echo 'N/A')$(NC)"

# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº Ïª¥ÌååÏùº
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | create-dirs
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)‚öôÔ∏è Compiling $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# main.cpp ÌäπÎ≥Ñ Ï≤òÎ¶¨
$(BUILD_DIR)/main.o: $(SRC_DIR)/main.cpp | create-dirs
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)‚öôÔ∏è Compiling main.cpp$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ÏùòÏ°¥ÏÑ± ÏÉùÏÑ±
# =============================================================================

# ÏùòÏ°¥ÏÑ± ÌååÏùº ÏÉùÏÑ±
$(BUILD_DIR)/%.d: $(SRC_DIR)/%.cpp | create-dirs
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $(BUILD_DIR)/$*.o $< > $@

# ÏùòÏ°¥ÏÑ± ÌååÏùº Ìè¨Ìï®
-include $(ALL_OBJECTS:.o=.d)

# =============================================================================
# Ïú†Ìã∏Î¶¨Ìã∞ ÌÉÄÍ≤üÎì§
# =============================================================================

# ÌôòÍ≤Ω ÌôïÏù∏
check-env:
	@echo -e "$(BLUE)üîç Environment check for $(PLATFORM)...$(NC)"
	@echo -e "Platform: $(CYAN)$(PLATFORM)$(NC)"
	@echo -e "Compiler: $(CYAN)$(CXX)$(NC)"
	@echo -e "Shared libs: $(if $(HAS_SHARED),$(GREEN)‚úÖ $(SHARED_LIB_DIR)$(NC),$(YELLOW)‚ùå disabled$(NC))"
	@echo -e "Sources: $(CYAN)$(words $(ALL_SOURCES))$(NC) files"
	@echo -e "Protocol support:"
	@echo -e "  Modbus: $(if $(HAS_MODBUS),$(GREEN)‚úÖ$(NC),$(RED)‚ùå$(NC))"
	@echo -e "  MQTT: $(if $(HAS_MQTT_C),$(GREEN)‚úÖ$(NC),$(RED)‚ùå$(NC))"
	@echo -e "  MQTT++: $(if $(HAS_MQTT_CPP),$(GREEN)‚úÖ$(NC),$(RED)‚ùå$(NC))"
	@echo -e "  BACnet: $(if $(HAS_BACNET),$(GREEN)‚úÖ$(NC),$(RED)‚ùå$(NC))"
	@echo -e "  QuickJS: $(if $(HAS_QUICKJS),$(GREEN)‚úÖ$(NC),$(RED)‚ùå$(NC))"

# ÎπåÎìú ÏÉÅÌÉú ÌôïÏù∏
status:
	@echo -e "$(BLUE)üìä Build Status$(NC)"
	@echo -e "Platform: $(CYAN)$(PLATFORM)$(NC)"
	@echo -e "Target: $(if $(wildcard $(BIN_DIR)/$(TARGET)),$(GREEN)‚úÖ $(BIN_DIR)/$(TARGET)$(NC),$(RED)‚ùå not built$(NC))"
	@echo -e "Objects: $(CYAN)$(words $(wildcard $(BUILD_DIR)/**/*.o))$(NC) / $(CYAN)$(words $(ALL_OBJECTS))$(NC)"

# Ïã§Ìñâ
run: $(TARGET)
	@echo -e "$(GREEN)üöÄ Running $(TARGET)...$(NC)"
	$(BIN_DIR)/$(TARGET)

# Ï†ïÎ¶¨
clean:
	@echo -e "$(YELLOW)üßπ Cleaning build artifacts...$(NC)"
	@find $(BUILD_DIR) -name "*.o" -delete 2>/dev/null || true
	@find $(BUILD_DIR) -name "*.d" -delete 2>/dev/null || true
	@rm -f $(BIN_DIR)/$(TARGET) 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Clean completed$(NC)"

# ÏôÑÏ†Ñ Ï†ïÎ¶¨
distclean:
	@echo -e "$(RED)üóëÔ∏è Complete cleanup...$(NC)"
	@rm -rf $(BUILD_DIR) $(BIN_DIR) $(DIST_DIR)
	@echo -e "$(GREEN)‚úÖ Complete cleanup finished$(NC)"

# TCP ÏÜåÏºì Ïò§Î•ò ÏàòÏ†ï
fix-tcp:
	@echo -e "$(YELLOW)üîß Fixing TCP socket issues...$(NC)"
	@if [ -f "src/Workers/Base/TcpBasedWorker.cpp" ]; then \
		if ! grep -q "netinet/tcp.h" src/Workers/Base/TcpBasedWorker.cpp; then \
			sed -i '1i#include <netinet/tcp.h>' src/Workers/Base/TcpBasedWorker.cpp; \
			echo -e "$(GREEN)‚úÖ Added TCP header$(NC)"; \
		fi; \
		sed -i 's/case EWOULDBLOCK: return "Operation would block";/#if EAGAIN != EWOULDBLOCK\n        case EWOULDBLOCK: return "Operation would block";\n#endif/' src/Workers/Base/TcpBasedWorker.cpp; \
		echo -e "$(GREEN)‚úÖ Fixed EWOULDBLOCK duplicate case$(NC)"; \
	else \
		echo -e "$(YELLOW)‚ö†Ô∏è TcpBasedWorker.cpp not found$(NC)"; \
	fi

# ÎèÑÏõÄÎßê
help:
	@echo -e "$(BLUE)üîß PulseOne Collector Build System$(NC)"
	@echo ""
	@echo -e "$(GREEN)Building:$(NC)"
	@echo "  make all              - Build with all available libraries"
	@echo "  make debug            - Debug build (-g -O0)"
	@echo "  make release          - Release build (-O3 -flto)"
	@echo "  make windows-cross    - Cross-compile for Windows"
	@echo "  make run              - Build and run"
	@echo ""
	@echo -e "$(GREEN)Maintenance:$(NC)"
	@echo "  make clean            - Clean build artifacts"
	@echo "  make distclean        - Complete cleanup"
	@echo "  make fix-tcp          - Fix TCP socket compilation issues"
	@echo ""
	@echo -e "$(GREEN)Utilities:$(NC)"
	@echo "  make check-env        - Check build environment"
	@echo "  make status           - Show build status"
	@echo "  make create-dirs      - Create build directories"
	@echo ""
	@echo -e "$(YELLOW)Current Configuration:$(NC)"
	@echo "  Platform: $(PLATFORM)"
	@echo "  Shared Libraries: $(if $(HAS_SHARED),$(GREEN)‚úÖ enabled$(NC),$(YELLOW)‚ùå disabled$(NC))"
	@echo "  Cross Compile: $(if $(CROSS_COMPILE_WINDOWS),$(GREEN)‚úÖ Windows$(NC),$(YELLOW)‚ùå Native$(NC))"

# =============================================================================
# Phony ÌÉÄÍ≤üÎì§
# =============================================================================

.PHONY: all debug release windows-cross clean distclean check-env status run fix-tcp help create-dirs