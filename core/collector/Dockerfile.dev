# collector/Dockerfile.dev - BACnet + Redis + HTTP ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏôÑÏ†Ñ ÏÑ§Ï†ï
FROM gcc:12

# Í∏∞Î≥∏ Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò (libhttplib-dev Ï†úÏô∏ - ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú ÏÇ¨Ïö©)
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libpqxx-dev libpq-dev libsqlite3-dev \
    sqlite3 sqlite3-doc \
    curl git nodejs npm pkg-config \
    wget unzip vim nano \
    libssl-dev uuid-dev \
    autotools-dev autoconf automake libtool \
    tree htop procps \
    && rm -rf /var/lib/apt/lists/*

# httplib Ìó§Îçî ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú (ÏïàÏ†ïÏ†ÅÏù∏ Î∞©Î≤ï)
RUN echo "Installing httplib header..." && \
    mkdir -p /usr/local/include && \
    wget -O /usr/local/include/httplib.h https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.14.1/httplib.h && \
    chmod 644 /usr/local/include/httplib.h && \
    echo "httplib header installed successfully"

# SQLite ÏÑ§Ï†ï
RUN echo "SQLite version:" && sqlite3 --version

# =============================================================================
# ÌïÑÏàò ÎùºÏù¥Î∏åÎü¨Î¶¨Îì§ ÏÑ§Ïπò
# =============================================================================

# 1. libmodbus ÏÑ§Ïπò
RUN echo "Installing libmodbus..." && \
    cd /tmp && git clone --depth 1 --branch v3.1.10 https://github.com/stephane/libmodbus.git && \
    cd libmodbus && ./autogen.sh && ./configure --prefix=/usr/local && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/libmodbus

# 2. hiredis ÏÑ§Ïπò
RUN echo "Installing hiredis..." && \
    cd /tmp && git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_SSL=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/hiredis

# 3. Paho MQTT C ÏÑ§Ïπò
RUN echo "Installing Paho MQTT C..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_WITH_SSL=TRUE -DPAHO_BUILD_DOCUMENTATION=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.c

# 4. Paho MQTT C++ ÏÑ§Ïπò
RUN echo "Installing Paho MQTT C++..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.2 https://github.com/eclipse/paho.mqtt.cpp.git && \
    cd paho.mqtt.cpp && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local \
             -DPAHO_WITH_SSL=TRUE \
             -DPAHO_BUILD_DOCUMENTATION=FALSE \
             -DPAHO_BUILD_SAMPLES=FALSE \
             -DPAHO_BUILD_TESTS=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.cpp

# 5. nlohmann/json ÏÑ§Ïπò
RUN echo "Installing nlohmann/json..." && \
    cd /tmp && git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DJSON_BuildTests=OFF && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/json

# 6. QuickJS JavaScript ÏóîÏßÑ ÏÑ§Ïπò
RUN echo "Installing QuickJS..." && \
    cd /tmp && git clone --depth 1 https://github.com/bellard/quickjs.git && \
    cd quickjs && \
    make && \
    make install PREFIX=/usr/local && \
    ldconfig && \
    cd / && rm -rf /tmp/quickjs

# 7. spdlog ÏÑ§Ïπò
RUN echo "Installing spdlog..." && \
    cd /tmp && git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DSPDLOG_BUILD_SHARED=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/spdlog

# 8. BACnet Stack ÏÑ§Ïπò
RUN echo "Installing BACnet Stack..." && \
    cd /tmp && \
    git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    cd bacnet-stack && \
    make BACNET_PORT=linux BACDL_DEFINE=-DBACDL_BIP=1 library && \
    cp apps/lib/libbacnet.a /usr/local/lib/ && \
    cp -r src/bacnet /usr/local/include/ && \
    ldconfig && \
    cd / && rm -rf /tmp/bacnet-stack

# pkg-config ÌååÏùºÎì§ ÏÉùÏÑ±
RUN mkdir -p /usr/local/lib/pkgconfig

RUN cat > /usr/local/lib/pkgconfig/bacnet.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: BACnet Stack
Description: BACnet protocol library
Version: 1.0.0
Libs: -L${libdir} -lbacnet -lm
Cflags: -I${includedir} -DPRINT_ENABLED=1 -DBACAPP_ALL -DINTRINSIC_REPORTING
EOF

RUN cat > /usr/local/lib/pkgconfig/libmodbus.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: libmodbus
Description: Modbus library
Version: 3.1.10
Libs: -L${libdir} -lmodbus
Cflags: -I${includedir}
EOF

RUN cat > /usr/local/lib/pkgconfig/paho-mqttpp3.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: Paho MQTT C++
Description: Eclipse Paho MQTT C++ Client Library
Version: 1.3.2
Requires: paho-mqtt3c
Libs: -L${libdir} -lpaho-mqttpp3
Cflags: -I${includedir}
EOF

RUN cat > /usr/local/lib/pkgconfig/quickjs.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: QuickJS
Description: QuickJS JavaScript Engine
Version: master
Libs: -L${libdir} -lquickjs
Cflags: -I${includedir}
EOF

RUN cat > /usr/local/lib/pkgconfig/httplib.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: cpp-httplib
Description: A C++ header-only HTTP/HTTPS server and client library
Version: 0.14.1
Libs: -lpthread
Cflags: -I${includedir}
EOF

# ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV BACNET_PORT=linux
ENV BACDL_DEFINE="-DBACDL_BIP=1"

# Í∞úÎ∞ú ÎèÑÍµ¨ Ïä§ÌÅ¨Î¶ΩÌä∏Îì§
RUN echo '#!/bin/bash' > /usr/local/bin/check-deps.sh && \
    echo 'echo "Library dependency check:"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  httplib: $(test -f /usr/local/include/httplib.h && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  libmodbus: $(pkg-config --exists libmodbus && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  hiredis: $(test -f /usr/local/lib/libhiredis.so && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  BACnet: $(test -f /usr/local/lib/libbacnet.a && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  Paho MQTT C: $(test -f /usr/local/lib/libpaho-mqtt3c.so && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  QuickJS: $(pkg-config --exists quickjs && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    echo 'echo "  nlohmann/json: $(test -f /usr/local/include/nlohmann/json.hpp && echo "available" || echo "unavailable")"' >> /usr/local/bin/check-deps.sh && \
    chmod +x /usr/local/bin/check-deps.sh

# httplib ÌÖåÏä§Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏
RUN echo '#!/bin/bash' > /usr/local/bin/test-httplib.sh && \
    echo 'echo "httplib ÌÖåÏä§Ìä∏"' >> /usr/local/bin/test-httplib.sh && \
    echo 'echo "==============="' >> /usr/local/bin/test-httplib.sh && \
    echo 'echo "Header file:"' >> /usr/local/bin/test-httplib.sh && \
    echo 'ls -la /usr/local/include/httplib.h 2>/dev/null || echo "httplib.h not found"' >> /usr/local/bin/test-httplib.sh && \
    echo 'echo "Compile test:"' >> /usr/local/bin/test-httplib.sh && \
    echo 'cat > /tmp/test_httplib.cpp << "TESTEOF"' >> /usr/local/bin/test-httplib.sh && \
    echo '#include <httplib.h>' >> /usr/local/bin/test-httplib.sh && \
    echo '#include <iostream>' >> /usr/local/bin/test-httplib.sh && \
    echo 'int main() {' >> /usr/local/bin/test-httplib.sh && \
    echo '    httplib::Server server;' >> /usr/local/bin/test-httplib.sh && \
    echo '    std::cout << "httplib test passed" << std::endl;' >> /usr/local/bin/test-httplib.sh && \
    echo '    return 0;' >> /usr/local/bin/test-httplib.sh && \
    echo '}' >> /usr/local/bin/test-httplib.sh && \
    echo 'TESTEOF' >> /usr/local/bin/test-httplib.sh && \
    echo 'if g++ -std=c++17 -o /tmp/test_httplib /tmp/test_httplib.cpp -lpthread 2>/dev/null; then' >> /usr/local/bin/test-httplib.sh && \
    echo '    echo "httplib compilation successful"' >> /usr/local/bin/test-httplib.sh && \
    echo '    /tmp/test_httplib' >> /usr/local/bin/test-httplib.sh && \
    echo 'else' >> /usr/local/bin/test-httplib.sh && \
    echo '    echo "httplib compilation failed"' >> /usr/local/bin/test-httplib.sh && \
    echo 'fi' >> /usr/local/bin/test-httplib.sh && \
    echo 'rm -f /tmp/test_httplib /tmp/test_httplib.cpp 2>/dev/null' >> /usr/local/bin/test-httplib.sh && \
    chmod +x /usr/local/bin/test-httplib.sh

# build ÎîîÎ†âÌÜ†Î¶¨ ÏûêÎèô ÏÉùÏÑ± Ïä§ÌÅ¨Î¶ΩÌä∏
RUN echo '#!/bin/bash' > /usr/local/bin/create-build-dirs.sh && \
    echo 'echo "Creating build directories..."' >> /usr/local/bin/create-build-dirs.sh && \
    echo 'mkdir -p build/{Storage,Api,Alarm,Network,VirtualPoint,Pipeline,Drivers/{Mqtt,Modbus,Bacnet},Workers/{Protocol,Base},Client,Database/{Repositories,Entities},Utils,Core}' >> /usr/local/bin/create-build-dirs.sh && \
    echo 'echo "Build directories created successfully!"' >> /usr/local/bin/create-build-dirs.sh && \
    echo 'find build -type d | head -20' >> /usr/local/bin/create-build-dirs.sh && \
    chmod +x /usr/local/bin/create-build-dirs.sh

# Bash ÌîÑÎ°¨ÌîÑÌä∏ ÏÑ§Ï†ï
RUN echo 'export PS1="\[\033[01;32m\]\u@collector-dev\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "üîß PulseOne Collector Development Environment"' >> /root/.bashrc && \
    echo 'echo "=============================================="' >> /root/.bashrc && \
    echo 'echo "Installed libraries:"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ httplib (HTTP server/client)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ libmodbus (Modbus communication)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ Paho MQTT C/C++ (MQTT communication)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ BACnet Stack (BACnet communication)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ hiredis (Redis client)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ nlohmann/json (JSON parsing)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ QuickJS (JavaScript engine)"' >> /root/.bashrc && \
    echo 'echo "  ‚úÖ spdlog (logging)"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "Useful commands:"' >> /root/.bashrc && \
    echo 'echo "  check-deps.sh           - Check all library dependencies"' >> /root/.bashrc && \
    echo 'echo "  test-httplib.sh         - Test httplib compilation"' >> /root/.bashrc && \
    echo 'echo "  create-build-dirs.sh    - Create all build directories"' >> /root/.bashrc && \
    echo 'echo "  make help               - Makefile help"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# Ïª¥ÌååÏùºÎü¨ ÏÑ§Ï†ï
ENV CC=gcc CXX=g++
ENV CFLAGS="-std=c11 -Wall -Wextra"
ENV CXXFLAGS="-std=c++17 -Wall -Wextra"

WORKDIR /app

# ÏµúÏ¢Ö Í≤ÄÏ¶ù
RUN echo "üîß Collector Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú ÏôÑÎ£å!" && \
    echo "ÏµúÏ¢Ö ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôïÏù∏:" && \
    echo "  httplib:" && ls -la /usr/local/include/httplib.h && \
    echo "  BACnet:" && ls -la /usr/local/lib/libbacnet.a && \
    echo "  hiredis:" && ls -la /usr/local/lib/libhiredis* | head -1 && \
    echo "  QuickJS:" && ls -la /usr/local/lib/libquickjs* 2>/dev/null || echo "QuickJS lib not found" && \
    echo "Î™®Îì† ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÑ§Ïπò ÏôÑÎ£å!"

CMD ["/bin/bash"]