# =============================================================================
# shared/Makefile - PulseOne Í≥µÏú† ÎùºÏù¥Î∏åÎü¨Î¶¨ (OpenSSL + Security + Data ÏßÄÏõê)
# üî• Redis ÌôúÏÑ±Ìôî ÏàòÏ†ï ÏôÑÎ£å (HAVE_REDIS=1 ÌîåÎûòÍ∑∏ Ï∂îÍ∞Ä)
# =============================================================================

# ÌîåÎû´Ìèº Í∞êÏßÄ
UNAME := $(shell uname -s 2>/dev/null || echo Windows)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
endif

# Ïª¥ÌååÏùºÎü¨ ÏÑ§Ï†ï
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -fPIC -DHAS_SHARED_LIBS=1

# Windows ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏßÄÏõê
ifeq ($(CROSS_COMPILE_WINDOWS),1)
    CXX = x86_64-w64-mingw32-g++
    CXXFLAGS += -DWIN32 -D_WIN32_WINNT=0x0601 -DWIN32_LEAN_AND_MEAN -DNOMINMAX
    PLATFORM := Windows-Cross
    MINGW_PREFIX = /usr/x86_64-w64-mingw32
    INCLUDES += -I$(MINGW_PREFIX)/include
    LIB_SUFFIX = .a
else ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1
    LIB_SUFFIX = .a
else
    CXXFLAGS += -DPULSEONE_LINUX=1
    LIB_SUFFIX = .a
endif

# ÎîîÎ†âÌÜ†Î¶¨ ÏÑ§Ï†ï
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
LIB_DIR = lib

# Include Í≤ΩÎ°ú (Data Ï∂îÍ∞Ä!)
INCLUDES = -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Security \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Client \
           -I$(INCLUDE_DIR)/Data \
           -I$(INCLUDE_DIR)/Export \
           -I$(INCLUDE_DIR)/Alarm

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∞êÏßÄ (OpenSSL Ï∂îÍ∞Ä!)
# =============================================================================

HAS_CURL := $(shell pkg-config --exists libcurl 2>/dev/null && echo "1" || echo "0")
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# üî• OpenSSL Í∞êÏßÄ (S3ClientÏö© - ÌïÑÏàò!)
HAS_OPENSSL := $(shell pkg-config --exists openssl 2>/dev/null && echo "1" || echo "0")
ifeq ($(HAS_OPENSSL),0)
    HAS_OPENSSL := $(shell echo '\#include <openssl/sha.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
endif

# =============================================================================
# Ï°∞Í±¥Î∂Ä Ïª¥ÌååÏùº ÌîåÎûòÍ∑∏
# =============================================================================

ifeq ($(HAS_CURL),1)
    CXXFLAGS += -DHAS_CURL
    LDFLAGS += $(shell pkg-config --libs libcurl)
endif

ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# üî•üî•üî• Redis ÌîåÎûòÍ∑∏ ÏàòÏ†ï (ÌïµÏã¨!)
ifeq ($(HAS_HIREDIS),1)
    CXXFLAGS += -DHAS_HIREDIS -DHAVE_REDIS=1
    $(info ‚úÖ Redis enabled: -DHAVE_REDIS=1)
endif

# üî• OpenSSL Ïª¥ÌååÏùº ÌîåÎûòÍ∑∏ (Í∞ÄÏû• Ï§ëÏöî!)
ifeq ($(HAS_OPENSSL),1)
    OPENSSL_LIBS := $(shell pkg-config --libs openssl 2>/dev/null)
    ifneq ($(OPENSSL_LIBS),)
        CXXFLAGS += -DHAS_OPENSSL=1
        LDFLAGS += $(OPENSSL_LIBS)
        $(info ‚úÖ OpenSSL found via pkg-config)
    else
        CXXFLAGS += -DHAS_OPENSSL=1
        LDFLAGS += -lssl -lcrypto
        $(info ‚úÖ OpenSSL found (direct link))
    endif
else
    $(warning ‚ö†Ô∏è  OpenSSL not found - S3 AWS Signature V4 will NOT work!)
    $(warning     Install: sudo apt-get install libssl-dev pkg-config)
endif

# =============================================================================
# ÏÜåÏä§ ÌååÏùº ÏàòÏßë (Data Ï∂îÍ∞Ä!)
# =============================================================================

COMMON_SOURCES = $(wildcard $(SRC_DIR)/Common/*.cpp) \
                $(wildcard $(SRC_DIR)/Utils/*.cpp) \
                $(wildcard $(SRC_DIR)/Platform/*.cpp)

SECURITY_SOURCES = $(wildcard $(SRC_DIR)/Security/*.cpp)

DATABASE_SOURCES = $(wildcard $(SRC_DIR)/Database/*.cpp) \
                  $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                  $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

CLIENT_SOURCES = $(wildcard $(SRC_DIR)/Client/*.cpp)

# üÜï Data ÏÜåÏä§ (DataReader, DataWriter)
DATA_SOURCES = $(wildcard $(SRC_DIR)/Data/*.cpp)

EXPORT_SOURCES = $(wildcard $(SRC_DIR)/Export/*.cpp)

ALARM_SOURCES = $(wildcard $(SRC_DIR)/Alarm/*.cpp)

# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº
COMMON_OBJECTS = $(COMMON_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
SECURITY_OBJECTS = $(SECURITY_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DATABASE_OBJECTS = $(DATABASE_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
CLIENT_OBJECTS = $(CLIENT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DATA_OBJECTS = $(DATA_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
EXPORT_OBJECTS = $(EXPORT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
ALARM_OBJECTS = $(ALARM_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)

# ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌååÏùºÎì§ (Data Ï∂îÍ∞Ä!)
COMMON_LIB = $(LIB_DIR)/libpulseone-common$(LIB_SUFFIX)
SECURITY_LIB = $(LIB_DIR)/libpulseone-security$(LIB_SUFFIX)
DATABASE_LIB = $(LIB_DIR)/libpulseone-database$(LIB_SUFFIX)
CLIENT_LIB = $(LIB_DIR)/libpulseone-client$(LIB_SUFFIX)
DATA_LIB = $(LIB_DIR)/libpulseone-data$(LIB_SUFFIX)
EXPORT_LIB = $(LIB_DIR)/libpulseone-export$(LIB_SUFFIX)
ALARM_LIB = $(LIB_DIR)/libpulseone-alarm$(LIB_SUFFIX)

# ÏÉâÏÉÅ Ï†ïÏùò
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# Î©îÏù∏ ÌÉÄÍ≤üÎì§
# =============================================================================

.PHONY: all clean common security database client data export alarm test-headers help info openssl-check

all: $(BUILD_DIR) $(LIB_DIR) common security database client data export alarm
	@echo -e "$(GREEN)‚úÖ Î™®Îì† Í≥µÏú† ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎπåÎìú ÏôÑÎ£å [$(PLATFORM)]$(NC)"

# ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± (Data Ï∂îÍ∞Ä!)
$(BUILD_DIR) $(LIB_DIR):
	@mkdir -p $@
	@mkdir -p $(BUILD_DIR)/Common $(BUILD_DIR)/Utils $(BUILD_DIR)/Platform
	@mkdir -p $(BUILD_DIR)/Security
	@mkdir -p $(BUILD_DIR)/Database/Entities $(BUILD_DIR)/Database/Repositories
	@mkdir -p $(BUILD_DIR)/Client
	@mkdir -p $(BUILD_DIR)/Data
	@mkdir -p $(BUILD_DIR)/Export
	@mkdir -p $(BUILD_DIR)/Alarm

# =============================================================================
# ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎπåÎìú (Data Ï∂îÍ∞Ä!)
# =============================================================================

common: $(COMMON_LIB)
$(COMMON_LIB): $(COMMON_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-common [$(PLATFORM)]$(NC)"
ifneq ($(COMMON_OBJECTS),)
	@ar rcs $@ $(COMMON_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

security: $(SECURITY_LIB)
$(SECURITY_LIB): $(SECURITY_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-security [$(PLATFORM)]$(NC)"
ifneq ($(SECURITY_OBJECTS),)
	@ar rcs $@ $(SECURITY_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

database: $(DATABASE_LIB)
$(DATABASE_LIB): $(DATABASE_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-database [$(PLATFORM)]$(NC)"
ifneq ($(DATABASE_OBJECTS),)
	@ar rcs $@ $(DATABASE_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

client: $(CLIENT_LIB)
$(CLIENT_LIB): $(CLIENT_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-client [$(PLATFORM)]$(NC)"
ifneq ($(CLIENT_OBJECTS),)
	@ar rcs $@ $(CLIENT_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

# üÜï Data ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎπåÎìú (DataReader, DataWriter)
data: $(DATA_LIB)
$(DATA_LIB): $(DATA_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-data [$(PLATFORM)]$(NC)"
ifneq ($(DATA_OBJECTS),)
	@ar rcs $@ $(DATA_OBJECTS)
	@ranlib $@ 2>/dev/null || true
	@echo -e "$(GREEN)   ‚úÖ DataReader.cpp, DataWriter.cpp compiled$(NC)"
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

export: $(EXPORT_LIB)
$(EXPORT_LIB): $(EXPORT_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-export [$(PLATFORM)]$(NC)"
ifneq ($(EXPORT_OBJECTS),)
	@ar rcs $@ $(EXPORT_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

alarm: $(ALARM_LIB)
$(ALARM_LIB): $(ALARM_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)üîß Building libpulseone-alarm [$(PLATFORM)]$(NC)"
ifneq ($(ALARM_OBJECTS),)
	@ar rcs $@ $(ALARM_OBJECTS)
	@ranlib $@ 2>/dev/null || true
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@ar rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

# =============================================================================
# Ïò§Î∏åÏ†ùÌä∏ ÌååÏùº Ïª¥ÌååÏùº
# =============================================================================

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)‚öôÔ∏è Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# OpenSSL ÌôïÏù∏ ÌÉÄÍ≤ü (ÎîîÎ≤ÑÍπÖÏö©)
# =============================================================================

openssl-check:
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üîí OpenSSL ÏÑ§Ï†ï ÌôïÏù∏ (Shared ÎùºÏù¥Î∏åÎü¨Î¶¨)"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "HAS_OPENSSL = $(HAS_OPENSSL)"
ifeq ($(HAS_OPENSSL),1)
	@echo "‚úÖ OpenSSL ÌôúÏÑ±ÌôîÎê®"
	@echo "   CXXFLAGS: $(CXXFLAGS)" | grep -o "HAS_OPENSSL=1" && echo "   ‚úÖ -DHAS_OPENSSL=1 ÌîåÎûòÍ∑∏ Ï†ÅÏö©Îê®" || echo "   ‚ùå ÌîåÎûòÍ∑∏ ÎàÑÎùΩ!"
	@pkg-config --modversion openssl 2>/dev/null && echo "   OpenSSL Î≤ÑÏ†Ñ: $$(pkg-config --modversion openssl)" || echo "   Î≤ÑÏ†Ñ ÌôïÏù∏ Î∂àÍ∞Ä"
else
	@echo "‚ùå OpenSSL ÎπÑÌôúÏÑ±ÌôîÎê® - S3ClientÍ∞Ä dummy_hash ÏÇ¨Ïö©!"
	@echo "   Ìï¥Í≤∞: sudo apt-get install libssl-dev pkg-config"
endif
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# üî• Redis ÏÑ§Ï†ï ÌôïÏù∏ ÌÉÄÍ≤ü Ï∂îÍ∞Ä
redis-check:
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "üî¥ Redis/hiredis ÏÑ§Ï†ï ÌôïÏù∏ (Shared ÎùºÏù¥Î∏åÎü¨Î¶¨)"
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo "HAS_HIREDIS = $(HAS_HIREDIS)"
ifeq ($(HAS_HIREDIS),1)
	@echo "‚úÖ hiredis ÌôúÏÑ±ÌôîÎê®"
	@echo "   Ïª¥ÌååÏùº ÌîåÎûòÍ∑∏ ÌôïÏù∏:"
	@echo "$(CXXFLAGS)" | grep -q "DHAVE_REDIS=1" && echo "     ‚úÖ -DHAVE_REDIS=1 Ï†ÅÏö©Îê®" || echo "     ‚ùå -DHAVE_REDIS=1 ÎàÑÎùΩ!"
	@echo "$(CXXFLAGS)" | grep -q "DHAS_HIREDIS" && echo "     ‚úÖ -DHAS_HIREDIS Ï†ÅÏö©Îê®" || echo "     ‚ùå -DHAS_HIREDIS ÎàÑÎùΩ!"
	@pkg-config --exists hiredis && echo "   hiredis pkg-config: ‚úÖ ÏÇ¨Ïö© Í∞ÄÎä•" || echo "   hiredis pkg-config: ‚ùå ÏóÜÏùå"
	@pkg-config --modversion hiredis 2>/dev/null && echo "   hiredis Î≤ÑÏ†Ñ: $$(pkg-config --modversion hiredis)" || echo "   Î≤ÑÏ†Ñ ÌôïÏù∏ Î∂àÍ∞Ä"
else
	@echo "‚ùå hiredis ÎπÑÌôúÏÑ±ÌôîÎê® - RedisÍ∞Ä ÏãúÎÆ¨Î†àÏù¥ÏÖò Î™®ÎìúÎ°ú ÎèôÏûë!"
	@echo "   Ìï¥Í≤∞: sudo apt-get install libhiredis-dev"
endif
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# =============================================================================
# ÌÖåÏä§Ìä∏ Î∞è Í≤ÄÏ¶ù (Data Ìó§Îçî Ï∂îÍ∞Ä!)
# =============================================================================

test-headers:
	@echo -e "$(BLUE)üîç Testing shared header files [$(PLATFORM)]...$(NC)"
	@echo "Testing Common headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/BasicTypes.h 2>/dev/null && echo "  ‚úÖ BasicTypes.h" || echo "  ‚ùå BasicTypes.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Enums.h 2>/dev/null && echo "  ‚úÖ Enums.h" || echo "  ‚ùå Enums.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Structs.h 2>/dev/null && echo "  ‚úÖ Structs.h" || echo "  ‚ùå Structs.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Utils.h 2>/dev/null && echo "  ‚úÖ Utils.h" || echo "  ‚ùå Utils.h"
	@echo "Testing Utils headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Utils/LogManager.h 2>/dev/null && echo "  ‚úÖ LogManager.h" || echo "  ‚ùå LogManager.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Utils/ConfigManager.h 2>/dev/null && echo "  ‚úÖ ConfigManager.h" || echo "  ‚ùå ConfigManager.h"
	@echo "Testing Security headers..."
	@if [ -f include/Security/SecretManager.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Security/SecretManager.h 2>/dev/null && echo "  ‚úÖ SecretManager.h" || echo "  ‚ùå SecretManager.h"; fi
	@echo "Testing Data headers..."
	@if [ -f include/Data/DataReader.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/DataReader.h 2>/dev/null && echo "  ‚úÖ DataReader.h" || echo "  ‚ùå DataReader.h"; fi
	@if [ -f include/Data/DataWriter.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/DataWriter.h 2>/dev/null && echo "  ‚úÖ DataWriter.h" || echo "  ‚ùå DataWriter.h"; fi
	@if [ -f include/Data/RedisDataTypes.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/RedisDataTypes.h 2>/dev/null && echo "  ‚úÖ RedisDataTypes.h" || echo "  ‚ùå RedisDataTypes.h"; fi
	@echo "Testing Alarm headers..."
	@if [ -f include/Alarm/AlarmTypes.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Alarm/AlarmTypes.h 2>/dev/null && echo "  ‚úÖ AlarmTypes.h" || echo "  ‚ùå AlarmTypes.h"; fi
	@echo "Testing Export headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Export/ExportTypes.h 2>/dev/null && echo "  ‚úÖ ExportTypes.h" || echo "  ‚ùå ExportTypes.h"
	@echo -e "$(GREEN)‚úÖ Header syntax check completed [$(PLATFORM)]$(NC)"

test-compile:
	@echo -e "$(BLUE)üß™ Testing compilation [$(PLATFORM)]...$(NC)"
	@echo '#include "Common/BasicTypes.h"' > /tmp/test_shared.cpp
	@echo '#include "Export/ExportTypes.h"' >> /tmp/test_shared.cpp
	@if [ -f include/Security/SecretManager.h ]; then echo '#include "Security/SecretManager.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Data/DataReader.h ]; then echo '#include "Data/DataReader.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Data/DataWriter.h ]; then echo '#include "Data/DataWriter.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Alarm/AlarmTypes.h ]; then echo '#include "Alarm/AlarmTypes.h"' >> /tmp/test_shared.cpp; fi
	@echo 'int main() { return 0; }' >> /tmp/test_shared.cpp
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c /tmp/test_shared.cpp -o /tmp/test_shared.o 2>/dev/null && echo "  ‚úÖ Compilation test passed" || echo "  ‚ùå Compilation test failed"
	@rm -f /tmp/test_shared.cpp /tmp/test_shared.o

# =============================================================================
# ÌÅ¨Î°úÏä§ Ïª¥ÌååÏùº ÏßÄÏõê
# =============================================================================

windows-cross:
	@echo -e "$(YELLOW)üîß Building for Windows (cross-compile)...$(NC)"
	$(MAKE) CROSS_COMPILE_WINDOWS=1 all

# =============================================================================
# Ï†ïÎ≥¥ Î∞è ÏÉÅÌÉú (Data Ï∂îÍ∞Ä!)
# =============================================================================

info:
	@echo -e "$(BLUE)üìã PulseOne Shared Library Build Info$(NC)"
	@echo "=================================="
	@echo "Platform: $(PLATFORM)"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Header files: $(shell find $(INCLUDE_DIR) -name '*.h' 2>/dev/null | wc -l)"
	@echo "Source files: $(words $(COMMON_SOURCES) $(SECURITY_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(DATA_SOURCES) $(EXPORT_SOURCES) $(ALARM_SOURCES))"
	@echo ""
	@echo "Library Support:"
	@echo "CURL (libcurl): $(if $(filter 1,$(HAS_CURL)),‚úÖ available,‚ùå missing)"
	@echo "JSON (nlohmann): $(if $(filter 1,$(HAS_NLOHMANN_JSON)),‚úÖ available,‚ùå missing)"
	@echo "Redis (hiredis): $(if $(filter 1,$(HAS_HIREDIS)),‚úÖ available,‚ùå missing)"
	@echo "OpenSSL: $(if $(filter 1,$(HAS_OPENSSL)),‚úÖ available,‚ùå missing) $(if $(filter 1,$(HAS_OPENSSL)),<- S3 ÏÑúÎ™Ö Í∞ÄÎä•,<- S3 ÏÑúÎ™Ö Î∂àÍ∞Ä!)"
	@echo ""
	@echo "Libraries:"
	@echo "libpulseone-common: $(if $(wildcard $(COMMON_LIB)),‚úÖ exists,‚ùå missing)"
	@echo "libpulseone-security: $(if $(wildcard $(SECURITY_LIB)),‚úÖ exists,‚ùå missing)"
	@echo "libpulseone-database: $(if $(wildcard $(DATABASE_LIB)),‚úÖ exists,‚ùå missing)"
	@echo "libpulseone-client: $(if $(wildcard $(CLIENT_LIB)),‚úÖ exists,‚ùå missing)"
	@echo "libpulseone-data: $(if $(wildcard $(DATA_LIB)),‚úÖ exists (DataReader/Writer),‚ùå missing)"
	@echo "libpulseone-export: $(if $(wildcard $(EXPORT_LIB)),‚úÖ exists,‚ùå missing)"
	@echo "libpulseone-alarm: $(if $(wildcard $(ALARM_LIB)),‚úÖ exists,‚ùå missing)"

# =============================================================================
# Ïú†Ìã∏Î¶¨Ìã∞
# =============================================================================

clean:
	@echo -e "$(YELLOW)üßπ Cleaning shared libraries [$(PLATFORM)]...$(NC)"
	@rm -rf $(BUILD_DIR)
	@rm -rf $(LIB_DIR)/*.a $(LIB_DIR)/*.so 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Clean completed$(NC)"

install: all
	@echo -e "$(BLUE)üì¶ Installing shared libraries [$(PLATFORM)]...$(NC)"
ifeq ($(IS_WINDOWS),1)
	@echo "Windows install not implemented yet"
else
	@sudo mkdir -p /usr/local/lib/pulseone /usr/local/include/pulseone
	@sudo cp -r $(LIB_DIR)/* /usr/local/lib/pulseone/ 2>/dev/null || true
	@sudo cp -r $(INCLUDE_DIR)/* /usr/local/include/pulseone/ 2>/dev/null || true
	@sudo ldconfig 2>/dev/null || true
	@echo -e "$(GREEN)‚úÖ Installation completed$(NC)"
endif

help:
	@echo -e "$(BLUE)üöÄ PulseOne Shared Library Makefile$(NC)"
	@echo "======================================"
	@echo ""
	@echo -e "$(GREEN)Main Targets:$(NC)"
	@echo "  make              - Build all shared libraries (Í∏∞Î≥∏)"
	@echo "  make all          - Build all shared libraries"
	@echo "  make common       - Build common library (BasicTypes, Utils, etc.)"
	@echo "  make security     - Build security library (SecretManager, etc.)"
	@echo "  make database     - Build database library (Entities, Repositories)"
	@echo "  make client       - Build client library (S3Client, Redis, InfluxDB)"
	@echo "  make data         - Build data library (DataReader, DataWriter) üÜï"
	@echo "  make export       - Build export library (Export types)"
	@echo "  make alarm        - Build alarm library (Alarm types)"
	@echo ""
	@echo -e "$(GREEN)Testing:$(NC)"
	@echo "  make test-headers - Test header file syntax"
	@echo "  make test-compile - Test compilation"
	@echo "  make openssl-check - Check OpenSSL configuration"
	@echo "  make redis-check  - Check Redis/hiredis configuration üÜï"
	@echo ""
	@echo -e "$(GREEN)Cross-Compilation:$(NC)"
	@echo "  make windows-cross - Build for Windows (requires mingw-w64)"
	@echo ""
	@echo -e "$(GREEN)Utilities:$(NC)"
	@echo "  make info         - Show build information"
	@echo "  make clean        - Clean build files"
	@echo "  make install      - Install to system (Linux only)"
	@echo "  make help         - Show this help"
	@echo ""
	@echo -e "$(YELLOW)Current Platform: $(PLATFORM)$(NC)"
	@echo -e "$(YELLOW)OpenSSL Status: $(if $(filter 1,$(HAS_OPENSSL)),‚úÖ Enabled,‚ùå Disabled)$(NC)"
	@echo -e "$(YELLOW)Redis Status: $(if $(filter 1,$(HAS_HIREDIS)),‚úÖ Enabled with HAVE_REDIS=1,‚ùå Disabled)$(NC)"
	@echo -e "$(YELLOW)Data Library: DataReader.cpp + DataWriter.cpp üÜï$(NC)"

# =============================================================================
# üî• Í∏∞Î≥∏ ÌÉÄÍ≤ü Î≥ÄÍ≤Ω: makeÎßå ÏûÖÎ†•Ìï¥ÎèÑ ÎπåÎìúÎêòÎèÑÎ°ù!
# =============================================================================

.DEFAULT_GOAL := all