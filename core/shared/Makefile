# =============================================================================
# shared/Makefile - PulseOne ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ (OpenSSL + Security + Data ì§€ì›)
# ğŸ”¥ Redis í™œì„±í™” ìˆ˜ì • ì™„ë£Œ (HAVE_REDIS=1 í”Œë˜ê·¸ ì¶”ê°€)
# =============================================================================

# í”Œë«í¼ ê°ì§€
UNAME := $(shell uname -s 2>/dev/null || echo Windows)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
endif

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX ?= g++
AR ?= ar
RANLIB ?= ranlib
CXXFLAGS = -std=c++17 -Wall -Wextra -O0 -DHAS_SHARED_LIBS=1

# Windows í¬ë¡œìŠ¤ ì»´íŒŒì¼ ì§€ì›
ifeq ($(CROSS_COMPILE_WINDOWS),1)
    CXX = x86_64-w64-mingw32-g++
    AR = x86_64-w64-mingw32-ar
    RANLIB = x86_64-w64-mingw32-ranlib
    CXXFLAGS += -DWIN32 -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX -DDBLIB_STATIC -DLOGLIB_STATIC -DCURL_STATICLIB -DPULSEONE_STATIC
    PLATFORM := Windows-Cross
    MINGW_PREFIX = /usr/x86_64-w64-mingw32
    INCLUDES += -I$(MINGW_PREFIX)/include
    LIB_SUFFIX = .a
else ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1
    LIB_SUFFIX = .a
else
    CXXFLAGS += -DPULSEONE_LINUX=1
    LIB_SUFFIX = .a
endif

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_ROOT = build
BUILD_DIR = $(BUILD_ROOT)/$(PLATFORM)
LIB_ROOT = lib
LIB_DIR = $(LIB_ROOT)/$(PLATFORM)

# Include ê²½ë¡œ (Data ì¶”ê°€!)
INCLUDES = -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Security \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Client \
           -I$(INCLUDE_DIR)/Data \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/Logging \
           -I$(INCLUDE_DIR)/Event \
           -Imodules/LogLib/include \
           -Imodules/DbLib/include \
           -I../collector/include

# =============================================================================
# ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°ì§€ (OpenSSL ì¶”ê°€!)
# =============================================================================

HAS_CURL := $(shell pkg-config --exists libcurl 2>/dev/null && echo "1" || echo "0")
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_PQXX := $(shell pkg-config --exists libpqxx 2>/dev/null && echo "1" || echo "0")

# ğŸ”¥ OpenSSL ê°ì§€ (S3Clientìš© - í•„ìˆ˜!)
HAS_OPENSSL := $(shell pkg-config --exists openssl 2>/dev/null && echo "1" || echo "0")
ifeq ($(HAS_OPENSSL),0)
    HAS_OPENSSL := $(shell echo '\#include <openssl/sha.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
endif

# =============================================================================
# ì¡°ê±´ë¶€ ì»´íŒŒì¼ í”Œë˜ê·¸
# =============================================================================

ifeq ($(HAS_CURL),1)
    CXXFLAGS += -DHAS_CURL
    LDFLAGS += $(shell pkg-config --libs libcurl)
endif

ifneq ($(HAS_NLOHMANN_JSON),0)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

ifeq ($(HAS_PQXX),1)
    CXXFLAGS += -DHAS_PQXX=1
endif

# ğŸ”¥ğŸ”¥ğŸ”¥ Redis í”Œë˜ê·¸ ìˆ˜ì • (í•µì‹¬!)
ifeq ($(HAS_HIREDIS),1)
    CXXFLAGS += -DHAS_HIREDIS -DHAVE_REDIS=1
    HIREDIS_CFLAGS := $(shell pkg-config --cflags hiredis 2>/dev/null)
    CXXFLAGS += $(HIREDIS_CFLAGS)
    $(info âœ… Redis enabled: -DHAVE_REDIS=1)
endif

# ğŸ”¥ OpenSSL ì»´íŒŒì¼ í”Œë˜ê·¸ (ê°€ì¥ ì¤‘ìš”!)
ifeq ($(HAS_OPENSSL),1)
    OPENSSL_LIBS := $(shell pkg-config --libs openssl 2>/dev/null)
    OPENSSL_CFLAGS := $(shell pkg-config --cflags openssl 2>/dev/null)
    ifneq ($(OPENSSL_LIBS),)
        CXXFLAGS += -DHAS_OPENSSL=1 $(OPENSSL_CFLAGS)
        LDFLAGS += $(OPENSSL_LIBS)
        $(info âœ… OpenSSL found via pkg-config)
    else
        CXXFLAGS += -DHAS_OPENSSL=1
        LDFLAGS += -lssl -lcrypto
        $(info âœ… OpenSSL found (direct link))
    endif
else
    $(warning âš ï¸  OpenSSL not found - S3 AWS Signature V4 will NOT work!)
    $(warning     Install: sudo apt-get install libssl-dev pkg-config)
endif

# =============================================================================
# ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘ (Data ì¶”ê°€!)
# =============================================================================

COMMON_SOURCES = $(wildcard $(SRC_DIR)/Common/*.cpp) \
                $(wildcard $(SRC_DIR)/Utils/*.cpp) \
                $(wildcard $(SRC_DIR)/Platform/*.cpp) \
                src/Logging/LogManager.cpp \
                src/Logging/LogLevelManager.cpp \
                $(wildcard modules/LogLib/src/*.cpp)

# ğŸ†• DbLib ì†ŒìŠ¤
DBLIB_SOURCES = $(wildcard modules/DbLib/src/*.cpp)

SECURITY_SOURCES = $(wildcard $(SRC_DIR)/Security/*.cpp)

DATABASE_SOURCES = $(wildcard $(SRC_DIR)/Database/*.cpp) \
                  $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                  $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

CLIENT_SOURCES = $(wildcard $(SRC_DIR)/Client/*.cpp)

# ğŸ†• Data ì†ŒìŠ¤ (DataReader, DataWriter)
DATA_SOURCES = $(wildcard $(SRC_DIR)/Data/*.cpp)

EXPORT_SOURCES = $(wildcard $(SRC_DIR)/Export/*.cpp)

ALARM_SOURCES = $(wildcard $(SRC_DIR)/Alarm/*.cpp)
EVENT_SOURCES = $(wildcard $(SRC_DIR)/Event/*.cpp)

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ (src/ ì•„ë˜ ì†ŒìŠ¤ë“¤)
COMMON_OBJECTS = $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(filter $(SRC_DIR)/%,$(COMMON_SOURCES))) \
                 $(patsubst modules/%.cpp,$(BUILD_DIR)/%.o,$(filter modules/%,$(COMMON_SOURCES)))
SECURITY_OBJECTS = $(SECURITY_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DATABASE_OBJECTS = $(DATABASE_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
CLIENT_OBJECTS = $(CLIENT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DATA_OBJECTS = $(DATA_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
EXPORT_OBJECTS = $(EXPORT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
ALARM_OBJECTS = $(ALARM_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
EVENT_OBJECTS = $(EVENT_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
DBLIB_OBJECTS = $(patsubst modules/DbLib/src/%.cpp,$(BUILD_DIR)/DbLib/src/%.o,$(DBLIB_SOURCES))

# ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ë“¤ (Data ì¶”ê°€!)
COMMON_LIB = $(LIB_DIR)/libpulseone-common$(LIB_SUFFIX)
SECURITY_LIB = $(LIB_DIR)/libpulseone-security$(LIB_SUFFIX)
DATABASE_LIB = $(LIB_DIR)/libpulseone-database$(LIB_SUFFIX)
CLIENT_LIB = $(LIB_DIR)/libpulseone-client$(LIB_SUFFIX)
DATA_LIB = $(LIB_DIR)/libpulseone-data$(LIB_SUFFIX)
EXPORT_LIB = $(LIB_DIR)/libpulseone-export$(LIB_SUFFIX)
ALARM_LIB = $(LIB_DIR)/libpulseone-alarm$(LIB_SUFFIX)
EVENT_LIB = $(LIB_DIR)/libpulseone-event$(LIB_SUFFIX)
DBLIB_LIB = $(LIB_DIR)/libpulseone-dblib$(LIB_SUFFIX)

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤
# =============================================================================

.PHONY: all clean common security database client data export alarm event dblib test-dblib test-headers help info openssl-check

all: $(BUILD_DIR) $(LIB_DIR) common security database client data export alarm event dblib
	@echo -e "$(GREEN)âœ… ëª¨ë“  ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ ì™„ë£Œ [$(PLATFORM)]$(NC)"

# ë””ë ‰í† ë¦¬ ìƒì„± (Data ì¶”ê°€!)
$(BUILD_DIR) $(LIB_DIR):
	@mkdir -p $@
	@mkdir -p $(BUILD_DIR)/Common $(BUILD_DIR)/Utils $(BUILD_DIR)/Platform
	@mkdir -p $(BUILD_DIR)/Security
	@mkdir -p $(BUILD_DIR)/Database/Entities $(BUILD_DIR)/Database/Repositories
	@mkdir -p $(BUILD_DIR)/Client
	@mkdir -p $(BUILD_DIR)/Data
	@mkdir -p $(BUILD_DIR)/Export
	@mkdir -p $(BUILD_DIR)/Alarm
	@mkdir -p $(BUILD_DIR)/Event
	@mkdir -p $(BUILD_DIR)/LogLib
	@mkdir -p $(BUILD_DIR)/DbLib/src
	@mkdir -p $(BUILD_DIR)/Logging

# =============================================================================
# ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ (Data ì¶”ê°€!)
# =============================================================================

common: $(COMMON_LIB)
$(COMMON_LIB): $(COMMON_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-common [$(PLATFORM)]$(NC)"
ifneq ($(COMMON_OBJECTS),)
	@$(AR) rcs $@ $(COMMON_OBJECTS)
	@echo "ğŸ” Checking symbols in libpulseone-common:"
	@nm -C $@ | grep "LogManager::Info" || echo "âŒ LogManager::Info symbol MISSING!"
	@nm -C $@ | grep "ConfigManager::reload" || echo "âŒ ConfigManager::reload symbol MISSING!"
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

security: $(SECURITY_LIB)
$(SECURITY_LIB): $(SECURITY_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-security [$(PLATFORM)]$(NC)"
ifneq ($(SECURITY_OBJECTS),)
	@$(AR) rcs $@ $(SECURITY_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

database: $(DATABASE_LIB)
$(DATABASE_LIB): $(DATABASE_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-database [$(PLATFORM)]$(NC)"
ifneq ($(DATABASE_OBJECTS),)
	@$(AR) rcs $@ $(DATABASE_OBJECTS)
	@echo "ğŸ” Checking symbols in libpulseone-database:"
	@nm -C $@ | grep "RepositoryFactory::getInstance" || echo "âŒ RepositoryFactory::getInstance symbol MISSING!"
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

client: $(CLIENT_LIB)
$(CLIENT_LIB): $(CLIENT_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-client [$(PLATFORM)]$(NC)"
ifneq ($(CLIENT_OBJECTS),)
	@$(AR) rcs $@ $(CLIENT_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

# ğŸ†• Data ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ (DataReader, DataWriter)
data: $(DATA_LIB)
$(DATA_LIB): $(DATA_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-data [$(PLATFORM)]$(NC)"
ifneq ($(DATA_OBJECTS),)
	@$(AR) rcs $@ $(DATA_OBJECTS)
	@$(RANLIB) $@
	@echo -e "$(GREEN)   âœ… DataReader.cpp, DataWriter.cpp compiled$(NC)"
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy_data.c && $(CXX) -c /tmp/dummy_data.c -o /tmp/dummy_data.o
	@$(AR) rcs $@ /tmp/dummy_data.o && rm -f /tmp/dummy_data.c /tmp/dummy_data.o
endif

export: $(EXPORT_LIB)
$(EXPORT_LIB): $(EXPORT_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-export [$(PLATFORM)]$(NC)"
ifneq ($(EXPORT_OBJECTS),)
	@$(AR) rcs $@ $(EXPORT_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy_export.c && $(CXX) -c /tmp/dummy_export.c -o /tmp/dummy_export.o
	@$(AR) rcs $@ /tmp/dummy_export.o && rm -f /tmp/dummy_export.c /tmp/dummy_export.o
endif

alarm: $(ALARM_LIB)
$(ALARM_LIB): $(ALARM_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-alarm [$(PLATFORM)]$(NC)"
ifneq ($(ALARM_OBJECTS),)
	@$(AR) rcs $@ $(ALARM_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

# ğŸ†• DbLib ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ
dblib: $(DBLIB_LIB)
$(DBLIB_LIB): $(DBLIB_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-dblib [$(PLATFORM)]$(NC)"
ifneq ($(DBLIB_OBJECTS),)
	@$(AR) rcs $@ $(DBLIB_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy.c && $(CXX) -c /tmp/dummy.c -o /tmp/dummy.o
	@$(AR) rcs $@ /tmp/dummy.o && rm -f /tmp/dummy.c /tmp/dummy.o
endif

# ğŸ†• Event ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ
event: $(EVENT_LIB)
$(EVENT_LIB): $(EVENT_OBJECTS) | $(LIB_DIR)
	@echo -e "$(BLUE)ğŸ”§ Building libpulseone-event [$(PLATFORM)]$(NC)"
ifneq ($(EVENT_OBJECTS),)
	@$(AR) rcs $@ $(EVENT_OBJECTS)
	@$(RANLIB) $@
else
	@echo '/* Header-only library - dummy object */' > /tmp/dummy_event.c && $(CXX) -c /tmp/dummy_event.c -o /tmp/dummy_event.o
	@$(AR) rcs $@ /tmp/dummy_event.o && rm -f /tmp/dummy_event.c /tmp/dummy_event.o
endif

# =============================================================================
# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼
# =============================================================================

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# LogLib ì†ŒìŠ¤ ì»´íŒŒì¼ìš© ë³„ë„ ê·œì¹™
$(BUILD_DIR)/LogLib/src/%.o: modules/LogLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling LogLib $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# DbLib ì†ŒìŠ¤ ì»´íŒŒì¼ìš© ë³„ë„ ê·œì¹™
$(BUILD_DIR)/DbLib/src/%.o: modules/DbLib/src/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)âš™ï¸ Compiling DbLib $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# DbLib í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰
test-dblib: dblib common client security
	@echo -e "$(BLUE)ğŸ§ª Building DbLib Standalone Test...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) modules/DbLib/tests/test_dblib_core.cpp \
		$(DBLIB_LIB) $(CLIENT_LIB) $(COMMON_LIB) $(SECURITY_LIB) \
		-lsqlite3 -lpqxx -lpq -lmysqlclient -lhiredis $(LDFLAGS) \
		-o $(BUILD_DIR)/test_dblib_core
	@echo -e "$(GREEN)ğŸš€ Running DbLib Standalone Test...$(NC)"
	@./$(BUILD_DIR)/test_dblib_core

# =============================================================================
# OpenSSL í™•ì¸ íƒ€ê²Ÿ (ë””ë²„ê¹…ìš©)
# =============================================================================

openssl-check:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸ”’ OpenSSL ì„¤ì • í™•ì¸ (Shared ë¼ì´ë¸ŒëŸ¬ë¦¬)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "HAS_OPENSSL = $(HAS_OPENSSL)"
ifeq ($(HAS_OPENSSL),1)
	@echo "âœ… OpenSSL í™œì„±í™”ë¨"
	@echo "   CXXFLAGS: $(CXXFLAGS)" | grep -o "HAS_OPENSSL=1" && echo "   âœ… -DHAS_OPENSSL=1 í”Œë˜ê·¸ ì ìš©ë¨" || echo "   âŒ í”Œë˜ê·¸ ëˆ„ë½!"
	@pkg-config --modversion openssl 2>/dev/null && echo "   OpenSSL ë²„ì „: $$(pkg-config --modversion openssl)" || echo "   ë²„ì „ í™•ì¸ ë¶ˆê°€"
else
	@echo "âŒ OpenSSL ë¹„í™œì„±í™”ë¨ - S3Clientê°€ dummy_hash ì‚¬ìš©!"
	@echo "   í•´ê²°: sudo apt-get install libssl-dev pkg-config"
endif
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ğŸ”¥ Redis ì„¤ì • í™•ì¸ íƒ€ê²Ÿ ì¶”ê°€
redis-check:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "ğŸ”´ Redis/hiredis ì„¤ì • í™•ì¸ (Shared ë¼ì´ë¸ŒëŸ¬ë¦¬)"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "HAS_HIREDIS = $(HAS_HIREDIS)"
ifeq ($(HAS_HIREDIS),1)
	@echo "âœ… hiredis í™œì„±í™”ë¨"
	@echo "   ì»´íŒŒì¼ í”Œë˜ê·¸ í™•ì¸:"
	@echo "$(CXXFLAGS)" | grep -q "DHAVE_REDIS=1" && echo "     âœ… -DHAVE_REDIS=1 ì ìš©ë¨" || echo "     âŒ -DHAVE_REDIS=1 ëˆ„ë½!"
	@echo "$(CXXFLAGS)" | grep -q "DHAS_HIREDIS" && echo "     âœ… -DHAS_HIREDIS ì ìš©ë¨" || echo "     âŒ -DHAS_HIREDIS ëˆ„ë½!"
	@pkg-config --exists hiredis && echo "   hiredis pkg-config: âœ… ì‚¬ìš© ê°€ëŠ¥" || echo "   hiredis pkg-config: âŒ ì—†ìŒ"
	@pkg-config --modversion hiredis 2>/dev/null && echo "   hiredis ë²„ì „: $$(pkg-config --modversion hiredis)" || echo "   ë²„ì „ í™•ì¸ ë¶ˆê°€"
else
	@echo "âŒ hiredis ë¹„í™œì„±í™”ë¨ - Redisê°€ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ë™ì‘!"
	@echo "   í•´ê²°: sudo apt-get install libhiredis-dev"
endif
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# =============================================================================
# í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (Data í—¤ë” ì¶”ê°€!)
# =============================================================================

test-headers:
	@echo -e "$(BLUE)ğŸ” Testing shared header files [$(PLATFORM)]...$(NC)"
	@echo "Testing Common headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/BasicTypes.h 2>/dev/null && echo "  âœ… BasicTypes.h" || echo "  âŒ BasicTypes.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Enums.h 2>/dev/null && echo "  âœ… Enums.h" || echo "  âŒ Enums.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Structs.h 2>/dev/null && echo "  âœ… Structs.h" || echo "  âŒ Structs.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Common/Utils.h 2>/dev/null && echo "  âœ… Utils.h" || echo "  âŒ Utils.h"
	@echo "Testing Utils headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Utils/LogManager.h 2>/dev/null && echo "  âœ… LogManager.h" || echo "  âŒ LogManager.h"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Utils/ConfigManager.h 2>/dev/null && echo "  âœ… ConfigManager.h" || echo "  âŒ ConfigManager.h"
	@echo "Testing Security headers..."
	@if [ -f include/Security/SecretManager.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Security/SecretManager.h 2>/dev/null && echo "  âœ… SecretManager.h" || echo "  âŒ SecretManager.h"; fi
	@echo "Testing Data headers..."
	@if [ -f include/Data/DataReader.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/DataReader.h 2>/dev/null && echo "  âœ… DataReader.h" || echo "  âŒ DataReader.h"; fi
	@if [ -f include/Data/DataWriter.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/DataWriter.h 2>/dev/null && echo "  âœ… DataWriter.h" || echo "  âŒ DataWriter.h"; fi
	@if [ -f include/Data/RedisDataTypes.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Data/RedisDataTypes.h 2>/dev/null && echo "  âœ… RedisDataTypes.h" || echo "  âŒ RedisDataTypes.h"; fi
	@echo "Testing Alarm headers..."
	@if [ -f include/Alarm/AlarmTypes.h ]; then $(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Alarm/AlarmTypes.h 2>/dev/null && echo "  âœ… AlarmTypes.h" || echo "  âŒ AlarmTypes.h"; fi
	@echo "Testing Export headers..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only include/Export/ExportTypes.h 2>/dev/null && echo "  âœ… ExportTypes.h" || echo "  âŒ ExportTypes.h"
	@echo -e "$(GREEN)âœ… Header syntax check completed [$(PLATFORM)]$(NC)"

test-compile:
	@echo -e "$(BLUE)ğŸ§ª Testing compilation [$(PLATFORM)]...$(NC)"
	@echo '#include "Common/BasicTypes.h"' > /tmp/test_shared.cpp
	@echo '#include "Export/ExportTypes.h"' >> /tmp/test_shared.cpp
	@if [ -f include/Security/SecretManager.h ]; then echo '#include "Security/SecretManager.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Data/DataReader.h ]; then echo '#include "Data/DataReader.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Data/DataWriter.h ]; then echo '#include "Data/DataWriter.h"' >> /tmp/test_shared.cpp; fi
	@if [ -f include/Alarm/AlarmTypes.h ]; then echo '#include "Alarm/AlarmTypes.h"' >> /tmp/test_shared.cpp; fi
	@echo 'int main() { return 0; }' >> /tmp/test_shared.cpp
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c /tmp/test_shared.cpp -o /tmp/test_shared.o 2>/dev/null && echo "  âœ… Compilation test passed" || echo "  âŒ Compilation test failed"
	@rm -f /tmp/test_shared.cpp /tmp/test_shared.o

# =============================================================================
# í¬ë¡œìŠ¤ ì»´íŒŒì¼ ì§€ì›
# =============================================================================

windows-cross:
	@echo -e "$(YELLOW)ğŸ”§ Building for Windows (cross-compile)...$(NC)"
	$(MAKE) CROSS_COMPILE_WINDOWS=1 all

# =============================================================================
# ì •ë³´ ë° ìƒíƒœ (Data ì¶”ê°€!)
# =============================================================================

info:
	@echo -e "$(BLUE)ğŸ“‹ PulseOne Shared Library Build Info$(NC)"
	@echo "=================================="
	@echo "Platform: $(PLATFORM)"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
	@echo "Header files: $(shell find $(INCLUDE_DIR) -name '*.h' 2>/dev/null | wc -l)"
	@echo "Source files: $(words $(COMMON_SOURCES) $(SECURITY_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(DATA_SOURCES) $(EXPORT_SOURCES) $(ALARM_SOURCES))"
	@echo ""
	@echo "Library Support:"
	@echo "CURL (libcurl): $(if $(filter 1,$(HAS_CURL)),âœ… available,âŒ missing)"
	@echo "JSON (nlohmann): $(if $(filter 1,$(HAS_NLOHMANN_JSON)),âœ… available,âŒ missing)"
	@echo "Redis (hiredis): $(if $(filter 1,$(HAS_HIREDIS)),âœ… available,âŒ missing)"
	@echo "OpenSSL: $(if $(filter 1,$(HAS_OPENSSL)),âœ… available,âŒ missing) $(if $(filter 1,$(HAS_OPENSSL)),<- S3 ì„œëª… ê°€ëŠ¥,<- S3 ì„œëª… ë¶ˆê°€!)"
	@echo ""
	@echo "Libraries:"
	@echo "libpulseone-common: $(if $(wildcard $(COMMON_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-security: $(if $(wildcard $(SECURITY_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-database: $(if $(wildcard $(DATABASE_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-client: $(if $(wildcard $(CLIENT_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-data: $(if $(wildcard $(DATA_LIB)),âœ… exists (DataReader/Writer),âŒ missing)"
	@echo "libpulseone-export: $(if $(wildcard $(EXPORT_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-export: $(if $(wildcard $(EXPORT_LIB)),âœ… exists,âŒ missing)"
	@echo "libpulseone-alarm: $(if $(wildcard $(ALARM_LIB)),âœ… exists,âŒ missing)"
	@echo ""
	@echo "DEBUG: COMMON_SOURCES = $(COMMON_SOURCES)"
	@echo "DEBUG: DATABASE_SOURCES = $(DATABASE_SOURCES)"

# =============================================================================
# ìœ í‹¸ë¦¬í‹°
# =============================================================================

clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning shared libraries [$(PLATFORM)]...$(NC)"
	@rm -rf $(BUILD_DIR)
	@rm -rf $(LIB_DIR)/*.a $(LIB_DIR)/*.so 2>/dev/null || true
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

install: all
	@echo -e "$(BLUE)ğŸ“¦ Installing shared libraries [$(PLATFORM)]...$(NC)"
ifeq ($(IS_WINDOWS),1)
	@echo "Windows install not implemented yet"
else
	@sudo mkdir -p /usr/local/lib/pulseone /usr/local/include/pulseone
	@sudo cp -r $(LIB_DIR)/* /usr/local/lib/pulseone/ 2>/dev/null || true
	@sudo cp -r $(INCLUDE_DIR)/* /usr/local/include/pulseone/ 2>/dev/null || true
	@sudo ldconfig 2>/dev/null || true
	@echo -e "$(GREEN)âœ… Installation completed$(NC)"
endif

help:
	@echo -e "$(BLUE)ğŸš€ PulseOne Shared Library Makefile$(NC)"
	@echo "======================================"
	@echo ""
	@echo -e "$(GREEN)Main Targets:$(NC)"
	@echo "  make              - Build all shared libraries (ê¸°ë³¸)"
	@echo "  make all          - Build all shared libraries"
	@echo "  make common       - Build common library (BasicTypes, Utils, etc.)"
	@echo "  make security     - Build security library (SecretManager, etc.)"
	@echo "  make database     - Build database library (Entities, Repositories)"
	@echo "  make client       - Build client library (S3Client, Redis, InfluxDB)"
	@echo "  make data         - Build data library (DataReader, DataWriter) ğŸ†•"
	@echo "  make export       - Build export library (Export types)"
	@echo "  make alarm        - Build alarm library (Alarm types)"
	@echo ""
	@echo -e "$(GREEN)Testing:$(NC)"
	@echo "  make test-headers - Test header file syntax"
	@echo "  make test-compile - Test compilation"
	@echo "  make openssl-check - Check OpenSSL configuration"
	@echo "  make redis-check  - Check Redis/hiredis configuration ğŸ†•"
	@echo ""
	@echo -e "$(GREEN)Cross-Compilation:$(NC)"
	@echo "  make windows-cross - Build for Windows (requires mingw-w64)"
	@echo ""
	@echo -e "$(GREEN)Utilities:$(NC)"
	@echo "  make info         - Show build information"
	@echo "  make clean        - Clean build files"
	@echo "  make install      - Install to system (Linux only)"
	@echo "  make help         - Show this help"
	@echo ""
	@echo -e "$(YELLOW)Current Platform: $(PLATFORM)$(NC)"
	@echo -e "$(YELLOW)OpenSSL Status: $(if $(filter 1,$(HAS_OPENSSL)),âœ… Enabled,âŒ Disabled)$(NC)"
	@echo -e "$(YELLOW)Redis Status: $(if $(filter 1,$(HAS_HIREDIS)),âœ… Enabled with HAVE_REDIS=1,âŒ Disabled)$(NC)"
	@echo -e "$(YELLOW)Data Library: DataReader.cpp + DataWriter.cpp ğŸ†•$(NC)"

# =============================================================================
# ğŸ”¥ ê¸°ë³¸ íƒ€ê²Ÿ ë³€ê²½: makeë§Œ ì…ë ¥í•´ë„ ë¹Œë“œë˜ë„ë¡!
# =============================================================================

.DEFAULT_GOAL := all