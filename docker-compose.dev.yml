version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15
    container_name: pulseone-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: pulseone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # InfluxDB (ìƒˆë¡œ ì¶”ê°€)
  influxdb:
    image: influxdb:2.7
    container_name: pulseone-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influxpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-pulseone}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-timeseries}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: pulseone-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq123}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # Backend
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    container_name: pulseone-backend-dev
    working_dir: /app  # ğŸ¯ ì‘ì—… ë””ë ‰í† ë¦¬ ëª…ì‹œ
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      NODE_ENV: development
      ENV_STAGE: ${ENV_STAGE:-dev}
      # ê¸°ì¡´ Docker ì„œë¹„ìŠ¤ ì—°ê²° ì •ë³´ ìœ ì§€
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq123}@rabbitmq:5672
    ports:
      - "3000:3000"
      - "9229:9229"
    volumes:
      - ./backend:/app/backend
      - ./config:/app/config
      - ./secrets:/app/secrets
      - ./data:/app/data  # ğŸ¯ SQLite íŒŒì¼ ì ‘ê·¼ìš© ë³¼ë¥¨ ì¶”ê°€
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone_network

# Collector (ì™„ì„±ëœ ë²„ì „)
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile.dev
    container_name: pulseone-collector-dev
    tty: true
    stdin_open: true
    working_dir: /app  # ğŸ¯ ì‘ì—… ë””ë ‰í† ë¦¬ ëª…ì‹œ
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      BUILD_TYPE: Debug
      LOG_LEVEL: debug
      ENV_STAGE: ${ENV_STAGE:-dev}
      AUTO_BUILD: "true"          # ìë™ ë¹Œë“œ í™œì„±í™”
      AUTO_RUN: "false"           # ìë™ ì‹¤í–‰ ë¹„í™œì„±í™” (ê°œë°œìš©)
    volumes:
      - ./collector:/app/collector
      - ./config:/app/config
      - ./secrets:/app/secrets
      - ./logs:/app/logs
      - ./data:/app/data  # ğŸ¯ SQLite íŒŒì¼ ì ‘ê·¼ìš© ë³¼ë¥¨ ì¶”ê°€
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    command: >
      bash -c "
        echo 'ğŸ”§ PulseOne Collector Development Environment'
        echo '============================================='
        
        # í™˜ê²½ ì •ë³´ ì¶œë ¥
        if [ -f /app/secrets/anthropic_api_key ]; then
          export ANTHROPIC_API_KEY=\$$(cat /app/secrets/anthropic_api_key)
          echo 'âœ… ANTHROPIC_API_KEY loaded'
        fi
        
        echo 'ğŸ“‹ System Info:'
        echo \"  OS: \$$(uname -s) \$$(uname -r)\"
        echo \"  Compiler: \$$(g++ --version | head -n1)\"
        echo \"  Build Type: \$$BUILD_TYPE\"
        echo \"  Working Dir: \$$(pwd)\"
        
        # ğŸ¯ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • í™•ì¸ ì¶”ê°€
        echo 'ğŸ—„ï¸ Database Configuration:'
        echo \"  DATABASE_TYPE: \$$DATABASE_TYPE\"
        echo \"  SQLITE_PATH: \$$SQLITE_PATH\"
        if [ -f \"\$$SQLITE_PATH\" ]; then
          echo \"  âœ… SQLite file found: \$$SQLITE_PATH\"
          sqlite3 \"\$$SQLITE_PATH\" 'SELECT COUNT(*) as device_count FROM devices;' 2>/dev/null && echo \"  ğŸ“Š Database accessible\" || echo \"  âš ï¸ Database query failed\"
        else
          echo \"  âŒ SQLite file not found: \$$SQLITE_PATH\"
        fi
        
        # ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ í™•ì¸
        echo 'ğŸ“š Library Status:'
        pkg-config --exists libmodbus && echo \"  âœ… libmodbus: \$$(pkg-config --modversion libmodbus)\" || echo '  âŒ libmodbus'
        [ -f /usr/local/include/MQTTClient.h ] && echo '  âœ… Paho MQTT C: Found' || echo '  âŒ Paho MQTT C'
        [ -f /usr/local/include/mqtt/client.h ] && echo '  âœ… Paho MQTT C++: Found' || echo '  âŒ Paho MQTT C++'
        [ -d /usr/local/include/bacnet ] && echo '  âœ… BACnet: Found' || echo '  âŒ BACnet'
        
        # ì„œë¹„ìŠ¤ ì—°ê²° í™•ì¸
        echo 'ğŸŒ Service Connectivity:'
        timeout 5 bash -c '</dev/tcp/postgres/5432' 2>/dev/null && echo '  âœ… PostgreSQL' || echo '  âŒ PostgreSQL'
        timeout 5 bash -c '</dev/tcp/redis/6379' 2>/dev/null && echo '  âœ… Redis' || echo '  âŒ Redis'
        timeout 5 bash -c '</dev/tcp/influxdb/8086' 2>/dev/null && echo '  âœ… InfluxDB' || echo '  âŒ InfluxDB'
        timeout 5 bash -c '</dev/tcp/rabbitmq/5672' 2>/dev/null && echo '  âœ… RabbitMQ' || echo '  âŒ RabbitMQ'
        
        # ìë™ ë¹Œë“œ (ì„ íƒì )
        if [ \"\$$AUTO_BUILD\" = \"true\" ]; then
          echo 'ğŸ”¨ Starting automatic build...'
          cd /app/collector
          
          # ëˆ„ë½ëœ íŒŒì¼ë“¤ ì²´í¬
          echo 'ğŸ“ Checking required files...'
          
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p include/Core src/Core include/Drivers src/Drivers
          
          echo 'ğŸ”§ Building collector...'
          make clean 2>/dev/null || true
          
          if make debug; then
            echo 'âœ… Build successful!'
            
            # ìë™ ì‹¤í–‰ (ì„ íƒì )
            if [ \"\$$AUTO_RUN\" = \"true\" ]; then
              echo 'ğŸš€ Starting collector...'
              make run
            else
              echo 'ğŸ’¡ Build completed. Use \"make run\" to start collector.'
            fi
          else
            echo 'âŒ Build failed. Check the error messages above.'
            echo 'ğŸ’¡ You can still access the container to debug:'
            echo '   docker exec -it pulseone-collector-dev bash'
          fi
        fi
        
        echo ''
        echo 'ğŸš€ Available Commands:'
        echo '  make clean && make debug  - Build collector'
        echo '  make run                  - Run collector'
        echo '  make tests                - Run tests'
        echo '  claude-code               - Use Claude Code CLI'
        echo ''
        echo 'ğŸ“Š Database Commands:'
        echo '  sqlite3 \$$SQLITE_PATH    - Access SQLite database'
        echo '  sqlite3 \$$SQLITE_PATH \".tables\"  - List tables'
        echo ''
        echo 'ğŸš€ PulseOne Collector Development Environment Ready!'
        echo 'ğŸ’¡ Use: docker exec -it pulseone-collector-dev bash'
        
        # ë¬´í•œ ëŒ€ê¸°
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep pulseone-collector || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - pulseone_network

networks:
  pulseone_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  influxdb_config:
  rabbitmq_data: