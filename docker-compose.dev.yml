services:
  # ============================================================================
  # Backend ì„œë¹„ìŠ¤ (Node.js API ì„œë²„)
  # ============================================================================
  backend:
    container_name: pulseone-backend-dev
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    working_dir: /app/backend
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influx:
        condition: service_started
      rabbitmq:
        condition: service_started
    environment:
      - ENV_STAGE=${ENV_STAGE:-dev}
      - ANTHROPIC_API_KEY=./secrets/anthropic_api_key
    env_file:
      - ./config/.env.${ENV_STAGE:-dev}
    volumes:
      - ./backend:/app/backend
      - ./config:/app/config
      - ./secrets:/app/secrets:ro
      - claude_cache:/root/.cache/claude-code
    tty: true
    stdin_open: true
    command: >
      bash -c "
        if [ -f /app/secrets/anthropic_api_key ]; then
          export ANTHROPIC_API_KEY=$(cat /app/secrets/anthropic_api_key)
          echo 'âœ… ANTHROPIC_API_KEY loaded from secrets'
        else
          echo 'âš ï¸  ANTHROPIC_API_KEY file not found'
        fi
        echo 'ğŸš€ PulseOne Backend Development Environment'
        echo 'Available commands:'
        echo '  npm run dev    - Start development server'
        echo '  npm run debug  - Start with debugger'
        echo '  npm test       - Run tests'
        echo '  claude-code    - Use Claude Code CLI'
        echo ''
        /bin/bash
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Frontend ê°œë°œ ì„œë²„ (Vite)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: pulseone-frontend-dev
    environment:
      VITE_API_BASE_URL: http://localhost:3000/api
      VITE_WEBSOCKET_URL: ws://localhost:3000
      VITE_DEBUG_MODE: "true"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"    # Vite ê°œë°œ ì„œë²„
    depends_on:
      - backend

  # ============================================================================
  # Collector ì„œë¹„ìŠ¤ (C++ ë°ì´í„° ìˆ˜ì§‘ê¸°)
  # ============================================================================
  collector:
    container_name: pulseone-collector-dev
    build:
      context: .
      dockerfile: collector/Dockerfile.dev
      args:
        BUILD_TYPE: ${BUILD_TYPE:-Debug}
        INSTALL_DEPS: "true"
    working_dir: /app/collector
    volumes:
      - ./collector:/app/collector
      - ./config:/app/config
      - ./secrets:/app/secrets:ro
      - claude_cache:/root/.cache/claude-code
      # ë“œë¼ì´ë²„ ì„¤ì • íŒŒì¼ë“¤ ë§ˆìš´íŠ¸
      - ./config/drivers:/app/config/drivers
      # ë¡œê·¸ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸
      - ./logs/collector:/app/logs
      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹œ (ë¹Œë“œ ì„±ëŠ¥ í–¥ìƒ)
      - collector_libs:/usr/local/lib
      - collector_includes:/usr/local/include
    ports:
      # ë””ë²„ê¹…ìš© í¬íŠ¸ (gdb ì›ê²© ë””ë²„ê¹…)
      - "2345:2345"
      # ëª¨ë‹ˆí„°ë§ìš© í¬íŠ¸ (í–¥í›„ í™•ì¥)
      - "8080:8080"
    tty: true
    stdin_open: true
    depends_on:
      rabbitmq:
        condition: service_started
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - ENV_STAGE=${ENV_STAGE:-dev}
      - BUILD_TYPE=${BUILD_TYPE:-Debug}
      - ANTHROPIC_API_KEY_FILE=./secrets/anthropic_api_key
      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ ì„¤ì •
      - LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:/lib
      - PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/lib/pkgconfig
      # ë“œë¼ì´ë²„ ì„¤ì •
      - DRIVER_CONFIG_PATH=/app/config/drivers
      - LOG_LEVEL=${LOG_LEVEL:-debug}
      - ENABLE_PACKET_LOGGING=${ENABLE_PACKET_LOGGING:-true}
      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=pulseone
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - INFLUX_HOST=influx
      - INFLUX_PORT=8086
      - INFLUX_TOKEN=mytoken
      - INFLUX_ORG=pulseone
      - INFLUX_BUCKET=metrics
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=admin
      - RABBITMQ_PASS=admin
    command: >
      bash -c "
        echo 'ğŸ”§ PulseOne Collector Development Environment'
        echo '============================================='
        
        # ANTHROPIC API í‚¤ ë¡œë“œ
        if [ -f /app/secrets/anthropic_api_key ]; then
          export ANTHROPIC_API_KEY=\$$(cat /app/secrets/anthropic_api_key)
          echo 'âœ… ANTHROPIC_API_KEY loaded from secrets'
        else
          echo 'âš ï¸  ANTHROPIC_API_KEY file not found'
        fi
        
        # ì‹œìŠ¤í…œ ì •ë³´ ì¶œë ¥
        echo ''
        echo 'ğŸ“‹ System Information:'
        echo \"  OS: \$$(uname -s) \$$(uname -r)\"
        echo \"  Compiler: \$$(g++ --version 2>/dev/null | head -n1 || echo 'Not found')\"
        echo \"  Build Type: \$$BUILD_TYPE\"
        echo \"  Log Level: \$$LOG_LEVEL\"
        echo ''
        
        # ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ ì²´í¬
        echo 'ğŸ“š Library Status:'
        if pkg-config --exists libmodbus 2>/dev/null; then
          VERSION=\$$(pkg-config --modversion libmodbus 2>/dev/null || echo 'unknown')
          echo \"  âœ… libmodbus: \$$VERSION\"
        else
          echo '  âŒ libmodbus: Not found'
        fi
        [ -f /usr/local/include/MQTTClient.h ] && echo '  âœ… Paho MQTT C: Found' || echo '  âŒ Paho MQTT C: Not found'
        [ -f /usr/local/include/mqtt/client.h ] && echo '  âœ… Paho MQTT C++: Found' || echo '  âŒ Paho MQTT C++: Not found'
        [ -d /usr/local/include/bacnet ] && echo '  âœ… BACnet Stack: Found' || echo '  âŒ BACnet Stack: Not found'
        echo ''
        
        # ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì²´í¬
        echo 'ğŸŒ Service Connectivity:'
        timeout 5 bash -c '</dev/tcp/postgres/5432' 2>/dev/null && echo '  âœ… PostgreSQL: Connected' || echo '  âŒ PostgreSQL: Not reachable'
        timeout 5 bash -c '</dev/tcp/redis/6379' 2>/dev/null && echo '  âœ… Redis: Connected' || echo '  âŒ Redis: Not reachable'
        timeout 5 bash -c '</dev/tcp/influx/8086' 2>/dev/null && echo '  âœ… InfluxDB: Connected' || echo '  âŒ InfluxDB: Not reachable'
        timeout 5 bash -c '</dev/tcp/rabbitmq/5672' 2>/dev/null && echo '  âœ… RabbitMQ: Connected' || echo '  âŒ RabbitMQ: Not reachable'
        echo ''
        
        # ì„¤ì • íŒŒì¼ ì²´í¬
        echo 'âš™ï¸  Configuration Files:'
        [ -f /app/config/.env.dev ] && echo '  âœ… Environment: /app/config/.env.dev' || echo '  âŒ Environment: Not found'
        [ -f /app/config/drivers/drivers.conf ] && echo '  âœ… Drivers: /app/config/drivers/drivers.conf' || echo '  âš ï¸  Drivers: Using default config'
        [ -f /app/config/drivers/drivers.dev.conf ] && echo '  âœ… Dev Drivers: /app/config/drivers/drivers.dev.conf' || echo '  âš ï¸  Dev Drivers: Not found'
        echo ''
        
        # ë¹Œë“œ ìƒíƒœ ì²´í¬
        echo 'ğŸ”¨ Build Status:'
        if [ -f /app/collector/bin/pulseone-collector ]; then
          FILE_SIZE=\$$(ls -lh /app/collector/bin/pulseone-collector 2>/dev/null | awk '{print \$$5}' || echo 'N/A')
          echo \"  âœ… Executable: Found (\$$FILE_SIZE)\"
        else
          echo '  âŒ Executable: Not built'
        fi
        [ -f /app/collector/Makefile ] && echo '  âœ… Makefile: Found' || echo '  âŒ Makefile: Not found'
        echo ''
        
        echo 'ğŸš€ Available Commands:'
        echo '  make info           - Show detailed build information'
        echo '  make deps           - Install/update dependencies'
        echo '  make clean          - Clean build files'
        echo '  make debug          - Build in debug mode'
        echo '  make release        - Build in release mode'
        echo '  make drivers        - Build driver plugins'
        echo '  make tests          - Build and run tests'
        echo '  make run            - Build and run collector'
        echo '  make ci             - Run full CI pipeline'
        echo '  make docker-logs    - Show collector logs'
        echo '  claude-code         - Use Claude Code CLI'
        echo ''
        echo 'ğŸ”§ Development Workflow:'
        echo '  1. make deps        # Install dependencies (if needed)'
        echo '  2. make clean       # Clean previous builds'
        echo '  3. make debug       # Build in debug mode'
        echo '  4. make run         # Run the collector'
        echo ''
        echo 'ğŸ’¡ Tips:'
        echo '  - Use Ctrl+C to stop running processes'
        echo '  - Use \"docker-compose logs collector\" to view logs'
        echo '  - Configuration files are in /app/config/'
        echo '  - Driver configs are in /app/config/drivers/'
        echo ''
        
        /bin/bash
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep pulseone-collector || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # ë¦¬ì†ŒìŠ¤ ì œí•œ (ê°œë°œ í™˜ê²½)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    # ë¡œê·¸ ì„¤ì •
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
  # ============================================================================
  postgres:
    image: postgres:15
    container_name: pulseone-postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: pulseone
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ë¡œë“œ (ìˆë‹¤ë©´)
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # InfluxDB ì‹œê³„ì—´ ë°ì´í„°ë² ì´ìŠ¤
  # ============================================================================
  influx:
    image: influxdb:2.7
    container_name: pulseone-influx
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpass
      - DOCKER_INFLUXDB_INIT_ORG=pulseone
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mytoken
    volumes:
      - influx_data:/var/lib/influxdb2

  # ============================================================================
  # Redis ìºì‹œ ë°ì´í„°ë² ì´ìŠ¤
  # ============================================================================
  redis:
    image: redis:alpine
    container_name: pulseone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # RabbitMQ ë©”ì‹œì§€ í
  # ============================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: pulseone-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"    # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  # ============================================================================
  # ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ë“¤ (ì„ íƒì )
  # ============================================================================
  monitoring:
    image: prom/prometheus:latest
    container_name: pulseone-monitoring
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    profiles:
      - monitoring

  loki:
    image: grafana/loki:latest
    container_name: pulseone-loki
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/tmp/loki
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: pulseone-grafana
    ports:
      - "3001:3000"    # í¬íŠ¸ ì¶©ëŒ ë°©ì§€ (backendê°€ 3000 ì‚¬ìš©)
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    profiles:
      - monitoring

# ============================================================================
# ë³¼ë¥¨ ì •ì˜
# ============================================================================
volumes:
  claude_cache:
    driver: local
  postgres_data:
    driver: local
  influx_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  # Collector ê´€ë ¨ ë³¼ë¥¨ë“¤
  collector_libs:
    driver: local
  collector_includes:
    driver: local
  # ëª¨ë‹ˆí„°ë§ ê´€ë ¨ ë³¼ë¥¨ë“¤
  prometheus_data:
    driver: local
  loki_data:
    driver: local
  grafana_data:
    driver: local

# ============================================================================
# ë„¤íŠ¸ì›Œí¬ ì •ì˜ (ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©)
# ============================================================================
networks:
  default:
    driver: bridge