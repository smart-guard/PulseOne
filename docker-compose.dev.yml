version: '3.8'

services:
  influxdb:
    image: influxdb:2.7
    container_name: pulseone-influxdb
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - pulseone_network

  postgres:
    image: postgres:14
    container_name: pulseone-postgres
    environment:
      - POSTGRES_DB=pulseone
      - POSTGRES_USER=pulseone
      - POSTGRES_PASSWORD=pulseone
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U pulseone -d pulseone" ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/sql/schema_postgres_minimal.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - pulseone_network

  redis:
    image: redis:alpine
    container_name: pulseone-redis
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - pulseone_network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: pulseone-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
      - "1883:1883"
    networks:
      - pulseone_network

  export-gateway:
    build:
      context: .
      dockerfile: core/export-gateway/Dockerfile.dev
    container_name: pulseone-export-gateway
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 1G
    command: tail -f /dev/null
    tty: true
    restart: always
    environment:
      - REDIS_PRIMARY_HOST=redis
      - REDIS_PRIMARY_PORT=6379
      - DATABASE_TYPE=SQLITE
      - SQLITE_PATH=/app/data/db/pulseone.db
      - LOG_LEVEL=debug
      - PULSEONE_CONFIG_DIR=/app/config
      - PULSEONE_DATA_DIR=/app/data
      - AUTO_RUN=false
    volumes:
      - ./core:/app/core
      - ./config:/app/config
      - ./data:/app/data
      - ./logs:/app/logs
      - shared_libs:/app/core/shared/lib
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - pulseone_network

networks:
  pulseone_network:
    driver: bridge

volumes:
  influxdb_data:
  shared_libs:
