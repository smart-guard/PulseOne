version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15
    container_name: pulseone-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./data/sql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: pulseone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # InfluxDB
  influxdb:
    image: influxdb:2.7
    container_name: pulseone-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influxpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-pulseone}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-timeseries}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: pulseone-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq123}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # Backend (Node.js)
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    container_name: pulseone-backend-dev
    working_dir: /app
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      NODE_ENV: development
      ENV_STAGE: ${ENV_STAGE:-dev}
      # ğŸ”¥ Backendìš© ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      # ğŸ”¥ Backendìš© Redis ì—°ê²° ì •ë³´
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      # ğŸ”¥ Backendìš© ê¸°íƒ€ ì„œë¹„ìŠ¤
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
      INFLUX_ORG: ${INFLUX_ORG:-pulseone}
      INFLUX_BUCKET: ${INFLUX_BUCKET:-timeseries}
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-rabbitmq}:${RABBITMQ_PASSWORD:-rabbitmq123}@rabbitmq:5672
      BACKEND_PORT: 3000
    ports:
      - "3000:3000"
      - "9229:9229"  # Node.js debugging port
    volumes:
      - ./backend:/app/backend
      - ./config:/app/config
      - ./secrets:/app/secrets
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone_network
    command: >
      bash -c "
        echo 'ğŸš€ PulseOne Backend Development Environment'
        echo '============================================='
        
        # í™˜ê²½ í™•ì¸
        echo 'ğŸ“‹ Environment Info:'
        echo \"  NODE_ENV: \$NODE_ENV\"
        echo \"  ENV_STAGE: \$ENV_STAGE\"
        echo \"  Backend Port: \$BACKEND_PORT\"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
        echo 'ğŸŒ Service Connectivity Check:'
        timeout 5 bash -c '</dev/tcp/postgres/5432' && echo '  âœ… PostgreSQL: Connected' || echo '  âŒ PostgreSQL: Failed'
        timeout 5 bash -c '</dev/tcp/redis/6379' && echo '  âœ… Redis: Connected' || echo '  âŒ Redis: Failed'
        timeout 5 bash -c '</dev/tcp/influxdb/8086' && echo '  âœ… InfluxDB: Connected' || echo '  âŒ InfluxDB: Failed'
        timeout 5 bash -c '</dev/tcp/rabbitmq/5672' && echo '  âœ… RabbitMQ: Connected' || echo '  âŒ RabbitMQ: Failed'
        
        # npm ì˜ì¡´ì„± ì„¤ì¹˜
        cd /app/backend
        if [ ! -d node_modules ]; then
          echo 'ğŸ“¦ Installing npm dependencies...'
          npm install
        fi
        
        # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
        echo 'ğŸ” Validating environment variables...'
        node scripts/validate-env.js || echo 'âš ï¸ Environment validation failed'
        
        # ê°œë°œ ì„œë²„ ì‹œì‘
        echo 'ğŸš€ Starting Backend Development Server...'
        npm run dev
      "

  # Frontend (React + TypeScript + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: pulseone-frontend-dev
    working_dir: /app
    environment:
      NODE_ENV: development
      ENV_STAGE: ${ENV_STAGE:-dev}
      VITE_API_BASE_URL: http://localhost:3000/api
      VITE_WEBSOCKET_URL: ws://localhost:3000
      CHOKIDAR_USEPOLLING: "true"
      VITE_HMR_HOST: 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - pulseone_network
    command: >
      bash -c "
        echo 'ğŸ¨ PulseOne Frontend Development Environment'
        echo '============================================='
        
        # npm ì˜ì¡´ì„± ì„¤ì¹˜
        if [ ! -d node_modules ]; then
          echo 'ğŸ“¦ Installing npm dependencies...'
          npm install
        fi
        
        # ê°œë°œ ì„œë²„ ì‹œì‘
        echo 'ğŸš€ Starting Frontend Development Server...'
        npm run dev -- --host 0.0.0.0
      "

  # Collector (C++)
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile.dev
    container_name: pulseone-collector-dev
    tty: true
    stdin_open: true
    working_dir: /app
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      # ğŸ”¥ Build ê´€ë ¨ í™˜ê²½ë³€ìˆ˜
      BUILD_TYPE: Debug
      LOG_LEVEL: debug
      ENV_STAGE: ${ENV_STAGE:-dev}
      AUTO_BUILD: "true"
      AUTO_RUN: "false"
      
      # ğŸ”¥ C++ Collectorìš© ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ (ì¤‘ìš”!)
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      
      # ğŸ”¥ Redis ì—°ê²° ì •ë³´ (Docker í™˜ê²½ ìë™ ê°ì§€)
      REDIS_HOST: redis                      # Docker Compose ë‚´ë¶€ ì„œë¹„ìŠ¤ëª…
      REDIS_HOST_EXTERNAL: host.docker.internal  # ì™¸ë¶€ Mac/Windows ì ‘ê·¼ìš©
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ""
      REDIS_SSL: "false"
      REDIS_TEST_MODE: "true"
      REDIS_FLUSH_ON_START: "false"
      REDIS_AUTO_PING: "true"
      REDIS_PING_INTERVAL_S: 30
      REDIS_CONNECTION_TIMEOUT_MS: 5000
      REDIS_COMMAND_TIMEOUT_MS: 3000
      REDIS_MAX_CONNECTIONS: 20
      REDIS_MIN_CONNECTIONS: 5
      REDIS_RETRY_ATTEMPTS: 3
      REDIS_RETRY_DELAY_MS: 1000
      
      # ğŸ”¥ InfluxDB ì—°ê²° ì •ë³´
      INFLUXDB_HOST: influxdb
      INFLUXDB_PORT: 8086
      INFLUXDB_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
      INFLUXDB_ORG: ${INFLUX_ORG:-pulseone}
      INFLUXDB_BUCKET: ${INFLUX_BUCKET:-timeseries}
      
      # ğŸ”¥ RabbitMQ ì—°ê²° ì •ë³´
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-rabbitmq123}
      
      # ğŸ”¥ SQLite (ê°œë°œìš© ë°±ì—… DB)
      SQLITE_PATH: /app/data/pulseone.db
      DATABASE_TYPE: sqlite
    volumes:
      - ./collector:/app/collector
      - ./config:/app/config
      - ./secrets:/app/secrets
      - ./logs:/app/logs
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone_network
    command: >
      bash -c "
        echo 'ğŸ”§ PulseOne Collector Development Environment'
        echo '============================================='
        
        # ğŸ”¥ Docker Redis ì„¤ì • ìë™ ì ìš©
        echo 'ğŸ” Redis ì—°ê²° í™˜ê²½ ìë™ ì„¤ì •:'
        if timeout 3 bash -c '</dev/tcp/redis/6379' 2>/dev/null; then
          echo 'âœ… ë‚´ë¶€ Redis ì„œë¹„ìŠ¤ ì—°ê²° ì„±ê³µ (redis:6379)'
          export REDIS_HOST=redis
        elif timeout 3 bash -c '</dev/tcp/host.docker.internal/6379' 2>/dev/null; then
          echo 'âœ… ì™¸ë¶€ Redis ì„œë¹„ìŠ¤ ì—°ê²° ì„±ê³µ (host.docker.internal:6379)'
          export REDIS_HOST=host.docker.internal
        else
          echo 'âŒ Redis ì—°ê²° ì‹¤íŒ¨ - ê¸°ë³¸ê°’ ì‚¬ìš© (redis)'
          export REDIS_HOST=redis
        fi
        
        echo \"ğŸ“ ìµœì¢… Redis ì„¤ì •: \$REDIS_HOST:6379\"
        
        # í™˜ê²½ ì •ë³´ ì¶œë ¥
        if [ -f /app/secrets/anthropic_api_key ]; then
          export ANTHROPIC_API_KEY=\$$(cat /app/secrets/anthropic_api_key)
          echo 'âœ… Claude Code API Key ë¡œë“œë¨'
        fi
        
        echo 'ğŸ“‹ System Info:'
        echo \"  OS: \$$(uname -s) \$$(uname -r)\"
        echo \"  Compiler: \$$(g++ --version | head -n1)\"
        echo \"  Build Type: \$BUILD_TYPE\"
        echo \"  Working Dir: \$$(pwd)\"
        
        # ğŸ”¥ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • í™•ì¸
        echo 'ğŸ—„ï¸ Database Configuration:'
        echo \"  DATABASE_TYPE: \$DATABASE_TYPE\"
        echo \"  POSTGRES_HOST: \$POSTGRES_HOST:\$POSTGRES_PORT\"
        echo \"  REDIS_HOST: \$REDIS_HOST:\$REDIS_PORT\"
        echo \"  INFLUXDB_HOST: \$INFLUXDB_HOST:\$INFLUXDB_PORT\"
        echo \"  SQLITE_PATH: \$SQLITE_PATH\"
        
        # SQLite íŒŒì¼ í™•ì¸
        if [ -f \"\$SQLITE_PATH\" ]; then
          echo \"  âœ… SQLite file found: \$SQLITE_PATH\"
          sqlite3 \"\$SQLITE_PATH\" 'SELECT COUNT(*) as device_count FROM devices;' 2>/dev/null && echo \"  ğŸ“Š SQLite accessible\" || echo \"  âš ï¸ SQLite query failed\"
        else
          echo \"  âŒ SQLite file not found: \$SQLITE_PATH\"
          echo \"  ğŸ“ Creating SQLite file...\"
          mkdir -p \$(dirname \"\$SQLITE_PATH\")
          touch \"\$SQLITE_PATH\"
        fi
        
        # ğŸ”¥ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ í™•ì¸
        echo 'ğŸ“š Library Status:'
        pkg-config --exists libmodbus && echo \"  âœ… libmodbus: \$$(pkg-config --modversion libmodbus)\" || echo '  âŒ libmodbus'
        [ -f /usr/local/lib/libhiredis.so ] && echo '  âœ… hiredis: Found' || echo '  âŒ hiredis'
        [ -f /usr/local/include/MQTTClient.h ] && echo '  âœ… Paho MQTT C: Found' || echo '  âŒ Paho MQTT C'
        [ -f /usr/local/include/mqtt/async_client.h ] && echo '  âœ… Paho MQTT C++: Found' || echo '  âŒ Paho MQTT C++'
        [ -d /usr/local/include/bacnet ] && echo '  âœ… BACnet: Found' || echo '  âŒ BACnet'
        [ -f /usr/local/lib/libbacnet.a ] && echo \"  âœ… BACnet library: \$(du -h /usr/local/lib/libbacnet.a | cut -f1)\" || echo '  âŒ BACnet library'
        
        # ğŸ”¥ ì„œë¹„ìŠ¤ ì—°ê²° í™•ì¸
        echo 'ğŸŒ Service Connectivity:'
        timeout 5 bash -c '</dev/tcp/postgres/5432' 2>/dev/null && echo '  âœ… PostgreSQL' || echo '  âŒ PostgreSQL'
        timeout 5 bash -c '</dev/tcp/redis/6379' 2>/dev/null && echo '  âœ… Redis' || echo '  âŒ Redis'
        timeout 5 bash -c '</dev/tcp/influxdb/8086' 2>/dev/null && echo '  âœ… InfluxDB' || echo '  âŒ InfluxDB'
        timeout 5 bash -c '</dev/tcp/rabbitmq/5672' 2>/dev/null && echo '  âœ… RabbitMQ' || echo '  âŒ RabbitMQ'
        
        # ğŸ”¥ ìë™ ë¹Œë“œ
        if [ \"\$AUTO_BUILD\" = \"true\" ]; then
          echo 'ğŸ”¨ Starting automatic build...'
          cd /app/collector
          
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
          echo 'ğŸ“ Creating required directories...'
          mkdir -p include/Core src/Core include/Drivers src/Drivers bin obj tests/bin
          
          echo 'ğŸ”§ Building collector with environment variables...'
          make clean 2>/dev/null || true
          
          # ğŸ”¥ í™˜ê²½ë³€ìˆ˜ë¥¼ Makefileì— ì „ë‹¬
          if make debug REDIS_HOST=\$REDIS_HOST POSTGRES_HOST=\$POSTGRES_HOST INFLUX_HOST=\$INFLUXDB_HOST; then
            echo 'âœ… Build successful!'
            
            # ìë™ ì‹¤í–‰
            if [ \"\$AUTO_RUN\" = \"true\" ]; then
              echo 'ğŸš€ Starting collector...'
              make run
            else
              echo 'ğŸ’¡ Build completed. Use \"make run\" to start collector.'
            fi
          else
            echo 'âŒ Build failed. Check the error messages above.'
            echo 'ğŸ’¡ You can still access the container to debug:'
            echo '   docker exec -it pulseone-collector-dev bash'
          fi
        fi
        
        echo ''
        echo 'ğŸš€ Available Commands:'
        echo '  dev-build.sh              - ê°œë°œ ë¹Œë“œ (Redis ì„¤ì • ìë™ ì ìš©)'
        echo '  setup-docker-redis.sh     - Redis ì„¤ì • ìë™ êµ¬ì„±'
        echo '  test-redis-connection.sh  - Redis ì—°ê²° í…ŒìŠ¤íŠ¸'
        echo '  test-bacnet-symbols.sh    - BACnet ì‹¬ë³¼ í…ŒìŠ¤íŠ¸'
        echo '  make clean && make debug  - Manual build'
        echo '  make test                 - Run tests'
        echo '  make help                 - Makefile help'
        echo ''
        echo 'ğŸ“Š Database Commands:'
        echo '  sqlite3 \$SQLITE_PATH     - Access SQLite database'
        echo '  sqlite3 \$SQLITE_PATH \".tables\"  - List tables'
        echo ''
        echo 'ğŸš€ PulseOne Collector Development Environment Ready!'
        echo 'ğŸ’¡ Use: docker exec -it pulseone-collector-dev bash'
        
        # ë¬´í•œ ëŒ€ê¸° (ì»¨í…Œì´ë„ˆ ìœ ì§€)
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f pulseone-collector || test -f /app/collector/bin/collector"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  pulseone_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  influxdb_config:
  rabbitmq_data: