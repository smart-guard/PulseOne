version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15
    container_name: pulseone-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./data/sql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: pulseone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pulseone_network

  # InfluxDB
  influxdb:
    image: influxdb:2.7
    container_name: pulseone-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-influxpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-pulseone}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-timeseries}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: pulseone-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq123}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - pulseone_network

  # Backend (Node.js)
  # Backend (Node.js) - ê¸°ì¡´ í™˜ê²½ë³€ìˆ˜ êµ¬ì¡°ì— ë§ì¶¤
# Backend (Node.js) - ìŠ¤ë§ˆíŠ¸ ìë™ ì‹œì‘
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    container_name: pulseone-backend-dev
    working_dir: /app
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      NODE_ENV: development
      ENV_STAGE: ${ENV_STAGE:-dev}
      BACKEND_PORT: 3000
      DATABASE_TYPE: SQLITE
      SQLITE_DB_PATH: ./data/db/pulseone.db
      REDIS_PRIMARY_ENABLED: "false"
      REDIS_PRIMARY_HOST: redis
      REDIS_PRIMARY_PORT: 6379
    ports:
      - "3000:3000"
      - "9229:9229"
    volumes:
      - ./backend:/app/backend
      - ./config:/app/config
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pulseone_network
    # ğŸš€ ìŠ¤ë§ˆíŠ¸ ìë™ ì‹œì‘ (í¬íŠ¸ ì¶©ëŒ ì‹œ ë‹¤ë¥¸ í¬íŠ¸ ì‚¬ìš©)
    command: >
      sh -c '
        echo "ğŸš€ PulseOne Backend Container Starting..."
        
        # ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p /app/data/db /app/data/backup /app/data/logs /app/data/temp
        
        # ì˜ì¡´ì„± í™•ì¸
        cd /app/backend
        if [ ! -d node_modules ]; then
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install
        fi
        
        # í¬íŠ¸ ì‚¬ìš© ì²´í¬ ë° ìë™ ì¡°ì •
        if netstat -tuln | grep -q ":3000 "; then
          echo "âš ï¸  í¬íŠ¸ 3000ì´ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. í¬íŠ¸ 3001ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
          export BACKEND_PORT=3001
        else
          export BACKEND_PORT=3000
        fi
        
        echo "ğŸš€ Starting server on port $$BACKEND_PORT..."
        npm run dev
      '

  # Frontend (React + TypeScript + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: pulseone-frontend-dev
    working_dir: /app
    environment:
      NODE_ENV: development
      ENV_STAGE: ${ENV_STAGE:-dev}
      VITE_API_BASE_URL: http://localhost:3000/api
      VITE_WEBSOCKET_URL: ws://localhost:3000
      CHOKIDAR_USEPOLLING: "true"
      VITE_HMR_HOST: 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - pulseone_network
    command: >
      sh -c '
        echo "ğŸ¨ PulseOne Frontend Development Environment"
        echo "============================================="
        
        # npm ì˜ì¡´ì„± ì„¤ì¹˜
        if [ ! -d node_modules ]; then
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install
        fi
        
        # ê°œë°œ ì„œë²„ ì‹œì‘
        echo "ğŸš€ Starting Frontend Development Server..."
        npm run dev -- --host 0.0.0.0
      '

  # Collector (C++)
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile.dev
    container_name: pulseone-collector-dev
    tty: true
    stdin_open: true
    working_dir: /app
    env_file:
      - ./config/.env
      - ./config/database.env
      - ./config/redis.env  # redis.envì˜ ë³€ìˆ˜ëª…ë“¤ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      - ./config/timeseries.env
      - ./config/messaging.env
    environment:
      # Build ê´€ë ¨ í™˜ê²½ë³€ìˆ˜
      BUILD_TYPE: Debug
      LOG_LEVEL: debug
      ENV_STAGE: ${ENV_STAGE:-dev}
      AUTO_BUILD: "true"
      AUTO_RUN: "false"
      
      # PostgreSQL (database.envì—ì„œ ë¡œë“œë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
      POSTGRES_DB: ${POSTGRES_DB:-pulseone}
      
      # InfluxDB (timeseries.envì—ì„œ ë¡œë“œë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ)
      INFLUXDB_HOST: influxdb
      INFLUXDB_PORT: 8086
      INFLUXDB_TOKEN: ${INFLUX_TOKEN:-my-super-secret-auth-token}
      INFLUXDB_ORG: ${INFLUX_ORG:-pulseone}
      INFLUXDB_BUCKET: ${INFLUX_BUCKET:-timeseries}
      
      # RabbitMQ (messaging.envì—ì„œ ë¡œë“œë˜ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ)
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-rabbitmq123}
      
      # SQLite (ê°œë°œìš© ë°±ì—… DB)
      SQLITE_PATH: /app/data/pulseone.db
      DATABASE_TYPE: sqlite
      
      # RedisëŠ” redis.env íŒŒì¼ì˜ ë³€ìˆ˜ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      # REDIS_PRIMARY_HOSTë¥¼ Docker ë‚´ë¶€ ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ
      REDIS_PRIMARY_HOST: redis  # pulseone-redis ëŒ€ì‹  ì„œë¹„ìŠ¤ëª… ì‚¬ìš©
      
    volumes:
      - ./collector:/app/collector
      - ./config:/app/config
      - ./secrets:/app/secrets
      - ./logs:/app/logs
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - pulseone_network
    command: >
      bash -c '
        echo "ğŸ”§ PulseOne Collector Development Environment"
        echo "============================================="
        
        # Redis ì—°ê²° í™˜ê²½ ìë™ ì„¤ì • (redis.envì˜ ë³€ìˆ˜ëª… ì‚¬ìš©)
        echo "ğŸ” Redis ì—°ê²° í™˜ê²½ ìë™ ì„¤ì •:"
        if timeout 3 bash -c "</dev/tcp/redis/6379" 2>/dev/null; then
          echo "âœ… ë‚´ë¶€ Redis ì„œë¹„ìŠ¤ ì—°ê²° ì„±ê³µ (redis:6379)"
          export REDIS_PRIMARY_HOST=redis
        elif timeout 3 bash -c "</dev/tcp/host.docker.internal/6379" 2>/dev/null; then
          echo "âœ… ì™¸ë¶€ Redis ì„œë¹„ìŠ¤ ì—°ê²° ì„±ê³µ (host.docker.internal:6379)"
          export REDIS_PRIMARY_HOST=host.docker.internal
        else
          echo "âŒ Redis ì—°ê²° ì‹¤íŒ¨ - ê¸°ë³¸ê°’ ì‚¬ìš© (redis)"
          export REDIS_PRIMARY_HOST=redis
        fi
        
        echo "ğŸ“ ìµœì¢… Redis ì„¤ì •: $REDIS_PRIMARY_HOST:$REDIS_PRIMARY_PORT"
        
        # API Key ë¡œë“œ
        if [ -f /app/secrets/anthropic_api_key ]; then
          export ANTHROPIC_API_KEY=$(cat /app/secrets/anthropic_api_key)
          echo "âœ… Claude Code API Key ë¡œë“œë¨"
        fi
        
        echo "ğŸ“‹ System Info:"
        echo "  OS: $(uname -s) $(uname -r)"
        echo "  Compiler: $(g++ --version | head -n1)"
        echo "  Build Type: $BUILD_TYPE"
        echo "  Working Dir: $(pwd)"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • í™•ì¸
        echo "ğŸ—„ï¸ Database Configuration:"
        echo "  DATABASE_TYPE: $DATABASE_TYPE"
        echo "  POSTGRES_HOST: $POSTGRES_HOST:$POSTGRES_PORT"
        echo "  REDIS_PRIMARY_HOST: $REDIS_PRIMARY_HOST:$REDIS_PRIMARY_PORT"
        echo "  REDIS_PRIMARY_DB: $REDIS_PRIMARY_DB"
        echo "  REDIS_POOL_SIZE: $REDIS_POOL_SIZE"
        echo "  REDIS_KEY_PREFIX: $REDIS_KEY_PREFIX"
        echo "  INFLUXDB_HOST: $INFLUXDB_HOST:$INFLUXDB_PORT"
        echo "  SQLITE_PATH: $SQLITE_PATH"
        
        # SQLite íŒŒì¼ í™•ì¸
        if [ -f "$SQLITE_PATH" ]; then
          echo "  âœ… SQLite file found: $SQLITE_PATH"
          sqlite3 "$SQLITE_PATH" "SELECT COUNT(*) as device_count FROM devices;" 2>/dev/null && echo "  ğŸ“Š SQLite accessible" || echo "  âš ï¸ SQLite query failed"
        else
          echo "  âŒ SQLite file not found: $SQLITE_PATH"
          echo "  ğŸ“ Creating SQLite file..."
          mkdir -p $(dirname "$SQLITE_PATH")
          touch "$SQLITE_PATH"
        fi
        
        # ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ í™•ì¸
        echo "ğŸ“š Library Status:"
        pkg-config --exists libmodbus && echo "  âœ… libmodbus: $(pkg-config --modversion libmodbus)" || echo "  âŒ libmodbus"
        [ -f /usr/local/lib/libhiredis.so ] && echo "  âœ… hiredis: Found" || echo "  âŒ hiredis"
        [ -f /usr/local/include/MQTTClient.h ] && echo "  âœ… Paho MQTT C: Found" || echo "  âŒ Paho MQTT C"
        [ -f /usr/local/include/mqtt/async_client.h ] && echo "  âœ… Paho MQTT C++: Found" || echo "  âŒ Paho MQTT C++"
        [ -d /usr/local/include/bacnet ] && echo "  âœ… BACnet: Found" || echo "  âŒ BACnet"
        [ -f /usr/local/lib/libbacnet.a ] && echo "  âœ… BACnet library: $(du -h /usr/local/lib/libbacnet.a | cut -f1)" || echo "  âŒ BACnet library"
        
        # ì„œë¹„ìŠ¤ ì—°ê²° í™•ì¸
        echo "ğŸŒ Service Connectivity:"
        timeout 5 bash -c "</dev/tcp/postgres/5432" 2>/dev/null && echo "  âœ… PostgreSQL" || echo "  âŒ PostgreSQL"
        timeout 5 bash -c "</dev/tcp/$REDIS_PRIMARY_HOST/$REDIS_PRIMARY_PORT" 2>/dev/null && echo "  âœ… Redis" || echo "  âŒ Redis"
        timeout 5 bash -c "</dev/tcp/influxdb/8086" 2>/dev/null && echo "  âœ… InfluxDB" || echo "  âŒ InfluxDB"
        timeout 5 bash -c "</dev/tcp/rabbitmq/5672" 2>/dev/null && echo "  âœ… RabbitMQ" || echo "  âŒ RabbitMQ"
        
        # ìë™ ë¹Œë“œ
        if [ "$AUTO_BUILD" = "true" ]; then
          echo "ğŸ”¨ Starting automatic build..."
          cd /app/collector
          
          # í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±
          echo "ğŸ“ Creating required directories..."
          mkdir -p include/Core src/Core include/Drivers src/Drivers bin obj tests/bin
          
          echo "ğŸ”§ Building collector with environment variables..."
          make clean 2>/dev/null || true
          
          # í™˜ê²½ë³€ìˆ˜ë¥¼ Makefileì— ì „ë‹¬ (redis.envì˜ ë³€ìˆ˜ëª… ì‚¬ìš©)
          if make debug REDIS_HOST=$REDIS_PRIMARY_HOST POSTGRES_HOST=$POSTGRES_HOST INFLUX_HOST=$INFLUXDB_HOST; then
            echo "âœ… Build successful!"
            
            # ìë™ ì‹¤í–‰
            if [ "$AUTO_RUN" = "true" ]; then
              echo "ğŸš€ Starting collector..."
              make run
            else
              echo "ğŸ’¡ Build completed. Use make run to start collector."
            fi
          else
            echo "âŒ Build failed. Check the error messages above."
            echo "ğŸ’¡ You can still access the container to debug:"
            echo "   docker exec -it pulseone-collector-dev bash"
          fi
        fi
        
        echo ""
        echo "ğŸš€ Available Commands:"
        echo "  dev-build.sh              - ê°œë°œ ë¹Œë“œ (Redis ì„¤ì • ìë™ ì ìš©)"
        echo "  setup-docker-redis.sh     - Redis ì„¤ì • ìë™ êµ¬ì„±"
        echo "  test-redis-connection.sh  - Redis ì—°ê²° í…ŒìŠ¤íŠ¸"
        echo "  test-bacnet-symbols.sh    - BACnet ì‹¬ë³¼ í…ŒìŠ¤íŠ¸"
        echo "  make clean && make debug  - Manual build"
        echo "  make test                 - Run tests"
        echo "  make help                 - Makefile help"
        echo ""
        echo "ğŸ“Š Database Commands:"
        echo "  sqlite3 \$SQLITE_PATH     - Access SQLite database"
        echo "  sqlite3 \$SQLITE_PATH .tables  - List tables"
        echo ""
        echo "ğŸ” Redis Test Commands:"
        echo "  redis-cli -h \$REDIS_PRIMARY_HOST -p \$REDIS_PRIMARY_PORT ping"
        echo "  redis-cli -h \$REDIS_PRIMARY_HOST -p \$REDIS_PRIMARY_PORT --scan --pattern \"\$REDIS_KEY_PREFIX*\""
        echo ""
        echo "ğŸš€ PulseOne Collector Development Environment Ready!"
        echo "ğŸ’¡ Use: docker exec -it pulseone-collector-dev bash"
        
        # ë¬´í•œ ëŒ€ê¸° (ì»¨í…Œì´ë„ˆ ìœ ì§€)
        tail -f /dev/null
      '
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f pulseone-collector || test -f /app/collector/bin/collector"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  pulseone_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  influxdb_data:
  influxdb_config:
  rabbitmq_data: