# ============================================================================
# PulseOne Collector Development Dockerfile (ìƒˆ í´ë” êµ¬ì¡° ì§€ì›)
# ============================================================================

FROM gcc:latest

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Seoul
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# ============================================================================
# 1ë‹¨ê³„: í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
# ============================================================================
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libpqxx-dev libpq-dev libsqlite3-dev \
    curl git nodejs npm pkg-config \
    autoconf automake libtool uuid-dev libssl-dev \
    wget unzip gdb valgrind vim nano tree htop \
    netcat-openbsd telnet iputils-ping \
    libhiredis-dev libjson-c-dev libconfig-dev \
    libcurl4-openssl-dev libmodbus-dev \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ============================================================================
# 2ë‹¨ê³„: Claude Code ì„¤ì¹˜
# ============================================================================
RUN npm install -g @anthropic-ai/claude-code || echo "âš ï¸  Claude Code installation failed"

# ============================================================================
# 3ë‹¨ê³„: ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ ì„¤ì •
# ============================================================================
ENV LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:/lib
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig

# ============================================================================
# 4ë‹¨ê³„: Paho MQTT C ì„¤ì¹˜ (ì•ˆì •í™” ë²„ì „)
# ============================================================================
RUN echo "ğŸ”§ Installing Paho MQTT C..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_WITH_SSL=ON -DPAHO_ENABLE_TESTING=OFF \
             -DPAHO_BUILD_STATIC=ON -DPAHO_BUILD_SHARED=ON -DCMAKE_C_STANDARD=11 && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.c && echo "âœ… Paho MQTT C installed"

# ============================================================================
# 5ë‹¨ê³„: Paho MQTT C++ ì„¤ì¹˜
# ============================================================================
RUN echo "ğŸ”§ Installing Paho MQTT C++..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.2 https://github.com/eclipse/paho.mqtt.cpp.git && \
    cd paho.mqtt.cpp && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_BUILD_SAMPLES=OFF -DPAHO_BUILD_TESTS=OFF \
             -DPAHO_BUILD_STATIC=ON -DPAHO_BUILD_SHARED=ON -DCMAKE_CXX_STANDARD=17 && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.cpp && echo "âœ… Paho MQTT C++ installed"

# ============================================================================
# 6ë‹¨ê³„: BACnet í—¤ë”ë§Œ ì„¤ì¹˜ (ì•ˆì •ì„± ìš°ì„ )
# ============================================================================
RUN echo "ğŸ”§ Installing BACnet headers..." && \
    cd /tmp && git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    mkdir -p /usr/local/include/bacnet && \
    find bacnet-stack -name "*.h" -exec cp {} /usr/local/include/bacnet/ \; 2>/dev/null || true && \
    cd / && rm -rf /tmp/bacnet-stack && echo "âœ… BACnet headers installed"

# ============================================================================
# 7ë‹¨ê³„: ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
# ============================================================================
# nlohmann/json
RUN mkdir -p /usr/local/include/nlohmann && \
    wget -q -O /usr/local/include/nlohmann/json.hpp \
    https://github.com/nlohmann/json/releases/download/v3.11.3/json.hpp || \
    apt-get update && apt-get install -y nlohmann-json3-dev && apt-get clean

# spdlog
RUN cd /tmp && git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DSPDLOG_BUILD_SHARED=ON -DCMAKE_CXX_STANDARD=17 && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/spdlog

# Google Test
RUN cd /tmp && git clone --depth 1 --branch v1.14.0 https://github.com/google/googletest.git && \
    cd googletest && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=ON -DCMAKE_CXX_STANDARD=17 && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/googletest

# ============================================================================
# 8ë‹¨ê³„: PKG-CONFIG íŒŒì¼ ìƒì„±
# ============================================================================
RUN echo "prefix=/usr/local\nexec_prefix=\${prefix}\nlibdir=\${exec_prefix}/lib\nincludedir=\${prefix}/include\n\nName: paho-mqtt3c\nDescription: Eclipse Paho MQTT C Client\nVersion: 1.3.13\nLibs: -L\${libdir} -lpaho-mqtt3c -lpaho-mqtt3cs\nCflags: -I\${includedir}" > /usr/local/lib/pkgconfig/paho-mqtt3c.pc && \
    echo "prefix=/usr/local\nexec_prefix=\${prefix}\nlibdir=\${exec_prefix}/lib\nincludedir=\${prefix}/include\n\nName: paho-mqttpp3\nDescription: Eclipse Paho MQTT C++ Client\nVersion: 1.3.2\nRequires: paho-mqtt3c\nLibs: -L\${libdir} -lpaho-mqttpp3\nCflags: -I\${includedir}" > /usr/local/lib/pkgconfig/paho-mqttpp3.pc

# ============================================================================
# 9ë‹¨ê³„: ìƒˆ í´ë” êµ¬ì¡° ì§€ì› ê°œë°œ í™˜ê²½ ì„¤ì •
# ============================================================================
RUN mkdir -p /app/collector/{bin,build,lib,logs,test} && \
    mkdir -p /app/collector/include/{Workers/{Base,Protocol,Components},Drivers/{Common,Modbus,Mqtt,Bacnet,Wireless},Core,Client,Utils,Database,Plugin} && \
    mkdir -p /app/collector/src/{Workers/{Base,Protocol,Components},Drivers/{Common,Modbus,Mqtt,Bacnet,Wireless},Core,Client,Utils,Database,Plugin} && \
    mkdir -p /app/config/drivers && \
    mkdir -p /app/scripts && \
    mkdir -p /app/docs

# ============================================================================
# 10ë‹¨ê³„: ê°œë°œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# ============================================================================
RUN cat > /app/collector/dev-build.sh << 'EOF'
#!/bin/bash
# PulseOne Collector ê°œë°œ ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸

set -e

echo "ğŸ—ï¸ PulseOne Collector Development Build"
echo "========================================"

# ì»¬ëŸ¬ ì •ì˜
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# í™˜ê²½ ì²´í¬
echo -e "${BLUE}ğŸ“‹ Environment Check:${NC}"
echo "  Compiler: $(gcc --version | head -n1)"
echo "  Make: $(make --version | head -n1)"
echo "  Working Dir: $(pwd)"

# í´ë” êµ¬ì¡° ì²´í¬
echo -e "${BLUE}ğŸ“ Folder Structure Check:${NC}"
[ -d "include/Workers/Base" ] && echo -e "  ${GREEN}âœ… include/Workers/Base${NC}" || echo -e "  ${RED}âŒ include/Workers/Base${NC}"
[ -d "include/Drivers/Common" ] && echo -e "  ${GREEN}âœ… include/Drivers/Common${NC}" || echo -e "  ${RED}âŒ include/Drivers/Common${NC}"
[ -d "include/Client" ] && echo -e "  ${GREEN}âœ… include/Client${NC}" || echo -e "  ${RED}âŒ include/Client${NC}"
[ -d "src/Workers/Base" ] && echo -e "  ${GREEN}âœ… src/Workers/Base${NC}" || echo -e "  ${RED}âŒ src/Workers/Base${NC}"
[ -d "src/Core" ] && echo -e "  ${GREEN}âœ… src/Core${NC}" || echo -e "  ${RED}âŒ src/Core${NC}"

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
echo -e "${BLUE}ğŸ“š Library Check:${NC}"
pkg-config --exists libmodbus && echo -e "  ${GREEN}âœ… libmodbus: $(pkg-config --modversion libmodbus)${NC}" || echo -e "  ${RED}âŒ libmodbus${NC}"
pkg-config --exists paho-mqtt3c && echo -e "  ${GREEN}âœ… Paho MQTT C: $(pkg-config --modversion paho-mqtt3c)${NC}" || echo -e "  ${RED}âŒ Paho MQTT C${NC}"
pkg-config --exists paho-mqttpp3 && echo -e "  ${GREEN}âœ… Paho MQTT C++: $(pkg-config --modversion paho-mqttpp3)${NC}" || echo -e "  ${RED}âŒ Paho MQTT C++${NC}"
[ -d /usr/local/include/bacnet ] && echo -e "  ${GREEN}âœ… BACnet Headers${NC}" || echo -e "  ${RED}âŒ BACnet Headers${NC}"

# ë¹Œë“œ ì‹¤í–‰
echo -e "${BLUE}ğŸ”¨ Starting Build:${NC}"
case "${1:-debug}" in
    "clean")
        echo -e "${YELLOW}ğŸ§¹ Cleaning...${NC}"
        make clean
        ;;
    "debug")
        echo -e "${YELLOW}ğŸ› Debug Build...${NC}"
        make debug
        ;;
    "release")
        echo -e "${YELLOW}ğŸš€ Release Build...${NC}"
        make release
        ;;
    "minimal")
        echo -e "${YELLOW}ğŸ“¦ Minimal Build...${NC}"
        make minimal
        ;;
    "syntax")
        echo -e "${YELLOW}ğŸ“ Syntax Check...${NC}"
        make syntax-check
        ;;
    "analyze")
        echo -e "${YELLOW}ğŸ“Š Code Analysis...${NC}"
        make analyze
        ;;
    *)
        echo -e "${YELLOW}ğŸ”§ Default Build...${NC}"
        make
        ;;
esac

echo -e "${GREEN}âœ… Build script completed!${NC}"
EOF

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /app/collector/dev-build.sh

# ============================================================================
# 11ë‹¨ê³„: ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
# ============================================================================
RUN cat > /app/collector/quick-test.sh << 'EOF'
#!/bin/bash
# PulseOne Collector ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

echo "ğŸ§ª Quick Test Suite"
echo "=================="

# í—¤ë” íŒŒì¼ ì¡´ì¬ í™•ì¸
echo "ğŸ“„ Header Files Check:"
find include/ -name "*.h" | head -10 | while read file; do
    echo "  âœ“ $file"
done

# ì†ŒìŠ¤ íŒŒì¼ ì¡´ì¬ í™•ì¸  
echo "ğŸ’» Source Files Check:"
find src/ -name "*.cpp" | head -10 | while read file; do
    echo "  âœ“ $file"
done

# ê°„ë‹¨í•œ ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
echo "ğŸ”¨ Compilation Test:"
if [ -f "src/main.cpp" ]; then
    g++ -std=c++17 -Iinclude -fsyntax-only src/main.cpp && echo "  âœ… main.cpp syntax OK" || echo "  âŒ main.cpp syntax error"
else
    echo "  âš ï¸ main.cpp not found"
fi

# Makefile ì¡´ì¬ í™•ì¸
echo "ğŸ“‹ Build System Check:"
[ -f "Makefile" ] && echo "  âœ… Makefile exists" || echo "  âŒ Makefile missing"

echo "âœ… Quick test completed!"
EOF

RUN chmod +x /app/collector/quick-test.sh

# ============================================================================
# 12ë‹¨ê³„: ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ
# ============================================================================
RUN ldconfig && \
    echo "ğŸ” Final verification:" && \
    (pkg-config --exists libmodbus && echo "  âœ… libmodbus: $(pkg-config --modversion libmodbus)") || echo "  âŒ libmodbus" && \
    (pkg-config --exists paho-mqtt3c && echo "  âœ… Paho MQTT C: $(pkg-config --modversion paho-mqtt3c)") || echo "  âŒ Paho MQTT C" && \
    (pkg-config --exists paho-mqttpp3 && echo "  âœ… Paho MQTT C++: $(pkg-config --modversion paho-mqttpp3)") || echo "  âŒ Paho MQTT C++" && \
    ([ -d /usr/local/include/bacnet ] && echo "  âœ… BACnet Headers: Found") || echo "  âŒ BACnet Headers" && \
    ([ -f /usr/local/include/nlohmann/json.hpp ] && echo "  âœ… nlohmann/json: Found") || echo "  âŒ nlohmann/json" && \
    echo "âœ… All libraries verified!"

# Bash í”„ë¡¬í”„íŠ¸ ê°œì„  ë° ê°œë°œ í™˜ê²½ ë©”ì‹œì§€
RUN echo 'export PS1="\[\033[01;32m\]\u@collector-dev\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "ğŸš€ PulseOne Collector Development Environment Ready!"' >> /root/.bashrc && \
    echo 'echo "ğŸ“ New folder structure supported:"' >> /root/.bashrc && \
    echo 'echo "   include/Workers/{Base,Protocol,Components}/"' >> /root/.bashrc && \
    echo 'echo "   include/Drivers/{Common,Modbus,Mqtt,Bacnet}/"' >> /root/.bashrc && \
    echo 'echo "   include/{Core,Client,Utils,Database}/"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "ğŸ”§ Quick commands:"' >> /root/.bashrc && \
    echo 'echo "   ./dev-build.sh debug   - Debug build"' >> /root/.bashrc && \
    echo 'echo "   ./dev-build.sh syntax  - Syntax check"' >> /root/.bashrc && \
    echo 'echo "   ./quick-test.sh        - Quick test"' >> /root/.bashrc && \
    echo 'echo "   make help             - Full help"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV CC=gcc CXX=g++
ENV CFLAGS="-std=c11 -Wall -Wextra"
ENV CXXFLAGS="-std=c++17 -Wall -Wextra"

# ì‘ì—… ë””ë ‰í† ë¦¬ ë° í¬íŠ¸ ì„¤ì •
WORKDIR /app/collector
EXPOSE 2345 8080 5432 6379 1883

# ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸
VOLUME ["/app/collector", "/app/config", "/app/logs", "/app/scripts"]

# ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["/bin/bash"]

# ============================================================================
# ë¹Œë“œ í›„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ë“¤
# ============================================================================
# docker build -t pulseone-collector-dev -f Dockerfile.dev .
# docker run -it -v $(pwd):/app/collector pulseone-collector-dev
# 
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ:
# ./dev-build.sh debug     # ë””ë²„ê·¸ ë¹Œë“œ
# ./dev-build.sh syntax    # ë¬¸ë²• ì²´í¬ë§Œ
# ./quick-test.sh          # ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
# make help               # ì „ì²´ ë„ì›€ë§