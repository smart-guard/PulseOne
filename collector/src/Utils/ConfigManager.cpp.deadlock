// =============================================================================
// ë””ë²„ê¹…ìš© ConfigManager.cpp - ê° ë‹¨ê³„ë§ˆë‹¤ ë¡œê·¸ ì¶”ê°€
// =============================================================================

#include "Utils/ConfigManager.h"
#include "Utils/LogManager.h"
#include <fstream>
#include <sstream>
#include <cstdlib>
#include <algorithm>
#include <filesystem>
#include <iostream>
#include <cstring>

ConfigManager& ConfigManager::getInstance() {
    static ConfigManager instance;
    return instance;
}

void ConfigManager::initialize() {
    std::lock_guard<std::mutex> lock(configMutex);
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ConfigManager ì´ˆê¸°í™” ì‹œì‘...");
    
    // 1. ì„¤ì • ë””ë ‰í† ë¦¬ ì°¾ê¸°
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 1ë‹¨ê³„: ì„¤ì • ë””ë ‰í† ë¦¬ ì°¾ê¸° ì‹œì‘");
    configDir_ = findConfigDirectory();
    if (configDir_.empty()) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::ERROR, "âŒ ì„¤ì • ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        return;
    }
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ì„¤ì • ë””ë ‰í† ë¦¬: " + configDir_);
    
    // 2. ì„¤ì • íŒŒì¼ë“¤ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 2ë‹¨ê³„: ì„¤ì • íŒŒì¼ í™•ì¸ ì‹œì‘");
    try {
        ensureConfigFilesExist();
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 2ë‹¨ê³„: ì„¤ì • íŒŒì¼ í™•ì¸ ì™„ë£Œ");
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰): " + std::string(e.what()));
    }
    
    // 3. ë°ì´í„° ë””ë ‰í† ë¦¬ ì„¤ì •
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 3ë‹¨ê³„: ë°ì´í„° ë””ë ‰í† ë¦¬ ì„¤ì • ì‹œì‘");
    dataDir_ = findDataDirectory();
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 3ë‹¨ê³„: ë°ì´í„° ë””ë ‰í† ë¦¬: " + dataDir_);
    
    try {
        ensureDataDirectories();
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 3ë‹¨ê³„: ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ");
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘ ì˜¤ë¥˜: " + std::string(e.what()));
    }
    
    // 4. envFilePath ì„¤ì •
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 4ë‹¨ê³„: envFilePath ì„¤ì •");
    envFilePath = configDir_ + "/.env";
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 4ë‹¨ê³„: envFilePath = " + envFilePath);
    
    // 5. ë©”ì¸ ì„¤ì • íŒŒì¼ ë¡œë“œ
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 5ë‹¨ê³„: ë©”ì¸ ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹œì‘");
    loadMainConfig();
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 5ë‹¨ê³„: ë©”ì¸ ì„¤ì • íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
    
    // 6. ì¶”ê°€ ì„¤ì • íŒŒì¼ ë¡œë“œ
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 6ë‹¨ê³„: ì¶”ê°€ ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹œì‘");
    loadAdditionalConfigs();
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 6ë‹¨ê³„: ì¶”ê°€ ì„¤ì • íŒŒì¼ ë¡œë“œ ì™„ë£Œ");
    
    // 7. ë³€ìˆ˜ í™•ì¥
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” 7ë‹¨ê³„: ë³€ìˆ˜ í™•ì¥ ì‹œì‘");
    expandAllVariables();
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… 7ë‹¨ê³„: ë³€ìˆ˜ í™•ì¥ ì™„ë£Œ");
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, 
        "âœ… ConfigManager ì´ˆê¸°í™” ì™„ë£Œ - " + std::to_string(configMap.size()) + "ê°œ ì„¤ì • ë¡œë“œë¨");
}

// =============================================================================
// ê¸°ì¡´ ë©”ì„œë“œë“¤ (ë³€ê²½ ì—†ìŒ)
// =============================================================================

void ConfigManager::reload() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ”„ ConfigManager ì¬ë¡œë”© ì‹œì‘...");
    {
        std::lock_guard<std::mutex> lock(configMutex);
        configMap.clear();
        loadedFiles_.clear();
        searchLog_.clear();
    }
    initialize();
}

std::string ConfigManager::findConfigDirectory() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” findConfigDirectory() ì‹œì‘");
    
    searchLog_.clear();
    
    // 1. í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ìµœìš°ì„ )
    const char* env_config = std::getenv("PULSEONE_CONFIG_DIR");
    if (env_config && strlen(env_config) > 0 && directoryExists(env_config)) {
        searchLog_.push_back("âœ… í™˜ê²½ë³€ìˆ˜: " + std::string(env_config));
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… í™˜ê²½ë³€ìˆ˜ì—ì„œ ë°œê²¬: " + std::string(env_config));
        return std::string(env_config);
    } else if (env_config) {
        searchLog_.push_back("âŒ í™˜ê²½ë³€ìˆ˜ (ì¡´ì¬í•˜ì§€ ì•ŠìŒ): " + std::string(env_config));
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âŒ í™˜ê²½ë³€ìˆ˜ ë””ë ‰í† ë¦¬ ì—†ìŒ: " + std::string(env_config));
    }
    
    // ê¸°ë³¸ ê²½ë¡œë“¤ í™•ì¸ (ê°„ì†Œí™”)
    std::vector<std::string> candidates = {"./config", "../config", "../../config"};
    
    for (const auto& candidate : candidates) {
        try {
            if (directoryExists(candidate)) {
                std::string canonical_path = std::filesystem::canonical(candidate).string();
                searchLog_.push_back("âœ… ë°œê²¬: " + candidate + " â†’ " + canonical_path);
                PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ê¸°ë³¸ ê²½ë¡œì—ì„œ ë°œê²¬: " + canonical_path);
                return canonical_path;
            } else {
                searchLog_.push_back("âŒ ì—†ìŒ: " + candidate);
            }
        } catch (const std::exception& e) {
            searchLog_.push_back("âŒ ì˜¤ë¥˜: " + candidate + " (" + e.what() + ")");
        }
    }
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âŒ ì„¤ì • ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
    return "";
}

bool ConfigManager::directoryExists(const std::string& path) {
    try {
        return std::filesystem::exists(path) && std::filesystem::is_directory(path);
    } catch (const std::exception&) {
        return false;
    }
}

void ConfigManager::ensureConfigFilesExist() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ì„¤ì • íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘...");
    
    try {
        // ë©”ì¸ .env íŒŒì¼ë§Œ í™•ì¸/ìƒì„±
        std::string main_env_path = configDir_ + "/.env";
        if (!std::filesystem::exists(main_env_path)) {
            PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë©”ì¸ ì„¤ì • íŒŒì¼ ì—†ìŒ, ê¸°ë³¸ í…œí”Œë¦¿ ìƒì„±: .env");
            createMainEnvFile();
        } else {
            PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ë©”ì¸ ì„¤ì • íŒŒì¼ ì¡´ì¬: .env");
        }
        
        // ê¸°ë³¸ ì¶”ê°€ íŒŒì¼ë“¤ë„ ìƒì„± (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
        createDefaultConfigFiles();
        
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ì„¤ì • íŒŒì¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜: " + std::string(e.what()) + " (ê³„ì† ì§„í–‰)");
    }
}

void ConfigManager::createDefaultConfigFiles() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ê¸°ë³¸ ì„¤ì • íŒŒì¼ë“¤ ìƒì„± ì‹œì‘");
    
    try {
        createSecretsDirectory();
        createDatabaseEnvFile();
        createRedisEnvFile();
        createTimeseriesEnvFile();
        createMessagingEnvFile();
        
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ê¸°ë³¸ ì„¤ì • íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
            
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ì¶”ê°€ ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨: " + std::string(e.what()));
    }
}

void ConfigManager::createMainEnvFile() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ë©”ì¸ .env íŒŒì¼ ìƒì„±");
    
    std::string content = R"(# PulseOne ë©”ì¸ ì„¤ì • íŒŒì¼ (.env) - ìë™ ìƒì„±ë¨
NODE_ENV=development
LOG_LEVEL=info
DATABASE_TYPE=SQLITE
DATA_DIR=./data
MAX_WORKER_THREADS=4
DEFAULT_TIMEOUT_MS=5000
CONFIG_FILES=
)";
    
    if (createFileFromTemplate(configDir_ + "/.env", content)) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ë©”ì¸ .env íŒŒì¼ ìƒì„± ì™„ë£Œ");
    } else {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë©”ì¸ .env íŒŒì¼ ìƒì„± ì‹¤íŒ¨");
    }
}

// ë‚˜ë¨¸ì§€ create ë©”ì„œë“œë“¤ (ê°„ì†Œí™”)
void ConfigManager::createDatabaseEnvFile() {
    std::string content = "# Database config\nDATABASE_TYPE=SQLITE\n";
    createFileFromTemplate(configDir_ + "/database.env", content);
}

void ConfigManager::createRedisEnvFile() {
    std::string content = "# Redis config\nREDIS_HOST=localhost\n";
    createFileFromTemplate(configDir_ + "/redis.env", content);
}

void ConfigManager::createTimeseriesEnvFile() {
    std::string content = "# Timeseries config\nINFLUX_HOST=localhost\n";
    createFileFromTemplate(configDir_ + "/timeseries.env", content);
}

void ConfigManager::createMessagingEnvFile() {
    std::string content = "# Messaging config\nRABBITMQ_HOST=localhost\n";
    createFileFromTemplate(configDir_ + "/messaging.env", content);
}

void ConfigManager::createSecretsDirectory() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” Secrets ë””ë ‰í† ë¦¬ ìƒì„±");
    
    std::string secrets_dir = configDir_ + "/secrets";
    
    try {
        if (std::filesystem::exists(secrets_dir)) {
            return;
        }
        
        std::filesystem::create_directories(secrets_dir);
        
        std::string readme_content = "# Secrets Directory\n";
        createFileFromTemplate(secrets_dir + "/README.md", readme_content);
        createFileFromTemplate(secrets_dir + "/.gitignore", "*\n!README.md\n!.gitignore\n");
        
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… Secrets ë””ë ‰í† ë¦¬ ìƒì„±: " + secrets_dir);
            
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ Secrets ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + std::string(e.what()));
    }
}

bool ConfigManager::createFileFromTemplate(const std::string& filepath, const std::string& content) {
    try {
        if (std::filesystem::exists(filepath)) {
            return true;
        }
        
        std::ofstream file(filepath);
        if (!file.is_open()) {
            return false;
        }
        
        file << content;
        file.close();
        
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ì„¤ì • íŒŒì¼ ìƒì„±: " + std::filesystem::path(filepath).filename().string());
        
        return true;
        
    } catch (const std::exception& e) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ íŒŒì¼ ìƒì„± ì¤‘ ì˜ˆì™¸: " + std::string(e.what()));
        return false;
    }
}

std::string ConfigManager::findDataDirectory() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” findDataDirectory() ì‹œì‘");
    
    // 1. í™˜ê²½ë³€ìˆ˜ ìµœìš°ì„  í™•ì¸
    const char* env_data = std::getenv("PULSEONE_DATA_DIR");
    if (env_data && strlen(env_data) > 0) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… í™˜ê²½ë³€ìˆ˜ì—ì„œ ë°ì´í„° ë””ë ‰í† ë¦¬: " + std::string(env_data));
        return std::string(env_data);
    }
    
    // 2. ì„¤ì •íŒŒì¼ì—ì„œ í™•ì¸
    std::string config_data = get("DATA_DIR");
    if (!config_data.empty()) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ì„¤ì •ì—ì„œ ë°ì´í„° ë””ë ‰í† ë¦¬: " + config_data);
        return expandVariables(config_data);
    }
    
    // 3. ê¸°ë³¸ ê²½ë¡œ ì‚¬ìš©
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ê¸°ë³¸ ë°ì´í„° ë””ë ‰í† ë¦¬: ./data");
    return "./data";
}

void ConfigManager::ensureDataDirectories() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ensureDataDirectories() ì‹œì‘");
    
    if (dataDir_.empty()) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë°ì´í„° ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ");
        return;
    }
    
    std::vector<std::string> dirs = {"db", "logs", "backup", "temp"};
    
    for (const auto& dir : dirs) {
        try {
            std::string full_path = dataDir_ + "/" + dir;
            std::filesystem::create_directories(full_path);
            PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ë””ë ‰í† ë¦¬ ìƒì„±: " + full_path);
        } catch (const std::exception& e) {
            PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + dir + " - " + e.what());
        }
    }
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ensureDataDirectories() ì™„ë£Œ");
}

void ConfigManager::loadMainConfig() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” loadMainConfig() ì‹œì‘");
    
    std::string main_env_path = configDir_ + "/.env";
    
    if (std::filesystem::exists(main_env_path)) {
        loadConfigFile(main_env_path);
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… ë©”ì¸ ì„¤ì • ë¡œë“œ: .env");
    } else {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::WARN, "âš ï¸ ë©”ì¸ ì„¤ì • íŒŒì¼ ì—†ìŒ: .env");
    }
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… loadMainConfig() ì™„ë£Œ");
}

void ConfigManager::loadAdditionalConfigs() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” loadAdditionalConfigs() ì‹œì‘");
    
    // CONFIG_FILESì—ì„œ ì¶”ê°€ íŒŒì¼ ëª©ë¡ ì½ê¸°
    std::string config_files = getOrDefault("CONFIG_FILES", "");
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” CONFIG_FILES ê°’: '" + config_files + "'");
    
    if (config_files.empty()) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "â„¹ï¸ ì¶”ê°€ ì„¤ì • íŒŒì¼ ì—†ìŒ (CONFIG_FILES ë¹„ì–´ìˆìŒ)");
        return;
    }
    
    // ğŸš¨ ë¬´í•œë£¨í”„ ë°©ì§€: ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "â„¹ï¸ ì¶”ê°€ ì„¤ì • íŒŒì¼ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™” (ë¬´í•œë£¨í”„ ë°©ì§€)");
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… loadAdditionalConfigs() ì™„ë£Œ");
}

void ConfigManager::loadConfigFile(const std::string& filepath) {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” loadConfigFile() ì‹œì‘: " + filepath);
    
    std::ifstream file(filepath);
    if (!file.is_open()) {
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::ERROR, "âŒ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: " + filepath);
        return;
    }
    
    std::string line;
    int line_count = 0;
    int parsed_count = 0;
    
    while (std::getline(file, line)) {
        line_count++;
        size_t original_size = configMap.size();
        parseLine(line);
        
        if (configMap.size() > original_size) {
            parsed_count++;
        }
    }
    
    file.close();
    loadedFiles_.push_back(filepath);
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, 
        "ğŸ“„ " + filepath + " - " + std::to_string(parsed_count) + "/" + std::to_string(line_count) + " ë¼ì¸ íŒŒì‹±ë¨");
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… loadConfigFile() ì™„ë£Œ");
}

void ConfigManager::expandAllVariables() {
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” expandAllVariables() ì‹œì‘");
    
    // ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬ (ë¬´í•œë£¨í”„ ë°©ì§€)
    bool changed = true;
    int max_iterations = 3;  // ìµœëŒ€ 3ë²ˆë§Œ
    
    for (int i = 0; i < max_iterations && changed; ++i) {
        changed = false;
        
        for (auto& [key, value] : configMap) {
            std::string expanded = expandVariables(value);
            if (expanded != value) {
                value = expanded;
                changed = true;
            }
        }
        
        PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "ğŸ” ë³€ìˆ˜ í™•ì¥ ë°˜ë³µ " + std::to_string(i + 1) + "íšŒ");
    }
    
    PulseOne::LogManager::getInstance().log("config", PulseOne::LogLevel::INFO, "âœ… expandAllVariables() ì™„ë£Œ");
}

std::string ConfigManager::expandVariables(const std::string& value) const {
    // ê°„ë‹¨í•œ ë²„ì „ (ë¬´í•œë£¨í”„ ë°©ì§€)
    return value;  // ì¼ë‹¨ ë³€ìˆ˜ í™•ì¥ ë¹„í™œì„±í™”
}

// ê¸°ë³¸ ì¸í„°í˜ì´ìŠ¤ë“¤
void ConfigManager::parseLine(const std::string& line) {
    if (line.empty() || line[0] == '#') return;

    size_t eqPos = line.find('=');
    if (eqPos == std::string::npos) return;

    std::string key = line.substr(0, eqPos);
    std::string value = line.substr(eqPos + 1);

    // ì•ë’¤ ê³µë°± ì œê±°
    key.erase(std::remove_if(key.begin(), key.end(), ::isspace), key.end());
    value.erase(0, value.find_first_not_of(" \t"));
    value.erase(value.find_last_not_of(" \t") + 1);
    value.erase(std::remove(value.begin(), value.end(), '\"'), value.end());

    if (!key.empty()) {
        configMap[key] = value;
    }
}

std::string ConfigManager::get(const std::string& key) const {
    std::lock_guard<std::mutex> lock(configMutex);
    auto it = configMap.find(key);
    return (it != configMap.end()) ? it->second : "";
}

std::string ConfigManager::getOrDefault(const std::string& key, const std::string& defaultValue) const {
    std::lock_guard<std::mutex> lock(configMutex);
    auto it = configMap.find(key);
    return (it != configMap.end()) ? it->second : defaultValue;
}

void ConfigManager::set(const std::string& key, const std::string& value) {
    std::lock_guard<std::mutex> lock(configMutex);
    configMap[key] = value;
}

bool ConfigManager::hasKey(const std::string& key) const {
    std::lock_guard<std::mutex> lock(configMutex);
    return configMap.find(key) != configMap.end();
}

std::map<std::string, std::string> ConfigManager::listAll() const {
    std::lock_guard<std::mutex> lock(configMutex);
    return configMap;
}

// ì¶”ê°€ ë©”ì„œë“œë“¤ (ê¸°ë³¸ êµ¬í˜„)
int ConfigManager::getInt(const std::string& key, int defaultValue) const {
    std::string value = get(key);
    if (value.empty()) return defaultValue;
    try { return std::stoi(value); } catch (...) { return defaultValue; }
}

bool ConfigManager::getBool(const std::string& key, bool defaultValue) const {
    std::string value = get(key);
    if (value.empty()) return defaultValue;
    std::transform(value.begin(), value.end(), value.begin(), ::tolower);
    return (value == "true" || value == "yes" || value == "1" || value == "on");
}

double ConfigManager::getDouble(const std::string& key, double defaultValue) const {
    std::string value = get(key);
    if (value.empty()) return defaultValue;
    try { return std::stod(value); } catch (...) { return defaultValue; }
}

std::string ConfigManager::getDataDirectory() const {
    return dataDir_.empty() ? "./data" : dataDir_;
}

std::string ConfigManager::getSQLiteDbPath() const {
    return getDataDirectory() + "/db/pulseone.db";
}

std::string ConfigManager::getBackupDirectory() const {
    return getDataDirectory() + "/backup";
}

void ConfigManager::printConfigSearchLog() const {
    std::cout << "\nğŸ” ConfigManager ê²½ë¡œ ê²€ìƒ‰ ë¡œê·¸:\n";
    for (const auto& log_entry : searchLog_) {
        std::cout << log_entry << "\n";
    }
    std::cout << "\nğŸ“„ ë¡œë“œëœ ì„¤ì • íŒŒì¼ë“¤:\n";
    for (const auto& file : loadedFiles_) {
        std::cout << "  " + file << "\n";
    }
    std::cout << "\nâš™ï¸ ì´ " << configMap.size() << "ê°œ ì„¤ì • í•­ëª© ë¡œë“œë¨\n";
}