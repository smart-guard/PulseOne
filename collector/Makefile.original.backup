# =============================================================================
# PulseOne Collector Makefile - ìˆ˜ì •ëœ ë²„ì „ (Redis ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
# =============================================================================

# nlohmann/json ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# ğŸ”§ ìˆ˜ì •: hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ ì¶”ê°€
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# BACnet Stack ì²´í¬ (ê¸°ì¡´ hiredis ì²´í¬ ë°‘ì— ì¶”ê°€)
HAS_BACNET_STACK := $(shell pkg-config --exists bacnet && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE -O0 -Iinclude $(shell pkg-config --cflags libmodbus) -I/usr/local/include/bacnet
LDFLAGS = 

# ğŸ”§ ìˆ˜ì •: Redis ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
LIBS = -lpthread \
       $(shell pkg-config --libs libmodbus) \
       -lpqxx -lpq -lsqlite3 \
       -lpaho-mqtt3c -lpaho-mqttpp3 \
       -lbacnet -lmysqlclient \
       -lhiredis -lhiredis_ssl

# ê¸°ì¡´ CXXFLAGSì— JSON í”Œë˜ê·¸ ì¶”ê°€
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# ğŸ”§ ì¶”ê°€: hiredis í”Œë˜ê·¸ ì¶”ê°€
ifeq ($(HAS_HIREDIS),1)
    CXXFLAGS += -DHAS_HIREDIS
else
    $(warning âš ï¸  hiredis not found - Redis functionality will be limited)
    $(warning    Install with: sudo apt-get install libhiredis-dev)
endif

ifeq ($(HAS_BACNET_STACK), 1)
    CXXFLAGS += -DHAS_BACNET_STACK=1
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
endif

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_NAME = pulseone_collector
TARGET = $(PROJECT_NAME)

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
BIN_DIR = bin

# Include ê²½ë¡œ
INCLUDES = -I$(INCLUDE_DIR)

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ì†ŒìŠ¤ íŒŒì¼ ê·¸ë£¹ ì •ì˜ (ê¸°ì¡´ê³¼ ë™ì¼)
# =============================================================================

# Core ì†ŒìŠ¤ë“¤
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)

# ê¸°ì¡´ Utils, Config ë“±
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

# Workers ì†ŒìŠ¤ë“¤
WORKERS_BASE_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp)
WORKERS_PROTOCOL_SOURCES := $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp)
WORKERS_COMPONENTS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Components/*.cpp)
WORKERS_SOURCES := $(WORKERS_BASE_SOURCES) $(WORKERS_PROTOCOL_SOURCES) $(WORKERS_COMPONENTS_SOURCES) $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# Drivers ì†ŒìŠ¤ë“¤
DRIVERS_COMMON_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
DRIVERS_MODBUS_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
DRIVERS_MQTT_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
DRIVERS_BACNET_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
DRIVERS_SOURCES := $(DRIVERS_COMMON_SOURCES) $(DRIVERS_MODBUS_SOURCES) $(DRIVERS_MQTT_SOURCES) $(DRIVERS_BACNET_SOURCES)

# Database ì†ŒìŠ¤ë“¤
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# ğŸ”§ ìˆ˜ì •: Client ì†ŒìŠ¤ë“¤ (Redis í¬í•¨)
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Plugin ì†ŒìŠ¤ë“¤
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

# ë©”ì¸ ì†ŒìŠ¤
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ì „ì²´ ì†ŒìŠ¤ë“¤
EXISTING_SOURCES = $(CORE_SOURCES) $(UTILS_SOURCES) $(CONFIG_SOURCES)
OPTIONAL_SOURCES = $(WORKERS_SOURCES) $(DRIVERS_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(PLUGIN_SOURCES)

ALL_LIB_SOURCES = $(EXISTING_SOURCES) $(OPTIONAL_SOURCES)

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
ALL_LIB_OBJECTS = $(ALL_LIB_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJECT = $(MAIN_SOURCE:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
ALL_OBJECTS = $(ALL_LIB_OBJECTS) $(MAIN_OBJECT)

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤
# =============================================================================

.DEFAULT_GOAL := all

# ğŸ”§ ìˆ˜ì •: ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ í¬í•¨
check-deps:
	@echo -e "$(BLUE)ğŸ” Checking dependencies...$(NC)"
	@echo -e "$(YELLOW)Required libraries:$(NC)"
	@if [ "$(HAS_NLOHMANN_JSON)" = "1" ]; then \
		echo -e "  $(GREEN)âœ… nlohmann/json$(NC)"; \
	else \
		echo -e "  $(YELLOW)âš ï¸  nlohmann/json (optional)$(NC)"; \
	fi
	@if [ "$(HAS_HIREDIS)" = "1" ]; then \
		echo -e "  $(GREEN)âœ… hiredis$(NC)"; \
	else \
		echo -e "  $(RED)âŒ hiredis (required for Redis support)$(NC)"; \
		echo -e "     Install: sudo apt-get install libhiredis-dev"; \
	fi
	@pkg-config --exists libmodbus && echo -e "  $(GREEN)âœ… libmodbus$(NC)" || echo -e "  $(RED)âŒ libmodbus$(NC)"
	@echo -e "$(YELLOW)Checking libraries:$(NC)"
	@for lib in pthread hiredis pqxx pq sqlite3 paho-mqtt3c paho-mqttpp3 mysqlclient; do \
		if ldconfig -p | grep -q "lib$$lib"; then \
			echo -e "  $(GREEN)âœ… $$lib$(NC)"; \
		else \
			echo -e "  $(YELLOW)âš ï¸  $$lib (may not be installed)$(NC)"; \
		fi \
	done

# íŒŒì¼ ì¡´ì¬ í™•ì¸ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
check-sources:
	@echo -e "$(BLUE)ğŸ” Checking required source files...$(NC)"
	@echo -e "$(YELLOW)Main source:$(NC)"
	@if [ -f "$(MAIN_SOURCE)" ]; then \
		echo -e "  $(GREEN)âœ… $(MAIN_SOURCE)$(NC)"; \
	else \
		echo -e "  $(RED)âŒ $(MAIN_SOURCE) (MISSING)$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(YELLOW)Core sources:$(NC)"
	@if [ -z "$(CORE_SOURCES)" ]; then \
		echo -e "  $(RED)âŒ No Core sources found in $(SRC_DIR)/Core/$(NC)"; \
		echo -e "  $(YELLOW)Expected: $(SRC_DIR)/Core/Application.cpp$(NC)"; \
		ls -la $(SRC_DIR)/Core/ 2>/dev/null || echo "  $(RED)âŒ $(SRC_DIR)/Core/ directory not found$(NC)"; \
		exit 1; \
	else \
		for src in $(CORE_SOURCES); do \
			echo -e "  $(GREEN)âœ… $$src$(NC)"; \
		done \
	fi
	@echo -e "$(YELLOW)Client sources (Redis):$(NC)"
	@for src in $(CLIENT_SOURCES); do \
		if [ -f "$$src" ]; then \
			echo -e "  $(GREEN)âœ… $$src$(NC)"; \
		else \
			echo -e "  $(YELLOW)âš ï¸  $$src (optional)$(NC)"; \
		fi \
	done

# ì „ì²´ ë¹Œë“œ (ì˜ì¡´ì„± ë° ì†ŒìŠ¤ í™•ì¸ í¬í•¨)
all: check-deps check-sources directories $(TARGET)
	@echo -e "$(GREEN)ğŸ‰ Build completed successfully!$(NC)"
	@echo -e "$(BLUE)ğŸ“¦ Executable: $(BIN_DIR)/$(TARGET)$(NC)"
	@echo -e "$(BLUE)ğŸ“Š Object files: $(words $(ALL_OBJECTS))$(NC)"

# ì‹¤í–‰ íŒŒì¼ ìƒì„±
$(TARGET): $(ALL_OBJECTS) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”— Linking $(TARGET)...$(NC)"
	@echo -e "$(YELLOW)   Objects: $(words $(ALL_OBJECTS))$(NC)"
	@echo -e "$(YELLOW)   Libraries: $(LIBS)$(NC)"
	$(CXX) $(LDFLAGS) -o $(BIN_DIR)/$@ $(ALL_OBJECTS) $(LIBS)

# =============================================================================
# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„± ê·œì¹™ (ê¸°ì¡´ê³¼ ë™ì¼, Client ì¶”ê°€)
# =============================================================================

# Core íŒŒì¼ë“¤
$(BUILD_DIR)/Core/%.o: $(SRC_DIR)/Core/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ›ï¸  Compiling Core: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Utils íŒŒì¼ë“¤
$(BUILD_DIR)/Utils/%.o: $(SRC_DIR)/Utils/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ”§ Compiling Utils: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Config íŒŒì¼ë“¤
$(BUILD_DIR)/Config/%.o: $(SRC_DIR)/Config/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)âš™ï¸  Compiling Config: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Workers íŒŒì¼ë“¤
$(BUILD_DIR)/Workers/%.o: $(SRC_DIR)/Workers/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ‘· Compiling Worker: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Drivers íŒŒì¼ë“¤
$(BUILD_DIR)/Drivers/%.o: $(SRC_DIR)/Drivers/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Driver: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Database íŒŒì¼ë“¤
$(BUILD_DIR)/Database/%.o: $(SRC_DIR)/Database/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ—„ï¸  Compiling Database: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”§ ìˆ˜ì •: Client íŒŒì¼ë“¤ (Redis í¬í•¨)
$(BUILD_DIR)/Client/%.o: $(SRC_DIR)/Client/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ“¡ Compiling Client (Redis): $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Plugin íŒŒì¼ë“¤
$(BUILD_DIR)/Plugin/%.o: $(SRC_DIR)/Plugin/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Plugin: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë©”ì¸ íŒŒì¼
$(BUILD_DIR)/main.o: $(SRC_DIR)/main.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸš€ Compiling Main: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ìœ í‹¸ë¦¬í‹° íƒ€ê²Ÿë“¤
# =============================================================================

# ë””ë ‰í† ë¦¬ ìƒì„±
directories:
	@mkdir -p $(BUILD_DIR)/{Core,Workers/{Base,Protocol,Components},Drivers/{Common,Modbus,Mqtt,Bacnet},Database,Client,Utils,Config,Plugin}
	@mkdir -p $(BIN_DIR)

# ì •ë¦¬
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning build files...$(NC)"
	rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# ì‹¤í–‰
run: $(TARGET)
	@echo -e "$(BLUE)ğŸš€ Running $(TARGET)...$(NC)"
	cd $(BIN_DIR) && ./$(TARGET)

# ë¹Œë“œ ëª¨ë“œë³„ íƒ€ê²Ÿë“¤
debug: CXXFLAGS += -g -DPULSEONE_DEBUG_MODE -O0
debug: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
debug: check-deps clean all
	@echo -e "$(GREEN)ğŸ› Debug build completed - verbose logging enabled$(NC)"

release: CXXFLAGS += -O3 -DNDEBUG  
release: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
release: clean all
	@echo -e "$(GREEN)ğŸš€ Release build completed - optimized for performance$(NC)"

# Redis ì „ìš© í…ŒìŠ¤íŠ¸ ë¹Œë“œ
redis-test: check-deps
	@echo -e "$(BLUE)ğŸ§ª Testing Redis components only...$(NC)"
	@if [ "$(HAS_HIREDIS)" != "1" ]; then \
		echo -e "$(RED)âŒ hiredis not found - cannot test Redis$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)âœ… Redis test ready$(NC)"

# ğŸ”§ ì¶”ê°€: hiredis ì²´í¬ íƒ€ê²Ÿ
check-redis:
	@echo "ğŸ” Checking Redis/hiredis setup..."
	@if [ "$(HAS_HIREDIS)" = "1" ]; then \
		echo "âœ… hiredis headers found"; \
		if ldconfig -p | grep -q libhiredis; then \
			echo "âœ… hiredis library installed"; \
		else \
			echo "âš ï¸  hiredis library may not be properly installed"; \
		fi \
	else \
		echo "âŒ hiredis headers not found"; \
		echo "   Install: sudo apt-get install libhiredis-dev"; \
		echo "   Or compile from source: https://github.com/redis/hiredis"; \
	fi

# PHONY íƒ€ê²Ÿë“¤
.PHONY: all clean run debug release check-deps check-sources check-redis redis-test directories

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸ”§ PulseOne Collector Build System$(NC)"
	@echo ""
	@echo -e "$(GREEN)Main targets:$(NC)"
	@echo "  all              - Build the complete project"
	@echo "  clean            - Remove all build files"
	@echo "  run              - Build and run the application"
	@echo ""
	@echo -e "$(GREEN)Build modes:$(NC)"
	@echo "  debug            - Build with debug symbols and verbose logging"
	@echo "  release          - Build optimized for production"
	@echo ""
	@echo -e "$(GREEN)Development tools:$(NC)"
	@echo "  check-deps       - Check all library dependencies"
	@echo "  check-sources    - Verify all required source files exist"
	@echo "  check-redis      - Check Redis/hiredis installation"
	@echo "  redis-test       - Test Redis components only"
	@echo ""
	@echo -e "$(GREEN)Examples:$(NC)"
	@echo "  make check-deps          # Check if all libraries are available"
	@echo "  make check-redis         # Specifically check Redis setup"
	@echo "  make redis-test          # Test Redis compilation"
	@echo "  make clean && make       # Clean rebuild"