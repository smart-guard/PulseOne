# Makefile - PulseOne Collector ÎπåÎìú + Docker + CI/CD ÌôïÏû•

CXX = g++
CXXFLAGS = -std=c++17 -Wall \
	-Iinclude \
	-Iinclude/Database \
	-Iinclude/Utils \
	-Iinclude/Plugin \
	-Iinclude/Config \
	-Iinclude/Engine \
	-Iinclude/Publisher \
	-Iinclude/Drivers

LDFLAGS = -lpqxx -lpq -lsqlite3

SRCS = $(shell find src -name '*.cpp')
OBJS = $(SRCS:.cpp=.o)
TARGET = bin/collector

ENV_FILE = ../config/.env
ENV_TEMPLATE = ../config/.env.template

all: precheck $(TARGET)

# ‚úÖ 1. .env Î≥µÏÇ¨
precheck:
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "‚ö†Ô∏è  $(ENV_FILE) not found. Copying from template..."; \
		cp $(ENV_TEMPLATE) $(ENV_FILE); \
	fi

# ‚úÖ 2. ÎπåÎìú
$(TARGET): $(OBJS)
	@mkdir -p bin
	$(CXX) -o $@ $^ $(LDFLAGS)

clean:
	rm -f $(OBJS) $(TARGET)

# ‚úÖ 3. Docker ÎπåÎìú Î∞è Ïã§Ìñâ
build-docker: precheck
	docker build -t pulseone-collector -f dev.Dockerfile .

run-docker:
	docker run --rm -it \
		-v $(PWD)/../config:/app/config \
		-v $(PWD)/logrotate:/etc/logrotate.d \
		-v $(PWD)/logs:/opt/pulseone/logs \
		--name pulseone-instance \
		pulseone-collector

# ‚úÖ 4. CI/CD ÌÉÄÍ≤ü
ci-check:
	@echo "‚úÖ Running static check..."
	@$(CXX) $(CXXFLAGS) -fsyntax-only $(SRCS)

ci-build: clean all
	@echo "‚úÖ Build success."

ci-test:
	@echo "üß™ No collector unit tests defined. Skipping..."

ci: ci-check ci-build ci-test

.PHONY: all clean build-docker run-docker precheck ci-check ci-build ci-test ci
