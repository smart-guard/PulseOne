# =============================================================================
# PulseOne Collector í†µí•© Makefile (ê¸°ì¡´ + ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì§€ì›)
# ê¸°ì¡´ ì‹œìŠ¤í…œ + ìƒˆë¡œìš´ ë“œë¼ì´ë²„ ì‹œìŠ¤í…œ + Docker + CI/CD
# =============================================================================

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_NAME := pulseone-collector
VERSION := 1.0.0
BUILD_TYPE := Release

# ìƒ‰ìƒ ì •ì˜
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX := g++
CC := gcc

# ê¸°ë³¸ ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸ (ê¸°ì¡´ + í™•ì¥)
CXXFLAGS := -std=c++17 -Wall -Wextra -Wpedantic
CFLAGS := -std=c99 -Wall -Wextra

# ì¸í´ë£¨ë“œ ë””ë ‰í† ë¦¬ (ê¸°ì¡´ + ìƒˆë¡œìš´ ë“œë¼ì´ë²„)
INCLUDES := -Iinclude \
           -Iinclude/Database \
           -Iinclude/Utils \
           -Iinclude/Plugin \
           -Iinclude/Config \
           -Iinclude/Engine \
           -Iinclude/Publisher \
           -Iinclude/Drivers \
           -I/usr/local/include \
           -I/usr/include

# ë¹Œë“œ íƒ€ì…ë³„ í”Œë˜ê·¸
ifeq ($(BUILD_TYPE),Debug)
    CXXFLAGS += -g -O0 -DDEBUG -fsanitize=address
    CFLAGS += -g -O0 -DDEBUG
    LDFLAGS += -fsanitize=address
else ifeq ($(BUILD_TYPE),Release)
    CXXFLAGS += -O3 -DNDEBUG -march=native
    CFLAGS += -O3 -DNDEBUG
else ifeq ($(BUILD_TYPE),RelWithDebInfo)
    CXXFLAGS += -O2 -g -DNDEBUG
    CFLAGS += -O2 -g -DNDEBUG
endif

# pkg-configë¥¼ í†µí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
PKG_CONFIG := pkg-config

# ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬
DB_LIBS := -lpqxx -lpq -lsqlite3

# ìƒˆë¡œìš´ í”„ë¡œí† ì½œ ë¼ì´ë¸ŒëŸ¬ë¦¬
# libmodbus ì„¤ì •
MODBUS_CFLAGS := $(shell $(PKG_CONFIG) --cflags libmodbus 2>/dev/null || echo "-I/usr/local/include")
MODBUS_LIBS := $(shell $(PKG_CONFIG) --libs libmodbus 2>/dev/null || echo "-L/usr/local/lib -lmodbus")

# Paho MQTT ì„¤ì •
MQTT_CFLAGS := $(shell $(PKG_CONFIG) --cflags paho-mqtt3c paho-mqttpp3 2>/dev/null || echo "-I/usr/local/include")
MQTT_LIBS := $(shell $(PKG_CONFIG) --libs paho-mqtt3c paho-mqttpp3 2>/dev/null || echo "-L/usr/local/lib -lpaho-mqttpp3 -lpaho-mqtt3c")

# BACnet Stack ì„¤ì •
BACNET_CFLAGS := -I/usr/local/include/bacnet
BACNET_LIBS := -L/usr/local/lib -lbacnet

# ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (ìƒˆë¡œ ì„¤ì¹˜ëœ ê²ƒë“¤)
EXTRA_LIBS := -lspdlog -lhiredis -ljson-c -lconfig -lcurl -lrabbitmq

# ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬
SYSTEM_LIBS := -lpthread -ldl -lm -luuid

# SSL/TLS ë¼ì´ë¸ŒëŸ¬ë¦¬
SSL_LIBS := -lssl -lcrypto

# í†µí•© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ALL_CFLAGS := $(INCLUDES) $(MODBUS_CFLAGS) $(MQTT_CFLAGS) $(BACNET_CFLAGS)
ALL_LIBS := $(DB_LIBS) $(MODBUS_LIBS) $(MQTT_LIBS) $(BACNET_LIBS) $(EXTRA_LIBS) $(SSL_LIBS) $(SYSTEM_LIBS)

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR := src
BUILD_DIR := build
BIN_DIR := bin
LIB_DIR := lib
TEST_DIR := tests

# ì†ŒìŠ¤ íŒŒì¼ ê²€ìƒ‰ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€ + í™•ì¥)
MAIN_SRC := $(SRC_DIR)/main.cpp
ALL_SRCS := $(shell find $(SRC_DIR) -name '*.cpp' -not -name 'main.cpp' 2>/dev/null || echo "")
ALL_OBJS := $(ALL_SRCS:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJ := $(BUILD_DIR)/main.o

# ìµœì¢… ì‹¤í–‰ íŒŒì¼
TARGET := $(BIN_DIR)/$(PROJECT_NAME)

# í™˜ê²½ ì„¤ì • íŒŒì¼
ENV_FILE := ../config/.env
ENV_TEMPLATE := ../config/.env.template
ENV_DEV := ../config/.env.dev

# Docker ì„¤ì •
DOCKER_IMAGE := pulseone-collector
DOCKER_TAG := latest

# =============================================================================
# ì£¼ìš” ë¹Œë“œ íƒ€ê²Ÿë“¤
# =============================================================================

# ê¸°ë³¸ íƒ€ê²Ÿ
.DEFAULT_GOAL := all

# ëª¨ë“  íƒ€ê²Ÿ (ê¸°ì¡´ ë°©ì‹ + ìƒˆë¡œìš´ ê²€ì¦)
.PHONY: all
all: precheck directories header-check $(TARGET) post-build
	@echo -e "$(GREEN)âœ… Build completed successfully: $(TARGET)$(NC)"

# ì˜ì¡´ì„± í™•ì¸ (Dockerfileì—ì„œ ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆìœ¼ë¯€ë¡œ ìƒíƒœë§Œ í™•ì¸)
.PHONY: deps
deps:
	@echo -e "$(BLUE)ğŸ” Checking dependencies...$(NC)"
	@echo "ğŸ“¦ Library Status:"
	@$(PKG_CONFIG) --exists libmodbus && echo "  âœ… libmodbus: $$($(PKG_CONFIG) --modversion libmodbus)" || echo "  âŒ libmodbus: Not found"
	@[ -f /usr/local/include/MQTTClient.h ] && echo "  âœ… Paho MQTT C: Found" || echo "  âŒ Paho MQTT C: Not found"
	@[ -f /usr/local/include/mqtt/client.h ] && echo "  âœ… Paho MQTT C++: Found" || echo "  âŒ Paho MQTT C++: Not found"
	@[ -d /usr/local/include/bacnet ] && echo "  âœ… BACnet Stack: Found" || echo "  âŒ BACnet Stack: Not found"
	@[ -f /usr/local/include/amqp.h ] && echo "  âœ… RabbitMQ-C: Found" || echo "  âŒ RabbitMQ-C: Not found"
	@[ -f /usr/local/include/nlohmann/json.hpp ] && echo "  âœ… nlohmann/json: Found" || echo "  âŒ nlohmann/json: Not found"
	@[ -f /usr/local/include/spdlog/spdlog.h ] && echo "  âœ… spdlog: Found" || echo "  âŒ spdlog: Not found"
	@echo "âœ… All dependencies are already installed in the container!"

# ë””ë ‰í† ë¦¬ ìƒì„±
.PHONY: directories
directories:
	@mkdir -p $(BUILD_DIR)/Database $(BUILD_DIR)/Utils $(BUILD_DIR)/Plugin
	@mkdir -p $(BUILD_DIR)/Config $(BUILD_DIR)/Engine $(BUILD_DIR)/Publisher
	@mkdir -p $(BUILD_DIR)/Drivers $(BUILD_DIR)/tests
	@mkdir -p $(BIN_DIR) $(LIB_DIR)

# í™˜ê²½ ì„¤ì • í™•ì¸ (ê¸°ì¡´ ë°©ì‹ í™•ì¥)
.PHONY: precheck
precheck:
	@echo -e "$(BLUE)ğŸ” Checking environment...$(NC)"
	@if [ ! -f $(ENV_FILE) ]; then \
		if [ -f $(ENV_TEMPLATE) ]; then \
			echo -e "$(YELLOW)âš ï¸ $(ENV_FILE) not found. Copying from template...$(NC)"; \
			cp $(ENV_TEMPLATE) $(ENV_FILE); \
		elif [ -f $(ENV_DEV) ]; then \
			echo -e "$(YELLOW)âš ï¸ $(ENV_FILE) not found. Copying from dev template...$(NC)"; \
			cp $(ENV_DEV) $(ENV_FILE); \
		else \
			echo -e "$(YELLOW)âš ï¸ Creating default .env file...$(NC)"; \
			mkdir -p ../config; \
			echo "ENV_STAGE=dev" > $(ENV_FILE); \
			echo "LOG_LEVEL=info" >> $(ENV_FILE); \
		fi \
	fi
	@echo -e "$(GREEN)âœ… Environment check completed$(NC)"

# í—¤ë” íŒŒì¼ í™•ì¸ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
.PHONY: header-check
header-check:
	@echo -e "$(BLUE)ğŸ” Checking required headers...$(NC)"
	@headers_ok=true; \
	echo "#include <iostream>" | $(CXX) $(ALL_CFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <thread>" | $(CXX) $(ALL_CFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <memory>" | $(CXX) $(ALL_CFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	if [ "$$headers_ok" = "false" ]; then \
		echo -e "$(RED)âŒ Essential headers missing$(NC)"; \
		exit 1; \
	fi; \
	echo "#include <modbus.h>" | $(CXX) $(ALL_CFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "$(GREEN)âœ… Modbus headers found$(NC)" || \
		echo -e "$(YELLOW)âš ï¸ Modbus headers not found - support may be limited$(NC)"; \
	echo "#include <MQTTClient.h>" | $(CXX) $(ALL_CFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "$(GREEN)âœ… MQTT headers found$(NC)" || \
		echo -e "$(YELLOW)âš ï¸ MQTT headers not found - support may be limited$(NC)"

# ë©”ì¸ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
$(TARGET): $(MAIN_OBJ) $(ALL_OBJS)
	@echo -e "$(BLUE)ğŸ”— Linking $(TARGET)...$(NC)"
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $^ $(ALL_LIBS)

# ë©”ì¸ ì˜¤ë¸Œì íŠ¸ íŒŒì¼
$(MAIN_OBJ): $(MAIN_SRC)
	@echo -e "$(BLUE)ğŸ”¨ Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

# ì¼ë°˜ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤ (ê¸°ì¡´ íŒ¨í„´ í™•ì¥)
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ”¨ Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

# ë¹Œë“œ í›„ ì²˜ë¦¬ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
.PHONY: post-build
post-build:
	@echo -e "$(BLUE)ğŸ“‹ Post-build processing...$(NC)"
	@if [ -f "$(TARGET)" ]; then \
		chmod +x $(TARGET); \
		file_size=$$(ls -lh $(TARGET) | awk '{print $$5}'); \
		echo -e "$(GREEN)âœ… Executable created: $(TARGET) ($$file_size)$(NC)"; \
	fi
	@# ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
	@if [ ! -f "run.sh" ]; then \
		echo "#!/bin/bash" > run.sh; \
		echo "export PKG_CONFIG_PATH=\"/usr/local/lib/pkgconfig:\$$PKG_CONFIG_PATH\"" >> run.sh; \
		echo "export LD_LIBRARY_PATH=\"/usr/local/lib:\$$LD_LIBRARY_PATH\"" >> run.sh; \
		echo "$(TARGET) \"\$$@\"" >> run.sh; \
		chmod +x run.sh; \
		echo -e "$(GREEN)âœ… Created run.sh script$(NC)"; \
	fi

# =============================================================================
# ë¹Œë“œ ë³€í˜•ë“¤
# =============================================================================

# ë””ë²„ê·¸ ë¹Œë“œ
.PHONY: debug
debug:
	@$(MAKE) BUILD_TYPE=Debug all

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
.PHONY: release
release:
	@$(MAKE) BUILD_TYPE=Release all

# ì •ë¦¬
.PHONY: clean
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning build files...$(NC)"
	rm -rf $(BUILD_DIR) $(BIN_DIR) $(LIB_DIR)
	rm -f run.sh dev.sh
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# =============================================================================
# ê¸°ì¡´ Docker ë° CI/CD ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
# =============================================================================

.PHONY: build-docker
build-docker: precheck
	@echo -e "$(BLUE)ğŸ³ Building Docker image...$(NC)"
	docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) -f Dockerfile.dev .
	@echo -e "$(GREEN)âœ… Docker image built: $(DOCKER_IMAGE):$(DOCKER_TAG)$(NC)"

.PHONY: run-docker
run-docker:
	@echo -e "$(BLUE)ğŸ³ Running Docker container...$(NC)"
	docker run --rm -it \
		-v $(PWD)/../config:/app/config \
		-v $(PWD)/logrotate:/etc/logrotate.d \
		-v $(PWD)/logs:/opt/pulseone/logs \
		-v /etc/localtime:/etc/localtime:ro \
		--name pulseone-instance \
		$(DOCKER_IMAGE):$(DOCKER_TAG)

# Docker Compose ì§€ì›
.PHONY: docker-up
docker-up:
	@echo -e "$(BLUE)ğŸ³ Starting Docker Compose services...$(NC)"
	cd .. && docker-compose -f docker-compose.dev.yml up --build

.PHONY: docker-down
docker-down:
	@echo -e "$(BLUE)ğŸ³ Stopping Docker Compose services...$(NC)"
	cd .. && docker-compose -f docker-compose.dev.yml down

# Docker ì´ë¯¸ì§€ ì •ë¦¬
.PHONY: docker-clean
docker-clean:
	@echo -e "$(YELLOW)ğŸ³ Cleaning Docker images...$(NC)"
	docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG) 2>/dev/null || true
	docker system prune -f

# =============================================================================
# CI/CD íŒŒì´í”„ë¼ì¸ (ê¸°ì¡´ ìœ ì§€)
# =============================================================================

.PHONY: ci-check
ci-check:
	@echo -e "$(BLUE)âœ… Running static checks...$(NC)"
	@if [ -n "$(ALL_SRCS)" ]; then \
		$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -fsyntax-only $(ALL_SRCS) $(MAIN_SRC); \
	else \
		$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -fsyntax-only $(MAIN_SRC); \
	fi
	@echo -e "$(GREEN)âœ… Static check passed$(NC)"

.PHONY: ci-build
ci-build: clean all
	@echo -e "$(GREEN)âœ… CI build completed$(NC)"

.PHONY: ci-test
ci-test:
	@echo -e "$(BLUE)ğŸ§ª Running tests...$(NC)"
	@if [ -f "$(BIN_DIR)/run_tests" ]; then \
		$(BIN_DIR)/run_tests; \
		echo -e "$(GREEN)âœ… Tests passed$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸ No collector unit tests defined. Skipping...$(NC)"; \
	fi

.PHONY: ci
ci: ci-check ci-build ci-test
	@echo -e "$(GREEN)ğŸ‰ CI pipeline completed successfully$(NC)"

# =============================================================================
# ì •ë³´ ë° ë„ì›€ë§ (ê¸°ì¡´ ìœ ì§€í•˜ë˜ ì—…ë°ì´íŠ¸)
# =============================================================================

.PHONY: info
info:
	@echo -e "$(BLUE)=== PulseOne Collector Build Information ===$(NC)"
	@echo "Project: $(PROJECT_NAME) v$(VERSION)"
	@echo "Build Type: $(BUILD_TYPE)"
	@echo "Compiler: $(CXX) $(shell $(CXX) --version 2>/dev/null | head -n1 || echo 'not found')"
	@echo "C++ Standard: C++17"
	@echo ""
	@echo -e "$(BLUE)=== Library Information ===$(NC)"
	@echo "Database: PostgreSQL + SQLite"
	@echo "Modbus: $(shell $(PKG_CONFIG) --modversion libmodbus 2>/dev/null || echo 'manual installation')"
	@echo "MQTT: $(shell $(PKG_CONFIG) --modversion paho-mqtt3c 2>/dev/null || echo 'manual installation')"
	@echo "BACnet: Manual installation"
	@echo "Logging: spdlog"
	@echo "JSON: nlohmann/json"
	@echo "Redis: hiredis"
	@echo ""
	@echo -e "$(BLUE)=== Build Status ===$(NC)"
	@[ -f "$(TARGET)" ] && echo "Executable: Found ($(shell ls -lh $(TARGET) 2>/dev/null | awk '{print $$5}' || echo 'N/A'))" || echo "Executable: Not built"
	@[ -f "$(ENV_FILE)" ] && echo "Environment: Configured" || echo "Environment: Not configured"
	@echo "Source files: $(shell find $(SRC_DIR) -name '*.cpp' 2>/dev/null | wc -l || echo 0)"

# ì‹¤í–‰
.PHONY: run
run: all
	@echo -e "$(BLUE)ğŸš€ Running $(PROJECT_NAME)...$(NC)"
	@if [ -f "run.sh" ]; then \
		./run.sh; \
	else \
		export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$$PKG_CONFIG_PATH"; \
		export LD_LIBRARY_PATH="/usr/local/lib:$$LD_LIBRARY_PATH"; \
		$(TARGET); \
	fi

# ë„ì›€ë§
.PHONY: help
help:
	@echo -e "$(BLUE)PulseOne Collector Build System$(NC)"
	@echo "Usage: make [target]"
	@echo ""
	@echo "Main targets:"
	@echo "  all             - Build the main application (default)"
	@echo "  debug           - Build with debug symbols"
	@echo "  release         - Build optimized version"
	@echo "  deps            - Check dependencies"
	@echo "  run             - Build and run application"
	@echo "  clean           - Remove build files"
	@echo ""
	@echo "Docker targets:"
	@echo "  docker-up       - Start with Docker Compose"
	@echo "  docker-down     - Stop Docker Compose"
	@echo "  docker-clean    - Clean Docker images"
	@echo ""
	@echo "CI/CD targets:"
	@echo "  ci              - Run CI pipeline"
	@echo "  ci-check        - Static code analysis"
	@echo "  ci-build        - Clean build"
	@echo "  ci-test         - Run tests"
	@echo ""
	@echo "Utility targets:"
	@echo "  info            - Show build information"
	@echo "  help            - Show this help"