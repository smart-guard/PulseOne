# =============================================================================
# PulseOne Collector ë©”ì¸ Makefile - ì „ì²´ ëª¨ë“ˆ ì™„ì „ í†µí•© ì™„ì„±ë³¸
# /app/collector/Makefile
# ğŸ”¥ API, Network, Alarm, VirtualPoint, Platform ëª¨ë“  ìƒˆ ëª¨ë“ˆ ì™„ì „ í¬í•¨
# =============================================================================

# CPU ì½”ì–´ ìˆ˜ ìë™ ê°ì§€ ë° ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC)

# ğŸ”§ í”Œë«í¼ ê°ì§€
UNAME := $(shell uname -s)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
    IS_LINUX := 1
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
    IS_LINUX := 0
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
    IS_LINUX := 0
endif

# ğŸ”§ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ë™ì  ê°ì§€) - ëª¨ë“  í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_AS := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3as >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")
HAS_BACNET_STACK := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")
HAS_HTTPLIB := $(shell echo '\#include <httplib.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_QUICKJS := $(shell pkg-config --exists quickjs && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -fPIC \
           -Wno-unused-but-set-variable -Wno-unused-variable \
           -Wno-unused-parameter \
           -fdiagnostics-color=always
LDFLAGS = 

# ğŸ”§ í”Œë«í¼ë³„ ì»´íŒŒì¼ í”Œë˜ê·¸
ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1 -DPULSEONE_LINUX=0 \
                -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX
    PLATFORM_LIBS = -lws2_32 -liphlpapi -lkernel32 -luser32
else
    CXXFLAGS += -DPULSEONE_WINDOWS=0 -DPULSEONE_LINUX=1
    PLATFORM_LIBS = 
endif

# ê²½ë¡œ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
BIN_DIR = bin
TARGET = pulseone-collector

# ğŸ”¥ í•µì‹¬: ëª¨ë“  ìƒˆ ëª¨ë“ˆ í—¤ë” ê²½ë¡œ ì™„ì „ í¬í•¨
INCLUDES = -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Core \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Client

# =============================================================================
# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (ì¡°ê±´ë¶€ ë§í‚¹) - ëª¨ë“  ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨
# =============================================================================

# ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ (í”Œë«í¼ë³„ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
BASIC_LIBS = -lpthread -lsqlite3 -lm -ldl $(PLATFORM_LIBS)

# Modbus ë¼ì´ë¸ŒëŸ¬ë¦¬
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1; echo $$?),0)
    $(warning âš ï¸  libmodbus not found - Modbus features will be disabled)
    MODBUS_LIBS = 
    MODBUS_INCLUDES = 
else
    MODBUS_LIBS = -lmodbus
    MODBUS_INCLUDES = $(shell pkg-config --cflags libmodbus 2>/dev/null || echo "")
    INCLUDES += $(MODBUS_INCLUDES)
    $(info âœ… Modbus found)
endif

# MySQL ë¼ì´ë¸ŒëŸ¬ë¦¬
MYSQL_CONFIG := $(shell which mysql_config 2>/dev/null)
ifneq ($(MYSQL_CONFIG),)
    MYSQL_LIBS = $(shell mysql_config --libs)
    MYSQL_INCLUDES = $(shell mysql_config --include)
    INCLUDES += $(MYSQL_INCLUDES)
    $(info âœ… MySQL found: $(MYSQL_CONFIG))
else
    $(warning âš ï¸  mysql_config not found - MySQL features will be disabled)
    MYSQL_LIBS = 
    CXXFLAGS += -DDISABLE_MYSQL_FEATURES
endif

# ğŸ”§ MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê°œì„ ëœ ê°ì§€ - ë¹„ë™ê¸° SSL ì§€ì›)
MQTT_LIBS = 
MQTT_STATUS = 

# MQTT C ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë™ê¸°)
ifeq ($(HAS_MQTT_C),1)
    MQTT_LIBS += -lpaho-mqtt3c
    MQTT_STATUS += "MQTT-C:âœ… "
else
    MQTT_STATUS += "MQTT-C:âŒ "
endif

# MQTT C ë¹„ë™ê¸° SSL ë¼ì´ë¸ŒëŸ¬ë¦¬ (í•µì‹¬!)
ifeq ($(HAS_MQTT_AS),1)
    MQTT_LIBS += -lpaho-mqtt3as
    MQTT_STATUS += "MQTT-AS:âœ… "
else
    MQTT_STATUS += "MQTT-AS:âŒ "
endif

# MQTT C++ ë¼ì´ë¸ŒëŸ¬ë¦¬
ifeq ($(HAS_MQTT_CPP),1)
    MQTT_LIBS += -lpaho-mqttpp3
    MQTT_STATUS += "MQTT-CPP:âœ…"
    INCLUDES += -I/usr/local/include
else
    MQTT_STATUS += "MQTT-CPP:âŒ"
endif

# MQTT ìƒíƒœ ì¶œë ¥
ifneq ($(MQTT_LIBS),)
    $(info âœ… MQTT Libraries: $(MQTT_LIBS))
    $(info    Status: $(MQTT_STATUS))
else
    $(warning âš ï¸  No MQTT libraries found - MQTT features disabled)
endif

# PostgreSQL ë¼ì´ë¸ŒëŸ¬ë¦¬
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpqxx >/dev/null 2>&1; echo $$?),0)
    $(warning âš ï¸  libpqxx not found - PostgreSQL features will be disabled)
    PGSQL_LIBS = 
else
    PGSQL_LIBS = -lpqxx -lpq
    $(info âœ… PostgreSQL found)
endif

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬
ifeq ($(HAS_BACNET_STACK), 1)
    BACNET_LIBS = -lbacnet -lm
    BACNET_INCLUDES = -I/usr/local/include/bacnet
    INCLUDES += $(BACNET_INCLUDES)
    CXXFLAGS += -DHAS_BACNET_STACK=1
    $(info âœ… BACnet found)
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
    BACNET_LIBS = 
    $(warning âš ï¸  BACnet library not found)
endif

# Redis ë¼ì´ë¸ŒëŸ¬ë¦¬
ifeq ($(HAS_HIREDIS),1)
    REDIS_LIBS = -lhiredis -lhiredis_ssl
    CXXFLAGS += -DHAS_HIREDIS
    $(info âœ… Redis found)
else
    $(warning âš ï¸  hiredis not found - Redis functionality will be limited)
    REDIS_LIBS = 
endif

# JSON ë¼ì´ë¸ŒëŸ¬ë¦¬
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
    $(info âœ… nlohmann/json found)
endif

# ğŸ”¥ HTTP ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (API/Network ëª¨ë“ˆìš©)
ifeq ($(HAS_HTTPLIB),1)
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=1
    $(info âœ… httplib.h found - API/Network modules enabled)
else
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=0
    $(warning âš ï¸  httplib.h not found - API/Network modules disabled)
endif

# ğŸ”¥ QuickJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (ìŠ¤í¬ë¦½íŠ¸ ì•ŒëŒìš©)
ifeq ($(HAS_QUICKJS),1)
    QUICKJS_LIBS = $(shell pkg-config --libs quickjs 2>/dev/null || echo "-lquickjs")
    QUICKJS_INCLUDES = $(shell pkg-config --cflags quickjs 2>/dev/null || echo "-I/usr/local/include")
    INCLUDES += $(QUICKJS_INCLUDES)
    CXXFLAGS += -DHAS_QUICKJS=1
    $(info âœ… QuickJS found - Script alarms enabled)
else
    QUICKJS_LIBS = 
    CXXFLAGS += -DHAS_QUICKJS=0
    $(warning âš ï¸  QuickJS not found - Script alarms disabled)
endif

# ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
OPTIONAL_LIBS = $(MODBUS_LIBS) $(MYSQL_LIBS) $(PGSQL_LIBS) $(MQTT_LIBS) \
                $(BACNET_LIBS) $(REDIS_LIBS) $(HTTP_LIBS) $(QUICKJS_LIBS)
LIBS = $(BASIC_LIBS) $(OPTIONAL_LIBS)

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
PURPLE = \033[0;35m
CYAN = \033[0;36m
MAGENTA = \033[0;95m
NC = \033[0m

# =============================================================================
# ì†ŒìŠ¤ íŒŒì¼ ì •ì˜ (ê³„ì¸µì  êµ¬ì¡°) - ëª¨ë“  ìƒˆ ëª¨ë“ˆ ì™„ì „ í¬í•¨
# =============================================================================

# ê¸°ë³¸ í•„ìˆ˜ ì†ŒìŠ¤ë“¤
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

# Database ì†ŒìŠ¤ë“¤
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# Client ì†ŒìŠ¤ë“¤
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Workers ì†ŒìŠ¤ë“¤ (ìˆœì„œ ì¤‘ìš”!)
WORKERS_BASE_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp)
WORKERS_PROTOCOL_SOURCES := $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp)
WORKERS_COMPONENTS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Components/*.cpp)
WORKERS_SOURCES := $(WORKERS_BASE_SOURCES) $(WORKERS_PROTOCOL_SOURCES) $(WORKERS_COMPONENTS_SOURCES) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# Drivers ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨)
DRIVERS_COMMON_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
DRIVERS_SOURCES = $(DRIVERS_COMMON_SOURCES)

# Modbus ë“œë¼ì´ë²„
ifneq ($(MODBUS_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif

# MQTT ë“œë¼ì´ë²„ (ìˆ˜ì •ë¨ - ë” ìœ ì—°í•œ ì¡°ê±´)
ifneq ($(MQTT_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
    $(info âœ… Including MQTT driver sources)
else
    $(warning âš ï¸  MQTT driver sources excluded - no MQTT libraries)
endif

# BACnet ë“œë¼ì´ë²„
ifeq ($(HAS_BACNET_STACK),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif

# Pipeline ì†ŒìŠ¤ë“¤
PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)

# Plugin ì†ŒìŠ¤ë“¤
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

# ğŸ”¥ ì•ŒëŒ ì†ŒìŠ¤ë“¤ (QuickJS ìŠ¤í¬ë¦½íŠ¸ ì•ŒëŒ í¬í•¨)
ALARM_SOURCES := $(wildcard $(SRC_DIR)/Alarm/*.cpp)

# ğŸ”¥ ê°€ìƒí¬ì¸íŠ¸ ì†ŒìŠ¤ë“¤
VIRTUALPOINT_SOURCES := $(wildcard $(SRC_DIR)/VirtualPoint/*.cpp)

# ğŸ”¥ Network ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨ - httplib í•„ìš”)
ifeq ($(HAS_HTTPLIB),1)
    NETWORK_SOURCES := $(wildcard $(SRC_DIR)/Network/*.cpp)
    $(info âœ… Including Network sources: $(words $(NETWORK_SOURCES)) files)
else
    NETWORK_SOURCES :=
    $(warning âš ï¸  Network sources excluded - httplib not available)
endif

# ğŸ”¥ API ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨ - httplib í•„ìš”)
ifeq ($(HAS_HTTPLIB),1)
    API_SOURCES := $(wildcard $(SRC_DIR)/Api/*.cpp)
    $(info âœ… Including API sources: $(words $(API_SOURCES)) files)
else
    API_SOURCES :=
    $(warning âš ï¸  API sources excluded - httplib not available)
endif

# ğŸ”¥ Platform ì†ŒìŠ¤ë“¤ (í—¤ë” ì˜¨ë¦¬ì§€ë§Œ í–¥í›„ í™•ì¥ ëŒ€ë¹„)
PLATFORM_SOURCES := $(wildcard $(SRC_DIR)/Platform/*.cpp)

# ë©”ì¸ ì†ŒìŠ¤
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ğŸ”¥ ì „ì²´ ì†ŒìŠ¤ ì¡°í•© (ëª¨ë“  ìƒˆ ëª¨ë“ˆ ì™„ì „ í¬í•¨)
ALL_LIB_SOURCES = $(CORE_SOURCES) $(UTILS_SOURCES) $(CONFIG_SOURCES) \
                  $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(WORKERS_SOURCES) \
                  $(DRIVERS_SOURCES) $(PIPELINE_SOURCES) $(PLUGIN_SOURCES) \
                  $(ALARM_SOURCES) $(VIRTUALPOINT_SOURCES) $(NETWORK_SOURCES) \
                  $(API_SOURCES) $(PLATFORM_SOURCES)

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
ALL_LIB_OBJECTS = $(ALL_LIB_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJECT = $(MAIN_SOURCE:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
ALL_OBJECTS = $(ALL_LIB_OBJECTS) $(MAIN_OBJECT)

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤
# =============================================================================

.DEFAULT_GOAL := help

# ğŸ”¥ ë””ë ‰í† ë¦¬ ìƒì„± (ëª¨ë“  ìƒˆ ëª¨ë“ˆ ë””ë ‰í† ë¦¬ ì™„ì „ í¬í•¨)
$(BUILD_DIR):
	@echo -e "$(BLUE)ğŸ“ Creating build directories for $(PLATFORM)...$(NC)"
	@mkdir -p $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Core
	@mkdir -p $(BUILD_DIR)/Utils $(BUILD_DIR)/Config $(BUILD_DIR)/Database/Entities $(BUILD_DIR)/Database/Repositories
	@mkdir -p $(BUILD_DIR)/Client $(BUILD_DIR)/Workers/Base $(BUILD_DIR)/Workers/Protocol $(BUILD_DIR)/Workers/Components
	@mkdir -p $(BUILD_DIR)/Drivers/Common $(BUILD_DIR)/Drivers/Modbus $(BUILD_DIR)/Drivers/Mqtt $(BUILD_DIR)/Drivers/Bacnet
	@mkdir -p $(BUILD_DIR)/Pipeline $(BUILD_DIR)/Alarm $(BUILD_DIR)/VirtualPoint $(BUILD_DIR)/Plugin 
	@mkdir -p $(BUILD_DIR)/Network $(BUILD_DIR)/Api $(BUILD_DIR)/Platform
	@echo -e "$(GREEN)âœ… Build directories created for $(PLATFORM) (all modules)$(NC)"

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

directories: $(BUILD_DIR) $(BIN_DIR)

# ğŸ”§ ì†ŒìŠ¤ íŒŒì¼ ê²€ì¦ (ëª¨ë“  ëª¨ë“ˆ ì™„ì „ í¬í•¨)
check-sources:
	@echo -e "$(BLUE)ğŸ” Checking required source files for $(PLATFORM)...$(NC)"
	@echo -e "$(YELLOW)Main source:$(NC)"
	@if [ -f "$(MAIN_SOURCE)" ]; then \
		echo -e "  âœ… $(MAIN_SOURCE)"; \
	else \
		echo -e "  âŒ $(MAIN_SOURCE) (MISSING)"; \
		exit 1; \
	fi
	@echo -e "$(YELLOW)Source counts by module:$(NC)"
	@echo "  Core: $(words $(CORE_SOURCES))"
	@echo "  Utils: $(words $(UTILS_SOURCES))"
	@echo "  Config: $(words $(CONFIG_SOURCES))"
	@echo "  Database: $(words $(DATABASE_SOURCES))"
	@echo "  Workers: $(words $(WORKERS_SOURCES))"
	@echo "  Drivers: $(words $(DRIVERS_SOURCES))"
	@echo "  Client: $(words $(CLIENT_SOURCES))"
	@echo "  Pipeline: $(words $(PIPELINE_SOURCES))"
	@echo "  Plugin: $(words $(PLUGIN_SOURCES))"
	@echo "  ğŸ”¥ Alarm: $(words $(ALARM_SOURCES))"
	@echo "  ğŸ”¥ VirtualPoint: $(words $(VIRTUALPOINT_SOURCES))"
	@echo "  ğŸ”¥ Network: $(words $(NETWORK_SOURCES))"
	@echo "  ğŸ”¥ Api: $(words $(API_SOURCES))"
	@echo "  ğŸ”¥ Platform: $(words $(PLATFORM_SOURCES))"
	@echo -e "$(GREEN)Total sources: $(words $(ALL_LIB_SOURCES)) files$(NC)"

# ğŸ”¥ ì˜ì¡´ì„± í™•ì¸ (ëª¨ë“  ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì™„ì „ í¬í•¨)
check-deps:
	@echo -e "$(BLUE)ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì²´í¬ for $(PLATFORM)$(NC)"
	@echo -e "$(YELLOW)========================================$(NC)"
	@echo "Platform: $(PLATFORM) (Windows: $(IS_WINDOWS), Linux: $(IS_LINUX))"
	@echo ""
	@echo -e "$(BLUE)ğŸ“¦ ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… $(MODBUS_LIBS),âŒ not found)"
	@echo "  MySQL: $(if $(MYSQL_LIBS),âœ… found,âŒ not found)"
	@echo "  PostgreSQL: $(if $(PGSQL_LIBS),âœ… $(PGSQL_LIBS),âŒ not found)"
	@echo "  MQTT: $(if $(MQTT_LIBS),âœ… $(MQTT_LIBS),âŒ not found)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… $(BACNET_LIBS),âŒ not found)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ… $(REDIS_LIBS),âŒ not found)"
	@echo ""
	@echo -e "$(BLUE)ğŸ”¥ ìƒˆ ëª¨ë“ˆ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:$(NC)"
	@echo "  HTTP (API/Network): $(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ… available,âŒ unavailable)"
	@echo "  QuickJS (Script Alarms): $(if $(QUICKJS_LIBS),âœ… available $(QUICKJS_LIBS),âŒ unavailable)"
	@echo "  Platform libs: $(if $(PLATFORM_LIBS),âœ… $(PLATFORM_LIBS),â„¹ï¸  no platform-specific libs)"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ MQTT ìƒì„¸ ìƒíƒœ:$(NC)"
	@echo "  $(MQTT_STATUS)"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ ëª¨ë“ˆë³„ ì†ŒìŠ¤ ì§‘ê³„:$(NC)"
	@echo "  ì „ì²´ ì†ŒìŠ¤ íŒŒì¼: $(words $(ALL_LIB_SOURCES))"
	@echo "  Alarm ëª¨ë“ˆ: $(words $(ALARM_SOURCES)) files"
	@echo "  VirtualPoint ëª¨ë“ˆ: $(words $(VIRTUALPOINT_SOURCES)) files"
	@echo "  Network ëª¨ë“ˆ: $(words $(NETWORK_SOURCES)) files"
	@echo "  Api ëª¨ë“ˆ: $(words $(API_SOURCES)) files"
	@echo "  Platform ëª¨ë“ˆ: $(words $(PLATFORM_SOURCES)) files"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ ìµœì¢… ë§ì»¤ ë¼ì´ë¸ŒëŸ¬ë¦¬:$(NC)"
	@echo "  LIBS: $(LIBS)"

# ì „ì²´ ë¹Œë“œ
all: check-deps check-sources directories $(TARGET)
	@echo -e "$(GREEN)ğŸ‰ Build completed successfully for $(PLATFORM) (all modules)!$(NC)"
	@echo -e "$(BLUE)ğŸ“¦ Executable: $(BIN_DIR)/$(TARGET)$(NC)"
	@echo -e "$(BLUE)ğŸ“Š Total object files: $(words $(ALL_OBJECTS))$(NC)"
	@echo -e "$(BLUE)ğŸ”¥ Included modules: Core, Utils, Config, Database, Workers, Drivers, Pipeline, Plugin, Alarm, VirtualPoint, Network, Api, Platform$(NC)"

# ë©”ì¸ ì‹¤í–‰ íŒŒì¼
$(TARGET): $(ALL_OBJECTS) | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking $(TARGET) for $(PLATFORM) (all modules)...$(NC)"
	@echo -e "$(YELLOW)   Objects: $(words $(ALL_OBJECTS))$(NC)"
	@echo -e "$(YELLOW)   Libraries: $(LIBS)$(NC)"
	@mkdir -p $(BIN_DIR)
	$(CXX) $(LDFLAGS) -o $(BIN_DIR)/$@ $(ALL_OBJECTS) $(LIBS)
	@echo -e "$(GREEN)âœ… $(TARGET) built successfully for $(PLATFORM) with all modules!$(NC)"

# =============================================================================
# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼ ê·œì¹™ (ëª¨ë“  ìƒˆ ëª¨ë“ˆ ì™„ì „ í¬í•¨)
# =============================================================================

# Core íŒŒì¼ë“¤
$(BUILD_DIR)/Core/%.o: $(SRC_DIR)/Core/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Core
	@echo -e "$(GREEN)ğŸ›ï¸  Compiling Core: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Utils íŒŒì¼ë“¤
$(BUILD_DIR)/Utils/%.o: $(SRC_DIR)/Utils/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Utils
	@echo -e "$(GREEN)ğŸ”§ Compiling Utils: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Config íŒŒì¼ë“¤
$(BUILD_DIR)/Config/%.o: $(SRC_DIR)/Config/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Config
	@echo -e "$(BLUE)âš™ï¸  Compiling Config: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Workers íŒŒì¼ë“¤
$(BUILD_DIR)/Workers/%.o: $(SRC_DIR)/Workers/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ‘· Compiling Worker: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Drivers íŒŒì¼ë“¤
$(BUILD_DIR)/Drivers/%.o: $(SRC_DIR)/Drivers/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Driver: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Database íŒŒì¼ë“¤
$(BUILD_DIR)/Database/%.o: $(SRC_DIR)/Database/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ—„ï¸  Compiling Database: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Client íŒŒì¼ë“¤
$(BUILD_DIR)/Client/%.o: $(SRC_DIR)/Client/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Client
	@echo -e "$(BLUE)ğŸ“¡ Compiling Client: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Pipeline íŒŒì¼ë“¤
$(BUILD_DIR)/Pipeline/%.o: $(SRC_DIR)/Pipeline/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Pipeline
	@echo -e "$(PURPLE)âš¡ Compiling Pipeline: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Plugin íŒŒì¼ë“¤
$(BUILD_DIR)/Plugin/%.o: $(SRC_DIR)/Plugin/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Plugin
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Plugin: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ Alarm íŒŒì¼ë“¤ ì»´íŒŒì¼ (QuickJS ìŠ¤í¬ë¦½íŠ¸ ì•ŒëŒ ì§€ì›)
$(BUILD_DIR)/Alarm/%.o: $(SRC_DIR)/Alarm/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Alarm
	@echo -e "$(RED)ğŸš¨ Compiling Alarm: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ VirtualPoint íŒŒì¼ë“¤ ì»´íŒŒì¼
$(BUILD_DIR)/VirtualPoint/%.o: $(SRC_DIR)/VirtualPoint/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/VirtualPoint
	@echo -e "$(CYAN)ğŸ¯ Compiling VirtualPoint: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ Network íŒŒì¼ë“¤ ì»´íŒŒì¼ (REST API ì„œë²„)
$(BUILD_DIR)/Network/%.o: $(SRC_DIR)/Network/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Network
	@echo -e "$(MAGENTA)ğŸŒ Compiling Network: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ Api íŒŒì¼ë“¤ ì»´íŒŒì¼
$(BUILD_DIR)/Api/%.o: $(SRC_DIR)/Api/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Api
	@echo -e "$(GREEN)ğŸ”— Compiling Api: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ Platform íŒŒì¼ë“¤ ì»´íŒŒì¼ (í¬ë¡œìŠ¤ í”Œë«í¼ í˜¸í™˜ì„±)
$(BUILD_DIR)/Platform/%.o: $(SRC_DIR)/Platform/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Platform
	@echo -e "$(CYAN)ğŸ›¡ï¸  Compiling Platform: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë©”ì¸ íŒŒì¼
$(BUILD_DIR)/main.o: $(SRC_DIR)/main.cpp | $(BUILD_DIR)
	@echo -e "$(BLUE)ğŸš€ Compiling Main: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ìœ í‹¸ë¦¬í‹° íƒ€ê²Ÿë“¤
# =============================================================================

# ì •ë¦¬
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning build files for $(PLATFORM)...$(NC)"
	-rm -rf $(BUILD_DIR) $(BIN_DIR) 2>/dev/null || true
	@echo -e "$(GREEN)âœ… Clean completed for $(PLATFORM)$(NC)"

# ì‹¤í–‰
run: $(TARGET)
	@echo -e "$(BLUE)ğŸš€ Running $(TARGET) on $(PLATFORM)...$(NC)"
	cd $(BIN_DIR) && ./$(TARGET)

# ë¹Œë“œ ëª¨ë“œë³„ íƒ€ê²Ÿë“¤
debug: CXXFLAGS += -g -DPULSEONE_DEBUG_MODE -O0
debug: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
debug: check-deps clean all
	@echo -e "$(GREEN)ğŸ› Debug build completed for $(PLATFORM) - verbose logging enabled$(NC)"

release: CXXFLAGS += -O3 -DNDEBUG  
release: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
release: clean all
	@echo -e "$(GREEN)ğŸš€ Release build completed for $(PLATFORM) - optimized for performance$(NC)"

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´)
test-build:
	@echo -e "$(BLUE)ğŸ§ª Testing build without optional libraries on $(PLATFORM)...$(NC)"
	$(MAKE) MODBUS_LIBS= MQTT_LIBS= BACNET_LIBS= REDIS_LIBS= HTTP_LIBS= QUICKJS_LIBS= all

# ğŸ”§ MQTT ì „ìš© ì²´í¬ íƒ€ê²Ÿ
check-mqtt:
	@echo -e "$(BLUE)ğŸ” MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ì„¤ì¹˜ëœ MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬:$(NC)"
	@ls -la /usr/local/lib/libpaho-mqtt* 2>/dev/null || echo "  âŒ No MQTT libraries in /usr/local/lib"
	@echo ""
	@echo -e "$(BLUE)ì‹œìŠ¤í…œ ê²½ë¡œì˜ MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬:$(NC)"
	@ldconfig -p | grep paho || echo "  âŒ No paho libraries in system path"
	@echo ""
	@echo -e "$(BLUE)ë§í¬ í…ŒìŠ¤íŠ¸:$(NC)"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "  âœ… mqtt3c: OK" || echo "  âŒ mqtt3c: Failed"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3as >/dev/null 2>&1 && echo "  âœ… mqtt3as: OK" || echo "  âŒ mqtt3as: Failed"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "  âœ… mqttpp3: OK" || echo "  âŒ mqttpp3: Failed"
	@echo ""
	@echo -e "$(BLUE)ì¡°í•© í…ŒìŠ¤íŠ¸:$(NC)"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - $(MQTT_LIBS) >/dev/null 2>&1 && echo "  âœ… All MQTT libs combined: OK" || echo "  âŒ Combined test: Failed"

# ğŸ”¥ HTTP/API ì „ìš© ì²´í¬
check-http:
	@echo -e "$(BLUE)ğŸ” HTTP/API ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)====================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)í—¤ë” ì²´í¬:$(NC)"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - >/dev/null 2>&1 && echo "  âœ… ê¸°ë³¸ ì»´íŒŒì¼: OK" || echo "  âŒ ê¸°ë³¸ ì»´íŒŒì¼: Failed"
	@echo '\#include <httplib.h>' | $(CXX) -E -x c++ - $(INCLUDES) >/dev/null 2>&1 && echo "  âœ… httplib.h: Found" || echo "  âŒ httplib.h: Not found"
	@echo ""
	@echo -e "$(BLUE)Api/Network ëª¨ë“ˆ í™œì„±í™” ìƒíƒœ:$(NC)"
	@echo "  API modules: $(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ… enabled,âŒ disabled)"
	@echo "  Network sources: $(words $(NETWORK_SOURCES)) files"
	@echo "  Api sources: $(words $(API_SOURCES)) files"

# ğŸ”¥ QuickJS/Alarm ì „ìš© ì²´í¬
check-quickjs:
	@echo -e "$(BLUE)ğŸ” QuickJS/Alarm ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)=====================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)QuickJS ì²´í¬:$(NC)"
	@pkg-config --exists quickjs && echo "  âœ… quickjs pkg-config: OK" || echo "  âŒ quickjs pkg-config: Failed"
	@pkg-config --libs quickjs 2>/dev/null && echo "  âœ… quickjs libs found" || echo "  âŒ quickjs libs not found"
	@echo ""
	@echo -e "$(BLUE)Alarm ëª¨ë“ˆ í™œì„±í™” ìƒíƒœ:$(NC)"
	@echo "  Script alarms: $(if $(filter -DHAS_QUICKJS=1,$(CXXFLAGS)),âœ… enabled,âŒ disabled)"
	@echo "  Alarm sources: $(words $(ALARM_SOURCES)) files"
	@echo "  QuickJS libs: $(if $(QUICKJS_LIBS),$(QUICKJS_LIBS),none)"

# ğŸ”¥ ë¹Œë“œ ìƒíƒœ í™•ì¸ (ëª¨ë“  ëª¨ë“ˆ í¬í•¨)
status:
	@echo -e "$(BLUE)ğŸ—ï¸ Complete Build Status for $(PLATFORM)$(NC)"
	@echo -e "$(YELLOW)======================================$(NC)"
	@echo "Platform: $(PLATFORM) (Windows: $(IS_WINDOWS), Linux: $(IS_LINUX))"
	@echo "Object files: $(words $(wildcard $(BUILD_DIR)/**/*.o)) / $(words $(ALL_OBJECTS))"
	@echo ""
	@echo -e "$(BLUE)ğŸ“Š ì†ŒìŠ¤ íŒŒì¼ í†µê³„:$(NC)"
	@echo "  ì „ì²´ ì†ŒìŠ¤: $(words $(ALL_LIB_SOURCES)) files"
	@echo "  Core/ê¸°ë³¸: $(words $(CORE_SOURCES))$(if $(UTILS_SOURCES), + $(words $(UTILS_SOURCES))) + $(words $(CONFIG_SOURCES)) + $(words $(DATABASE_SOURCES)) = $(shell expr $(words $(CORE_SOURCES)) + $(words $(UTILS_SOURCES)) + $(words $(CONFIG_SOURCES)) + $(words $(DATABASE_SOURCES))) files"
	@echo "  Workers/Drivers: $(words $(WORKERS_SOURCES)) + $(words $(DRIVERS_SOURCES)) = $(shell expr $(words $(WORKERS_SOURCES)) + $(words $(DRIVERS_SOURCES))) files"
	@echo "  ğŸ”¥ ìƒˆ ëª¨ë“ˆë“¤: $(words $(ALARM_SOURCES)) + $(words $(VIRTUALPOINT_SOURCES)) + $(words $(NETWORK_SOURCES)) + $(words $(API_SOURCES)) + $(words $(PLATFORM_SOURCES)) = $(shell expr $(words $(ALARM_SOURCES)) + $(words $(VIRTUALPOINT_SOURCES)) + $(words $(NETWORK_SOURCES)) + $(words $(API_SOURCES)) + $(words $(PLATFORM_SOURCES))) files"
	@echo "  ê¸°íƒ€: $(words $(CLIENT_SOURCES)) + $(words $(PIPELINE_SOURCES)) + $(words $(PLUGIN_SOURCES)) = $(shell expr $(words $(CLIENT_SOURCES)) + $(words $(PIPELINE_SOURCES)) + $(words $(PLUGIN_SOURCES))) files"
	@echo ""
	@echo -e "$(BLUE)ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ:$(NC)"
	@echo "  ê¸°ë³¸: Modbus$(if $(MODBUS_LIBS),âœ…,âŒ), MQTT$(if $(MQTT_LIBS),âœ…,âŒ), BACnet$(if $(BACNET_LIBS),âœ…,âŒ), Redis$(if $(REDIS_LIBS),âœ…,âŒ)"
	@echo "  ğŸ”¥ ìƒˆ ë¼ì´ë¸ŒëŸ¬ë¦¬: HTTP$(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ…,âŒ), QuickJS$(if $(QUICKJS_LIBS),âœ…,âŒ), Platform$(if $(PLATFORM_LIBS),âœ…,â„¹ï¸ )"
	@echo ""
	@echo -e "$(BLUE)ğŸ“ ë¹Œë“œ íŒŒì¼:$(NC)"
	@echo "  Binary: $(if $(wildcard $(BIN_DIR)/$(TARGET)),âœ… $(BIN_DIR)/$(TARGET),âŒ missing)"
	@echo "  Build dir: $(if $(wildcard $(BUILD_DIR)),âœ… exists,âŒ missing)"

# ì§„ë‹¨
diagnose:
	@echo -e "$(BLUE)ğŸ¥ ì¢…í•© ì‹œìŠ¤í…œ ì§„ë‹¨ for $(PLATFORM)$(NC)"
	@echo -e "$(YELLOW)===============$(NC)"
	@echo ""
	@echo -e "$(BLUE)í”Œë«í¼ ì •ë³´:$(NC)"
	@echo "  Platform: $(PLATFORM)"
	@echo "  Windows build: $(IS_WINDOWS)"
	@echo "  Linux build: $(IS_LINUX)"
	@echo "  Platform libs: $(if $(PLATFORM_LIBS),$(PLATFORM_LIBS),none)"
	@echo ""
	@echo -e "$(BLUE)ì»´íŒŒì¼ëŸ¬:$(NC)"
	@$(CXX) --version | head -1
	@echo ""
	@echo -e "$(BLUE)ì§ì ‘ ë§í‚¹ í…ŒìŠ¤íŠ¸:$(NC)"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "  âœ… MQTT C ë§í¬ ì„±ê³µ" || echo "  âŒ MQTT C ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3as >/dev/null 2>&1 && echo "  âœ… MQTT AS ë§í¬ ì„±ê³µ" || echo "  âŒ MQTT AS ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "  âœ… MQTT C++ ë§í¬ ì„±ê³µ" || echo "  âŒ MQTT C++ ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1 && echo "  âœ… Modbus ë§í¬ ì„±ê³µ" || echo "  âŒ Modbus ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lhiredis >/dev/null 2>&1 && echo "  âœ… Redis ë§í¬ ì„±ê³µ" || echo "  âŒ Redis ë§í¬ ì‹¤íŒ¨"
	@echo ""
	@echo -e "$(BLUE)ğŸ”¥ ìƒˆ ëª¨ë“ˆ ì§„ë‹¨:$(NC)"
	@echo '\#include <httplib.h>' | $(CXX) -E -x c++ - $(INCLUDES) >/dev/null 2>&1 && echo "  âœ… HTTP ë¼ì´ë¸ŒëŸ¬ë¦¬ í—¤ë” OK" || echo "  âŒ HTTP ë¼ì´ë¸ŒëŸ¬ë¦¬ í—¤ë” ì‹¤íŒ¨"
	@pkg-config --exists quickjs && echo "  âœ… QuickJS pkg-config OK" || echo "  âŒ QuickJS pkg-config ì‹¤íŒ¨"

# ğŸ”¥ í¬ë¡œìŠ¤ í”Œë«í¼ ì¤€ë¹„ í™•ì¸
check-cross-platform:
	@echo -e "$(MAGENTA)ğŸ›¡ï¸  Cross-Platform Compatibility Check$(NC)"
	@echo -e "$(YELLOW)=======================================$(NC)"
	@echo "Platform detection: $(if $(filter Windows,$(PLATFORM)),âœ… Windows detected,$(if $(filter Linux,$(PLATFORM)),âœ… Linux detected,â„¹ï¸  Other: $(PLATFORM)))"
	@echo "PlatformCompat.h: $(if $(wildcard $(INCLUDE_DIR)/Platform/PlatformCompat.h),âœ… exists,âŒ missing)"
	@echo "Platform includes: $(if $(findstring -I$(INCLUDE_DIR)/Platform,$(INCLUDES)),âœ… included,âŒ missing)"
	@echo "Platform flags: $(if $(IS_WINDOWS),âœ… Windows build ready,$(if $(IS_LINUX),âœ… Linux build ready,â“ Unknown platform))"
	@echo "Platform libs: $(if $(PLATFORM_LIBS),âœ… $(PLATFORM_LIBS),â„¹ï¸  No platform-specific libs)"
	@echo "Platform sources: $(words $(PLATFORM_SOURCES)) files"
	@echo ""
	@echo -e "$(GREEN)Status: $(if $(wildcard $(INCLUDE_DIR)/Platform/PlatformCompat.h),ğŸ¯ Ready for cross-platform compilation,âš ï¸  Consider creating PlatformCompat.h)$(NC)"

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸ”§ PulseOne Collector Complete Build System$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo "Platform: $(PLATFORM)"
	@echo "All modules: Core, Utils, Config, Database, Workers, Drivers, Pipeline, Plugin"
	@echo "ğŸ”¥ New modules: Alarm, VirtualPoint, Network, Api, Platform"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ ì£¼ìš” ëª…ë ¹ì–´:$(NC)"
	@echo "  make all              - ì „ì²´ í”„ë¡œì íŠ¸ ë¹Œë“œ (ëª¨ë“  ëª¨ë“ˆ í¬í•¨)"
	@echo "  make clean            - ë¹Œë“œ íŒŒì¼ ì •ë¦¬"
	@echo "  make run              - ë¹Œë“œ í›„ ì‹¤í–‰"
	@echo ""
	@echo -e "$(GREEN)ğŸ”¨ ë¹Œë“œ ëª¨ë“œ:$(NC)"
	@echo "  make debug            - ë””ë²„ê·¸ ëª¨ë“œ ë¹Œë“œ (ìƒì„¸ ë¡œê¹…)"
	@echo "  make release          - ë¦´ë¦¬ì¦ˆ ëª¨ë“œ ë¹Œë“œ (ìµœì í™”)"
	@echo "  make test-build       - ìµœì†Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ í…ŒìŠ¤íŠ¸ ë¹Œë“œ"
	@echo ""
	@echo -e "$(GREEN)ğŸ” ì§„ë‹¨ ë„êµ¬:$(NC)"
	@echo "  make check-deps       - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± í™•ì¸"
	@echo "  make check-sources    - ì†ŒìŠ¤ íŒŒì¼ ì¡´ì¬ í™•ì¸"
	@echo "  make check-mqtt       - MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬"
	@echo "  make check-http       - HTTP/API ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬"
	@echo "  make check-quickjs    - QuickJS/Alarm ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„¸ ì²´í¬"
	@echo "  make check-cross-platform - í¬ë¡œìŠ¤ í”Œë«í¼ í˜¸í™˜ì„± ì²´í¬"
	@echo "  make diagnose         - ì „ì²´ ì‹œìŠ¤í…œ ì§„ë‹¨"
	@echo "  make status           - ë¹Œë“œ ìƒíƒœ í™•ì¸"
	@echo ""
	@echo -e "$(CYAN)ğŸ”¥ ìƒˆ ëª¨ë“ˆ ìƒíƒœ:$(NC)"
	@echo "  API/Network: $(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ… enabled ($(shell expr $(words $(API_SOURCES)) + $(words $(NETWORK_SOURCES))) files),âŒ disabled)"
	@echo "  Alarm/Script: $(if $(filter -DHAS_QUICKJS=1,$(CXXFLAGS)),âœ… enabled ($(words $(ALARM_SOURCES)) files),âŒ disabled)"
	@echo "  VirtualPoint: $(words $(VIRTUALPOINT_SOURCES)) files"
	@echo "  Platform: $(words $(PLATFORM_SOURCES)) files"
	@echo ""
	@echo -e "$(GREEN)ğŸ¯ ì¶”ì²œ ì‚¬ìš©ë²•:$(NC)"
	@echo "  make check-deps && make status    # ì „ì²´ ìƒíƒœ í™•ì¸"
	@echo "  make clean && make all           # í´ë¦° ë¹Œë“œ"
	@echo "  make debug                       # ê°œë°œ ì‹œ ë””ë²„ê·¸ ë¹Œë“œ"
	@echo "  make diagnose                    # ë¬¸ì œ ë°œìƒ ì‹œ ì§„ë‹¨"

# PHONY íƒ€ê²Ÿë“¤
.PHONY: all clean run debug release check-deps check-sources check-mqtt check-http check-quickjs \
        test-build diagnose directories status help check-cross-platform

# ìë™ ì¢…ì†ì„± ìƒì„± (ê³ ê¸‰ ê¸°ëŠ¥)
-include $(ALL_OBJECTS:.o=.d)

$(BUILD_DIR)/%.d: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@echo -e "$(YELLOW)ğŸ”— Generating dependencies for $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $(BUILD_DIR)/$*.o $< > $@