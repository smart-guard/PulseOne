# =============================================================================
# PulseOne Collector í†µí•© Makefile v2.0
# ê¸°ì¡´ ì‹œìŠ¤í…œ + ìƒˆë¡œìš´ ë°ì´í„° ì•¡ì„¸ìŠ¤ ì•„í‚¤í…ì²˜ + Docker + CI/CD
# =============================================================================

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_NAME := pulseone-collector
VERSION := 2.0.0
BUILD_TYPE := Release

# ìƒ‰ìƒ ì •ì˜
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
PURPLE := \033[0;35m
CYAN := \033[0;36m
NC := \033[0m

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX := g++
CC := gcc

# ê¸°ë³¸ ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸ (C++17 + ìƒˆ ì•„í‚¤í…ì²˜ ìš”êµ¬ì‚¬í•­)
CXXFLAGS := -std=c++17 -Wall -Wextra -Wpedantic -Wno-unused-parameter
CFLAGS := -std=c99 -Wall -Wextra

# ì¸í´ë£¨ë“œ ë””ë ‰í† ë¦¬ (ê¸°ì¡´ + ìƒˆë¡œìš´ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µ)
INCLUDES := -Iinclude \
           -Iinclude/Database \
           -Iinclude/Utils \
           -Iinclude/Plugin \
           -Iinclude/Config \
           -Iinclude/Engine \
           -Iinclude/Publisher \
           -Iinclude/Drivers \
           -I/usr/local/include \
           -I/usr/include

# ë¹Œë“œ íƒ€ì…ë³„ í”Œë˜ê·¸
ifeq ($(BUILD_TYPE),Debug)
    CXXFLAGS += -g -O0 -DDEBUG -fsanitize=address -fno-omit-frame-pointer
    CFLAGS += -g -O0 -DDEBUG
    LDFLAGS += -fsanitize=address
    BUILD_SUFFIX := _debug
else ifeq ($(BUILD_TYPE),Release)
    CXXFLAGS += -O3 -DNDEBUG -march=native -flto
    CFLAGS += -O3 -DNDEBUG -march=native
    LDFLAGS += -flto
    BUILD_SUFFIX := 
else ifeq ($(BUILD_TYPE),RelWithDebInfo)
    CXXFLAGS += -O2 -g -DNDEBUG
    CFLAGS += -O2 -g -DNDEBUG
    BUILD_SUFFIX := _rel_debug
endif

# pkg-configë¥¼ í†µí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
PKG_CONFIG := pkg-config

# =============================================================================
# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (ê¸°ì¡´ + ìƒˆ ì•„í‚¤í…ì²˜ ìš”êµ¬ì‚¬í•­)
# =============================================================================

# ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ (PostgreSQL ìš°ì„ )
DB_LIBS := -lpqxx -lpq -lsqlite3

# ìƒˆë¡œìš´ í”„ë¡œí† ì½œ ë¼ì´ë¸ŒëŸ¬ë¦¬
# libmodbus ì„¤ì •
MODBUS_CFLAGS := $(shell $(PKG_CONFIG) --cflags libmodbus 2>/dev/null || echo "-I/usr/local/include")
MODBUS_LIBS := $(shell $(PKG_CONFIG) --libs libmodbus 2>/dev/null || echo "-L/usr/local/lib -lmodbus")
ifneq ($(shell $(PKG_CONFIG) --exists libmodbus 2>/dev/null; echo $$?),0)
    CXXFLAGS += -DHAVE_LIBMODBUS=0
else
    CXXFLAGS += -DHAVE_LIBMODBUS=1
endif

# Paho MQTT ì„¤ì •
MQTT_CFLAGS := $(shell $(PKG_CONFIG) --cflags paho-mqtt3c paho-mqttpp3 2>/dev/null || echo "-I/usr/local/include")
MQTT_LIBS := $(shell $(PKG_CONFIG) --libs paho-mqtt3c paho-mqttpp3 2>/dev/null || echo "-L/usr/local/lib -lpaho-mqttpp3 -lpaho-mqtt3c")
ifneq ($(shell $(PKG_CONFIG) --exists paho-mqtt3c 2>/dev/null; echo $$?),0)
    CXXFLAGS += -DHAVE_PAHO_MQTT=0
else
    CXXFLAGS += -DHAVE_PAHO_MQTT=1
endif

# BACnet Stack ì„¤ì •
BACNET_CFLAGS := -I/usr/local/include/bacnet
BACNET_LIBS := -L/usr/local/lib -lbacnet
ifeq ($(shell test -d /usr/local/include/bacnet && echo yes),yes)
    CXXFLAGS += -DHAVE_BACNET=1
else
    CXXFLAGS += -DHAVE_BACNET=0
endif

# JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ (nlohmann/json)
JSON_CFLAGS := $(shell $(PKG_CONFIG) --cflags nlohmann_json 2>/dev/null || echo "-I/usr/local/include")
ifeq ($(shell test -f /usr/local/include/nlohmann/json.hpp && echo yes),yes)
    CXXFLAGS += -DHAVE_NLOHMANN_JSON=1
else
    CXXFLAGS += -DHAVE_NLOHMANN_JSON=0
endif

# spdlog ì„¤ì •
SPDLOG_CFLAGS := $(shell $(PKG_CONFIG) --cflags spdlog 2>/dev/null || echo "-I/usr/local/include")
SPDLOG_LIBS := $(shell $(PKG_CONFIG) --libs spdlog 2>/dev/null || echo "-L/usr/local/lib -lspdlog")
ifeq ($(shell test -f /usr/local/include/spdlog/spdlog.h && echo yes),yes)
    CXXFLAGS += -DHAVE_SPDLOG=1
else
    CXXFLAGS += -DHAVE_SPDLOG=0
endif

# ì¶”ê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
EXTRA_LIBS := $(SPDLOG_LIBS) -lhiredis -ljson-c -lconfig -lcurl -lrabbitmq

# ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬
SYSTEM_LIBS := -lpthread -ldl -lm -luuid -lrt

# SSL/TLS ë¼ì´ë¸ŒëŸ¬ë¦¬
SSL_LIBS := -lssl -lcrypto

# í†µí•© ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ALL_CFLAGS := $(INCLUDES) $(MODBUS_CFLAGS) $(MQTT_CFLAGS) $(BACNET_CFLAGS) $(JSON_CFLAGS) $(SPDLOG_CFLAGS)
ALL_LIBS := $(DB_LIBS) $(MODBUS_LIBS) $(MQTT_LIBS) $(BACNET_LIBS) $(EXTRA_LIBS) $(SSL_LIBS) $(SYSTEM_LIBS)

# =============================================================================
# ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì„¤ì •
# =============================================================================

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR := src
BUILD_DIR := build$(BUILD_SUFFIX)
BIN_DIR := bin
LIB_DIR := lib
TEST_DIR := test
INCLUDE_DIR := include

# ìƒˆë¡œìš´ ì•„í‚¤í…ì²˜ ì†ŒìŠ¤ íŒŒì¼ë“¤ ë¶„ë¥˜
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp)
ENGINE_SOURCES := $(wildcard $(SRC_DIR)/Engine/*.cpp)
DRIVERS_SOURCES := $(wildcard $(SRC_DIR)/Drivers/*.cpp)
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)
PUBLISHER_SOURCES := $(wildcard $(SRC_DIR)/Publisher/*.cpp)
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

# ë©”ì¸ ì†ŒìŠ¤ íŒŒì¼
MAIN_SRC := $(SRC_DIR)/main.cpp

# ì „ì²´ ì†ŒìŠ¤ íŒŒì¼ë“¤ (main ì œì™¸)
ALL_SRCS := $(DATABASE_SOURCES) $(ENGINE_SOURCES) $(DRIVERS_SOURCES) \
           $(UTILS_SOURCES) $(CONFIG_SOURCES) $(PUBLISHER_SOURCES) $(PLUGIN_SOURCES)

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
ALL_OBJS := $(ALL_SRCS:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJ := $(BUILD_DIR)/main.o

# ìµœì¢… ì‹¤í–‰ íŒŒì¼
TARGET := $(BIN_DIR)/$(PROJECT_NAME)$(BUILD_SUFFIX)

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼
TEST_SOURCES := $(wildcard $(TEST_DIR)/*.cpp)
TEST_OBJS := $(TEST_SOURCES:$(TEST_DIR)/%.cpp=$(BUILD_DIR)/test/%.o)
TEST_TARGET := $(BIN_DIR)/test_runner$(BUILD_SUFFIX)

# í™˜ê²½ ì„¤ì • íŒŒì¼
ENV_FILE := ../config/.env
ENV_TEMPLATE := ../config/.env.template
ENV_DEV := ../config/.env.dev

# Docker ì„¤ì •
DOCKER_IMAGE := pulseone-collector
DOCKER_TAG := $(VERSION)

# =============================================================================
# ì£¼ìš” ë¹Œë“œ íƒ€ê²Ÿë“¤
# =============================================================================

# ê¸°ë³¸ íƒ€ê²Ÿ
.DEFAULT_GOAL := all

# ëª¨ë“  íƒ€ê²Ÿ (ìƒˆ ì•„í‚¤í…ì²˜ ê²€ì¦ í¬í•¨)
.PHONY: all
all: precheck directories header-check feature-check $(TARGET) post-build
	@echo -e "$(GREEN)âœ… Build completed successfully: $(TARGET)$(NC)"

# ì˜ì¡´ì„± í™•ì¸ (ê°•í™”ëœ ë²„ì „)
.PHONY: deps
deps:
	@echo -e "$(BLUE)ğŸ” Checking dependencies...$(NC)"
	@echo "ğŸ“¦ Core Libraries:"
	@$(PKG_CONFIG) --exists libpqxx && echo -e "  $(GREEN)âœ… libpqxx: $$($(PKG_CONFIG) --modversion libpqxx)$(NC)" || echo -e "  $(RED)âŒ libpqxx: Not found$(NC)"
	@[ -f /usr/include/sqlite3.h ] && echo -e "  $(GREEN)âœ… SQLite3: Found$(NC)" || echo -e "  $(RED)âŒ SQLite3: Not found$(NC)"
	@echo ""
	@echo "ğŸ“¡ Protocol Libraries:"
	@$(PKG_CONFIG) --exists libmodbus && echo -e "  $(GREEN)âœ… libmodbus: $$($(PKG_CONFIG) --modversion libmodbus)$(NC)" || echo -e "  $(YELLOW)âš ï¸  libmodbus: Not found$(NC)"
	@[ -f /usr/local/include/MQTTClient.h ] && echo -e "  $(GREEN)âœ… Paho MQTT C: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  Paho MQTT C: Not found$(NC)"
	@[ -f /usr/local/include/mqtt/client.h ] && echo -e "  $(GREEN)âœ… Paho MQTT C++: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  Paho MQTT C++: Not found$(NC)"
	@[ -d /usr/local/include/bacnet ] && echo -e "  $(GREEN)âœ… BACnet Stack: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  BACnet Stack: Not found$(NC)"
	@echo ""
	@echo "ğŸ”§ Utility Libraries:"
	@[ -f /usr/local/include/nlohmann/json.hpp ] && echo -e "  $(GREEN)âœ… nlohmann/json: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  nlohmann/json: Not found$(NC)"
	@[ -f /usr/local/include/spdlog/spdlog.h ] && echo -e "  $(GREEN)âœ… spdlog: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  spdlog: Not found$(NC)"
	@[ -f /usr/local/include/amqp.h ] && echo -e "  $(GREEN)âœ… RabbitMQ-C: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  RabbitMQ-C: Not found$(NC)"
	@[ -f /usr/include/hiredis/hiredis.h ] && echo -e "  $(GREEN)âœ… hiredis: Found$(NC)" || echo -e "  $(YELLOW)âš ï¸  hiredis: Not found$(NC)"
	@echo -e "$(CYAN)â„¹ï¸  Missing libraries will disable related features$(NC)"

# ë””ë ‰í† ë¦¬ ìƒì„± (ìƒˆ ì•„í‚¤í…ì²˜ ì§€ì›)
.PHONY: directories
directories:
	@mkdir -p $(BUILD_DIR)/Database $(BUILD_DIR)/Engine $(BUILD_DIR)/Drivers
	@mkdir -p $(BUILD_DIR)/Utils $(BUILD_DIR)/Config $(BUILD_DIR)/Publisher
	@mkdir -p $(BUILD_DIR)/Plugin $(BUILD_DIR)/test
	@mkdir -p $(BIN_DIR) $(LIB_DIR)

# í™˜ê²½ ì„¤ì • í™•ì¸
.PHONY: precheck
precheck:
	@echo -e "$(BLUE)ğŸ” Checking environment...$(NC)"
	@if [ ! -f $(ENV_FILE) ]; then \
		if [ -f $(ENV_TEMPLATE) ]; then \
			echo -e "$(YELLOW)âš ï¸  $(ENV_FILE) not found. Copying from template...$(NC)"; \
			cp $(ENV_TEMPLATE) $(ENV_FILE); \
		elif [ -f $(ENV_DEV) ]; then \
			echo -e "$(YELLOW)âš ï¸  $(ENV_FILE) not found. Copying from dev template...$(NC)"; \
			cp $(ENV_DEV) $(ENV_FILE); \
		else \
			echo -e "$(YELLOW)âš ï¸  Creating default .env file...$(NC)"; \
			mkdir -p ../config; \
			echo "ENV_STAGE=dev" > $(ENV_FILE); \
			echo "LOG_LEVEL=info" >> $(ENV_FILE); \
			echo "DB_TYPE=postgresql" >> $(ENV_FILE); \
			echo "POSTGRES_MAIN_DB_HOST=localhost" >> $(ENV_FILE); \
			echo "POSTGRES_MAIN_DB_PORT=5432" >> $(ENV_FILE); \
			echo "POSTGRES_MAIN_DB_USER=user" >> $(ENV_FILE); \
			echo "POSTGRES_MAIN_DB_PASSWORD=password" >> $(ENV_FILE); \
			echo "POSTGRES_MAIN_DB_NAME=pulseone" >> $(ENV_FILE); \
		fi \
	fi
	@echo -e "$(GREEN)âœ… Environment check completed$(NC)"

# í—¤ë” íŒŒì¼ í™•ì¸ (ê°•í™”ëœ ë²„ì „)
.PHONY: header-check
header-check:
	@echo -e "$(BLUE)ğŸ” Checking required headers...$(NC)"
	@headers_ok=true; \
	echo "#include <iostream>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <thread>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <memory>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <atomic>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <mutex>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <condition_variable>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	echo "#include <chrono>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null || headers_ok=false; \
	if [ "$$headers_ok" = "false" ]; then \
		echo -e "$(RED)âŒ Essential C++17 headers missing$(NC)"; \
		exit 1; \
	fi; \
	echo -e "$(GREEN)âœ… Essential headers found$(NC)"; \
	echo "#include <pqxx/pqxx>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "$(GREEN)âœ… PostgreSQL headers found$(NC)" || \
		echo -e "$(RED)âŒ PostgreSQL headers not found - database access will fail$(NC)"; \
	echo "#include <sqlite3.h>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "$(GREEN)âœ… SQLite headers found$(NC)" || \
		echo -e "$(YELLOW)âš ï¸  SQLite headers not found$(NC)"

# ê¸°ëŠ¥ í™•ì¸ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
.PHONY: feature-check
feature-check:
	@echo -e "$(BLUE)ğŸ” Checking available features...$(NC)"
	@echo "Features that will be available:"
	@echo "#include <modbus.h>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "  $(GREEN)âœ… Modbus TCP/RTU support$(NC)" || \
		echo -e "  $(YELLOW)âš ï¸  Modbus support disabled$(NC)"
	@echo "#include <MQTTClient.h>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "  $(GREEN)âœ… MQTT client support$(NC)" || \
		echo -e "  $(YELLOW)âš ï¸  MQTT support disabled$(NC)"
	@echo "#include <nlohmann/json.hpp>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "  $(GREEN)âœ… JSON configuration support$(NC)" || \
		echo -e "  $(YELLOW)âš ï¸  JSON support limited$(NC)"
	@echo "#include <spdlog/spdlog.h>" | $(CXX) $(ALL_CFLAGS) $(CXXFLAGS) -x c++ -c - -o /dev/null 2>/dev/null && \
		echo -e "  $(GREEN)âœ… Advanced logging support$(NC)" || \
		echo -e "  $(YELLOW)âš ï¸  Basic logging only$(NC)"

# ë©”ì¸ ì‹¤í–‰ íŒŒì¼ ë¹Œë“œ
$(TARGET): $(MAIN_OBJ) $(ALL_OBJS)
	@echo -e "$(BLUE)ğŸ”— Linking $(TARGET)...$(NC)"
	@echo -e "$(CYAN)   Linking $$(echo '$(ALL_OBJS)' | wc -w) object files...$(NC)"
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $^ $(ALL_LIBS)

# ë©”ì¸ ì˜¤ë¸Œì íŠ¸ íŒŒì¼
$(MAIN_OBJ): $(MAIN_SRC)
	@echo -e "$(BLUE)ğŸ”¨ Compiling main application: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤ (ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ êµ¬ë¶„)
$(BUILD_DIR)/Database/%.o: $(SRC_DIR)/Database/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(PURPLE)ğŸ—„ï¸  Compiling database layer: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

$(BUILD_DIR)/Engine/%.o: $(SRC_DIR)/Engine/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)âš™ï¸  Compiling engine layer: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

$(BUILD_DIR)/Drivers/%.o: $(SRC_DIR)/Drivers/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling driver: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ”¨ Compiling: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

# ë¹Œë“œ í›„ ì²˜ë¦¬ (ê°•í™”ëœ ë²„ì „)
.PHONY: post-build
post-build:
	@echo -e "$(BLUE)ğŸ“‹ Post-build processing...$(NC)"
	@if [ -f "$(TARGET)" ]; then \
		chmod +x $(TARGET); \
		file_size=$$(ls -lh $(TARGET) | awk '{print $$5}'); \
		echo -e "$(GREEN)âœ… Executable created: $(TARGET) ($$file_size)$(NC)"; \
		strip_size=$$(strip -s $(TARGET) -o /tmp/stripped_test 2>/dev/null && ls -lh /tmp/stripped_test | awk '{print $$5}' && rm -f /tmp/stripped_test || echo "N/A"); \
		[ "$$strip_size" != "N/A" ] && echo -e "$(CYAN)â„¹ï¸  Stripped size would be: $$strip_size$(NC)"; \
	fi
	@# ê°œë°œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
	@if [ ! -f "dev.sh" ]; then \
		echo "#!/bin/bash" > dev.sh; \
		echo "# PulseOne Collector Development Runner" >> dev.sh; \
		echo "set -e" >> dev.sh; \
		echo "" >> dev.sh; \
		echo "export PKG_CONFIG_PATH=\"/usr/local/lib/pkgconfig:\$$PKG_CONFIG_PATH\"" >> dev.sh; \
		echo "export LD_LIBRARY_PATH=\"/usr/local/lib:\$$LD_LIBRARY_PATH\"" >> dev.sh; \
		echo "" >> dev.sh; \
		echo "# ì„¤ì • íŒŒì¼ í™•ì¸" >> dev.sh; \
		echo "if [ ! -f \"../config/.env\" ]; then" >> dev.sh; \
		echo "    echo \"âŒ Configuration file not found. Run 'make precheck' first.\"" >> dev.sh; \
		echo "    exit 1" >> dev.sh; \
		echo "fi" >> dev.sh; \
		echo "" >> dev.sh; \
		echo "echo \"ğŸš€ Starting PulseOne Collector in development mode...\"" >> dev.sh; \
		echo "echo \"ğŸ“ Executable: $(TARGET)\"" >> dev.sh; \
		echo "echo \"ğŸ“ Working Directory: \$$(pwd)\"" >> dev.sh; \
		echo "echo \"\"" >> dev.sh; \
		echo "" >> dev.sh; \
		echo "# Ctrl+C í•¸ë“¤ëŸ¬" >> dev.sh; \
		echo "trap 'echo \"\"; echo \"ğŸ›‘ Stopping PulseOne Collector...\"; exit 0' INT" >> dev.sh; \
		echo "" >> dev.sh; \
		echo "$(TARGET) \"\$$@\"" >> dev.sh; \
		chmod +x dev.sh; \
		echo -e "$(GREEN)âœ… Created dev.sh development script$(NC)"; \
	fi
	@# í”„ë¡œë•ì…˜ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
	@if [ ! -f "run.sh" ]; then \
		echo "#!/bin/bash" > run.sh; \
		echo "# PulseOne Collector Production Runner" >> run.sh; \
		echo "set -e" >> run.sh; \
		echo "" >> run.sh; \
		echo "export PKG_CONFIG_PATH=\"/usr/local/lib/pkgconfig:\$$PKG_CONFIG_PATH\"" >> run.sh; \
		echo "export LD_LIBRARY_PATH=\"/usr/local/lib:\$$LD_LIBRARY_PATH\"" >> run.sh; \
		echo "" >> run.sh; \
		echo "$(TARGET) \"\$$@\"" >> run.sh; \
		chmod +x run.sh; \
		echo -e "$(GREEN)âœ… Created run.sh production script$(NC)"; \
	fi

# =============================================================================
# ë¹Œë“œ ë³€í˜•ë“¤
# =============================================================================

# ë””ë²„ê·¸ ë¹Œë“œ
.PHONY: debug
debug:
	@echo -e "$(YELLOW)ğŸ› Building debug version...$(NC)"
	@$(MAKE) BUILD_TYPE=Debug all

# ë¦´ë¦¬ì¦ˆ ë¹Œë“œ
.PHONY: release
release:
	@echo -e "$(GREEN)ğŸš€ Building release version...$(NC)"
	@$(MAKE) BUILD_TYPE=Release all

# ë¦´ë¦¬ì¦ˆ + ë””ë²„ê·¸ ì •ë³´
.PHONY: relwithdebinfo
relwithdebinfo:
	@echo -e "$(CYAN)ğŸ” Building release with debug info...$(NC)"
	@$(MAKE) BUILD_TYPE=RelWithDebInfo all

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
.PHONY: tests
tests: $(TEST_TARGET)
	@echo -e "$(GREEN)âœ… Tests built: $(TEST_TARGET)$(NC)"

$(TEST_TARGET): $(TEST_OBJS) $(ALL_OBJS)
	@echo -e "$(BLUE)ğŸ§ª Linking test runner...$(NC)"
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $^ $(ALL_LIBS)

$(BUILD_DIR)/test/%.o: $(TEST_DIR)/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(CYAN)ğŸ§ª Compiling test: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -c $< -o $@

# ì •ë¦¬ (ê°•í™”ëœ ë²„ì „)
.PHONY: clean
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning build files...$(NC)"
	rm -rf build build_debug build_rel_debug
	rm -rf $(BIN_DIR) $(LIB_DIR)
	rm -f run.sh dev.sh
	rm -f *.log *.out core.*
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# ì™„ì „ ì •ë¦¬
.PHONY: distclean
distclean: clean
	@echo -e "$(YELLOW)ğŸ§¹ Deep cleaning...$(NC)"
	rm -rf logs/* 2>/dev/null || true
	rm -f ../config/.env.backup.* 2>/dev/null || true
	@echo -e "$(GREEN)âœ… Deep clean completed$(NC)"

# =============================================================================
# Docker ì§€ì› (ê¸°ì¡´ ìœ ì§€ + ê°œì„ )
# =============================================================================

.PHONY: build-docker
build-docker: precheck
	@echo -e "$(BLUE)ğŸ³ Building Docker image...$(NC)"
	docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) -f Dockerfile.dev .
	docker tag $(DOCKER_IMAGE):$(DOCKER_TAG) $(DOCKER_IMAGE):latest
	@echo -e "$(GREEN)âœ… Docker image built: $(DOCKER_IMAGE):$(DOCKER_TAG)$(NC)"

.PHONY: run-docker
run-docker:
	@echo -e "$(BLUE)ğŸ³ Running Docker container...$(NC)"
	docker run --rm -it \
		-v $(PWD)/../config:/app/config \
		-v $(PWD)/logs:/opt/pulseone/logs \
		-v /etc/localtime:/etc/localtime:ro \
		--name pulseone-instance \
		-p 8080:8080 \
		$(DOCKER_IMAGE):$(DOCKER_TAG)

# Docker Compose ì§€ì›
.PHONY: docker-up
docker-up:
	@echo -e "$(BLUE)ğŸ³ Starting Docker Compose services...$(NC)"
	cd .. && docker-compose -f docker-compose.dev.yml up --build -d
	@echo -e "$(GREEN)âœ… Services started. Use 'make docker-logs' to view logs$(NC)"

.PHONY: docker-down
docker-down:
	@echo -e "$(BLUE)ğŸ³ Stopping Docker Compose services...$(NC)"
	cd .. && docker-compose -f docker-compose.dev.yml down

.PHONY: docker-logs
docker-logs:
	@echo -e "$(BLUE)ğŸ³ Showing Docker Compose logs...$(NC)"
	cd .. && docker-compose -f docker-compose.dev.yml logs -f pulseone-collector

# Docker ì´ë¯¸ì§€ ì •ë¦¬
.PHONY: docker-clean
docker-clean:
	@echo -e "$(YELLOW)ğŸ³ Cleaning Docker images...$(NC)"
	docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG) $(DOCKER_IMAGE):latest 2>/dev/null || true
	docker system prune -f

# =============================================================================
# CI/CD íŒŒì´í”„ë¼ì¸ (ê°•í™”ëœ ë²„ì „)
# =============================================================================

.PHONY: ci-check
ci-check:
	@echo -e "$(BLUE)âœ… Running static checks...$(NC)"
	@if [ -n "$(ALL_SRCS)" ]; then \
		echo -e "$(CYAN)ğŸ“ Checking $(shell echo '$(ALL_SRCS)' | wc -w) source files...$(NC)"; \
		$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -fsyntax-only $(ALL_SRCS) $(MAIN_SRC); \
	else \
		echo -e "$(CYAN)ğŸ“ Checking main source file...$(NC)"; \
		$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -fsyntax-only $(MAIN_SRC); \
	fi
	@echo -e "$(GREEN)âœ… Static check passed$(NC)"

.PHONY: ci-build
ci-build: clean release
	@echo -e "$(GREEN)âœ… CI build completed$(NC)"

.PHONY: ci-test
ci-test:
	@echo -e "$(BLUE)ğŸ§ª Running tests...$(NC)"
	@if [ -f "$(TEST_TARGET)" ]; then \
		$(TEST_TARGET); \
		echo -e "$(GREEN)âœ… Tests passed$(NC)"; \
	elif [ -f "$(BIN_DIR)/run_tests" ]; then \
		$(BIN_DIR)/run_tests; \
		echo -e "$(GREEN)âœ… Tests passed$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  No tests available. Skipping...$(NC)"; \
	fi

.PHONY: ci-lint
ci-lint:
	@echo -e "$(BLUE)ğŸ” Running code linting...$(NC)"
	@if command -v cppcheck >/dev/null 2>&1; then \
		cppcheck --enable=all --std=c++17 --error-exitcode=1 $(SRC_DIR) 2>/dev/null || echo -e "$(YELLOW)âš ï¸  cppcheck warnings found$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  cppcheck not available$(NC)"; \
	fi

.PHONY: ci
ci: deps ci-check ci-build ci-test ci-lint
	@echo -e "$(GREEN)ğŸ‰ CI pipeline completed successfully$(NC)"

# =============================================================================
# ê°œë°œ ì§€ì› ë„êµ¬ë“¤ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
# =============================================================================

# ì†ŒìŠ¤ ì½”ë“œ í†µê³„
.PHONY: stats
stats:
	@echo -e "$(BLUE)=== PulseOne Source Code Statistics ===$(NC)"
	@echo "ğŸ“Š File counts:"
	@echo "  Header files (.h): $$(find $(INCLUDE_DIR) -name '*.h' 2>/dev/null | wc -l)"
	@echo "  Source files (.cpp): $$(find $(SRC_DIR) -name '*.cpp' 2>/dev/null | wc -l)"
	@echo "  Test files: $$(find $(TEST_DIR) -name '*.cpp' 2>/dev/null | wc -l)"
	@echo ""
	@echo "ğŸ“ˆ Line counts:"
	@if command -v wc >/dev/null 2>&1; then \
		echo "  Total lines: $$(find $(SRC_DIR) $(INCLUDE_DIR) -name '*.cpp' -o -name '*.h' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $$1}' || echo 'N/A')"; \
		echo "  Database layer: $$(find $(SRC_DIR)/Database $(INCLUDE_DIR)/Database -name '*.cpp' -o -name '*.h' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $$1}' || echo 'N/A')"; \
		echo "  Engine layer: $$(find $(SRC_DIR)/Engine $(INCLUDE_DIR)/Engine -name '*.cpp' -o -name '*.h' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $$1}' || echo 'N/A')"; \
		echo "  Driver layer: $$(find $(SRC_DIR)/Drivers $(INCLUDE_DIR)/Drivers -name '*.cpp' -o -name '*.h' 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $$1}' || echo 'N/A')"; \
	fi

# ê°œë°œ ëª¨ë“œ ì‹¤í–‰
.PHONY: dev
dev: debug
	@echo -e "$(BLUE)ğŸš€ Running in development mode...$(NC)"
	@if [ -f "dev.sh" ]; then \
		./dev.sh; \
	else \
		$(MAKE) run BUILD_TYPE=Debug; \
	fi

# í”„ë¡œíŒŒì¼ë§ ë¹Œë“œ
.PHONY: profile
profile:
	@echo -e "$(PURPLE)ğŸ“Š Building with profiling support...$(NC)"
	$(MAKE) BUILD_TYPE=RelWithDebInfo CXXFLAGS="$(CXXFLAGS) -pg" LDFLAGS="$(LDFLAGS) -pg" all

# =============================================================================
# ì •ë³´ ë° ë„ì›€ë§ (ê°œì„ ëœ ë²„ì „)
# =============================================================================

.PHONY: info
info:
	@echo -e "$(BLUE)=== PulseOne Collector Build Information ===$(NC)"
	@echo "Project: $(PROJECT_NAME) v$(VERSION)"
	@echo "Build Type: $(BUILD_TYPE)"
	@echo "Compiler: $(CXX) $(shell $(CXX) --version 2>/dev/null | head -n1 || echo 'not found')"
	@echo "C++ Standard: C++17"
	@echo "Target: $(TARGET)"
	@echo ""
	@echo -e "$(BLUE)=== Database Support ===$(NC)"
	@$(PKG_CONFIG) --exists libpqxx && echo "PostgreSQL: âœ… v$$($(PKG_CONFIG) --modversion libpqxx)" || echo "PostgreSQL: âŒ"
	@[ -f /usr/include/sqlite3.h ] && echo "SQLite: âœ…" || echo "SQLite: âŒ"
	@echo ""
	@echo -e "$(BLUE)=== Protocol Support ===$(NC)"
	@$(PKG_CONFIG) --exists libmodbus && echo "Modbus: âœ… v$$($(PKG_CONFIG) --modversion libmodbus)" || echo "Modbus: âŒ"
	@[ -f /usr/local/include/MQTTClient.h ] && echo "MQTT: âœ…" || echo "MQTT: âŒ"
	@[ -d /usr/local/include/bacnet ] && echo "BACnet: âœ…" || echo "BACnet: âŒ"
	@echo ""
	@echo -e "$(BLUE)=== Build Status ===$(NC)"
	@[ -f "$(TARGET)" ] && echo "Executable: âœ… ($(shell ls -lh $(TARGET) 2>/dev/null | awk '{print $$5}' || echo 'N/A'))" || echo "Executable: âŒ"
	@[ -f "$(ENV_FILE)" ] && echo "Environment: âœ…" || echo "Environment: âŒ"
	@echo "Object files: $(shell find build* -name '*.o' 2>/dev/null | wc -l || echo 0)"
	@echo "Source files: $(shell find $(SRC_DIR) -name '*.cpp' 2>/dev/null | wc -l || echo 0)"

# ì‹¤í–‰
.PHONY: run
run: all
	@echo -e "$(BLUE)ğŸš€ Running $(PROJECT_NAME)...$(NC)"
	@if [ -f "run.sh" ]; then \
		./run.sh; \
	else \
		export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$$PKG_CONFIG_PATH"; \
		export LD_LIBRARY_PATH="/usr/local/lib:$$LD_LIBRARY_PATH"; \
		$(TARGET); \
	fi

# ë„ì›€ë§ (ê°œì„ ëœ ë²„ì „)
.PHONY: help
help:
	@echo -e "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo -e "$(BLUE)â•‘                PulseOne Collector Build System              â•‘$(NC)"
	@echo -e "$(BLUE)â•‘                        v$(VERSION)                              â•‘$(NC)"
	@echo -e "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo -e "$(GREEN)ğŸ“¦ Main Targets:$(NC)"
	@echo "  all             - Build the main application (default)"
	@echo "  debug           - Build with debug symbols and AddressSanitizer"
	@echo "  release         - Build optimized production version"
	@echo "  relwithdebinfo  - Build optimized with debug symbols"
	@echo "  tests           - Build test suite"
	@echo "  clean           - Remove build files"
	@echo "  distclean       - Remove all generated files"
	@echo ""
	@echo -e "$(CYAN)ğŸ”§ Development:$(NC)"
	@echo "  dev             - Build and run in development mode"
	@echo "  deps            - Check dependencies"
	@echo "  stats           - Show source code statistics"
	@echo "  profile         - Build with profiling support"
	@echo "  run             - Build and run application"
	@echo ""
	@echo -e "$(PURPLE)ğŸ³ Docker:$(NC)"
	@echo "  docker-up       - Start with Docker Compose"
	@echo "  docker-down     - Stop Docker Compose"
	@echo "  docker-logs     - View container logs"
	@echo "  docker-clean    - Clean Docker images"
	@echo ""
	@echo -e "$(YELLOW)ğŸ” CI/CD:$(NC)"
	@echo "  ci              - Run full CI pipeline"
	@echo "  ci-check        - Static code analysis"
	@echo "  ci-build        - Clean release build"
	@echo "  ci-test         - Run tests"
	@echo "  ci-lint         - Code linting"
	@echo ""
	@echo -e "$(GREEN)â„¹ï¸  Utility:$(NC)"
	@echo "  info            - Show detailed build information"
	@echo "  help            - Show this help"
	@echo ""
	@echo -e "$(CYAN)ğŸ’¡ Examples:$(NC)"
	@echo "  make debug && make dev     - Debug build and run"
	@echo "  make release && make run   - Production build and run"
	@echo "  make docker-up             - Start in Docker"

# ëª¨ë“  ë¹Œë“œ íƒ€ì…ì„ í•œë²ˆì— í…ŒìŠ¤íŠ¸
.PHONY: test-all-builds
test-all-builds: clean
	@echo -e "$(BLUE)ğŸ”„ Testing all build configurations...$(NC)"
	@$(MAKE) debug
	@$(MAKE) clean
	@$(MAKE) release  
	@$(MAKE) clean
	@$(MAKE) relwithdebinfo
	@echo -e "$(GREEN)âœ… All build configurations tested successfully$(NC)"

# ì˜ì¡´ì„± ê·¸ë˜í”„ ìƒì„± (ìˆëŠ” ê²½ìš°)
.PHONY: deps-graph
deps-graph:
	@if command -v dot >/dev/null 2>&1; then \
		echo -e "$(BLUE)ğŸ“Š Generating dependency graph...$(NC)"; \
		$(CXX) $(CXXFLAGS) $(ALL_CFLAGS) -MM $(ALL_SRCS) $(MAIN_SRC) > deps.txt; \
		echo -e "$(GREEN)âœ… Dependencies saved to deps.txt$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  graphviz not available for dependency graph$(NC)"; \
	fi