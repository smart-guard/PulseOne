# =============================================================================
# PulseOne Collector Makefile - ìˆ˜ì •ëœ ë²„ì „ (CollectorApplication í¬í•¨)
# =============================================================================

# nlohmann/json ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE -O0 -Iinclude $(shell pkg-config --cflags libmodbus)
LDFLAGS = 
LIBS = -lpthread $(shell pkg-config --libs libmodbus) -lpqxx -lpq -lsqlite3 -lpaho-mqtt3c -lpaho-mqttpp3 -lbacnet -lmysqlclient

# ê¸°ì¡´ CXXFLAGSì— JSON í”Œë˜ê·¸ ì¶”ê°€
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# í”„ë¡œì íŠ¸ ì„¤ì •
PROJECT_NAME = pulseone_collector
TARGET = $(PROJECT_NAME)

# ë””ë ‰í† ë¦¬ ì„¤ì •
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build
BIN_DIR = bin

# Include ê²½ë¡œ
INCLUDES = -I$(INCLUDE_DIR)

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ğŸ”§ ìˆ˜ì •: ì˜¬ë°”ë¥¸ ì†ŒìŠ¤ íŒŒì¼ ê·¸ë£¹ ì •ì˜
# =============================================================================

# Core ì†ŒìŠ¤ë“¤ (ìˆ˜ì •: Application.cpp ì˜¬ë°”ë¥¸ ê²½ë¡œ)
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)

# ğŸ”§ DEBUG: Core ì†ŒìŠ¤ í™•ì¸ì„ ìœ„í•œ ì¶œë ¥
$(info ğŸ” DEBUG: CORE_SOURCES = $(CORE_SOURCES))

# ê¸°ì¡´ Utils, Config ë“± (í™•ì‹¤íˆ ì¡´ì¬í•˜ëŠ” ê²ƒë“¤)
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

# ğŸ”§ DEBUG: ê¸°ì¡´ ì†ŒìŠ¤ë“¤ í™•ì¸
$(info ğŸ” DEBUG: UTILS_SOURCES = $(UTILS_SOURCES))
$(info ğŸ” DEBUG: CONFIG_SOURCES = $(CONFIG_SOURCES))

# Workers ì†ŒìŠ¤ë“¤ (ì•„ì§ ì—†ì„ ìˆ˜ ìˆìŒ)
WORKERS_BASE_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp)
WORKERS_PROTOCOL_SOURCES := $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp)
WORKERS_COMPONENTS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Components/*.cpp)
WORKERS_SOURCES := $(WORKERS_BASE_SOURCES) $(WORKERS_PROTOCOL_SOURCES) $(WORKERS_COMPONENTS_SOURCES) $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# Drivers ì†ŒìŠ¤ë“¤ (ì•„ì§ ì—†ì„ ìˆ˜ ìˆìŒ)
DRIVERS_COMMON_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
DRIVERS_MODBUS_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
DRIVERS_MQTT_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
DRIVERS_BACNET_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
DRIVERS_SOURCES := $(DRIVERS_COMMON_SOURCES) $(DRIVERS_MODBUS_SOURCES) $(DRIVERS_MQTT_SOURCES) $(DRIVERS_BACNET_SOURCES)

# Database ì†ŒìŠ¤ë“¤ (ìˆì„ ìˆ˜ë„ ìˆìŒ)
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# Client ì†ŒìŠ¤ë“¤ (ìˆì„ ìˆ˜ë„ ìˆìŒ)
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Plugin ì†ŒìŠ¤ë“¤ (ì•„ì§ ì—†ì„ ìˆ˜ ìˆìŒ)
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

# ë©”ì¸ ì†ŒìŠ¤
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ğŸ”§ ìˆ˜ì •: í™•ì‹¤íˆ ì¡´ì¬í•˜ëŠ” ì†ŒìŠ¤ë“¤ë§Œ í¬í•¨
EXISTING_SOURCES = $(CORE_SOURCES) $(UTILS_SOURCES) $(CONFIG_SOURCES)
OPTIONAL_SOURCES = $(WORKERS_SOURCES) $(DRIVERS_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(PLUGIN_SOURCES)

# ì „ì²´ ì†ŒìŠ¤ë“¤ (main ì œì™¸, ì¡´ì¬í•˜ëŠ” ê²ƒë“¤ë§Œ)
ALL_LIB_SOURCES = $(EXISTING_SOURCES) $(OPTIONAL_SOURCES)

# ğŸ”§ DEBUG: ìµœì¢… ì†ŒìŠ¤ ëª©ë¡ í™•ì¸
$(info ğŸ” DEBUG: ALL_LIB_SOURCES = $(ALL_LIB_SOURCES))

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
ALL_LIB_OBJECTS = $(ALL_LIB_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJECT = $(MAIN_SOURCE:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
ALL_OBJECTS = $(ALL_LIB_OBJECTS) $(MAIN_OBJECT)

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤
# =============================================================================

.DEFAULT_GOAL := all

# ğŸ”§ ìˆ˜ì •: íŒŒì¼ ì¡´ì¬ í™•ì¸ ì¶”ê°€
check-sources:
	@echo -e "$(BLUE)ğŸ” Checking required source files...$(NC)"
	@echo -e "$(YELLOW)Main source:$(NC)"
	@if [ -f "$(MAIN_SOURCE)" ]; then \
		echo -e "  $(GREEN)âœ… $(MAIN_SOURCE)$(NC)"; \
	else \
		echo -e "  $(RED)âŒ $(MAIN_SOURCE) (MISSING)$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(YELLOW)Core sources:$(NC)"
	@if [ -z "$(CORE_SOURCES)" ]; then \
		echo -e "  $(RED)âŒ No Core sources found in $(SRC_DIR)/Core/$(NC)"; \
		echo -e "  $(YELLOW)Expected: $(SRC_DIR)/Core/Application.cpp$(NC)"; \
		ls -la $(SRC_DIR)/Core/ 2>/dev/null || echo "  $(RED)âŒ $(SRC_DIR)/Core/ directory not found$(NC)"; \
		exit 1; \
	else \
		for src in $(CORE_SOURCES); do \
			echo -e "  $(GREEN)âœ… $$src$(NC)"; \
		done \
	fi
	@echo -e "$(YELLOW)Utils/Config sources:$(NC)"
	@for src in $(UTILS_SOURCES) $(CONFIG_SOURCES); do \
		if [ -f "$$src" ]; then \
			echo -e "  $(GREEN)âœ… $$src$(NC)"; \
		else \
			echo -e "  $(RED)âŒ $$src (MISSING)$(NC)"; \
		fi \
	done

# ì „ì²´ ë¹Œë“œ (ì†ŒìŠ¤ í™•ì¸ í¬í•¨)
all: check-sources directories $(TARGET)
	@echo -e "$(GREEN)ğŸ‰ Build completed successfully!$(NC)"
	@echo -e "$(BLUE)ğŸ“¦ Executable: $(BIN_DIR)/$(TARGET)$(NC)"
	@echo -e "$(BLUE)ğŸ“Š Object files: $(words $(ALL_OBJECTS))$(NC)"

# ì‹¤í–‰ íŒŒì¼ ìƒì„±
$(TARGET): $(ALL_OBJECTS) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”— Linking $(TARGET)...$(NC)"
	@echo -e "$(YELLOW)   Objects: $(words $(ALL_OBJECTS))$(NC)"
	@echo -e "$(YELLOW)   Libraries: $(LIBS)$(NC)"
	$(CXX) $(LDFLAGS) -o $(BIN_DIR)/$@ $(ALL_OBJECTS) $(LIBS)

# =============================================================================
# ğŸ”§ ìˆ˜ì •: ë” ì •í™•í•œ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„± ê·œì¹™
# =============================================================================

# Core íŒŒì¼ë“¤ (ìˆ˜ì •ëœ ê²½ë¡œ)
$(BUILD_DIR)/Core/%.o: $(SRC_DIR)/Core/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ›ï¸  Compiling Core: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Utils íŒŒì¼ë“¤
$(BUILD_DIR)/Utils/%.o: $(SRC_DIR)/Utils/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ”§ Compiling Utils: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Config íŒŒì¼ë“¤ (ìˆë‹¤ë©´)
$(BUILD_DIR)/Config/%.o: $(SRC_DIR)/Config/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)âš™ï¸  Compiling Config: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Workers íŒŒì¼ë“¤
$(BUILD_DIR)/Workers/%.o: $(SRC_DIR)/Workers/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ‘· Compiling Worker: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Drivers íŒŒì¼ë“¤
$(BUILD_DIR)/Drivers/%.o: $(SRC_DIR)/Drivers/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Driver: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Database íŒŒì¼ë“¤
$(BUILD_DIR)/Database/%.o: $(SRC_DIR)/Database/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(GREEN)ğŸ—„ï¸  Compiling Database: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Client íŒŒì¼ë“¤
$(BUILD_DIR)/Client/%.o: $(SRC_DIR)/Client/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸ“¡ Compiling Client: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Plugin íŒŒì¼ë“¤
$(BUILD_DIR)/Plugin/%.o: $(SRC_DIR)/Plugin/%.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling Plugin: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ë©”ì¸ íŒŒì¼
$(BUILD_DIR)/main.o: $(SRC_DIR)/main.cpp
	@mkdir -p $(dir $@)
	@echo -e "$(BLUE)ğŸš€ Compiling Main: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ìœ í‹¸ë¦¬í‹° íƒ€ê²Ÿë“¤
# =============================================================================

# ë””ë ‰í† ë¦¬ ìƒì„±
directories:
	@mkdir -p $(BUILD_DIR)/{Core,Workers/{Base,Protocol,Components},Drivers/{Common,Modbus,Mqtt,Bacnet},Database,Client,Utils,Config,Plugin}
	@mkdir -p $(BIN_DIR)

# ì •ë¦¬
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning build files...$(NC)"
	rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# ì‹¤í–‰
run: $(TARGET)
	@echo -e "$(BLUE)ğŸš€ Running $(TARGET)...$(NC)"
	cd $(BIN_DIR) && ./$(TARGET)

# =============================================================================
# ğŸ”§ ìˆ˜ì •: ì˜¬ë°”ë¥¸ ìµœì†Œ ë¹Œë“œ
# =============================================================================

# ìµœì†Œ ë¹Œë“œ (í•µì‹¬ íŒŒì¼ë§Œ, ì˜¬ë°”ë¥¸ íŒŒì¼ëª… ì‚¬ìš©)
minimal: MINIMAL_SOURCES = $(SRC_DIR)/main.cpp $(SRC_DIR)/Core/Application.cpp $(SRC_DIR)/Utils/LogManager.cpp $(SRC_DIR)/Utils/ConfigManager.cpp
minimal: MINIMAL_OBJECTS = $(MINIMAL_SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
minimal: directories
	@echo -e "$(BLUE)ğŸ” Checking minimal build sources...$(NC)"
	@for src in $(MINIMAL_SOURCES); do \
		if [ -f "$$src" ]; then \
			echo -e "  $(GREEN)âœ… $$src$(NC)"; \
		else \
			echo -e "  $(RED)âŒ $$src (MISSING)$(NC)"; \
			echo -e "  $(YELLOW)Available files in $$(dirname $$src):$(NC)"; \
			ls -la $$(dirname $$src) 2>/dev/null || echo "    $(RED)Directory not found$(NC)"; \
			exit 1; \
		fi \
	done
	@$(MAKE) $(MINIMAL_OBJECTS)
	@echo -e "$(BLUE)ğŸ”— Linking minimal build...$(NC)"
	$(CXX) $(LDFLAGS) -o $(BIN_DIR)/$(TARGET)_minimal $(MINIMAL_OBJECTS) $(LIBS)
	@echo -e "$(GREEN)âœ… Minimal build completed: $(BIN_DIR)/$(TARGET)_minimal$(NC)"

# ë¹Œë“œ ëª¨ë“œë³„ íƒ€ê²Ÿë“¤
debug: CXXFLAGS += -g -DPULSEONE_DEBUG_MODE -O0
debug: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
debug: check-json clean all
	@echo -e "$(GREEN)ğŸ› Debug build completed - verbose logging enabled$(NC)"

release: CXXFLAGS += -O3 -DNDEBUG  
release: CXXFLAGS := $(filter-out -O2,$(CXXFLAGS))
release: clean all
	@echo -e "$(GREEN)ğŸš€ Release build completed - optimized for performance$(NC)"

# JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
check-json:
	@echo "ğŸ” Checking nlohmann/json..."
	@if [ "$(HAS_NLOHMANN_JSON)" = "0" ]; then \
		echo "âš ï¸  nlohmann/json not found - using fallback"; \
		echo "   Install: sudo apt-get install nlohmann-json3-dev"; \
	else \
		echo "âœ… nlohmann/json found"; \
	fi

# ì½”ë“œ ë¶„ì„
analyze:
	@echo -e "$(BLUE)ğŸ“Š Analyzing code structure...$(NC)"
	@echo -e "$(GREEN)Core files:$(NC) $(words $(CORE_SOURCES))"
	@echo -e "$(GREEN)Utils files:$(NC) $(words $(UTILS_SOURCES))"  
	@echo -e "$(BLUE)Config files:$(NC) $(words $(CONFIG_SOURCES))"
	@echo -e "$(BLUE)Worker files:$(NC) $(words $(WORKERS_SOURCES))"
	@echo -e "$(YELLOW)Driver files:$(NC) $(words $(DRIVERS_SOURCES))"
	@echo -e "$(GREEN)Database files:$(NC) $(words $(DATABASE_SOURCES))"
	@echo -e "$(BLUE)Client files:$(NC) $(words $(CLIENT_SOURCES))"
	@echo -e "$(YELLOW)Plugin files:$(NC) $(words $(PLUGIN_SOURCES))"
	@echo -e "$(YELLOW)Total source files:$(NC) $(words $(ALL_LIB_SOURCES))"

# íŒŒì¼ êµ¬ì¡° í™•ì¸
check-structure:
	@echo -e "$(BLUE)ğŸ“ Checking project structure...$(NC)"
	@echo -e "$(YELLOW)Source directories:$(NC)"
	@find $(SRC_DIR) -type d | sed 's/^/  /'
	@echo -e "$(YELLOW)Source files:$(NC)"
	@find $(SRC_DIR) -name "*.cpp" | sed 's/^/  /'
	@echo -e "$(YELLOW)Header files:$(NC)"
	@find $(INCLUDE_DIR) -name "*.h" | sed 's/^/  /' 2>/dev/null || echo "  No header files found"

# ë¬¸ë²• ì²´í¬
syntax-check:
	@echo -e "$(BLUE)ğŸ“ Syntax checking...$(NC)"
	@for src in $(ALL_LIB_SOURCES) $(MAIN_SOURCE); do \
		if [ -f "$$src" ]; then \
			echo -e "$(YELLOW)Checking: $$src$(NC)"; \
			$(CXX) $(CXXFLAGS) $(INCLUDES) -fsyntax-only $$src || exit 1; \
		fi \
	done
	@echo -e "$(GREEN)âœ… All syntax checks passed$(NC)"

# PHONY íƒ€ê²Ÿë“¤
.PHONY: all clean run debug release minimal analyze check-headers syntax-check info install directories check-sources check-structure check-json

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸ”§ PulseOne Collector Build System$(NC)"
	@echo ""
	@echo -e "$(GREEN)Main targets:$(NC)"
	@echo "  all              - Build the complete project"
	@echo "  minimal          - Build only core components"
	@echo "  clean            - Remove all build files"
	@echo "  run              - Build and run the application"
	@echo ""
	@echo -e "$(GREEN)Build modes:$(NC)"
	@echo "  debug            - Build with debug symbols and verbose logging"
	@echo "  release          - Build optimized for production"
	@echo ""
	@echo -e "$(GREEN)Development tools:$(NC)"
	@echo "  check-sources    - Verify all required source files exist"
	@echo "  check-structure  - Show project file structure"
	@echo "  syntax-check     - Check syntax without linking"
	@echo "  analyze          - Analyze code structure"
	@echo "  check-json       - Check JSON library availability"
	@echo ""
	@echo -e "$(GREEN)Examples:$(NC)"
	@echo "  make check-sources       # Check if all files exist"
	@echo "  make minimal             # Quick build with core files only"
	@echo "  make debug               # Build debug version"
	@echo "  make clean && make       # Clean rebuild"


