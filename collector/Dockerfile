# Makefile - PulseOne Collector ë¹Œë“œ + Docker + CI/CD í™•ì¥

CXX = g++
CXXFLAGS = -std=c++17 -Wall \
	-Iinclude \
	-Iinclude/Database \
	-Iinclude/Utils \
	-Iinclude/Plugin \
	-Iinclude/Config \
	-Iinclude/Engine \
	-Iinclude/Publisher \
	-Iinclude/Drivers

LDFLAGS = -lpqxx -lpq -lsqlite3

SRCS = $(shell find src -name '*.cpp')
OBJS = $(SRCS:.cpp=.o)
TARGET = bin/collector

ENV_FILE = ../config/.env
ENV_TEMPLATE = ../config/.env.template

all: precheck $(TARGET)

# ğŸ”¹ 1. precheck: .env ìë™ ë³µì‚¬
precheck:
	@if [ ! -f $(ENV_FILE) ]; then \
		echo "âš ï¸  $(ENV_FILE) not found. Copying from template..."; \
		cp $(ENV_TEMPLATE) $(ENV_FILE); \
	fi

# ğŸ”¹ 2. ë¹Œë“œ ëŒ€ìƒ
$(TARGET): $(OBJS)
	@mkdir -p bin
	$(CXX) -o $@ $^ $(LDFLAGS)

# ğŸ”¹ 3. ì •ë¦¬
clean:
	rm -f $(OBJS) $(TARGET)

# ğŸ”¹ 4. Docker ë¹Œë“œ ë° ì‹¤í–‰
build-docker: precheck
	docker build -t pulseone-collector .

run-docker:
	docker run --rm -it \
		-v $(PWD)/../config:/app/config \
		-v $(PWD)/logrotate:/etc/logrotate.d \
		-v $(PWD)/logs:/opt/pulseone/logs \
		--name pulseone-instance \
		pulseone-collector

# ğŸ”¹ 5. CI/CDìš© ëª…ë ¹ì–´
ci-check:
	@echo "âœ… Running static check..."
	@$(CXX) $(CXXFLAGS) -fsyntax-only $(SRCS)

ci-build: clean all
	@echo "âœ… Build success."

ci-test:
	@echo "ğŸ§ª No unit tests defined. Skipping..."

ci: ci-check ci-build ci-test

.PHONY: all clean build-docker run-docker precheck ci-check ci-build ci-test ci
