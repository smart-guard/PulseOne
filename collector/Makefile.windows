# =============================================================================
# Makefile.windows - ì‹¤ì œ íŒŒì¼ ê¸°ë°˜ PulseOne Windows í¬ë¡œìŠ¤ ì»´íŒŒì¼
# =============================================================================

# ê¸°ë³¸ ì„¤ì •
CXX = x86_64-w64-mingw32-g++
CC = x86_64-w64-mingw32-gcc
AR = x86_64-w64-mingw32-ar
STRIP = x86_64-w64-mingw32-strip

# ë””ë ‰í† ë¦¬
SRC_DIR = src
INCLUDE_DIR = include
BUILD_DIR = build-windows
BIN_DIR = bin-windows
TARGET = collector.exe

# Windows íŠ¹í™” ì»´íŒŒì¼ í”Œë˜ê·¸
CXXFLAGS = -std=c++17 -O2 -Wall -Wextra
CXXFLAGS += -DPULSEONE_WINDOWS=1 -D_WIN32 -DPULSEONE_DISABLE_MSSQL=1
CXXFLAGS += -DWIN32_LEAN_AND_MEAN -DNOMINMAX
CXXFLAGS += -static -static-libgcc -static-libstdc++

# Include ê²½ë¡œ
MINGW_PREFIX = /usr/x86_64-w64-mingw32
INCLUDES = -I$(INCLUDE_DIR)
INCLUDES += -I$(INCLUDE_DIR)/Platform
INCLUDES += -I$(INCLUDE_DIR)/Common
INCLUDES += -I$(INCLUDE_DIR)/Utils
INCLUDES += -I$(INCLUDE_DIR)/Database
INCLUDES += -I$(INCLUDE_DIR)/Database/Entities
INCLUDES += -I$(INCLUDE_DIR)/Database/Repositories
INCLUDES += -I$(INCLUDE_DIR)/Workers
INCLUDES += -I$(INCLUDE_DIR)/Workers/Base
INCLUDES += -I$(INCLUDE_DIR)/Workers/Protocol
INCLUDES += -I$(INCLUDE_DIR)/Workers/Components
INCLUDES += -I$(INCLUDE_DIR)/Client
INCLUDES += -I$(INCLUDE_DIR)/Alarm
INCLUDES += -I$(INCLUDE_DIR)/VirtualPoint
INCLUDES += -I$(INCLUDE_DIR)/Pipeline
INCLUDES += -I$(INCLUDE_DIR)/Storage
INCLUDES += -I$(MINGW_PREFIX)/include

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°ì§€ ë° ì„¤ì •
LDFLAGS = -L$(MINGW_PREFIX)/lib -static

# Windows í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬
WIN_LIBS = -lws2_32 -lwsock32 -liphlpapi -lrpcrt4 -luuid
WIN_LIBS += -lwinmm -lkernel32 -luser32 -ladvapi32

# SQLite (ê¸°ë³¸)
DB_LIBS = -lsqlite3

# í”„ë¡œí† ì½œ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì„ íƒì )
PROTOCOL_LIBS =
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libmodbus.a),)
    PROTOCOL_LIBS += -lmodbus
    CXXFLAGS += -DHAVE_MODBUS=1
endif

ifneq ($(wildcard $(MINGW_PREFIX)/lib/libpaho-mqtt3c.a),)
    PROTOCOL_LIBS += -lpaho-mqtt3c
    CXXFLAGS += -DHAVE_MQTT=1
endif

ifneq ($(wildcard $(MINGW_PREFIX)/lib/libbacnet.a),)
    PROTOCOL_LIBS += -lbacnet
    CXXFLAGS += -DHAVE_BACNET=1
endif

# Redis (ì„ íƒì )
ifneq ($(wildcard $(MINGW_PREFIX)/lib/libhiredis.a),)
    DB_LIBS += -lhiredis
    CXXFLAGS += -DHAVE_REDIS=1
endif

# ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬
LIBS = $(PROTOCOL_LIBS) $(DB_LIBS) $(WIN_LIBS) -lpthread

# =============================================================================
# ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì†ŒìŠ¤ íŒŒì¼ íƒì§€
# =============================================================================

# wildcardë¥¼ ì‚¬ìš©í•´ì„œ ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íŒŒì¼ë§Œ í¬í•¨
ALL_CPP_FILES = $(shell find $(SRC_DIR) -name "*.cpp" -type f 2>/dev/null)

# ì»´íŒŒì¼í•  ì†ŒìŠ¤ íŒŒì¼ë“¤ (main.cppëŠ” ë§ˆì§€ë§‰ì—)
SOURCES = $(filter-out $(SRC_DIR)/main.cpp,$(ALL_CPP_FILES))
MAIN_SOURCE = $(SRC_DIR)/main.cpp

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(BUILD_DIR)/%.o)
MAIN_OBJECT = $(BUILD_DIR)/main.o

# =============================================================================
# ë¹Œë“œ ê·œì¹™
# =============================================================================

.PHONY: all clean info check-files help

all: check-files $(BIN_DIR)/$(TARGET)

check-files:
	@echo "================================================"
	@echo "  PulseOne Windows Cross-Compile"
	@echo "================================================"
	@echo "Compiler: $(CXX)"
	@echo "Found CPP files: $(words $(ALL_CPP_FILES))"
	@echo ""
	@echo "Libraries:"
	@echo "  SQLite:   âœ… (ê¸°ë³¸)"
	@echo "  Modbus:   $(if $(findstring -lmodbus,$(PROTOCOL_LIBS)),âœ…,âŒ)"
	@echo "  MQTT:     $(if $(findstring -lpaho-mqtt3c,$(PROTOCOL_LIBS)),âœ…,âŒ)"
	@echo "  BACnet:   $(if $(findstring -lbacnet,$(PROTOCOL_LIBS)),âœ…,âŒ)"
	@echo "  Redis:    $(if $(findstring -lhiredis,$(DB_LIBS)),âœ…,âŒ)"
	@echo "================================================"

$(BIN_DIR)/$(TARGET): $(OBJECTS) $(MAIN_OBJECT) | $(BIN_DIR)
	@echo "ğŸ”— Linking $@..."
	$(CXX) $(LDFLAGS) -o $@ $(OBJECTS) $(MAIN_OBJECT) $(LIBS)
	@echo "ğŸ“¦ Stripping debug symbols..."
	$(STRIP) $@
	@echo "âœ… Build complete: $@"
	@echo "   Size: $(shell du -h $@ 2>/dev/null | cut -f1 || echo 'N/A')"

# ì¼ë°˜ ì†ŒìŠ¤ íŒŒì¼ ì»´íŒŒì¼
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "âš™ï¸  Compiling $(notdir $<)..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@ || \
	 (echo "âŒ Failed: $(notdir $<)" && exit 1)

# main.cpp ì»´íŒŒì¼
$(MAIN_OBJECT): $(MAIN_SOURCE) | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "âš™ï¸  Compiling main.cpp..."
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@ || \
	 (echo "âŒ Failed: main.cpp" && exit 1)

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BUILD_DIR):
	@mkdir -p $@
	@mkdir -p $(BUILD_DIR)/Utils
	@mkdir -p $(BUILD_DIR)/Database
	@mkdir -p $(BUILD_DIR)/Database/Entities
	@mkdir -p $(BUILD_DIR)/Database/Repositories
	@mkdir -p $(BUILD_DIR)/Workers
	@mkdir -p $(BUILD_DIR)/Workers/Base
	@mkdir -p $(BUILD_DIR)/Workers/Protocol
	@mkdir -p $(BUILD_DIR)/Workers/Components
	@mkdir -p $(BUILD_DIR)/Client
	@mkdir -p $(BUILD_DIR)/Alarm
	@mkdir -p $(BUILD_DIR)/VirtualPoint
	@mkdir -p $(BUILD_DIR)/Pipeline
	@mkdir -p $(BUILD_DIR)/Storage
	@mkdir -p $(BUILD_DIR)/Platform

$(BIN_DIR):
	@mkdir -p $@

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BUILD_DIR) $(BIN_DIR)
	@echo "âœ… Clean complete"

info:
	@echo "ğŸ“Š Source files analysis:"
	@echo "Total CPP files: $(words $(ALL_CPP_FILES))"
	@echo ""
	@echo "Found source files:"
	@for src in $(ALL_CPP_FILES); do echo "  - $$src"; done
	@echo ""
	@echo "Will compile $(words $(SOURCES)) files + main.cpp"

# ê°œë³„ íŒŒì¼ í…ŒìŠ¤íŠ¸ ì»´íŒŒì¼
test-file:
	@if [ -z "$(FILE)" ]; then \
		echo "Usage: make test-file FILE=src/path/to/file.cpp"; \
		exit 1; \
	fi
	@echo "ğŸ§ª Testing compilation of $(FILE)..."
	@mkdir -p build-test
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $(FILE) -o build-test/test.o && \
	 echo "âœ… $(FILE) compiles successfully" || \
	 echo "âŒ $(FILE) failed to compile"
	@rm -f build-test/test.o

help:
	@echo "PulseOne Windows Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all        - Build complete project"
	@echo "  clean      - Clean build artifacts"
	@echo "  info       - Show source file information"
	@echo "  test-file  - Test single file (use FILE=path)"
	@echo "  help       - Show this help"
	@echo ""
	@echo "Examples:"
	@echo "  make all"
	@echo "  make test-file FILE=src/main.cpp"
	@echo "  make clean"