# =============================================================================
# collector/tests/Makefile - Step3 ì™„ì „ ìˆ˜ì • ë²„ì „
# ì¤‘ë³µ ì œê±° + ëˆ„ë½ ì†ŒìŠ¤ ì¶”ê°€ + ë§í‚¹ ì—ëŸ¬ í•´ê²°
# =============================================================================

# ì›ë³¸ Makefileê³¼ ë™ì¼í•œ ì„¤ì • ì‚¬ìš©
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE -O0
LDFLAGS = 

# ê²½ë¡œ ì„¤ì • (tests í´ë” ê¸°ì¤€)
PARENT_DIR = ..
INCLUDE_DIR = $(PARENT_DIR)/include
SRC_DIR = $(PARENT_DIR)/src
BIN_DIR = ./bin
DATA_DIR = ./data

# Include ê²½ë¡œ (ì›ë³¸ê³¼ ë™ì¼)
INCLUDES = -I$(INCLUDE_DIR)

# =============================================================================
# ì›ë³¸ Makefileì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ ê·¸ëŒ€ë¡œ ì‚¬ìš©
# =============================================================================

HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_BACNET_STACK := $(shell pkg-config --exists bacnet && echo "1" || echo "0")

# ì›ë³¸ Makefileì˜ í”Œë˜ê·¸ ì ìš©
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

ifeq ($(HAS_HIREDIS),1)
    CXXFLAGS += -DHAS_HIREDIS
else
    $(warning âš ï¸  hiredis not found - Redis functionality will be limited)
    $(warning    Install with: sudo apt-get install libhiredis-dev)
endif

ifeq ($(HAS_BACNET_STACK), 1)
    CXXFLAGS += -DHAS_BACNET_STACK=1
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
endif

# ì›ë³¸ Makefileì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ í•„ìš”í•œ ê²ƒë§Œ)
LIBS = -lpthread \
       $(shell pkg-config --libs libmodbus 2>/dev/null || echo "-lmodbus") \
       -lpqxx -lpq -lsqlite3 \
       -lpaho-mqtt3c -lpaho-mqttpp3 \
       -lbacnet -lmysqlclient \
       -lhiredis -lhiredis_ssl

# í…ŒìŠ¤íŠ¸ ì „ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬
TEST_LIBS = -lgtest -lgtest_main -pthread

# ì›ë³¸ Makefileì˜ ìƒ‰ìƒ ì •ì˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ğŸ”§ ìˆ˜ì •: ì†ŒìŠ¤ íŒŒì¼ ê·¸ë£¹ ì •ì˜ (ì¤‘ë³µ ì œê±° + ëˆ„ë½ ì¶”ê°€)
# =============================================================================

# ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° ì†ŒìŠ¤ë“¤ (ì¤‘ë³µ ì—†ì´ í•œ ë²ˆë§Œ ì •ì˜)
UTILS_SOURCES := $(SRC_DIR)/Utils/LogManager.cpp $(SRC_DIR)/Utils/LogLevelManager.cpp
CONFIG_SOURCES := $(SRC_DIR)/Utils/ConfigManager.cpp

# ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì†ŒìŠ¤ë“¤
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# í´ë¼ì´ì–¸íŠ¸ ì†ŒìŠ¤ë“¤
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# ğŸ”§ ì¶”ê°€: Driver ì†ŒìŠ¤ë“¤ (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„)
DRIVERS_SOURCES := $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp) \
                  $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp) \
                  $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp) \
                  $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)

# ğŸ”§ ì¶”ê°€: Pipeline ì†ŒìŠ¤ë“¤ (ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„)
PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)

# Workers ì†ŒìŠ¤ë“¤
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Components/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# ğŸ”§ ìˆ˜ì •: í…ŒìŠ¤íŠ¸ ë‹¨ê³„ë³„ í•„ìš” ì†ŒìŠ¤ë“¤ (ì¤‘ë³µ ì œê±°)
STEP1_SOURCES = $(UTILS_SOURCES) $(CONFIG_SOURCES)
STEP2_SOURCES = $(STEP1_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES)
STEP3_SOURCES = $(STEP2_SOURCES) $(WORKERS_SOURCES) $(DRIVERS_SOURCES) $(PIPELINE_SOURCES)
STEP4_SOURCES = $(STEP3_SOURCES)
STEP5_SOURCES = $(STEP4_SOURCES)

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿ ì •ì˜
# =============================================================================

.PHONY: all clean clean-all clean-testdb step1 step2 step3 step4 step5 check-deps setup-testdb check-testdb reset-testdb

# ê¸°ë³¸ íƒ€ê²Ÿ
all: check-deps setup-testdb step1
	@echo -e "$(GREEN)ğŸ‰ í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ!$(NC)"

# =============================================================================
# ì˜ì¡´ì„± ë° í™˜ê²½ ì²´í¬ (ì›ë³¸ Makefile ìŠ¤íƒ€ì¼)
# =============================================================================

check-deps:
	@echo -e "$(BLUE)ğŸ” PulseOne Collector Dependencies Check$(NC)"
	@echo -e "$(YELLOW)===============================================$(NC)"
	@echo -e "$(BLUE)ğŸ“‹ ì»´íŒŒì¼ëŸ¬ ì •ë³´:$(NC)"
	@echo "  CXX: $(CXX)"
	@$(CXX) --version | head -1
	@echo ""
	@echo -e "$(BLUE)ğŸ“š í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬:$(NC)"
	@if [ "$(HAS_NLOHMANN_JSON)" = "1" ]; then \
		echo -e "  $(GREEN)âœ… nlohmann/json$(NC)"; \
	else \
		echo -e "  $(YELLOW)âš ï¸  nlohmann/json (optional)$(NC)"; \
	fi
	@if [ "$(HAS_HIREDIS)" = "1" ]; then \
		echo -e "  $(GREEN)âœ… hiredis$(NC)"; \
	else \
		echo -e "  $(RED)âŒ hiredis$(NC)"; \
		echo -e "     Install: sudo apt-get install libhiredis-dev"; \
	fi
	@pkg-config --exists libmodbus 2>/dev/null && echo -e "  $(GREEN)âœ… libmodbus: $$(pkg-config --modversion libmodbus)$(NC)" || echo -e "  $(RED)âŒ libmodbus$(NC)"
	@pkg-config --exists paho-mqtt3c 2>/dev/null && echo -e "  $(GREEN)âœ… paho-mqtt3c$(NC)" || echo -e "  $(YELLOW)âš ï¸  paho-mqtt3c$(NC)"
	@pkg-config --exists bacnet 2>/dev/null && echo -e "  $(GREEN)âœ… bacnet$(NC)" || echo -e "  $(YELLOW)âš ï¸  bacnet$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸ§ª í…ŒìŠ¤íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬:$(NC)"
	@ldconfig -p | grep -q "libgtest" && echo -e "  $(GREEN)âœ… Google Test$(NC)" || echo -e "  $(YELLOW)âš ï¸  Google Test (install: sudo apt-get install libgtest-dev)$(NC)"
	@ldconfig -p | grep -q "libsqlite3" && echo -e "  $(GREEN)âœ… SQLite3$(NC)" || echo -e "  $(RED)âŒ SQLite3$(NC)"

# ğŸ”§ ì¶”ê°€: ì†ŒìŠ¤ íŒŒì¼ ìƒì„¸ ì²´í¬
check-sources:
	@echo -e "$(BLUE)ğŸ” ì†ŒìŠ¤ íŒŒì¼ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)Utils sources: $(words $(UTILS_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Config sources: $(words $(CONFIG_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Database sources: $(words $(DATABASE_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Client sources: $(words $(CLIENT_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Workers sources: $(words $(WORKERS_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Drivers sources: $(words $(DRIVERS_SOURCES))ê°œ$(NC)"
	@echo -e "$(YELLOW)Pipeline sources: $(words $(PIPELINE_SOURCES))ê°œ$(NC)"

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

$(DATA_DIR):
	@mkdir -p $(DATA_DIR)

directories: $(BIN_DIR) $(DATA_DIR)

# =============================================================================
# í…ŒìŠ¤íŠ¸ DB ê´€ë¦¬ (SQLite ê¸°ë°˜)
# =============================================================================

# í…ŒìŠ¤íŠ¸ DB ìƒì„± (ê¸°ì¡´ ì½”ë“œ í™œìš©)
setup-testdb: $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ—„ï¸  ì‹¤ì œ í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±$(NC)"
	@echo -e "$(YELLOW)============================$(NC)"
	@echo -e "$(BLUE)ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘...$(NC)"
	@mkdir -p db logs backup config
	@if [ -f "db/pulseone_test.db" ]; then \
		echo -e "$(YELLOW)âš ï¸  ê¸°ì¡´ DB ë°œê²¬ - ë°±ì—… ìƒì„±$(NC)"; \
		mv db/pulseone_test.db backup/pulseone_test_backup_$$(date +%Y%m%d_%H%M%S).db; \
	fi
	@echo -e "$(BLUE)ğŸ“‹ í…ŒìŠ¤íŠ¸ DB ìƒì„±: db/pulseone_test.db$(NC)"
	@if [ ! -f "setup_test_db.sql" ]; then \
		echo -e "$(RED)âŒ setup_test_db.sql íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!$(NC)"; \
		echo -e "$(YELLOW)   './setup_test_environment.sh'ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ê±°ë‚˜$(NC)"; \
		echo -e "$(YELLOW)   artifactsì—ì„œ SQL íŒŒì¼ì„ ì €ì¥í•´ì£¼ì„¸ìš”.$(NC)"; \
		exit 1; \
	fi
	@sqlite3 db/pulseone_test.db < setup_test_db.sql
	@echo -e "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ DB ìƒì„± ì™„ë£Œ: db/pulseone_test.db$(NC)"
	@echo -e "$(BLUE)ğŸ“Š ConfigManagerê°€ ì´ DBë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •ë¨$(NC)"

# í…ŒìŠ¤íŠ¸ DB ìƒíƒœ í™•ì¸
check-testdb:
	@echo -e "$(BLUE)ğŸ” í…ŒìŠ¤íŠ¸ í™˜ê²½ ìƒíƒœ í™•ì¸$(NC)"
	@echo -e "$(YELLOW)========================$(NC)"
	@echo -e "$(BLUE)ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡°:$(NC)"
	@ls -la . | grep -E "(config|db|logs|backup)" || echo -e "$(YELLOW)   ì¼ë¶€ ë””ë ‰í† ë¦¬ ì—†ìŒ$(NC)"
	@echo ""
	@echo -e "$(BLUE)âš™ï¸  ì„¤ì • íŒŒì¼ë“¤:$(NC)"
	@if [ -f "config/.env" ]; then \
		echo -e "   $(GREEN)âœ… config/.env$(NC)"; \
	else \
		echo -e "   $(RED)âŒ config/.env$(NC)"; \
	fi
	@if [ -f "config/database.env" ]; then \
		echo -e "   $(GREEN)âœ… config/database.env$(NC)"; \
	else \
		echo -e "   $(RED)âŒ config/database.env$(NC)"; \
	fi
	@if [ -f "config/redis.env" ]; then \
		echo -e "   $(GREEN)âœ… config/redis.env$(NC)"; \
	else \
		echo -e "   $(RED)âŒ config/redis.env$(NC)"; \
	fi
	@echo ""
	@if [ ! -f "db/pulseone_test.db" ]; then \
		echo -e "$(RED)âŒ í…ŒìŠ¤íŠ¸ DBê°€ ì—†ìŠµë‹ˆë‹¤: db/pulseone_test.db$(NC)"; \
		echo -e "$(YELLOW)   'make setup-testdb' ë˜ëŠ” './setup_test_environment.sh'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ DB íŒŒì¼: db/pulseone_test.db$(NC)"
	@echo -e "$(BLUE)ğŸ“Š DB í…Œì´ë¸” ë° ë°ì´í„°:$(NC)"
	@sqlite3 db/pulseone_test.db "SELECT printf('   %-15s: %dê°œ', 'tenants', COUNT(*)) FROM tenants UNION ALL SELECT printf('   %-15s: %dê°œ', 'sites', COUNT(*)) FROM sites UNION ALL SELECT printf('   %-15s: %dê°œ', 'devices', COUNT(*)) FROM devices UNION ALL SELECT printf('   %-15s: %dê°œ', 'data_points', COUNT(*)) FROM data_points;"

# í…ŒìŠ¤íŠ¸ DB ì´ˆê¸°í™”
reset-testdb: setup-testdb
	@echo -e "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ DB ì´ˆê¸°í™” ì™„ë£Œ$(NC)"

# í…ŒìŠ¤íŠ¸ DB ì •ë¦¬
clean-testdb:
	@echo -e "$(YELLOW)ğŸ§¹ í…ŒìŠ¤íŠ¸ DB ì •ë¦¬$(NC)"
	@rm -f $(BIN_DIR)/test.db $(BIN_DIR)/test.db.backup.*
	@echo -e "$(GREEN)âœ… í…ŒìŠ¤íŠ¸ DB ì •ë¦¬ ì™„ë£Œ$(NC)"

# =============================================================================
# ğŸ”§ ìˆ˜ì •: 5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ë“¤ (ì¤‘ë³µ ì œê±°ëœ ì†ŒìŠ¤ ì‚¬ìš©)
# =============================================================================

# 1ë‹¨ê³„: âœ… ì„¤ì •íŒŒì¼ ì½ê¸°
step1: $(BIN_DIR)/test_step1
	@echo -e "$(GREEN)âœ… 1ë‹¨ê³„: ì„¤ì •íŒŒì¼ ì½ê¸° í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ$(NC)"

$(BIN_DIR)/test_step1: test_step1_config.cpp $(STEP1_SOURCES) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”§ Step1 ì»´íŒŒì¼: ì„¤ì •íŒŒì¼ ì½ê¸°$(NC)"
	@echo -e "$(YELLOW)   Sources: $(words $(STEP1_SOURCES))ê°œ íŒŒì¼$(NC)"
	@if [ ! -f "test_step1_config.cpp" ]; then \
		echo -e "$(RED)âŒ test_step1_config.cpp íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤$(NC)"; \
		exit 1; \
	fi
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step1_config.cpp $(STEP1_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $@

# 2ë‹¨ê³„: âœ… DB ì ‘ê·¼í•˜ì—¬ í…Œì´ë¸”ë“¤ ì½ê¸°
step2: $(BIN_DIR)/test_step2
	@echo -e "$(GREEN)âœ… 2ë‹¨ê³„: DB ì ‘ê·¼ í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ$(NC)"

$(BIN_DIR)/test_step2: test_step2_database.cpp $(STEP2_SOURCES) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”§ Step2 ì»´íŒŒì¼: DB ì ‘ê·¼$(NC)"
	@echo -e "$(YELLOW)   Sources: $(words $(STEP2_SOURCES))ê°œ íŒŒì¼$(NC)"
	@if [ ! -f "test_step2_database.cpp" ]; then \
		echo -e "$(RED)âŒ test_step2_database.cpp íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤$(NC)"; \
		exit 1; \
	fi
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step2_database.cpp $(STEP2_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $@

# ğŸ”§ ìˆ˜ì •: 3ë‹¨ê³„ - ì¤‘ë³µ ì œê±° ë° ëˆ„ë½ ì†ŒìŠ¤ ì¶”ê°€
step3: $(BIN_DIR)/test_step3
	@echo -e "$(GREEN)âœ… 3ë‹¨ê³„: DeviceWorker ìƒì„± í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ$(NC)"

$(BIN_DIR)/test_step3: test_step3_workers.cpp $(STEP3_SOURCES) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”§ Step3 ì»´íŒŒì¼: DeviceWorker ìƒì„± (ì™„ì „ ìˆ˜ì •)$(NC)"
	@echo -e "$(YELLOW)   Sources: $(words $(STEP3_SOURCES))ê°œ íŒŒì¼$(NC)"
	@echo -e "$(YELLOW)   Including: Utils($(words $(UTILS_SOURCES))), Config($(words $(CONFIG_SOURCES))), Database($(words $(DATABASE_SOURCES))), Workers($(words $(WORKERS_SOURCES))), Drivers($(words $(DRIVERS_SOURCES))), Pipeline($(words $(PIPELINE_SOURCES)))$(NC)"
	@if [ ! -f "test_step3_workers.cpp" ]; then \
		echo -e "$(RED)âŒ test_step3_workers.cpp íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤$(NC)"; \
		exit 1; \
	fi
	@# ì¤‘ë³µ ì œê±°ëœ ì†ŒìŠ¤ë¡œ ì»´íŒŒì¼
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step3_workers.cpp \
		$(STEP3_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $@

# 4ë‹¨ê³„: âœ… ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹œë®¬ë ˆì´ì…˜
step4: $(BIN_DIR)/test_step4
	@echo -e "$(GREEN)âœ… 4ë‹¨ê³„: ë“œë¼ì´ë²„ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ$(NC)"

$(BIN_DIR)/test_step4: test_step4_drivers.cpp $(STEP4_SOURCES) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”§ Step4 ì»´íŒŒì¼: ë“œë¼ì´ë²„ ì´ˆê¸°í™”$(NC)"
	@echo -e "$(YELLOW)   Sources: $(words $(STEP4_SOURCES))ê°œ íŒŒì¼$(NC)"
	@if [ ! -f "test_step4_drivers.cpp" ]; then \
		echo -e "$(RED)âŒ test_step4_drivers.cpp íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤$(NC)"; \
		exit 1; \
	fi
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step4_drivers.cpp $(STEP4_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $@

# 5ë‹¨ê³„: âœ… ë°ì´í„° Redis ì €ì¥ ì‹œë®¬ë ˆì´ì…˜
step5: $(BIN_DIR)/test_step5
	@echo -e "$(GREEN)âœ… 5ë‹¨ê³„: Redis ì €ì¥ í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì™„ë£Œ$(NC)"

$(BIN_DIR)/test_step5: test_step5_redis.cpp $(STEP5_SOURCES) | $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ”§ Step5 ì»´íŒŒì¼: Redis ì €ì¥$(NC)"
	@echo -e "$(YELLOW)   Sources: $(words $(STEP5_SOURCES))ê°œ íŒŒì¼$(NC)"
	@if [ ! -f "test_step5_redis.cpp" ]; then \
		echo -e "$(RED)âŒ test_step5_redis.cpp íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤$(NC)"; \
		exit 1; \
	fi
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step5_redis.cpp $(STEP5_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $@

# =============================================================================
# ì‹¤í–‰ íƒ€ê²Ÿë“¤ (ì›ë³¸ Makefileì˜ run ìŠ¤íƒ€ì¼)
# =============================================================================

run-step1: step1 check-testdb
	@echo -e "$(BLUE)ğŸš€ 1ë‹¨ê³„ ì‹¤í–‰: ì„¤ì •íŒŒì¼ ì½ê¸°$(NC)"
	@echo -e "$(YELLOW)================================$(NC)"
	cd $(BIN_DIR) && ./test_step1

run-step2: step2 check-testdb
	@echo -e "$(BLUE)ğŸš€ 2ë‹¨ê³„ ì‹¤í–‰: DB ì ‘ê·¼$(NC)"
	@echo -e "$(YELLOW)========================$(NC)"
	cd $(BIN_DIR) && ./test_step2

run-step3: step3 check-testdb
	@echo -e "$(BLUE)ğŸš€ 3ë‹¨ê³„ ì‹¤í–‰: DeviceWorker ìƒì„± (ì™„ì „ ìˆ˜ì •)$(NC)"
	@echo -e "$(YELLOW)===========================================$(NC)"
	@echo -e "$(GREEN)âœ… ì¤‘ë³µ ì œê±° + ëª¨ë“  Driver ë° Pipeline ì†ŒìŠ¤ í¬í•¨ë¨$(NC)"
	cd $(BIN_DIR) && ./test_step3

run-step4: step4 check-testdb
	@echo -e "$(BLUE)ğŸš€ 4ë‹¨ê³„ ì‹¤í–‰: ë“œë¼ì´ë²„ ì´ˆê¸°í™”$(NC)"
	@echo -e "$(YELLOW)==============================$(NC)"
	cd $(BIN_DIR) && ./test_step4

run-step5: step5 check-testdb
	@echo -e "$(BLUE)ğŸš€ 5ë‹¨ê³„ ì‹¤í–‰: Redis ì €ì¥$(NC)"
	@echo -e "$(YELLOW)==========================$(NC)"
	cd $(BIN_DIR) && ./test_step5

# ì „ì²´ 5ë‹¨ê³„ í”Œë¡œìš° ì‹¤í–‰
run-all: step1 step2 step3 step4 step5 check-testdb
	@echo -e "$(BLUE)ğŸš€ PulseOne Collector ì „ì²´ í…ŒìŠ¤íŠ¸ í”Œë¡œìš°$(NC)"
	@echo -e "$(YELLOW)=========================================$(NC)"
	@echo -e "$(GREEN)1ë‹¨ê³„: ì„¤ì •íŒŒì¼ ì½ê¸°$(NC)"
	cd $(BIN_DIR) && ./test_step1 && echo ""
	@echo -e "$(GREEN)2ë‹¨ê³„: DB ì ‘ê·¼í•˜ì—¬ í…Œì´ë¸”ë“¤ ì½ê¸°$(NC)"
	cd $(BIN_DIR) && ./test_step2 && echo ""
	@echo -e "$(GREEN)3ë‹¨ê³„: í”„ë¡œí† ì½œë³„ DeviceWorker ìƒì„±$(NC)"
	cd $(BIN_DIR) && ./test_step3 && echo ""
	@echo -e "$(GREEN)4ë‹¨ê³„: ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹œë®¬ë ˆì´ì…˜$(NC)"
	cd $(BIN_DIR) && ./test_step4 && echo ""
	@echo -e "$(GREEN)5ë‹¨ê³„: ë°ì´í„° Redis ì €ì¥ ì‹œë®¬ë ˆì´ì…˜$(NC)"
	cd $(BIN_DIR) && ./test_step5 && echo ""
	@echo -e "$(GREEN)ğŸ‰ ì „ì²´ 5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ í”Œë¡œìš° ì™„ë£Œ!$(NC)"

# =============================================================================
# ğŸ”§ ì¶”ê°€: ë””ë²„ê·¸ ë° ì§„ë‹¨ ë„êµ¬ë“¤
# =============================================================================

# ë””ë²„ê·¸: Step3ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì†ŒìŠ¤ í™•ì¸
debug-step3-sources:
	@echo -e "$(BLUE)ğŸ” Step3 ì†ŒìŠ¤ íŒŒì¼ ë¶„ì„$(NC)"
	@echo -e "$(YELLOW)========================$(NC)"
	@echo -e "$(BLUE)Total STEP3_SOURCES: $(words $(STEP3_SOURCES))ê°œ$(NC)"
	@echo ""
	@echo -e "$(BLUE)UTILS_SOURCES ($(words $(UTILS_SOURCES))ê°œ):$(NC)"
	@echo "$(UTILS_SOURCES)" | tr ' ' '\n'
	@echo ""
	@echo -e "$(BLUE)CONFIG_SOURCES ($(words $(CONFIG_SOURCES))ê°œ):$(NC)"
	@echo "$(CONFIG_SOURCES)" | tr ' ' '\n'
	@echo ""
	@echo -e "$(BLUE)DRIVERS_SOURCES ($(words $(DRIVERS_SOURCES))ê°œ):$(NC)"
	@echo "$(DRIVERS_SOURCES)" | tr ' ' '\n'
	@echo ""
	@echo -e "$(BLUE)PIPELINE_SOURCES ($(words $(PIPELINE_SOURCES))ê°œ):$(NC)"
	@echo "$(PIPELINE_SOURCES)" | tr ' ' '\n'
	@echo ""
	@echo -e "$(BLUE)WORKERS_SOURCES ($(words $(WORKERS_SOURCES))ê°œ):$(NC)"
	@echo "$(WORKERS_SOURCES)" | tr ' ' '\n' | head -10

# ì‹¤ì œ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
check-step3-files:
	@echo -e "$(BLUE)ğŸ” Step3 í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)==================================$(NC)"
	@echo -e "$(BLUE)Driver êµ¬í˜„ íŒŒì¼ë“¤:$(NC)"
	@ls -la $(SRC_DIR)/Drivers/*/*.cpp 2>/dev/null | head -10 || echo -e "$(RED)âŒ Driver ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ$(NC)"
	@echo ""
	@echo -e "$(BLUE)Pipeline êµ¬í˜„ íŒŒì¼ë“¤:$(NC)"
	@ls -la $(SRC_DIR)/Pipeline/*.cpp 2>/dev/null || echo -e "$(RED)âŒ Pipeline ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ$(NC)"
	@echo ""
	@echo -e "$(BLUE)Workers êµ¬í˜„ íŒŒì¼ë“¤:$(NC)"
	@ls -la $(SRC_DIR)/Workers/Protocol/*.cpp 2>/dev/null | head -5 || echo -e "$(RED)âŒ Workers ì†ŒìŠ¤ íŒŒì¼ ì—†ìŒ$(NC)"

# ì¤‘ë³µ íŒŒì¼ ì²´í¬
check-duplicates:
	@echo -e "$(BLUE)ğŸ” ì¤‘ë³µ ì†ŒìŠ¤ íŒŒì¼ ì²´í¬$(NC)"
	@echo -e "$(YELLOW)=====================$(NC)"
	@echo "$(STEP3_SOURCES)" | tr ' ' '\n' | sort | uniq -d | while read duplicate; do \
		if [ -n "$$duplicate" ]; then \
			echo -e "$(RED)âŒ ì¤‘ë³µ íŒŒì¼: $$duplicate$(NC)"; \
		fi; \
	done
	@echo -e "$(GREEN)âœ… ì¤‘ë³µ ì²´í¬ ì™„ë£Œ$(NC)"

.PHONY: debug-step3-sources check-step3-files check-duplicates

# =============================================================================
# í†µí•© ì‹¤í–‰ íƒ€ê²Ÿë“¤
# =============================================================================

# ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ (1ë‹¨ê³„ë§Œ) - DB ì„¤ì • í¬í•¨
quick: clean check-deps setup-testdb step1 run-step1
	@echo -e "$(GREEN)ğŸ‰ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ$(NC)"

# ì „ì²´ í…ŒìŠ¤íŠ¸ í”Œë¡œìš° - DB ì„¤ì • í¬í•¨
full: clean check-deps check-sources setup-testdb run-all
	@echo -e "$(GREEN)ğŸ‰ ì „ì²´ í…ŒìŠ¤íŠ¸ í”Œë¡œìš° ì™„ë£Œ$(NC)"

# ê°œë°œììš© ë¹ ë¥¸ ë¹Œë“œ ì²´í¬
build-only: check-deps step1 step2 step3 step4 step5
	@echo -e "$(GREEN)ğŸ‰ ëª¨ë“  ë‹¨ê³„ ë¹Œë“œ ì™„ë£Œ (ì‹¤í–‰ ì—†ìŒ)$(NC)"

# =============================================================================
# ìœ í‹¸ë¦¬í‹° ë° ì •ë¦¬
# =============================================================================

clean:
	@echo -e "$(YELLOW)ğŸ§¹ ë¹Œë“œ íŒŒì¼ ì •ë¦¬$(NC)"
	@rm -rf $(BIN_DIR)
	@echo -e "$(GREEN)âœ… ë¹Œë“œ ì •ë¦¬ ì™„ë£Œ$(NC)"

clean-all: clean clean-testdb
	@echo -e "$(GREEN)âœ… ì „ì²´ ì •ë¦¬ ì™„ë£Œ (ë¹Œë“œ íŒŒì¼ + í…ŒìŠ¤íŠ¸ DB)$(NC)"

# ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
debug-info:
	@echo -e "$(BLUE)ğŸ”§ PulseOne í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ ë””ë²„ê·¸ ì •ë³´$(NC)"
	@echo -e "$(YELLOW)========================================$(NC)"
	@echo "CXX: $(CXX)"
	@echo "CXXFLAGS: $(CXXFLAGS)"
	@echo "INCLUDES: $(INCLUDES)"
	@echo "LIBS: $(LIBS)"
	@echo "HAS_NLOHMANN_JSON: $(HAS_NLOHMANN_JSON)"
	@echo "HAS_HIREDIS: $(HAS_HIREDIS)"
	@echo "HAS_BACNET_STACK: $(HAS_BACNET_STACK)"
	@echo ""
	@echo "Source counts:"
	@echo "  UTILS_SOURCES: $(words $(UTILS_SOURCES))"
	@echo "  CONFIG_SOURCES: $(words $(CONFIG_SOURCES))"
	@echo "  DATABASE_SOURCES: $(words $(DATABASE_SOURCES))"
	@echo "  CLIENT_SOURCES: $(words $(CLIENT_SOURCES))"
	@echo "  WORKERS_SOURCES: $(words $(WORKERS_SOURCES))"
	@echo "  DRIVERS_SOURCES: $(words $(DRIVERS_SOURCES))"
	@echo "  PIPELINE_SOURCES: $(words $(PIPELINE_SOURCES))"

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸ”§ PulseOne Collector í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ (ì™„ì „ ìˆ˜ì •)$(NC)"
	@echo -e "$(YELLOW)===============================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)ğŸ—„ï¸  í…ŒìŠ¤íŠ¸ DB ê´€ë¦¬:$(NC)"
	@echo "  setup-testdb         - SQLite í…ŒìŠ¤íŠ¸ DB ìƒì„± (5ê°œ devices, 16ê°œ data_points)"
	@echo "  check-testdb         - í…ŒìŠ¤íŠ¸ DB ìƒíƒœ ë° ë°ì´í„° í™•ì¸"
	@echo "  reset-testdb         - í…ŒìŠ¤íŠ¸ DB ì´ˆê¸°í™”"
	@echo "  clean-testdb         - í…ŒìŠ¤íŠ¸ DB ì‚­ì œ"
	@echo ""
	@echo -e "$(GREEN)ğŸ§ª 5ë‹¨ê³„ í…ŒìŠ¤íŠ¸ í”Œë¡œìš°:$(NC)"
	@echo "  step1 / run-step1    - ì„¤ì •íŒŒì¼ ì½ê¸°"
	@echo "  step2 / run-step2    - DB ì ‘ê·¼í•˜ì—¬ í…Œì´ë¸”ë“¤ ì½ê¸°"
	@echo "  step3 / run-step3    - í”„ë¡œí† ì½œë³„ DeviceWorker ìƒì„± (ì™„ì „ ìˆ˜ì •)"
	@echo "  step4 / run-step4    - ë“œë¼ì´ë²„ ì´ˆê¸°í™” ì‹œë®¬ë ˆì´ì…˜"
	@echo "  step5 / run-step5    - ë°ì´í„° Redis ì €ì¥ ì‹œë®¬ë ˆì´ì…˜"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ í†µí•© ì‹¤í–‰:$(NC)"
	@echo "  run-all              - ì „ì²´ 5ë‹¨ê³„ í”Œë¡œìš° ì‹¤í–‰"
	@echo "  quick                - DB ì„¤ì • + 1ë‹¨ê³„ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸"
	@echo "  full                 - í™˜ê²½ì²´í¬ + DB ì„¤ì • + ì „ì²´ í”Œë¡œìš°"
	@echo "  build-only           - ëª¨ë“  ë‹¨ê³„ ë¹Œë“œ (ì‹¤í–‰ ì—†ìŒ)"
	@echo ""
	@echo -e "$(GREEN)ğŸ”§ ê°œë°œ ë„êµ¬:$(NC)"
	@echo "  check-deps           - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì²´í¬"
	@echo "  check-sources        - ì†ŒìŠ¤ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬"
	@echo "  debug-step3-sources  - Step3 ì†ŒìŠ¤ íŒŒì¼ ìƒì„¸ ë¶„ì„"
	@echo "  check-step3-files    - Step3 í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ì²´í¬"
	@echo "  check-duplicates     - ì¤‘ë³µ ì†ŒìŠ¤ íŒŒì¼ ì²´í¬"
	@echo "  debug-info           - ì»´íŒŒì¼ ì„¤ì • ë° í™˜ê²½ ì •ë³´ ì¶œë ¥"
	@echo "  clean                - ë¹Œë“œ íŒŒì¼ ì •ë¦¬"
	@echo "  clean-all            - ë¹Œë“œ íŒŒì¼ + í…ŒìŠ¤íŠ¸ DB ì •ë¦¬"
	@echo ""
	@echo -e "$(GREEN)ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ:$(NC)"
	@echo -e "  $(YELLOW)make debug-step3-sources$(NC)  # Step3 ì†ŒìŠ¤ ë¶„ì„"
	@echo -e "  $(YELLOW)make check-duplicates$(NC)     # ì¤‘ë³µ íŒŒì¼ ì²´í¬"
	@echo -e "  $(YELLOW)make step3$(NC)                # Step3ë§Œ ë¹Œë“œ"
	@echo -e "  $(YELLOW)make run-step3$(NC)            # Step3 ì‹¤í–‰"

# =============================================================================
# íŠ¹ìˆ˜ íƒ€ê²Ÿë“¤
# =============================================================================

# SQLite í…ŒìŠ¤íŠ¸ ë„êµ¬  
sqlite-shell:
	@echo -e "$(BLUE)ğŸ—„ï¸  SQLite ì…¸ ì‹¤í–‰ - í…ŒìŠ¤íŠ¸ DB$(NC)"
	@echo -e "$(YELLOW)ì¢…ë£Œ: .quit$(NC)"
	@sqlite3 db/pulseone_test.db

# ê¸°ë³¸ íƒ€ê²Ÿ ì²´ì¸
.DEFAULT_GOAL := help