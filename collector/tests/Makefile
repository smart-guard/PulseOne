# =============================================================================
# collector/tests/Makefile - ğŸš€ ê³ ì† ì¦ë¶„ ì»´íŒŒì¼ ë²„ì „
# ëª¨ë“  íŒŒì¼ í¬í•¨í•˜ë©´ì„œë„ ë¹ ë¥¸ ì»´íŒŒì¼
# =============================================================================

# ğŸš€ ì„±ëŠ¥ ìµœì í™” ì„¤ì •
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC) --output-sync=target

# ğŸ”§ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ìºì‹œëœ ê²°ê³¼ ì‚¬ìš©)
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")
HAS_BACNET_STACK := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì • (ğŸš€ ìµœì í™”ë¨)
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE \
           -O1 -fno-omit-frame-pointer \
           -Wno-unused-but-set-variable -Wno-unused-variable \
           -fdiagnostics-color=always

# ğŸš€ ì¦ë¶„ ì»´íŒŒì¼ìš© ë””ë ‰í† ë¦¬
OBJ_DIR = ./obj
BIN_DIR = ./bin
DATA_DIR = ./data

# ê²½ë¡œ ì„¤ì •
PARENT_DIR = ..
INCLUDE_DIR = $(PARENT_DIR)/include
SRC_DIR = $(PARENT_DIR)/src

# Include ê²½ë¡œ
INCLUDES = -I$(INCLUDE_DIR)

# ğŸ”§ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1; echo $$?),0)
    MODBUS_LIBS = 
    MODBUS_INCLUDES = 
else
    MODBUS_LIBS = -lmodbus
    MODBUS_INCLUDES = $(shell pkg-config --cflags libmodbus 2>/dev/null || echo "")
    INCLUDES += $(MODBUS_INCLUDES)
endif

MYSQL_CONFIG := $(shell which mysql_config 2>/dev/null)
ifneq ($(MYSQL_CONFIG),)
    MYSQL_LIBS = $(shell mysql_config --libs)
    MYSQL_INCLUDES = $(shell mysql_config --include)
    INCLUDES += $(MYSQL_INCLUDES)
else
    MYSQL_LIBS = 
    CXXFLAGS += -DDISABLE_MYSQL_FEATURES
endif

ifeq ($(HAS_MQTT_C),1)
    MQTT_C_LIBS = -lpaho-mqtt3c
else
    MQTT_C_LIBS = 
endif

ifeq ($(HAS_MQTT_CPP),1)
    MQTT_CPP_LIBS = -lpaho-mqttpp3
    INCLUDES += -I/usr/local/include
else
    MQTT_CPP_LIBS = 
endif

ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpqxx >/dev/null 2>&1; echo $$?),0)
    PGSQL_LIBS = 
else
    PGSQL_LIBS = -lpqxx -lpq
endif

ifeq ($(HAS_BACNET_STACK), 1)
    BACNET_LIBS = -lbacnet -lm
    BACNET_INCLUDES = -I/usr/local/include/bacnet
    INCLUDES += $(BACNET_INCLUDES)
    CXXFLAGS += -DHAS_BACNET_STACK=1
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
    BACNET_LIBS = 
endif

ifeq ($(HAS_HIREDIS),1)
    REDIS_LIBS = -lhiredis -lhiredis_ssl
    CXXFLAGS += -DHAS_HIREDIS
else
    REDIS_LIBS = 
endif

ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
BASIC_LIBS = -lpthread -lsqlite3
OPTIONAL_LIBS = $(MODBUS_LIBS) $(MYSQL_LIBS) $(PGSQL_LIBS) $(MQTT_C_LIBS) $(MQTT_CPP_LIBS) $(BACNET_LIBS) $(REDIS_LIBS)
LIBS = $(BASIC_LIBS) $(OPTIONAL_LIBS)
TEST_LIBS = -lgtest -lgtest_main -pthread

# =============================================================================
# ğŸš€ ì†ŒìŠ¤ íŒŒì¼ ë° ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì •ì˜ (ëª¨ë“  íŒŒì¼ í¬í•¨)
# =============================================================================

# ëª¨ë“  ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘ (ê¸°ì¡´ê³¼ ë™ì¼)
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Components/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# Drivers ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨)
DRIVERS_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
ifneq ($(MODBUS_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif
ifeq ($(HAS_MQTT_CPP),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
endif
ifeq ($(HAS_BACNET_STACK),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif

PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)

# ğŸš€ ì „ì²´ ì†ŒìŠ¤ íŒŒì¼ (ëª¨ë“  íŒŒì¼ í¬í•¨)
ALL_SOURCES = $(UTILS_SOURCES) $(CONFIG_SOURCES) $(DATABASE_SOURCES) \
              $(CLIENT_SOURCES) $(WORKERS_SOURCES) $(DRIVERS_SOURCES) \
              $(PIPELINE_SOURCES)

# ğŸš€ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„± (ì¦ë¶„ ì»´íŒŒì¼ìš©)
ALL_OBJECTS = $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(ALL_SOURCES))
TEST_OBJECTS = $(OBJ_DIR)/test_step3_workers.o

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
PURPLE = \033[0;35m
NC = \033[0m

# =============================================================================
# ğŸš€ ì¦ë¶„ ì»´íŒŒì¼ íƒ€ê²Ÿë“¤
# =============================================================================

.DEFAULT_GOAL := help

# ë””ë ‰í† ë¦¬ ìƒì„±
$(OBJ_DIR):
	@echo -e "$(BLUE)ğŸ“ Creating object directories...$(NC)"
	@mkdir -p $(OBJ_DIR)
	@mkdir -p $(OBJ_DIR)/Utils $(OBJ_DIR)/Config $(OBJ_DIR)/Database/Entities $(OBJ_DIR)/Database/Repositories
	@mkdir -p $(OBJ_DIR)/Client $(OBJ_DIR)/Workers/Base $(OBJ_DIR)/Workers/Protocol $(OBJ_DIR)/Workers/Components
	@mkdir -p $(OBJ_DIR)/Drivers/Common $(OBJ_DIR)/Drivers/Modbus $(OBJ_DIR)/Drivers/Mqtt $(OBJ_DIR)/Drivers/Bacnet
	@mkdir -p $(OBJ_DIR)/Pipeline

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# ğŸš€ ê°œë³„ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼ (ì¦ë¶„ ì»´íŒŒì¼)
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Compiling $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸš€ í…ŒìŠ¤íŠ¸ íŒŒì¼ ì»´íŒŒì¼
$(OBJ_DIR)/test_step3_workers.o: test_step3_workers.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Compiling test file...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸš€ ê³ ì† ë§í‚¹ (ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤ë§Œ ë§í¬)
$(BIN_DIR)/test_step3: $(ALL_OBJECTS) $(TEST_OBJECTS) | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step3 ($(words $(ALL_OBJECTS)) objects)...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(TEST_OBJECTS) $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Fast build completed!$(NC)"

# ğŸš€ ë©”ì¸ íƒ€ê²Ÿë“¤
fast-build: $(BIN_DIR)/test_step3
	@echo -e "$(GREEN)ğŸš€ Fast incremental build completed!$(NC)"
	@echo -e "$(BLUE)ğŸ“Š Compiled $(words $(ALL_OBJECTS)) object files$(NC)"

# ì „ì²´ í´ë¦° ë¹Œë“œ (ì²˜ìŒ í•œ ë²ˆë§Œ)
full-build: clean $(BIN_DIR)/test_step3
	@echo -e "$(GREEN)ğŸ—ï¸  Full build completed!$(NC)"

# ğŸš€ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test: fast-build
	@echo -e "$(PURPLE)ğŸ§ª Running tests...$(NC)"
	@./$(BIN_DIR)/test_step3

# í´ë¦°
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning...$(NC)"
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# ğŸ” ë¹Œë“œ ìƒíƒœ í™•ì¸
status:
	@echo -e "$(BLUE)ğŸ“Š Build Status$(NC)"
	@echo -e "$(YELLOW)===============$(NC)"
	@echo "Object files: $(words $(wildcard $(OBJ_DIR)/**/*.o)) / $(words $(ALL_OBJECTS))"
	@echo "Source files: $(words $(ALL_SOURCES))"
	@echo "Binary: $(if $(wildcard $(BIN_DIR)/test_step3),âœ… exists,âŒ missing)"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ Libraries:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ…,âŒ)"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ…,âŒ)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ…,âŒ)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ…,âŒ)"

# ğŸš€ ê°œë°œìš© ì›Œí¬í”Œë¡œìš°
dev: fast-build test

# ì¢…ì†ì„± í™•ì¸ (ê¸°ì¡´ê³¼ ë™ì¼)
check-deps:
	@echo -e "$(BLUE)ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì²´í¬$(NC)"
	@echo "  Total sources: $(words $(ALL_SOURCES))"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ… $(MQTT_CPP_LIBS),âŒ not found)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… $(MODBUS_LIBS),âŒ not found)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… $(BACNET_LIBS),âŒ not found)"

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸš€ PulseOne Fast Build System$(NC)"
	@echo -e "$(YELLOW)==============================$(NC)"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ ë¹ ë¥¸ ë¹Œë“œ ëª…ë ¹ì–´:$(NC)"
	@echo "  make fast-build   - ğŸš€ ì¦ë¶„ ì»´íŒŒì¼ (ì´ˆê³ ì†)"
	@echo "  make test         - ğŸ§ª ë¹ ë¥¸ ë¹Œë“œ + í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make dev          - ğŸ”„ ê°œë°œ ì›Œí¬í”Œë¡œìš° (build + test)"
	@echo ""
	@echo -e "$(GREEN)ğŸ—ï¸  ì „ì²´ ë¹Œë“œ:$(NC)"
	@echo "  make full-build   - ğŸ—ï¸  ì „ì²´ í´ë¦° ë¹Œë“œ (ì²˜ìŒ í•œ ë²ˆ)"
	@echo "  make clean        - ğŸ§¹ ëª¨ë“  ë¹Œë“œ íŒŒì¼ ì‚­ì œ"
	@echo ""
	@echo -e "$(GREEN)ğŸ“Š ìƒíƒœ í™•ì¸:$(NC)"
	@echo "  make status       - ğŸ“Š ë¹Œë“œ ìƒíƒœ í™•ì¸"
	@echo "  make check-deps   - ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸"
	@echo ""
	@echo -e "$(PURPLE)ğŸ’¡ ì‚¬ìš©ë²•:$(NC)"
	@echo "  1ï¸âƒ£  ì²« ë¹Œë“œ: make full-build"
	@echo "  2ï¸âƒ£  ì´í›„ ê°œë°œ: make dev (ë§¤ìš° ë¹ ë¦„!)"
	@echo "  3ï¸âƒ£  ì½”ë“œ ë³€ê²½ í›„: make fast-build"

# ğŸš€ ìë™ ì¢…ì†ì„± ìƒì„± (ê³ ê¸‰ ê¸°ëŠ¥)
-include $(ALL_OBJECTS:.o=.d)

$(OBJ_DIR)/%.d: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”— Generating dependencies for $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $(OBJ_DIR)/$*.o $< > $@

.PHONY: fast-build full-build test dev clean status check-deps help