# =============================================================================
# collector/tests/Makefile - MQTT ê°ì§€ ìˆ˜ì • ë²„ì „
# =============================================================================

# CPU ì½”ì–´ ìˆ˜ ìë™ ê°ì§€ ë° ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC)

# ğŸ”§ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ì§ì ‘ ë§í‚¹ í…ŒìŠ¤íŠ¸ë¡œ ë³€ê²½)
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# ğŸ”¥ MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ë§í‚¹ í…ŒìŠ¤íŠ¸ë¡œ ë³€ê²½)
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")

# ğŸ”¥ BACnet ì²´í¬ (ì§ì ‘ íŒŒì¼ í™•ì¸ìœ¼ë¡œ ë³€ê²½)
HAS_BACNET_STACK := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì •
CXX = g++
CXXFLAGS = -Wno-unused-but-set-variable -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE -O0
LDFLAGS = 

# ê²½ë¡œ ì„¤ì •
PARENT_DIR = ..
INCLUDE_DIR = $(PARENT_DIR)/include
SRC_DIR = $(PARENT_DIR)/src
BIN_DIR = ./bin
DATA_DIR = ./data

# Include ê²½ë¡œ
INCLUDES = -I$(INCLUDE_DIR)

# ğŸ”§ ë¼ì´ë¸ŒëŸ¬ë¦¬ë³„ ì„¤ì • (ë§í‚¹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê¸°ë°˜)

# Modbus ë¼ì´ë¸ŒëŸ¬ë¦¬
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1; echo $$?),0)
    $(warning âš ï¸  libmodbus not found - Modbus features will be disabled)
    MODBUS_LIBS = 
    MODBUS_INCLUDES = 
else
    MODBUS_LIBS = -lmodbus
    MODBUS_INCLUDES = $(shell pkg-config --cflags libmodbus 2>/dev/null || echo "")
    INCLUDES += $(MODBUS_INCLUDES)
    $(info âœ… Modbus found via linking test)
endif

# MySQL ë¼ì´ë¸ŒëŸ¬ë¦¬
MYSQL_CONFIG := $(shell which mysql_config 2>/dev/null)
ifneq ($(MYSQL_CONFIG),)
    MYSQL_LIBS = $(shell mysql_config --libs)
    MYSQL_INCLUDES = $(shell mysql_config --include)
    INCLUDES += $(MYSQL_INCLUDES)
    $(info âœ… MySQL found: $(MYSQL_CONFIG))
else
    $(warning âš ï¸  mysql_config not found - MySQL features will be disabled)
    MYSQL_LIBS = 
    CXXFLAGS += -DDISABLE_MYSQL_FEATURES
endif

# ğŸ”¥ MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (ìˆ˜ì •ë¨)
ifeq ($(HAS_MQTT_C),1)
    MQTT_C_LIBS = -lpaho-mqtt3c
    $(info âœ… MQTT C found via linking test)
else
    $(warning âš ï¸  paho-mqtt3c not found via linking test)
    MQTT_C_LIBS = 
endif

ifeq ($(HAS_MQTT_CPP),1)
    MQTT_CPP_LIBS = -lpaho-mqttpp3
    INCLUDES += -I/usr/local/include
    $(info âœ… MQTT C++ found via linking test)
else
    $(warning âš ï¸  paho-mqttpp3 not found via linking test)
    MQTT_CPP_LIBS = 
endif

# PostgreSQL ë¼ì´ë¸ŒëŸ¬ë¦¬
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpqxx >/dev/null 2>&1; echo $$?),0)
    $(warning âš ï¸  libpqxx not found - PostgreSQL features will be disabled)
    PGSQL_LIBS = 
else
    PGSQL_LIBS = -lpqxx -lpq
    $(info âœ… PostgreSQL found via linking test)
endif

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_BACNET_STACK), 1)
    BACNET_LIBS = -lbacnet -lm
    BACNET_INCLUDES = -I/usr/local/include/bacnet
    INCLUDES += $(BACNET_INCLUDES)
    CXXFLAGS += -DHAS_BACNET_STACK=1
    $(info âœ… BACnet found: /usr/local/lib/libbacnet.a)
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
    BACNET_LIBS = 
    $(warning âš ï¸  BACnet library not found)
endif

# Redis ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_HIREDIS),1)
    REDIS_LIBS = -lhiredis -lhiredis_ssl
    CXXFLAGS += -DHAS_HIREDIS
    $(info âœ… Redis found via header test)
else
    $(warning âš ï¸  hiredis not found - Redis functionality will be limited)
    REDIS_LIBS = 
endif

# JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ í”Œë˜ê·¸
ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
    $(info âœ… nlohmann/json found)
endif

# ğŸ”§ ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
BASIC_LIBS = -lpthread -lsqlite3
OPTIONAL_LIBS = $(MODBUS_LIBS) $(MYSQL_LIBS) $(PGSQL_LIBS) $(MQTT_C_LIBS) $(MQTT_CPP_LIBS) $(BACNET_LIBS) $(REDIS_LIBS)
LIBS = $(BASIC_LIBS) $(OPTIONAL_LIBS)

# í…ŒìŠ¤íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
TEST_LIBS = -lgtest -lgtest_main -pthread

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# =============================================================================
# ì†ŒìŠ¤ íŒŒì¼ ê·¸ë£¹ ì •ì˜
# =============================================================================

# ê¸°ë³¸ í•„ìˆ˜ ì†ŒìŠ¤ë“¤
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

# Database ì†ŒìŠ¤ë“¤
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# Client ì†ŒìŠ¤ë“¤
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Workers ì†ŒìŠ¤ë“¤
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Components/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp)

# ğŸ”§ Drivers ì†ŒìŠ¤ë“¤ (ë¼ì´ë¸ŒëŸ¬ë¦¬ë³„ ì¡°ê±´ë¶€ í¬í•¨)
DRIVERS_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)

# Modbus ë“œë¼ì´ë²„
ifneq ($(MODBUS_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif

# ğŸ”¥ MQTT ë“œë¼ì´ë²„ (ì´ì œ ì •ìƒ í¬í•¨ë¨)
ifeq ($(HAS_MQTT_CPP),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
    $(info âœ… Including MQTT driver sources)
endif

# BACnet ë“œë¼ì´ë²„
ifeq ($(HAS_BACNET_STACK),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif

# Pipeline ì†ŒìŠ¤ë“¤
PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)

# ë‹¨ê³„ë³„ ì†ŒìŠ¤ ê·¸ë£¹
STEP1_SOURCES = $(UTILS_SOURCES) $(CONFIG_SOURCES)
STEP2_SOURCES = $(STEP1_SOURCES) $(DATABASE_SOURCES) $(CLIENT_SOURCES)
STEP3_SOURCES = $(STEP2_SOURCES) $(WORKERS_SOURCES) $(DRIVERS_SOURCES) $(PIPELINE_SOURCES)

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤
# =============================================================================

.DEFAULT_GOAL := help

# ë””ë ‰í† ë¦¬ ìƒì„±
$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

directories: $(BIN_DIR)

clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning test build files...$(NC)"
	rm -rf $(BIN_DIR)
	@echo -e "$(GREEN)âœ… Clean completed$(NC)"

# ğŸ”§ ê°œì„ ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
check-deps:
	@echo -e "$(BLUE)ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì²´í¬$(NC)"
	@echo -e "$(YELLOW)========================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸ“¦ ê°ì§€ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… $(MODBUS_LIBS),âŒ not found)"
	@echo "  MySQL: $(if $(MYSQL_LIBS),âœ… found,âŒ not found)"
	@echo "  PostgreSQL: $(if $(PGSQL_LIBS),âœ… $(PGSQL_LIBS),âŒ not found)"
	@echo "  MQTT C: $(if $(MQTT_C_LIBS),âœ… $(MQTT_C_LIBS),âŒ not found)"
	@echo "  MQTT C++: $(if $(MQTT_CPP_LIBS),âœ… $(MQTT_CPP_LIBS),âŒ not found)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… $(BACNET_LIBS),âŒ not found)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ… $(REDIS_LIBS),âŒ not found)"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ ì»´íŒŒì¼ ì„¤ì •:$(NC)"
	@echo "  LIBS: $(LIBS)"
	@echo "  INCLUDES: $(INCLUDES)"
	@echo ""
	@echo -e "$(BLUE)ğŸ“Š ì†ŒìŠ¤ íŒŒì¼ ê°œìˆ˜:$(NC)"
	@echo "  UTILS: $(words $(UTILS_SOURCES))"
	@echo "  DATABASE: $(words $(DATABASE_SOURCES))"
	@echo "  WORKERS: $(words $(WORKERS_SOURCES))"
	@echo "  DRIVERS: $(words $(DRIVERS_SOURCES))"
	@echo "  TOTAL STEP3: $(words $(STEP3_SOURCES))"

# ğŸ”¥ ì´ì œ MQTT í¬í•¨í•œ ì „ì²´ ë¹Œë“œ
debug-step3: $(BIN_DIR)
	@echo -e "$(BLUE)ğŸ” Step3 ì „ì²´ ê¸°ëŠ¥ ì»´íŒŒì¼ (MQTT í¬í•¨)$(NC)"
	@echo -e "$(YELLOW)================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸ“‹ í¬í•¨ëœ ê¸°ëŠ¥ë“¤:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… í¬í•¨,âŒ ì œì™¸)"
	@echo "  MySQL: $(if $(MYSQL_LIBS),âœ… í¬í•¨,âŒ ì œì™¸)"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ… í¬í•¨,âŒ ì œì™¸)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… í¬í•¨,âŒ ì œì™¸)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ… í¬í•¨,âŒ ì œì™¸)"
	@echo ""
	@if [ ! -f "test_step3_workers.cpp" ]; then \
		echo -e "$(RED)âŒ test_step3_workers.cpp íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(BLUE)ğŸ”¨ ì „ì²´ ê¸°ëŠ¥ ì»´íŒŒì¼ ì‹œì‘...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) \
		test_step3_workers.cpp \
		$(STEP3_SOURCES) \
		$(TEST_LIBS) $(LIBS) -o $(BIN_DIR)/test_step3 || \
	(echo -e "$(RED)âŒ ì»´íŒŒì¼ ì‹¤íŒ¨!$(NC)" && exit 1)
	@echo -e "$(GREEN)âœ… Step3 ì „ì²´ ê¸°ëŠ¥ ì»´íŒŒì¼ ì„±ê³µ! (MQTT í¬í•¨)$(NC)"

# ë„ì›€ë§
help:
	@echo -e "$(BLUE)ğŸ”§ PulseOne Collector í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ$(NC)"
	@echo -e "$(YELLOW)=======================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ ì´ì œ MQTTê°€ ì •ìƒ ê°ì§€ë©ë‹ˆë‹¤!$(NC)"
	@echo ""
	@echo -e "$(GREEN)ì¶”ì²œ ëª…ë ¹ì–´:$(NC)"
	@echo "  make check-deps       - ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°ì§€ ìƒíƒœ í™•ì¸"
	@echo "  make clean && make debug-step3  - ì „ì²´ ê¸°ëŠ¥ ì»´íŒŒì¼ (MQTT í¬í•¨)"
	@echo ""
	@echo -e "$(GREEN)ì§„ë‹¨ ëª…ë ¹ì–´:$(NC)"
	@echo "  make diagnose         - í™˜ê²½ ì§„ë‹¨"

# ì§„ë‹¨
diagnose:
	@echo -e "$(BLUE)ğŸ¥ ì‹œìŠ¤í…œ ì§„ë‹¨$(NC)"
	@echo -e "$(YELLOW)===============$(NC)"
	@echo ""
	@echo -e "$(BLUE)ì§ì ‘ ë§í‚¹ í…ŒìŠ¤íŠ¸:$(NC)"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "  âœ… MQTT C ë§í¬ ì„±ê³µ" || echo "  âŒ MQTT C ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "  âœ… MQTT C++ ë§í¬ ì„±ê³µ" || echo "  âŒ MQTT C++ ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1 && echo "  âœ… Modbus ë§í¬ ì„±ê³µ" || echo "  âŒ Modbus ë§í¬ ì‹¤íŒ¨"
	@echo "int main(){return 0;}" | $(CXX) -x c++ - -lhiredis >/dev/null 2>&1 && echo "  âœ… Redis ë§í¬ ì„±ê³µ" || echo "  âŒ Redis ë§í¬ ì‹¤íŒ¨"

.PHONY: all clean help diagnose check-deps debug-step3 directories