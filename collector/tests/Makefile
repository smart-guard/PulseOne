# =============================================================================
# collector/tests/Makefile - WorkerManager + API í†µí•© ì™„ì„±ë³¸
# WorkerManager, DeviceApiCallbacks í¬í•¨í•œ ì™„ì „í•œ ì»´íŒŒì¼ ì§€ì›
# =============================================================================

# ì„±ëŠ¥ ìµœì í™” ì„¤ì •
NPROC := $(shell nproc 2>/dev/null || echo 4)
MAKEFLAGS += -j$(NPROC) --output-sync=target

# í”Œë«í¼ ê°ì§€
UNAME := $(shell uname -s)
ifeq ($(UNAME),Linux)
    PLATFORM := Linux
    IS_WINDOWS := 0
    IS_LINUX := 1
else ifeq ($(OS),Windows_NT)
    PLATFORM := Windows
    IS_WINDOWS := 1
    IS_LINUX := 0
else
    PLATFORM := $(UNAME)
    IS_WINDOWS := 0
    IS_LINUX := 0
endif

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬ (ìºì‹œëœ ê²°ê³¼ ì‚¬ìš©)
HAS_NLOHMANN_JSON := $(shell echo '\#include <nlohmann/json.hpp>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_HIREDIS := $(shell echo '\#include <hiredis/hiredis.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_C := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqtt3c >/dev/null 2>&1 && echo "1" || echo "0")
HAS_MQTT_CPP := $(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpaho-mqttpp3 >/dev/null 2>&1 && echo "1" || echo "0")
HAS_BACNET_STACK := $(shell [ -f "/usr/local/lib/libbacnet.a" ] && echo "1" || echo "0")
HAS_QUICKJS := $(shell pkg-config --exists quickjs && echo "1" || echo "0")
HAS_HTTPLIB := $(shell echo '\#include <httplib.h>' | $(CXX) -E -x c++ - >/dev/null 2>&1 && echo "1" || echo "0")

# ì»´íŒŒì¼ëŸ¬ ì„¤ì • (í”Œë«í¼ë³„)
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -g -DPULSEONE_DEBUG_MODE \
           -O1 -fno-omit-frame-pointer \
           -Wno-unused-but-set-variable -Wno-unused-variable \
           -Wno-unused-parameter \
           -fdiagnostics-color=always

# í”Œë«í¼ë³„ ì»´íŒŒì¼ í”Œë˜ê·¸ ì¶”ê°€
ifeq ($(IS_WINDOWS),1)
    CXXFLAGS += -DPULSEONE_WINDOWS=1 -DPULSEONE_LINUX=0 \
                -D_WIN32_WINNT=0x0A00 -DWIN32_LEAN_AND_MEAN -DNOMINMAX
    PLATFORM_LIBS = -lws2_32 -liphlpapi -lkernel32 -luser32
else
    CXXFLAGS += -DPULSEONE_WINDOWS=0 -DPULSEONE_LINUX=1
    PLATFORM_LIBS = 
endif

# ì¦ë¶„ ì»´íŒŒì¼ìš© ë””ë ‰í† ë¦¬
OBJ_DIR = ./obj
BIN_DIR = ./bin
DATA_DIR = ./data

# ê²½ë¡œ ì„¤ì •
PARENT_DIR = ..
INCLUDE_DIR = $(PARENT_DIR)/include
SRC_DIR = $(PARENT_DIR)/src

# Include ê²½ë¡œ (WorkerManager ì¶”ê°€)
INCLUDES = -I$(INCLUDE_DIR) \
           -I$(INCLUDE_DIR)/Platform \
           -I$(INCLUDE_DIR)/Api \
           -I$(INCLUDE_DIR)/Alarm \
           -I$(INCLUDE_DIR)/VirtualPoint \
           -I$(INCLUDE_DIR)/Network \
           -I$(INCLUDE_DIR)/Workers \
           -I$(INCLUDE_DIR)/Workers/Base \
           -I$(INCLUDE_DIR)/Workers/Protocol \
           -I$(INCLUDE_DIR)/Workers/Components \
           -I$(INCLUDE_DIR)/Database \
           -I$(INCLUDE_DIR)/Database/Entities \
           -I$(INCLUDE_DIR)/Database/Repositories \
           -I$(INCLUDE_DIR)/Common \
           -I$(INCLUDE_DIR)/Utils \
           -I$(INCLUDE_DIR)/Config \
           -I$(INCLUDE_DIR)/Drivers \
           -I$(INCLUDE_DIR)/Drivers/Common \
           -I$(INCLUDE_DIR)/Pipeline \
           -I$(INCLUDE_DIR)/Client

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lmodbus >/dev/null 2>&1; echo $$?),0)
    MODBUS_LIBS = 
    MODBUS_INCLUDES = 
else
    MODBUS_LIBS = -lmodbus
    MODBUS_INCLUDES = $(shell pkg-config --cflags libmodbus 2>/dev/null || echo "")
    INCLUDES += $(MODBUS_INCLUDES)
endif

MYSQL_CONFIG := $(shell which mysql_config 2>/dev/null)
ifneq ($(MYSQL_CONFIG),)
    MYSQL_LIBS = $(shell mysql_config --libs)
    MYSQL_INCLUDES = $(shell mysql_config --include)
    INCLUDES += $(MYSQL_INCLUDES)
else
    MYSQL_LIBS = 
    CXXFLAGS += -DDISABLE_MYSQL_FEATURES
endif

ifeq ($(HAS_MQTT_C),1)
    MQTT_C_LIBS = -lpaho-mqtt3c
else
    MQTT_C_LIBS = 
endif

ifeq ($(HAS_MQTT_CPP),1)
    MQTT_CPP_LIBS = -lpaho-mqttpp3
    INCLUDES += -I/usr/local/include
else
    MQTT_CPP_LIBS = 
endif

ifneq ($(shell echo "int main(){return 0;}" | $(CXX) -x c++ - -lpqxx >/dev/null 2>&1; echo $$?),0)
    PGSQL_LIBS = 
else
    PGSQL_LIBS = -lpqxx -lpq
endif

ifeq ($(HAS_BACNET_STACK), 1)
    BACNET_LIBS = -lbacnet -lm
    BACNET_INCLUDES = -I/usr/local/include/bacnet
    INCLUDES += $(BACNET_INCLUDES)
    CXXFLAGS += -DHAS_BACNET_STACK=1
else
    CXXFLAGS += -DHAS_BACNET_STACK=0
    BACNET_LIBS = 
endif

ifeq ($(HAS_HIREDIS),1)
    REDIS_LIBS = -lhiredis -lhiredis_ssl
    CXXFLAGS += -DHAS_HIREDIS
else
    REDIS_LIBS = 
endif

ifeq ($(HAS_NLOHMANN_JSON),1)
    CXXFLAGS += -DHAS_NLOHMANN_JSON
endif

# QuickJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_QUICKJS),1)
    QUICKJS_LIBS = $(shell pkg-config --libs quickjs 2>/dev/null || echo "-lquickjs")
    QUICKJS_INCLUDES = $(shell pkg-config --cflags quickjs 2>/dev/null || echo "-I/usr/local/include")
    INCLUDES += $(QUICKJS_INCLUDES)
    CXXFLAGS += -DHAS_QUICKJS=1
else
    QUICKJS_LIBS = 
    CXXFLAGS += -DHAS_QUICKJS=0
    $(warning QuickJS not found - Script alarms will be disabled)
endif

# HTTP ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
ifeq ($(HAS_HTTPLIB),1)
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=1
    $(info âœ… Including HTTP support - REST API enabled)
else
    HTTP_LIBS = 
    CXXFLAGS += -DHAVE_HTTPLIB=0
    $(warning âš ï¸  httplib not available - REST API disabled)
endif

# ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì • (í”Œë«í¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
BASIC_LIBS = -lpthread -lsqlite3 $(QUICKJS_LIBS) $(HTTP_LIBS) -lm -ldl $(PLATFORM_LIBS)
OPTIONAL_LIBS = $(MODBUS_LIBS) $(MYSQL_LIBS) $(PGSQL_LIBS) $(MQTT_C_LIBS) $(MQTT_CPP_LIBS) $(BACNET_LIBS) $(REDIS_LIBS)
LIBS = $(BASIC_LIBS) $(OPTIONAL_LIBS)
TEST_LIBS = -lgtest -lgtest_main -pthread

# =============================================================================
# ì†ŒìŠ¤ íŒŒì¼ ìˆ˜ì§‘ - WorkerManagerì™€ API ì™„ì „ í¬í•¨
# =============================================================================

# Core ì†ŒìŠ¤ë“¤
CORE_SOURCES := $(wildcard $(SRC_DIR)/Core/*.cpp)

# Utils ì†ŒìŠ¤ë“¤
UTILS_SOURCES := $(wildcard $(SRC_DIR)/Utils/*.cpp)

# Config ì†ŒìŠ¤ë“¤
CONFIG_SOURCES := $(wildcard $(SRC_DIR)/Config/*.cpp)

# Database ì†ŒìŠ¤ë“¤
DATABASE_SOURCES := $(wildcard $(SRC_DIR)/Database/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Entities/*.cpp) \
                   $(wildcard $(SRC_DIR)/Database/Repositories/*.cpp)

# Client ì†ŒìŠ¤ë“¤
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/Client/*.cpp)

# Workers ì†ŒìŠ¤ë“¤ - WorkerManager í¬í•¨!
WORKERS_SOURCES := $(wildcard $(SRC_DIR)/Workers/Base/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Protocol/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/Components/*.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerFactory.cpp) \
                  $(wildcard $(SRC_DIR)/Workers/WorkerManager.cpp)

# Network ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨)
ifeq ($(HAS_HTTPLIB),1)
    NETWORK_SOURCES := $(wildcard $(SRC_DIR)/Network/*.cpp)
    $(info âœ… Including Network sources: $(words $(NETWORK_SOURCES)) files)
else
    NETWORK_SOURCES :=
    $(warning âš ï¸  Network sources excluded - httplib not available)
endif

# API ì†ŒìŠ¤ë“¤ - DeviceApiCallbacks í¬í•¨! (ì¡°ê±´ë¶€ í¬í•¨)
ifeq ($(HAS_HTTPLIB),1)
    API_SOURCES := $(wildcard $(SRC_DIR)/Api/*.cpp)
    $(info âœ… Including API sources: $(words $(API_SOURCES)) files)
    $(info    - DeviceApiCallbacks.cpp included for REST API device control)
else
    API_SOURCES :=
    $(warning âš ï¸  API sources excluded - httplib not available)
endif

# Drivers ì†ŒìŠ¤ë“¤ (ì¡°ê±´ë¶€ í¬í•¨)
DRIVERS_SOURCES = $(wildcard $(SRC_DIR)/Drivers/Common/*.cpp)
ifneq ($(MODBUS_LIBS),)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Modbus/*.cpp)
endif
ifeq ($(HAS_MQTT_CPP),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Mqtt/*.cpp)
endif
ifeq ($(HAS_BACNET_STACK),1)
    DRIVERS_SOURCES += $(wildcard $(SRC_DIR)/Drivers/Bacnet/*.cpp)
endif

# Pipeline ì†ŒìŠ¤ë“¤
PIPELINE_SOURCES := $(wildcard $(SRC_DIR)/Pipeline/*.cpp)

# ì•ŒëŒ ë° ê°€ìƒí¬ì¸íŠ¸ ì†ŒìŠ¤ë“¤
ALARM_SOURCES := $(wildcard $(SRC_DIR)/Alarm/*.cpp)
VIRTUALPOINT_SOURCES := $(wildcard $(SRC_DIR)/VirtualPoint/*.cpp)

# Platform ì†ŒìŠ¤ë“¤
PLATFORM_SOURCES := $(wildcard $(SRC_DIR)/Platform/*.cpp)

# Plugin ì†ŒìŠ¤ë“¤
PLUGIN_SOURCES := $(wildcard $(SRC_DIR)/Plugin/*.cpp)

# ì „ì²´ ì†ŒìŠ¤ íŒŒì¼ (WorkerManager, API í¬í•¨)
ALL_SOURCES = $(CORE_SOURCES) $(UTILS_SOURCES) $(CONFIG_SOURCES) \
              $(DATABASE_SOURCES) $(CLIENT_SOURCES) $(WORKERS_SOURCES) \
              $(DRIVERS_SOURCES) $(PIPELINE_SOURCES) $(ALARM_SOURCES) \
              $(VIRTUALPOINT_SOURCES) $(NETWORK_SOURCES) $(API_SOURCES) \
              $(PLATFORM_SOURCES) $(PLUGIN_SOURCES)

# ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ìƒì„±
ALL_OBJECTS = $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(ALL_SOURCES))

# í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤ ì •ì˜
TEST_OBJECTS = $(OBJ_DIR)/test_step3_workers.o \
               $(OBJ_DIR)/test_step4_driver_data_validation.o \
               $(OBJ_DIR)/test_step5_complete_db_integration_validation.o \
               $(OBJ_DIR)/test_step6_enhanced_pipeline.o \
               $(OBJ_DIR)/test_network_api.o \
               $(OBJ_DIR)/test_platform_compat.o \
               $(OBJ_DIR)/test_workermanager.o

# ìƒ‰ìƒ ì •ì˜
GREEN = \033[0;32m
BLUE = \033[0;34m
YELLOW = \033[1;33m
RED = \033[0;31m
PURPLE = \033[0;35m
CYAN = \033[0;36m
MAGENTA = \033[0;95m
NC = \033[0m

# =============================================================================
# ì¦ë¶„ ì»´íŒŒì¼ íƒ€ê²Ÿë“¤ (WorkerManager, Api ë””ë ‰í† ë¦¬ ì¶”ê°€)
# =============================================================================

.DEFAULT_GOAL := help

# ë””ë ‰í† ë¦¬ ìƒì„± (WorkerManager, Api ë””ë ‰í† ë¦¬ ì¶”ê°€)
$(OBJ_DIR):
	@echo -e "$(BLUE)ğŸ—ï¸ Creating object directories for $(PLATFORM) (with WorkerManager + API)...$(NC)"
	@mkdir -p $(OBJ_DIR)
	@mkdir -p $(OBJ_DIR)/Core $(OBJ_DIR)/Utils $(OBJ_DIR)/Config 
	@mkdir -p $(OBJ_DIR)/Database/Entities $(OBJ_DIR)/Database/Repositories
	@mkdir -p $(OBJ_DIR)/Client $(OBJ_DIR)/Workers/Base $(OBJ_DIR)/Workers/Protocol $(OBJ_DIR)/Workers/Components
	@mkdir -p $(OBJ_DIR)/Drivers/Common $(OBJ_DIR)/Drivers/Modbus $(OBJ_DIR)/Drivers/Mqtt $(OBJ_DIR)/Drivers/Bacnet
	@mkdir -p $(OBJ_DIR)/Pipeline $(OBJ_DIR)/Alarm $(OBJ_DIR)/VirtualPoint $(OBJ_DIR)/Plugin
	@mkdir -p $(OBJ_DIR)/Network $(OBJ_DIR)/Api $(OBJ_DIR)/Platform
	@echo -e "$(GREEN)âœ… Directories created for $(PLATFORM) platform (WorkerManager + API support)$(NC)"

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# ê°œë³„ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ ì»´íŒŒì¼
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for $<$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)âš™ï¸  Compiling $< [$(PLATFORM)]$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# WorkerManager í…ŒìŠ¤íŠ¸ ì»´íŒŒì¼
$(OBJ_DIR)/test_workermanager.o: test_workermanager.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_workermanager.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(MAGENTA)ğŸ‘· Compiling WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# í”Œë«í¼ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
$(OBJ_DIR)/test_platform_compat.o: test_platform_compat.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_platform_compat.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(MAGENTA)ğŸ›¡ï¸  Compiling Platform Compatibility Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ê¸°ì¡´ í…ŒìŠ¤íŠ¸ íŒŒì¼ë“¤ ì»´íŒŒì¼
$(OBJ_DIR)/test_step3_workers.o: test_step3_workers.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_step3_workers.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)ğŸ‘· Compiling test_step3_workers [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step4_driver_data_validation.o: test_step4_driver_data_validation.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_step4_driver_data_validation.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)ğŸ”Œ Compiling test_step4_driver_data_validation [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step5_complete_db_integration_validation.o: test_step5_complete_db_integration_validation.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_step5_complete_db_integration_validation.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)ğŸ—„ï¸  Compiling test_step5_complete_db_integration_validation [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/test_step6_enhanced_pipeline.o: test_step6_enhanced_pipeline.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_step6_enhanced_pipeline.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)âš¡ Compiling test_step6_enhanced_pipeline [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Network API í…ŒìŠ¤íŠ¸
$(OBJ_DIR)/test_network_api.o: test_network_api.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Generating dependencies for test_network_api.cpp$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -MM -MT $@ $< > $(patsubst %.o,%.d,$@)
	@echo -e "$(YELLOW)ğŸŒ Compiling test_network_api [$(PLATFORM)]...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Api íŒŒì¼ë“¤ ì»´íŒŒì¼ ë£° ìˆ˜ì •
$(BUILD_DIR)/Api/%.o: $(SRC_DIR)/Api/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Api
	@echo -e "$(GREEN)ğŸ”— Compiling Api: $<$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ì˜ì¡´ì„± íŒŒì¼ ìƒì„± ë£°ë„ ìˆ˜ì •
$(BUILD_DIR)/Api/%.d: $(SRC_DIR)/Api/%.cpp | $(BUILD_DIR)
	@mkdir -p $(BUILD_DIR)/Api
	@echo -e "ğŸ”¨ Generating dependencies for $<"
	@$(CXX) -MM $(CXXFLAGS) $(INCLUDES) $< > $@.tmp
	@sed 's,\($*\)\.o[ :]*,$(BUILD_DIR)/Api/\1.o $@ : ,g' < $@.tmp > $@
	@rm -f $@.tmp
# =============================================================================
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼ë“¤ (WorkerManager í…ŒìŠ¤íŠ¸ ì¶”ê°€)
# =============================================================================

# WorkerManager í…ŒìŠ¤íŠ¸
$(BIN_DIR)/test_workermanager: $(ALL_OBJECTS) $(OBJ_DIR)/test_workermanager.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking WorkerManager Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_workermanager.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… WorkerManager Test build completed for $(PLATFORM)!$(NC)"

# í”Œë«í¼ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
$(BIN_DIR)/test_platform: $(ALL_OBJECTS) $(OBJ_DIR)/test_platform_compat.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking Platform Compatibility Test [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_platform_compat.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… Platform Compatibility Test build completed for $(PLATFORM)!$(NC)"

$(BIN_DIR)/test_step3: $(ALL_OBJECTS) $(OBJ_DIR)/test_step3_workers.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step3 [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step3_workers.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step3 build completed for $(PLATFORM)!$(NC)"

$(BIN_DIR)/test_step4: $(ALL_OBJECTS) $(OBJ_DIR)/test_step4_driver_data_validation.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step4 (Driver Data Validation) [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step4_driver_data_validation.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step4 (Driver Data Validation) build completed for $(PLATFORM)!$(NC)"

$(BIN_DIR)/test_step5: $(ALL_OBJECTS) $(OBJ_DIR)/test_step5_complete_db_integration_validation.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step5 [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step5_complete_db_integration_validation.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step5 build completed for $(PLATFORM)!$(NC)"

$(BIN_DIR)/test_step6: $(ALL_OBJECTS) $(OBJ_DIR)/test_step6_enhanced_pipeline.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step6 (Enhanced Alarm+VirtualPoint Pipeline) [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step6_enhanced_pipeline.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step6 (Enhanced Alarm+VirtualPoint Pipeline) build completed for $(PLATFORM)!$(NC)"

# Network API í…ŒìŠ¤íŠ¸
$(BIN_DIR)/test_network: $(ALL_OBJECTS) $(OBJ_DIR)/test_network_api.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_network (REST API Server) [$(PLATFORM)]...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_network_api.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_network (REST API Server) build completed for $(PLATFORM)!$(NC)"

# =============================================================================
# ë©”ì¸ íƒ€ê²Ÿë“¤ (WorkerManager í…ŒìŠ¤íŠ¸ ì¶”ê°€)
# =============================================================================

# WorkerManager í…ŒìŠ¤íŠ¸ ë¹Œë“œ/ì‹¤í–‰
workermanager-build: $(BIN_DIR)/test_workermanager

workermanager-test: workermanager-build
	@echo -e "$(MAGENTA)ğŸ‘· Running WorkerManager Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Testing WorkerManager singleton and worker lifecycle management$(NC)"
	@./$(BIN_DIR)/test_workermanager

# í”Œë«í¼ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
platform-build: $(BIN_DIR)/test_platform

platform-test: platform-build
	@echo -e "$(MAGENTA)ğŸ›¡ï¸  Running Platform Compatibility Test [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)Testing cross-platform functionality$(NC)"
	@./$(BIN_DIR)/test_platform

# ê°œë³„ í…ŒìŠ¤íŠ¸ ë¹Œë“œ
step3-build: $(BIN_DIR)/test_step3

step4-build: $(BIN_DIR)/test_step4

step5-build: $(BIN_DIR)/test_step5

step6-build: $(BIN_DIR)/test_step6

network-build: $(BIN_DIR)/test_network

# ê°œë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
step3-test: step3-build
	@echo -e "$(PURPLE)ğŸš€ Running Step 3 (Workers) tests [$(PLATFORM)]...$(NC)"
	@./$(BIN_DIR)/test_step3

step4-test: step4-build
	@echo -e "$(PURPLE)ğŸš€ Running Step 4 (Driver Data Validation) tests [$(PLATFORM)]...$(NC)"
	@./$(BIN_DIR)/test_step4

step5-test: step5-build
	@echo -e "$(PURPLE)ğŸš€ Running Step 5 (Complete DB Integration) tests [$(PLATFORM)]...$(NC)"
	@./$(BIN_DIR)/test_step5

step6-test: step6-build
	@echo -e "$(PURPLE)ğŸš€ Running Step 6 (Enhanced Alarm+VirtualPoint Pipeline) tests [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)This test requires Redis server running$(NC)"
	@echo -e "$(CYAN)Test data should be present in DB$(NC)"
	@./$(BIN_DIR)/test_step6

network-test: network-build
	@echo -e "$(PURPLE)ğŸš€ Running Network API tests [$(PLATFORM)]...$(NC)"
	@echo -e "$(CYAN)This test starts REST API server on port 8080$(NC)"
	@./$(BIN_DIR)/test_network

# ëª¨ë“  í…ŒìŠ¤íŠ¸ ë¹Œë“œ (WorkerManager í…ŒìŠ¤íŠ¸ í¬í•¨)
all-tests-build: $(BIN_DIR)/test_workermanager $(BIN_DIR)/test_platform $(BIN_DIR)/test_step3 $(BIN_DIR)/test_step4 $(BIN_DIR)/test_step5 $(BIN_DIR)/test_step6 $(BIN_DIR)/test_network
	@echo -e "$(GREEN)âœ… All tests build completed for $(PLATFORM) (WorkerManager + Platform + Step 3-6 + Network)!$(NC)"

# ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (WorkerManager í…ŒìŠ¤íŠ¸ í¬í•¨)
all-tests-run: all-tests-build
	@echo -e "$(BLUE)ğŸš€ Running all tests in sequence on $(PLATFORM)...$(NC)"
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(MAGENTA)WorkerManager: Singleton and Lifecycle Test$(NC)"
	@./$(BIN_DIR)/test_workermanager
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(MAGENTA)Platform: Cross-Platform Compatibility Test$(NC)"
	@./$(BIN_DIR)/test_platform
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(PURPLE)Step 3: Workers Test$(NC)"
	@./$(BIN_DIR)/test_step3
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(PURPLE)Step 4: Driver Data Validation Test$(NC)"
	@./$(BIN_DIR)/test_step4
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(PURPLE)Step 5: Complete DB Integration Test$(NC)"
	@./$(BIN_DIR)/test_step5
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(PURPLE)Step 6: Enhanced Alarm+VirtualPoint Pipeline Test$(NC)"
	@./$(BIN_DIR)/test_step6
	@echo -e "$(YELLOW)============================================$(NC)"
	@echo -e "$(PURPLE)Network: REST API Server Test$(NC)"
	@./$(BIN_DIR)/test_network
	@echo -e "$(GREEN)ğŸ‰ All tests completed successfully on $(PLATFORM)!$(NC)"

# ì „ì²´ í´ë¦° ë¹Œë“œ
full-build: clean all-tests-build
	@echo -e "$(GREEN)âœ… Full build completed for $(PLATFORM)!$(NC)"

# ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (WorkerManager + í”Œë«í¼ í…ŒìŠ¤íŠ¸)
test: workermanager-test platform-test step3-test

# í´ë¦°
clean:
	@echo -e "$(YELLOW)ğŸ§¹ Cleaning $(PLATFORM) build files...$(NC)"
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo -e "$(GREEN)âœ… Clean completed for $(PLATFORM)$(NC)"

# ë¹Œë“œ ìƒíƒœ í™•ì¸ (WorkerManager ì •ë³´ í¬í•¨)
status:
	@echo -e "$(BLUE)ğŸ—ï¸ Build Status for $(PLATFORM) (with WorkerManager + API)$(NC)"
	@echo -e "$(YELLOW)===============================================$(NC)"
	@echo "Platform: $(PLATFORM)"
	@echo "Windows: $(IS_WINDOWS), Linux: $(IS_LINUX)"
	@echo "Object files: $(words $(wildcard $(OBJ_DIR)/**/*.o)) / $(words $(ALL_OBJECTS))"
	@echo "Source files: $(words $(ALL_SOURCES))"
	@echo "Workers sources: $(words $(WORKERS_SOURCES)) (includes WorkerManager)"
	@echo "API sources: $(words $(API_SOURCES)) (includes DeviceApiCallbacks)"
	@echo "Network sources: $(words $(NETWORK_SOURCES))"
	@echo "Platform sources: $(words $(PLATFORM_SOURCES))"
	@echo ""
	@echo "WorkerManager binary: $(if $(wildcard $(BIN_DIR)/test_workermanager),âœ… exists,âŒ missing)"
	@echo "Platform binary: $(if $(wildcard $(BIN_DIR)/test_platform),âœ… exists,âŒ missing)"
	@echo "Step 3 binary: $(if $(wildcard $(BIN_DIR)/test_step3),âœ… exists,âŒ missing)"
	@echo "Step 4 binary: $(if $(wildcard $(BIN_DIR)/test_step4),âœ… exists,âŒ missing)"
	@echo "Step 5 binary: $(if $(wildcard $(BIN_DIR)/test_step5),âœ… exists,âŒ missing)"
	@echo "Step 6 binary: $(if $(wildcard $(BIN_DIR)/test_step6),âœ… exists,âŒ missing)"
	@echo "Network binary: $(if $(wildcard $(BIN_DIR)/test_network),âœ… exists,âŒ missing)"
	@echo ""
	@echo -e "$(BLUE)ğŸ“š Libraries:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… available,âŒ unavailable)"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ… available,âŒ unavailable)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… available,âŒ unavailable)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ… available,âŒ unavailable)"
	@echo "  QuickJS: $(if $(QUICKJS_LIBS),âœ… available $(QUICKJS_LIBS),âŒ unavailable)"
	@echo "  HTTP: $(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ… available,âŒ unavailable)"
	@echo "  Platform libs: $(PLATFORM_LIBS)"

# ì¢…ì†ì„± í™•ì¸ (WorkerManager ì •ë³´ í¬í•¨)
check-deps:
	@echo -e "$(BLUE)ğŸ” Library dependency check for $(PLATFORM) (WorkerManager + API)$(NC)"
	@echo -e "$(YELLOW)===============================================$(NC)"
	@echo "Platform: $(PLATFORM) (Windows: $(IS_WINDOWS), Linux: $(IS_LINUX))"
	@echo "Total sources: $(words $(ALL_SOURCES))"
	@echo "Workers sources: $(words $(WORKERS_SOURCES)) (includes WorkerManager.cpp)"
	@echo "API sources: $(words $(API_SOURCES)) (includes DeviceApiCallbacks.cpp)"
	@echo "Network sources: $(words $(NETWORK_SOURCES))"
	@echo "Platform sources: $(words $(PLATFORM_SOURCES))"
	@echo "Platform libraries: $(PLATFORM_LIBS)"
	@echo ""
	@echo -e "$(CYAN)Critical for WorkerManager + API:$(NC)"
	@echo "  HTTP support: $(if $(filter -DHAVE_HTTPLIB=1,$(CXXFLAGS)),âœ… available - REST API enabled,âŒ unavailable - REST API disabled)"
	@echo "  JSON support: $(if $(filter -DHAS_NLOHMANN_JSON,$(CXXFLAGS)),âœ… available,âŒ unavailable)"
	@echo "  Threading: âœ… available (pthread)"
	@echo ""
	@echo -e "$(CYAN)Optional Libraries:$(NC)"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ… available $(MQTT_CPP_LIBS),âŒ unavailable)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ… available $(MODBUS_LIBS),âŒ unavailable)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ… available $(BACNET_LIBS),âŒ unavailable)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ… available $(REDIS_LIBS),âŒ unavailable)"
	@echo "  QuickJS: $(if $(QUICKJS_LIBS),âœ… available $(QUICKJS_LIBS),âŒ unavailable)"

# Windows ì¤€ë¹„ í™•ì¸
check-windows-ready:
	@echo -e "$(MAGENTA)ğŸªŸ Windows Compatibility Check$(NC)"
	@echo -e "$(YELLOW)==============================$(NC)"
	@echo "Platform detection: $(if $(filter Windows,$(PLATFORM)),âœ… Windows detected,â„¹ï¸  Running on $(PLATFORM))"
	@echo "PlatformCompat.h: $(if $(wildcard $(INCLUDE_DIR)/Platform/PlatformCompat.h),âœ… exists,âŒ missing - run 'mkdir -p ../include/Platform' and create file)"
	@echo "Platform includes: $(if $(findstring -I$(INCLUDE_DIR)/Platform,$(INCLUDES)),âœ… included,âŒ missing)"
	@echo "Windows flags: $(if $(filter -DPULSEONE_WINDOWS=1,$(CXXFLAGS)),âœ… Windows build ready,â„¹ï¸  Linux build)"
	@echo "Windows libs: $(if $(PLATFORM_LIBS),âœ… $(PLATFORM_LIBS),â„¹ï¸  Linux - no Windows libs needed)"
	@echo "WorkerManager ready: $(if $(wildcard $(SRC_DIR)/Workers/WorkerManager.cpp),âœ… WorkerManager.cpp exists,âŒ WorkerManager.cpp missing)"
	@echo "API ready: $(if $(wildcard $(SRC_DIR)/Api/DeviceApiCallbacks.cpp),âœ… DeviceApiCallbacks.cpp exists,âŒ DeviceApiCallbacks.cpp missing)"
	@echo ""
	@echo -e "$(GREEN)Status: $(if $(wildcard $(INCLUDE_DIR)/Platform/PlatformCompat.h),ğŸ¯ Ready for cross-platform compilation,âš ï¸  Need to create PlatformCompat.h)$(NC)"

# ë„ì›€ë§ (WorkerManager í…ŒìŠ¤íŠ¸ ì¶”ê°€)
help:
	@echo -e "$(BLUE)ğŸš€ PulseOne Build System with WorkerManager + API Support$(NC)"
	@echo -e "$(YELLOW)======================================================$(NC)"
	@echo ""
	@echo -e "$(MAGENTA)ğŸ¯ New Features:$(NC)"
	@echo "  Current platform: $(PLATFORM)"
	@echo "  make workermanager-test  - Test WorkerManager singleton and lifecycle"
	@echo "  make workermanager-build - Build WorkerManager test only"
	@echo ""
	@echo -e "$(MAGENTA)ğŸ›¡ï¸ Platform Support:$(NC)"
	@echo "  make platform-test    - Test cross-platform compatibility"
	@echo "  make platform-build   - Build platform compatibility test"
	@echo "  make check-windows-ready - Check Windows compilation readiness"
	@echo ""
	@echo -e "$(GREEN)Individual test commands:$(NC)"
	@echo "  make step3-test   - Step 3: Workers test"
	@echo "  make step4-test   - Step 4: Driver data validation test"
	@echo "  make step5-test   - Step 5: Complete DB integration test"
	@echo "  make step6-test   - Step 6: Enhanced alarm+virtualpoint pipeline test"
	@echo "  make network-test - Network: REST API server test"
	@echo ""
	@echo -e "$(GREEN)Quick build commands:$(NC)"
	@echo "  make step3-build  - Build Step 3 only"
	@echo "  make step4-build  - Build Step 4 only"
	@echo "  make step5-build  - Build Step 5 only"
	@echo "  make step6-build  - Build Step 6 only"
	@echo "  make network-build - Build Network test only"
	@echo "  make all-tests-build - Build all tests (includes WorkerManager)"
	@echo ""
	@echo -e "$(GREEN)Integrated execution:$(NC)"
	@echo "  make all-tests-run - Run all tests in sequence (includes WorkerManager + platform)"
	@echo "  make full-build   - Complete clean build"
	@echo "  make test         - Quick test (WorkerManager + platform + step3)"
	@echo "  make clean        - Delete all build files"
	@echo ""
	@echo -e "$(GREEN)Status check:$(NC)"
	@echo "  make status       - Check build status (shows WorkerManager + API info)"
	@echo "  make check-deps   - Check library availability"
	@echo ""
	@echo -e "$(CYAN)ğŸ’¡ Next steps for full functionality:$(NC)"
	@echo "  1. Ensure httplib is available for REST API support"
	@echo "  2. Run 'make workermanager-test' to verify WorkerManager functionality"
	@echo "  3. Run 'make network-test' to test REST API with WorkerManager integration"
	@echo "  4. Create WorkerManager.h and WorkerManager.cpp if missing"

# ìë™ ì¢…ì†ì„± ìƒì„±
-include $(ALL_OBJECTS:.o=.d) $(TEST_OBJECTS:.o=.d)

.PHONY: full-build test clean status check-deps help \
        step3-build step3-test step4-build step4-test step5-build step5-test \
        step6-build step6-test network-build network-test all-tests-build all-tests-run \
        platform-build platform-test check-windows-ready workermanager-build workermanager-test