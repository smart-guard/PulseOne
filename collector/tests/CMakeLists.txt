# ============================================================================
# collector/tests/CMakeLists.txt
# MQTT ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì„¤ì •
# ============================================================================

cmake_minimum_required(VERSION 3.16)
project(PulseOneTests)

# C++ í‘œì¤€ ì„¤ì •
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ì»´íŒŒì¼ëŸ¬ ì˜µì…˜
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -g")

# Google Test ì°¾ê¸°
find_package(PkgConfig REQUIRED)
find_package(GTest REQUIRED)
find_package(GMock REQUIRED)

# í¬í•¨ ë””ë ‰í† ë¦¬ ì„¤ì •
include_directories(
    ${CMAKE_SOURCE_DIR}/../include
    ${CMAKE_SOURCE_DIR}/../src
    ${GTEST_INCLUDE_DIRS}
    ${GMOCK_INCLUDE_DIRS}
)

# MQTT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°
find_library(PAHO_MQTT_CPP_LIB paho-mqttpp3)
find_library(PAHO_MQTT_C_LIB paho-mqtt3c)

# PostgreSQL ë¼ì´ë¸ŒëŸ¬ë¦¬
find_package(PkgConfig REQUIRED)
pkg_check_modules(LIBPQ REQUIRED libpq)

# Redis ë¼ì´ë¸ŒëŸ¬ë¦¬
pkg_check_modules(HIREDIS REQUIRED hiredis)

# ì†ŒìŠ¤ íŒŒì¼ë“¤
set(MQTT_DRIVER_SOURCES
    ${CMAKE_SOURCE_DIR}/../src/Drivers/Mqtt/MqttDriver.cpp
    ${CMAKE_SOURCE_DIR}/../src/Drivers/Common/DriverLogger.cpp
    ${CMAKE_SOURCE_DIR}/../src/Config/ConfigManager.cpp
    ${CMAKE_SOURCE_DIR}/../src/Utils/LogManager.cpp
)

set(TEST_SOURCES
    Drivers/Mqtt/MqttDriverTest.cpp
)

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼ ìƒì„±
add_executable(mqtt_driver_tests
    ${TEST_SOURCES}
    ${MQTT_DRIVER_SOURCES}
)

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬
target_link_libraries(mqtt_driver_tests
    ${GTEST_LIBRARIES}
    ${GMOCK_LIBRARIES}
    ${PAHO_MQTT_CPP_LIB}
    ${PAHO_MQTT_C_LIB}
    ${LIBPQ_LIBRARIES}
    ${HIREDIS_LIBRARIES}
    pthread
)

# ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸ ì¶”ê°€
target_compile_options(mqtt_driver_tests PRIVATE
    ${LIBPQ_CFLAGS_OTHER}
    ${HIREDIS_CFLAGS_OTHER}
)

# í…ŒìŠ¤íŠ¸ ë“±ë¡
enable_testing()
add_test(NAME MqttDriverTests COMMAND mqtt_driver_tests)

# ============================================================================
# collector/tests/Drivers/Mqtt/CMakeLists.txt
# MQTT ë“œë¼ì´ë²„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°œë³„ ì„¤ì •
# ============================================================================

# MQTT ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ë§Œ ë³„ë„ë¡œ ë¹Œë“œí•˜ëŠ” ê²½ìš°
add_executable(mqtt_tests_only
    MqttDriverTest.cpp
    ${CMAKE_SOURCE_DIR}/../../src/Drivers/Mqtt/MqttDriver.cpp
)

target_link_libraries(mqtt_tests_only
    ${GTEST_LIBRARIES}
    ${GMOCK_LIBRARIES}
    ${PAHO_MQTT_CPP_LIB}
    ${PAHO_MQTT_C_LIB}
    pthread
)

# ============================================================================
# collector/tests/build_and_run.sh
# í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# ============================================================================

#!/bin/bash

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
set -e

echo "ğŸ”§ PulseOne MQTT Driver Tests"
echo "==============================="

# ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p build
cd build

# CMake ì„¤ì •
echo "ğŸ“‹ Configuring CMake..."
cmake ..

# ë¹Œë“œ
echo "ğŸ”¨ Building tests..."
make -j$(nproc)

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "ğŸ§ª Running tests..."
./mqtt_driver_tests --gtest_output=xml:mqtt_test_results.xml

# í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¶œë ¥
echo "ğŸ“Š Test results:"
if [ -f mqtt_test_results.xml ]; then
    echo "âœ… Test results saved to mqtt_test_results.xml"
else
    echo "âŒ Test results file not found"
fi

echo "ğŸ‰ Tests completed!"

# ============================================================================
# collector/Makefileì— ì¶”ê°€í•  í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ
# ============================================================================

# ê¸°ì¡´ Makefileì— ì¶”ê°€í•  ë‚´ìš©:

# Google Test ì„¤ì •
GTEST_LIBS = -lgtest -lgtest_main -lgmock -lgmock_main
TEST_DIR = tests
TEST_BUILD_DIR = $(BUILD_DIR)/tests

# í…ŒìŠ¤íŠ¸ ì†ŒìŠ¤ íŒŒì¼ë“¤
TEST_SOURCES = $(shell find $(TEST_DIR) -name "*.cpp")
TEST_OBJECTS = $(TEST_SOURCES:$(TEST_DIR)/%.cpp=$(TEST_BUILD_DIR)/%.o)

# í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ
.PHONY: test test-mqtt test-clean test-install

# ëª¨ë“  í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë° ì‹¤í–‰
test: test-mqtt
	@echo -e "$(GREEN)âœ… All tests completed$(NC)"

# MQTT ë“œë¼ì´ë²„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
test-mqtt: $(BIN_DIR)/mqtt_tests
	@echo -e "$(BLUE)ğŸ§ª Running MQTT driver tests...$(NC)"
	@$(BIN_DIR)/mqtt_tests

# MQTT í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼ ìƒì„±
$(BIN_DIR)/mqtt_tests: $(TEST_BUILD_DIR)/Drivers/Mqtt/MqttDriverTest.o $(filter-out $(BUILD_DIR)/main.o, $(OBJECTS))
	@echo -e "$(BLUE)ğŸ”— Linking MQTT tests...$(NC)"
	@mkdir -p $(BIN_DIR)
	@$(CXX) $(CXXFLAGS) $^ -o $@ $(LIBS) $(GTEST_LIBS)

# í…ŒìŠ¤íŠ¸ ê°ì²´ íŒŒì¼ ìƒì„±
$(TEST_BUILD_DIR)/%.o: $(TEST_DIR)/%.cpp
	@echo -e "$(YELLOW)ğŸ“ Compiling test: $<$(NC)"
	@mkdir -p $(dir $@)
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Google Test ì„¤ì¹˜ (Ubuntu/Debian)
test-install:
	@echo -e "$(BLUE)ğŸ“¦ Installing Google Test...$(NC)"
	@sudo apt-get update
	@sudo apt-get install -y libgtest-dev libgmock-dev
	@echo -e "$(GREEN)âœ… Google Test installed$(NC)"

# í…ŒìŠ¤íŠ¸ ì •ë¦¬
test-clean:
	@echo -e "$(BLUE)ğŸ§¹ Cleaning test files...$(NC)"
	@rm -rf $(TEST_BUILD_DIR)
	@rm -f $(BIN_DIR)/mqtt_tests
	@echo -e "$(GREEN)âœ… Test files cleaned$(NC)"

# ============================================================================
# .github/workflows/tests.yml
# GitHub Actions CI/CD ì„¤ì •
# ============================================================================

name: Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mosquitto:
        image: eclipse-mosquitto:latest
        ports:
          - 1883:1883
        options: >-
          --health-cmd "mosquitto_sub -t '$SYS/broker/uptime' -C 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgtest-dev \
          libgmock-dev \
          libpaho-mqtt-dev \
          libpq-dev \
          libhiredis-dev \
          libnlohmann-json3-dev
    
    - name: Build tests
      run: |
        cd collector/tests
        mkdir -p build && cd build
        cmake ..
        make -j$(nproc)
    
    - name: Run tests
      run: |
        cd collector/tests/build
        ./mqtt_driver_tests --gtest_output=xml:test_results.xml
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: collector/tests/build/test_results.xml