# =============================================================================
# ğŸ”¥ ê¸°ì¡´ Makefileì— ì¶”ê°€í•  íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì„¹ì…˜
# ê¸°ì¡´ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ì´ ë‚´ìš©ì„ ë§¨ ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”
# =============================================================================

# ğŸš€ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€ (ê¸°ì¡´ TEST_OBJECTS ë‹¤ìŒì— ì¶”ê°€)
PIPELINE_TEST_OBJ = $(OBJ_DIR)/test_complete_data_pipeline.o

# ğŸš€ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì†ŒìŠ¤ ì»´íŒŒì¼
$(OBJ_DIR)/test_complete_data_pipeline.o: test_complete_data_pipeline.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Compiling test_complete_data_pipeline...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# ğŸ”¥ Step 6: ì™„ì „í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (ì‹ ê·œ ì¶”ê°€)
$(BIN_DIR)/test_step6: $(ALL_OBJECTS) $(PIPELINE_TEST_OBJ) | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step6 (Complete Data Pipeline)...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(PIPELINE_TEST_OBJ) $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step6 (Complete Data Pipeline) build completed!$(NC)"

# =============================================================================
# ğŸ”¥ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿë“¤ (ê¸°ì¡´ step4-build, step5-build ë‹¤ìŒì— ì¶”ê°€)
# =============================================================================

# ğŸ”¥ Step 6: ì™„ì „í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ë¹Œë“œ
step6-build: $(BIN_DIR)/test_step6
	@echo -e "$(GREEN)ğŸš€ Step 6 (Complete Data Pipeline) build completed!$(NC)"

step6-test: step6-build
	@echo -e "$(PURPLE)ğŸ§ª Running Step 6 (Complete Data Pipeline) tests...$(NC)"
	@echo -e "$(CYAN)ğŸ“Š ì´ í…ŒìŠ¤íŠ¸ëŠ” Redis ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤$(NC)"
	@./$(BIN_DIR)/test_step6

# ğŸš€ íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°œë³„)
pipeline-step1: step6-build
	@echo -e "$(BLUE)ğŸ” Pipeline Step 1: Worker ê¸°ë°˜ ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤ìº”$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step1*" --gtest_color=yes

pipeline-step2: step6-build  
	@echo -e "$(BLUE)ğŸ” Pipeline Step 2: ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìŠ¤ìº” í”„ë¡œì„¸ìŠ¤$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step2*" --gtest_color=yes

pipeline-step3: step6-build
	@echo -e "$(BLUE)ğŸ” Pipeline Step 3: DataProcessingService ë°°ì¹˜ ì²˜ë¦¬$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step3*" --gtest_color=yes

pipeline-step4: step6-build
	@echo -e "$(BLUE)ğŸ” Pipeline Step 4: Redis ì €ì¥ ê²€ì¦$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step4*" --gtest_color=yes

pipeline-step5: step6-build
	@echo -e "$(BLUE)ğŸ” Pipeline Step 5: ì™„ì „í•œ ì‹¤ì‹œê°„ íŒŒì´í”„ë¼ì¸ í†µí•©$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step5*" --gtest_color=yes

# ğŸ”¥ íŒŒì´í”„ë¼ì¸ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ (Step 1-3ë§Œ)
pipeline-quick: step6-build
	@echo -e "$(BLUE)âš¡ ë¹ ë¥¸ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (Step 1-3ë§Œ)$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step1*:*Step2*:*Step3*" --gtest_color=yes

# ğŸ”¥ Redis ì¤‘ì‹¬ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (Step 3-4)
pipeline-redis: step6-build
	@echo -e "$(BLUE)ğŸ” Redis ì¤‘ì‹¬ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (Step 3-4)$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step3*:*Step4*" --gtest_color=yes

# ğŸ”¥ í†µí•© íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (Step 5ë§Œ)
pipeline-integration: step6-build
	@echo -e "$(BLUE)ğŸ”— í†µí•© íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (Step 5ë§Œ)$(NC)"
	@./$(BIN_DIR)/test_step6 --gtest_filter="*Step5*" --gtest_color=yes

# =============================================================================
# ğŸ”¥ í†µí•©ëœ ëª¨ë“  í…ŒìŠ¤íŠ¸ ë¹Œë“œ (ê¸°ì¡´ all-tests-build ìˆ˜ì •)
# =============================================================================

# ê¸°ì¡´ all-tests-buildë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •:
all-tests-build: $(BIN_DIR)/test_step3 $(BIN_DIR)/test_step4 $(BIN_DIR)/test_step5 $(BIN_DIR)/test_step6
	@echo -e "$(GREEN)ğŸ‰ All tests build completed! (Step 3-6)$(NC)"

# ê¸°ì¡´ all-tests-runì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •:
all-tests-run: all-tests-build check-redis-connection
	@echo -e "$(BLUE)ğŸš€ Running all tests in sequence (Step 3-6)...$(NC)"
	@echo -e "$(YELLOW)======================================$(NC)"
	@echo -e "$(PURPLE)ğŸ§ª Step 3: Workers Test$(NC)"
	@./$(BIN_DIR)/test_step3
	@echo -e "$(YELLOW)======================================$(NC)"
	@echo -e "$(PURPLE)ğŸ§ª Step 4: Driver Data Validation Test$(NC)"
	@./$(BIN_DIR)/test_step4
	@echo -e "$(YELLOW)======================================$(NC)"
	@echo -e "$(PURPLE)ğŸ§ª Step 5: Complete DB Integration Test$(NC)"
	@./$(BIN_DIR)/test_step5
	@echo -e "$(YELLOW)======================================$(NC)"
	@echo -e "$(PURPLE)ğŸ§ª Step 6: Complete Data Pipeline Test$(NC)"
	@./$(BIN_DIR)/test_step6
	@echo -e "$(GREEN)ğŸ‰ All tests completed!$(NC)"

# =============================================================================
# ğŸ”§ Redis ì—°ê²° í™•ì¸ (íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ìš©)
# =============================================================================

check-redis-connection:
	@echo -e "$(BLUE)ğŸ” Redis ì„œë²„ ì—°ê²° í™•ì¸...$(NC)"
	@if command -v redis-cli >/dev/null 2>&1; then \
		if redis-cli ping >/dev/null 2>&1; then \
			echo -e "$(GREEN)âœ… Redis ì„œë²„ ì—°ê²° ì •ìƒ$(NC)"; \
		else \
			echo -e "$(RED)âŒ Redis ì„œë²„ ì—°ê²° ì‹¤íŒ¨$(NC)"; \
			echo -e "$(YELLOW)Redis ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”:$(NC)"; \
			echo -e "  sudo systemctl start redis-server"; \
			echo -e "  ë˜ëŠ”: redis-server &"; \
			false; \
		fi; \
	else \
		echo -e "$(RED)âŒ Redis CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤$(NC)"; \
		echo -e "$(YELLOW)ì„¤ì¹˜ ë°©ë²•: sudo apt-get install redis-tools$(NC)"; \
		false; \
	fi

# =============================================================================
# ğŸ”¥ ê°œë°œ ì›Œí¬í”Œë¡œìš° í™•ì¥ (ê¸°ì¡´ dev-* ë‹¤ìŒì— ì¶”ê°€)
# =============================================================================

dev-step6: step6-build step6-test
dev-pipeline: step6-build step6-test
dev-all-extended: all-tests-run

# =============================================================================
# ğŸ”¥ ìƒíƒœ í™•ì¸ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ status íƒ€ê²Ÿ ìˆ˜ì •)
# =============================================================================

# ê¸°ì¡´ status íƒ€ê²Ÿì˜ ì´ ë¶€ë¶„ì„:
# @echo "Step 3 binary: $(if $(wildcard $(BIN_DIR)/test_step3),âœ… exists,âŒ missing)"
# @echo "Step 4 binary: $(if $(wildcard $(BIN_DIR)/test_step4),âœ… exists,âŒ missing)"
# @echo "Step 5 binary: $(if $(wildcard $(BIN_DIR)/test_step5),âœ… exists,âŒ missing)"

# ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •:
status-extended:
	@echo -e "$(BLUE)ğŸ“Š Build Status (Extended)$(NC)"
	@echo -e "$(YELLOW)===============$(NC)"
	@echo "Object files: $(words $(wildcard $(OBJ_DIR)/**/*.o)) / $(words $(ALL_OBJECTS))"
	@echo "Source files: $(words $(ALL_SOURCES))"
	@echo "Step 3 binary: $(if $(wildcard $(BIN_DIR)/test_step3),âœ… exists,âŒ missing)"
	@echo "Step 4 binary: $(if $(wildcard $(BIN_DIR)/test_step4),âœ… exists,âŒ missing)"
	@echo "Step 5 binary: $(if $(wildcard $(BIN_DIR)/test_step5),âœ… exists,âŒ missing)"
	@echo "Step 6 binary: $(if $(wildcard $(BIN_DIR)/test_step6),âœ… exists,âŒ missing) - Data Pipeline"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ Libraries:$(NC)"
	@echo "  Modbus: $(if $(MODBUS_LIBS),âœ…,âŒ)"
	@echo "  MQTT: $(if $(MQTT_CPP_LIBS),âœ…,âŒ)"
	@echo "  BACnet: $(if $(BACNET_LIBS),âœ…,âŒ)"
	@echo "  Redis: $(if $(REDIS_LIBS),âœ…,âŒ)"
	@echo ""
	@echo -e "$(BLUE)ğŸš€ Pipeline Test Status:$(NC)"
	@if command -v redis-cli >/dev/null 2>&1; then \
		if redis-cli ping >/dev/null 2>&1; then \
			echo "  Redis Server: âœ… running"; \
		else \
			echo "  Redis Server: âŒ not running"; \
		fi; \
	else \
		echo "  Redis CLI: âŒ not installed"; \
	fi

# =============================================================================
# ğŸ”¥ ë„ì›€ë§ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ help íƒ€ê²Ÿ ìˆ˜ì •)
# =============================================================================

# ê¸°ì¡´ help íƒ€ê²Ÿì— ë‹¤ìŒ ë‚´ìš© ì¶”ê°€:
help-extended:
	@echo -e "$(BLUE)ğŸš€ PulseOne Fast Build System (Extended with Pipeline)$(NC)"
	@echo -e "$(YELLOW)==========================================$(NC)"
	@echo ""
	@echo -e "$(GREEN)ğŸ”¥ ê°œë³„ í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´:$(NC)"
	@echo "  make step3-test   - ğŸ§ª Step 3: Workers í…ŒìŠ¤íŠ¸"
	@echo "  make step4-test   - ğŸ§ª Step 4: Driver ë°ì´í„° ê²€ì¦ í…ŒìŠ¤íŠ¸"
	@echo "  make step5-test   - ğŸ§ª Step 5: ì™„ì „í•œ DB í†µí•© í…ŒìŠ¤íŠ¸"
	@echo "  make step6-test   - ğŸ§ª Step 6: ì™„ì „í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (ì‹ ê·œ!)"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ íŒŒì´í”„ë¼ì¸ ê°œë³„ ë‹¨ê³„:$(NC)"
	@echo "  make pipeline-step1 - ğŸ“Š Worker ê¸°ë°˜ ë°ì´í„° ìŠ¤ìº”"
	@echo "  make pipeline-step2 - ğŸ”„ ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ìƒì„±"
	@echo "  make pipeline-step3 - âš™ï¸  DataProcessingService ë°°ì¹˜ ì²˜ë¦¬"
	@echo "  make pipeline-step4 - ğŸ“Š Redis ì €ì¥ ê²€ì¦"
	@echo "  make pipeline-step5 - ğŸ”— ì™„ì „í•œ ì‹¤ì‹œê°„ í†µí•©"
	@echo ""
	@echo -e "$(GREEN)âš¡ ë¹ ë¥¸ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸:$(NC)"
	@echo "  make pipeline-quick     - âš¡ Step 1-3ë§Œ ë¹ ë¥´ê²Œ"
	@echo "  make pipeline-redis     - ğŸ” Redis ê´€ë ¨ í…ŒìŠ¤íŠ¸ë§Œ"
	@echo "  make pipeline-integration - ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ë§Œ"
	@echo ""
	@echo -e "$(GREEN)ğŸš€ ë¹ ë¥¸ ë¹Œë“œ ëª…ë ¹ì–´:$(NC)"
	@echo "  make step3-build  - ğŸš€ Step 3 ë¹Œë“œë§Œ"
	@echo "  make step4-build  - ğŸš€ Step 4 ë¹Œë“œë§Œ"
	@echo "  make step5-build  - ğŸš€ Step 5 ë¹Œë“œë§Œ"
	@echo "  make step6-build  - ğŸš€ Step 6 ë¹Œë“œë§Œ (íŒŒì´í”„ë¼ì¸)"
	@echo "  make all-tests-build - ğŸš€ ëª¨ë“  í…ŒìŠ¤íŠ¸ ë¹Œë“œ (Step 3-6)"
	@echo ""
	@echo -e "$(GREEN)ğŸ¯ í†µí•© ì‹¤í–‰:$(NC)"
	@echo "  make all-tests-run    - ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ (Step 3-6)"
	@echo "  make dev-all-extended - ğŸ”„ í™•ì¥ëœ ê°œë°œ ì›Œí¬í”Œë¡œìš°"
	@echo ""
	@echo -e "$(GREEN)ğŸ“Š ìƒíƒœ í™•ì¸:$(NC)"
	@echo "  make status-extended     - ğŸ“Š í™•ì¥ëœ ë¹Œë“œ ìƒíƒœ í™•ì¸"
	@echo "  make check-redis-connection - ğŸ” Redis ì—°ê²° í™•ì¸"
	@echo ""
	@echo -e "$(PURPLE)ğŸ’¡ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ê¶Œì¥ ì‚¬ìš©ë²•:$(NC)"
	@echo "  1ï¸âƒ£  í™˜ê²½ í™•ì¸: make check-redis-connection"
	@echo "  2ï¸âƒ£  ë¹ ë¥¸ í…ŒìŠ¤íŠ¸: make pipeline-quick"
	@echo "  3ï¸âƒ£  Redis í…ŒìŠ¤íŠ¸: make pipeline-redis"
	@echo "  4ï¸âƒ£  ì „ì²´ íŒŒì´í”„ë¼ì¸: make step6-test"
	@echo "  5ï¸âƒ£  ëª¨ë“  í…ŒìŠ¤íŠ¸: make all-tests-run"
	@echo ""
	@echo -e "$(RED)ğŸ”¥ ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì´í”„ë¼ì¸ ê¸°ëŠ¥:$(NC)"
	@echo "  - Step 6: ë””ë°”ì´ìŠ¤ ìŠ¤ìº” â†’ Redis ì €ì¥ ì™„ì „ íŒŒì´í”„ë¼ì¸"
	@echo "  - 5ë‹¨ê³„ ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ ê²€ì¦"
	@echo "  - DataProcessingService ë°°ì¹˜ ì²˜ë¦¬"
	@echo "  - Redis ë°ì´í„° ë¬´ê²°ì„± í™•ì¸"
	@echo "  - ë©€í‹°ì‚¬ì´í´ ì‹¤ì‹œê°„ í†µí•© í…ŒìŠ¤íŠ¸"

# =============================================================================
# ğŸ”¥ .PHONY íƒ€ê²Ÿ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ .PHONYì— ì¶”ê°€)
# =============================================================================

# ê¸°ì¡´ .PHONY ì¤„ì„ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¥:
.PHONY: fast-build full-build test clean status status-extended check-deps help help-extended \
        step3-build step3-test step4-build step4-test step5-build step5-test step6-build step6-test \
        all-tests-build all-tests-run dev-step3 dev-step4 dev-step5 dev-step6 dev-pipeline dev-all-extended \
        pipeline-step1 pipeline-step2 pipeline-step3 pipeline-step4 pipeline-step5 \
        pipeline-quick pipeline-redis pipeline-integration check-redis-connection

# =============================================================================
# ğŸ¯ ì‚¬ìš© ì˜ˆì‹œ ë° ê¶Œì¥ ì›Œí¬í”Œë¡œìš°
# =============================================================================

# ğŸš€ ì™„ì „í•œ ê°œë°œ ì›Œí¬í”Œë¡œìš° ì˜ˆì‹œ:
# 1. make check-redis-connection    # Redis í™•ì¸
# 2. make step6-build              # íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ë¹Œë“œ
# 3. make pipeline-quick           # ë¹ ë¥¸ ê²€ì¦
# 4. make step6-test              # ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸
# 5. make all-tests-run           # ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰


# =============================================================================
# Step 6 ì¶”ê°€ ì„¤ì • - ê¸°ì¡´ tests/Makefileì— ì¶”ê°€í•  ë‚´ìš©
# =============================================================================

# Step 6 ì „ìš© ì†ŒìŠ¤ (ê¸°ì¡´ ëª¨ë“  ì†ŒìŠ¤ + Pipeline ì¶”ê°€)
STEP6_SOURCES = $(UTILS_SOURCES) $(CONFIG_SOURCES) $(DATABASE_SOURCES) \
                $(WORKERS_SOURCES) $(DRIVERS_SOURCES) $(CLIENT_SOURCES) \
                $(PIPELINE_SOURCES)

# Step 6 íŒŒì´í”„ë¼ì¸ ì†ŒìŠ¤ ì •ì˜ (ë§Œì•½ ê¸°ì¡´ì— ì—†ë‹¤ë©´)
PIPELINE_SOURCES = ../src/Pipeline/DataProcessingService.cpp

# Step 6 ì»´íŒŒì¼ ê·œì¹™
step6: $(STEP6_SOURCES) test_step6_full_pipeline.cpp
	@echo "ğŸ”§ Step 6: ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì»´íŒŒì¼ ì¤‘..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -o bin/test_step6_full_pipeline \
		test_step6_full_pipeline.cpp $(STEP6_SOURCES) $(TEST_LIBS) $(LIBS)
	@echo "âœ… Step 6 ì»´íŒŒì¼ ì™„ë£Œ: bin/test_step6_full_pipeline"

# Step 6 ì‹¤í–‰
run-step6: step6
	@echo ""
	@echo "ğŸš€ Step 6: ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "=================================================="
	@cd bin && ./test_step6_full_pipeline

# ì „ì²´ 6ë‹¨ê³„ í”Œë¡œìš° ì‹¤í–‰
run-all-6steps: run-step1 run-step2 run-step3 run-step4 run-step5 run-step6
	@echo ""
	@echo "ğŸ‰ ì „ì²´ 6ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
	@echo "âœ… Step 1: ì„¤ì •íŒŒì¼ ì½ê¸°"
	@echo "âœ… Step 2: DB ì ‘ê·¼"  
	@echo "âœ… Step 3: Worker ìƒì„±"
	@echo "âœ… Step 4: ë“œë¼ì´ë²„ ì´ˆê¸°í™”"
	@echo "âœ… Step 5: Redis ì €ì¥ ì‹œë®¬ë ˆì´ì…˜"
	@echo "âœ… Step 6: ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ (ìŠ¤ìº”â†’ì²˜ë¦¬â†’ì €ì¥â†’ê²€ì¦)"

# íŒŒì´í”„ë¼ì¸ ì „ìš© ëª…ë ¹ì–´ë“¤
pipeline: step6
	@echo "ğŸ”„ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ"

test-pipeline: run-step6
	@echo "âœ… íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ"

full-pipeline: run-all-6steps
	@echo "ğŸ† ì „ì²´ 6ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

# Redis ì—°ê²° í…ŒìŠ¤íŠ¸ (Step6 ì‹¤í–‰ ì „ í™•ì¸ìš©)
check-redis:
	@echo "ğŸ” Redis ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘..."
	@if command -v redis-cli >/dev/null 2>&1; then \
		echo "âœ… redis-cli ë°œê²¬"; \
		if redis-cli ping 2>/dev/null | grep -q PONG; then \
			echo "âœ… Redis ì„œë²„ ì‘ë‹µ í™•ì¸ (PONG)"; \
		else \
			echo "âš ï¸  Redis ì„œë²„ ë¬´ì‘ë‹µ (í…ŒìŠ¤íŠ¸ëŠ” ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì§„í–‰ë¨)"; \
		fi \
	else \
		echo "âš ï¸  redis-cli ì—†ìŒ (í…ŒìŠ¤íŠ¸ëŠ” ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë¡œ ì§„í–‰ë¨)"; \
	fi

# í™˜ê²½ ì²´í¬ì— Redis ì¶”ê°€
check-pipeline-env: check-deps check-sources check-redis
	@echo ""
	@echo "ğŸ¯ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì²´í¬ ì™„ë£Œ"
	@echo "   - ì»´íŒŒì¼ëŸ¬: âœ…"
	@echo "   - ë¼ì´ë¸ŒëŸ¬ë¦¬: âœ…" 
	@echo "   - ì†ŒìŠ¤ íŒŒì¼: âœ…"
	@echo "   - Redis: $(shell if redis-cli ping 2>/dev/null | grep -q PONG; then echo "âœ…"; else echo "âš ï¸ "; fi)"

# íŒŒì´í”„ë¼ì¸ ë””ë²„ê·¸ ì‹¤í–‰
debug-pipeline: step6
	@echo "ğŸ› íŒŒì´í”„ë¼ì¸ ë””ë²„ê·¸ ëª¨ë“œ ì‹¤í–‰"
	@cd bin && gdb -batch -ex run -ex bt --args ./test_step6_full_pipeline

# íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ì¸¡ì •
profile-pipeline: step6
	@echo "ğŸ“Š íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§"
	@cd bin && time ./test_step6_full_pipeline

# =============================================================================
# helpì— Step6 ê´€ë ¨ ëª…ë ¹ì–´ ì¶”ê°€
# =============================================================================

# ê¸°ì¡´ help íƒ€ê²Ÿì— ì¶”ê°€í•  ë‚´ìš©:
help-step6:
	@echo ""
	@echo "ğŸ”„ Step 6 (ì™„ì „í•œ íŒŒì´í”„ë¼ì¸) ê´€ë ¨ ëª…ë ¹ì–´:"
	@echo "  make step6              - Step 6 ì»´íŒŒì¼"
	@echo "  make run-step6          - Step 6 ì‹¤í–‰ (DBâ†’Workerâ†’ìŠ¤ìº”â†’ì²˜ë¦¬â†’Redis)"
	@echo "  make run-all-6steps     - ì „ì²´ 1~6ë‹¨ê³„ ìˆœì°¨ ì‹¤í–‰"
	@echo "  make pipeline           - íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì¤€ë¹„"
	@echo "  make test-pipeline      - íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make full-pipeline      - ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸"
	@echo "  make check-redis        - Redis ì—°ê²° ìƒíƒœ í™•ì¸"
	@echo "  make check-pipeline-env - íŒŒì´í”„ë¼ì¸ í™˜ê²½ ì „ì²´ ì²´í¬"
	@echo "  make debug-pipeline     - íŒŒì´í”„ë¼ì¸ ë””ë²„ê·¸ ì‹¤í–‰"
	@echo "  make profile-pipeline   - íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ì¸¡ì •"

# =============================================================================
# ì‹¤í–‰ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
# =============================================================================

pre-step6-check:
	@echo "ğŸ“‹ Step 6 ì‹¤í–‰ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
	@echo "1. ê¸°ë³¸ í™˜ê²½:"
	@if [ -f "../config/.env" ]; then echo "   âœ… .env íŒŒì¼ ì¡´ì¬"; else echo "   âŒ .env íŒŒì¼ ì—†ìŒ"; fi
	@if [ -f "db/pulseone_test.db" ]; then echo "   âœ… í…ŒìŠ¤íŠ¸ DB ì¡´ì¬"; else echo "   âŒ í…ŒìŠ¤íŠ¸ DB ì—†ìŒ (setup_test_environment.sh ì‹¤í–‰ í•„ìš”)"; fi
	@echo "2. ì´ì „ ë‹¨ê³„ ì¤€ë¹„:"
	@if [ -f "bin/test_step1_config" ]; then echo "   âœ… Step 1 ì»´íŒŒì¼ë¨"; else echo "   âš ï¸  Step 1 ë¯¸ì»´íŒŒì¼"; fi
	@if [ -f "bin/test_step2_database" ]; then echo "   âœ… Step 2 ì»´íŒŒì¼ë¨"; else echo "   âš ï¸  Step 2 ë¯¸ì»´íŒŒì¼"; fi
	@if [ -f "bin/test_step3_workers" ]; then echo "   âœ… Step 3 ì»´íŒŒì¼ë¨"; else echo "   âš ï¸  Step 3 ë¯¸ì»´íŒŒì¼"; fi
	@if [ -f "bin/test_step4_drivers" ]; then echo "   âœ… Step 4 ì»´íŒŒì¼ë¨"; else echo "   âš ï¸  Step 4 ë¯¸ì»´íŒŒì¼"; fi
	@if [ -f "bin/test_step5_redis" ]; then echo "   âœ… Step 5 ì»´íŒŒì¼ë¨"; else echo "   âš ï¸  Step 5 ë¯¸ì»´íŒŒì¼"; fi
	@echo "3. Redis ìƒíƒœ:"
	@make check-redis
	@echo ""
	@echo "ğŸ’¡ ëª¨ë“  ì²´í¬ê°€ ì™„ë£Œë˜ë©´ 'make run-step6' ì‹¤í–‰í•˜ì„¸ìš”"

# ì „ì²´ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì²´í¬ í¬í•¨)
complete-pipeline-test: pre-step6-check run-step6
	@echo ""
	@echo "ğŸ¯ === ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ==="
	@echo "âœ… ì‚¬ì „ ì²´í¬ í†µê³¼"
	@echo "âœ… Step 6 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ" 
	@echo "ğŸ† ì „ì²´ í…ŒìŠ¤íŠ¸ ì„±ê³µ!"

	# =============================================================================
# ğŸ”¥ ê¸°ì¡´ Makefileì— Step 6ë§Œ ì¶”ê°€ (ìµœì†Œí•œì˜ ìˆ˜ì •)
# ê¸°ì¡´ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ì•„ë˜ ë‚´ìš©ë§Œ ì ì ˆí•œ ìœ„ì¹˜ì— ì¶”ê°€í•˜ì„¸ìš”
# =============================================================================

# Step 6 í…ŒìŠ¤íŠ¸ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€ (ê¸°ì¡´ TEST_OBJECTS ì¤„ì— ì¶”ê°€)
# ê¸°ì¡´: TEST_OBJECTS = $(OBJ_DIR)/test_step3_workers.o \
#                     $(OBJ_DIR)/test_step4_driver_data_validation.o \
#                     $(OBJ_DIR)/test_step5_complete_db_integration_validation.o
# 
# ìˆ˜ì • í›„: TEST_OBJECTS = $(OBJ_DIR)/test_step3_workers.o \
#                         $(OBJ_DIR)/test_step4_driver_data_validation.o \
#                         $(OBJ_DIR)/test_step5_complete_db_integration_validation.o \
#                         $(OBJ_DIR)/test_step6_full_pipeline.o

# =============================================================================
# ğŸ”¥ Step 6 í…ŒìŠ¤íŠ¸ íŒŒì¼ ì»´íŒŒì¼ (ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì»´íŒŒì¼ ê·œì¹™ë“¤ ë‹¤ìŒì— ì¶”ê°€)
# =============================================================================

$(OBJ_DIR)/test_step6_full_pipeline.o: test_step6_full_pipeline.cpp | $(OBJ_DIR)
	@echo -e "$(YELLOW)ğŸ”¨ Compiling test_step6_full_pipeline...$(NC)"
	@$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# =============================================================================
# ğŸ”¥ Step 6 ì‹¤í–‰ íŒŒì¼ (ê¸°ì¡´ ì‹¤í–‰ íŒŒì¼ íƒ€ê²Ÿë“¤ ë‹¤ìŒì— ì¶”ê°€)
# =============================================================================

# Step 6: ì™„ì „í•œ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸
$(BIN_DIR)/test_step6: $(ALL_OBJECTS) $(OBJ_DIR)/test_step6_full_pipeline.o | $(BIN_DIR)
	@echo -e "$(PURPLE)ğŸ”— Linking test_step6 (Complete Data Pipeline)...$(NC)"
	@$(CXX) $(ALL_OBJECTS) $(OBJ_DIR)/test_step6_full_pipeline.o $(TEST_LIBS) $(LIBS) -o $@
	@echo -e "$(GREEN)âœ… test_step6 (Complete Data Pipeline) build completed!$(NC)"

# =============================================================================
# ğŸ”¥ Step 6 ë©”ì¸ íƒ€ê²Ÿë“¤ (ê¸°ì¡´ step5-build, step5-test ë‹¤ìŒì— ì¶”ê°€)
# =============================================================================

step6-build: $(BIN_DIR)/test_step6
	@echo -e "$(GREEN)ğŸš€ Step 6 (Complete Data Pipeline) build completed!$(NC)"

step6-test: step6-build
	@echo -e "$(PURPLE)ğŸ§ª Running Step 6 (Complete Data Pipeline) tests...$(NC)"
	@echo -e "$(CYAN)ğŸ“Š ì´ í…ŒìŠ¤íŠ¸ëŠ” Redis ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤$(NC)"
	@./$(BIN_DIR)/test_step6

# ğŸš€ Step 6 ê°œë°œ ì›Œí¬í”Œë¡œìš° (ê¸°ì¡´ dev-* ë‹¤ìŒì— ì¶”ê°€)
dev-step6: step6-build step6-test

# =============================================================================
# ğŸ”¥ ê¸°ì¡´ íƒ€ê²Ÿë“¤ ìˆ˜ì • (ê¸°ì¡´ íƒ€ê²Ÿì„ ì°¾ì•„ì„œ ìˆ˜ì •)
# =============================================================================

# ê¸°ì¡´ all-tests-build íƒ€ê²Ÿì„ ìˆ˜ì •:
# ê¸°ì¡´: all-tests-build: $(BIN_DIR)/test_step3 $(BIN_DIR)/test_step4 $(BIN_DIR)/test_step5
# ìˆ˜ì • í›„: all-tests-build: $(BIN_DIR)/test_step3 $(BIN_DIR)/test_step4 $(BIN_DIR)/test_step5 $(BIN_DIR)/test_step6

# ê¸°ì¡´ all-tests-run íƒ€ê²Ÿì— Step 6 ì¶”ê°€:
# ê¸°ì¡´ all-tests-run íƒ€ê²Ÿ ëë¶€ë¶„ì— ë‹¤ìŒ ì¶”ê°€:
#	@echo -e "$(YELLOW)======================================$(NC)"
#	@echo -e "$(PURPLE)ğŸ§ª Step 6: Complete Data Pipeline Test$(NC)"
#	@./$(BIN_DIR)/test_step6

# ê¸°ì¡´ status íƒ€ê²Ÿì— Step 6 ìƒíƒœ ì¶”ê°€:
# ê¸°ì¡´ status íƒ€ê²Ÿì˜ ë°”ì´ë„ˆë¦¬ ì²´í¬ ë¶€ë¶„ì— ë‹¤ìŒ ì¶”ê°€:
#	@echo "Step 6 binary: $(if $(wildcard $(BIN_DIR)/test_step6),âœ… exists,âŒ missing) - Data Pipeline"

# ê¸°ì¡´ help íƒ€ê²Ÿì— Step 6 ë„ì›€ë§ ì¶”ê°€:
# ê¸°ì¡´ help íƒ€ê²Ÿì˜ "ğŸ”¥ ê°œë³„ í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´:" ì„¹ì…˜ì— ë‹¤ìŒ ì¶”ê°€:
#	@echo "  make step6-test   - ğŸ§ª Step 6: ì™„ì „í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ (ì‹ ê·œ!)"

# ê¸°ì¡´ help íƒ€ê²Ÿì˜ "ğŸš€ ë¹ ë¥¸ ë¹Œë“œ ëª…ë ¹ì–´:" ì„¹ì…˜ì— ë‹¤ìŒ ì¶”ê°€:
#	@echo "  make step6-build  - ğŸš€ Step 6 ë¹Œë“œë§Œ (íŒŒì´í”„ë¼ì¸)"

# ê¸°ì¡´ .PHONY íƒ€ê²Ÿì— ì¶”ê°€:
# ê¸°ì¡´: .PHONY: fast-build full-build test clean status check-deps help \
#               step3-build step3-test step4-build step4-test step5-build step5-test \
#               all-tests-build all-tests-run dev-step3 dev-step4 dev-step5 dev-all
# ìˆ˜ì • í›„: ê¸°ì¡´ì— ë‹¤ìŒë§Œ ì¶”ê°€: step6-build step6-test dev-step6

# =============================================================================
# ğŸ¯ ì™„ì „í•œ ìˆ˜ì • ê°€ì´ë“œ
# =============================================================================

# 1. TEST_OBJECTS ë³€ìˆ˜ì— $(OBJ_DIR)/test_step6_full_pipeline.o ì¶”ê°€
# 2. $(OBJ_DIR)/test_step6_full_pipeline.o ì»´íŒŒì¼ ê·œì¹™ ì¶”ê°€ (ìœ„ ì½”ë“œ)
# 3. $(BIN_DIR)/test_step6 ë§í‚¹ ê·œì¹™ ì¶”ê°€ (ìœ„ ì½”ë“œ)
# 4. step6-build, step6-test, dev-step6 íƒ€ê²Ÿ ì¶”ê°€ (ìœ„ ì½”ë“œ)
# 5. all-tests-buildì— $(BIN_DIR)/test_step6 ì¶”ê°€
# 6. all-tests-runì— Step 6 ì‹¤í–‰ ì½”ë“œ ì¶”ê°€
# 7. status, help, .PHONYì— Step 6 ê´€ë ¨ ë‚´ìš© ì¶”ê°€