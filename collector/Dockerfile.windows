FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# =============================================================================
# 1. ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
# =============================================================================
RUN apt-get update && apt-get install -y \
    gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 \
    make cmake pkg-config git \
    wget curl unzip patch \
    build-essential autotools-dev automake autoconf libtool \
    libssl-dev zlib1g-dev uuid-dev \
    mingw-w64-tools mingw-w64-x86-64-dev \
    vim nano tree htop procps \
    && rm -rf /var/lib/apt/lists/*

# MinGW ì„¤ì •
RUN update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix && \
    update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix

ENV CC=x86_64-w64-mingw32-gcc
ENV CXX=x86_64-w64-mingw32-g++
ENV AR=x86_64-w64-mingw32-ar
ENV STRIP=x86_64-w64-mingw32-strip
ENV WINDRES=x86_64-w64-mingw32-windres
ENV MINGW_PREFIX=/usr/x86_64-w64-mingw32
ENV PATH="${MINGW_PREFIX}/bin:${PATH}"

# =============================================================================
# 2. SQLite3
# =============================================================================
RUN cd /tmp && \
    wget https://www.sqlite.org/2023/sqlite-amalgamation-3420000.zip -O sqlite.zip && \
    unzip sqlite.zip && \
    cd sqlite-amalgamation-3420000 && \
    ${CC} -c sqlite3.c -o sqlite3.o \
        -DSQLITE_THREADSAFE=1 \
        -DSQLITE_ENABLE_FTS5 \
        -DSQLITE_ENABLE_JSON1 \
        -DSQLITE_ENABLE_RTREE \
        -DSQLITE_USE_URI=1 && \
    ${AR} rcs ${MINGW_PREFIX}/lib/libsqlite3.a sqlite3.o && \
    cp sqlite3.h sqlite3ext.h ${MINGW_PREFIX}/include/ && \
    rm -rf /tmp/sqlite* && \
    echo "SQLite3 ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 3. OpenSSL
# =============================================================================
RUN cd /tmp && \
    wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz && \
    tar xzf openssl-1.1.1w.tar.gz && \
    cd openssl-1.1.1w && \
    ./Configure mingw64 no-shared no-asm \
        --prefix=${MINGW_PREFIX} \
        --openssldir=${MINGW_PREFIX}/ssl && \
    make CC=${CC} AR=${AR} RANLIB=x86_64-w64-mingw32-ranlib && \
    make install_sw && \
    rm -rf /tmp/openssl* && \
    echo "OpenSSL ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 4. libmodbus (í—¤ë” ê²½ë¡œ ìˆ˜ì •)
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 --branch v3.1.10 https://github.com/stephane/libmodbus.git && \
    cd libmodbus && \
    ./autogen.sh && \
    ./configure --host=x86_64-w64-mingw32 \
                --prefix=${MINGW_PREFIX} \
                --enable-static \
                --disable-shared \
                --disable-tests \
                CFLAGS="-O2 -D_WIN32_WINNT=0x0601" && \
    make && make install && \
    mkdir -p ${MINGW_PREFIX}/include/modbus && \
    cp ${MINGW_PREFIX}/include/modbus*.h ${MINGW_PREFIX}/include/modbus/ 2>/dev/null || true && \
    rm -rf /tmp/libmodbus && \
    echo "libmodbus ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 5. hiredis
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && \
    make CC=${CC} AR=${AR} PREFIX=${MINGW_PREFIX} \
         CFLAGS="-O2 -DWIN32_LEAN_AND_MEAN -D_WIN32_WINNT=0x0601 -w" \
         LDFLAGS="-lws2_32" \
         WARNINGS="" && \
    make PREFIX=${MINGW_PREFIX} install && \
    rm -rf /tmp/hiredis && \
    echo "hiredis ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 6. Windowsìš© ì™„ì „í•œ poll.h ìƒì„±
# =============================================================================
RUN cat > ${MINGW_PREFIX}/include/poll.h << 'EOF'
#ifndef POLL_H
#define POLL_H

#ifdef _WIN32
#include <winsock2.h>
#include <ws2tcpip.h>
#include <windows.h>

#define POLLIN      0x0001
#define POLLPRI     0x0002
#define POLLOUT     0x0004
#define POLLERR     0x0008
#define POLLHUP     0x0010
#define POLLNVAL    0x0020

struct pollfd {
    SOCKET fd;
    short events;
    short revents;
};

typedef unsigned long nfds_t;

#ifdef __cplusplus
extern "C" {
#endif

static inline int poll(struct pollfd *fds, nfds_t nfds, int timeout) {
    #if defined(WSAPoll)
        return WSAPoll(fds, nfds, timeout);
    #else
        fd_set readfds, writefds, exceptfds;
        struct timeval tv, *tvp = NULL;
        SOCKET maxfd = 0;
        int result, i;

        if (timeout >= 0) {
            tv.tv_sec = timeout / 1000;
            tv.tv_usec = (timeout % 1000) * 1000;
            tvp = &tv;
        }

        FD_ZERO(&readfds);
        FD_ZERO(&writefds);
        FD_ZERO(&exceptfds);

        for (i = 0; i < nfds; i++) {
            if (fds[i].fd == INVALID_SOCKET) continue;
            
            if (fds[i].events & POLLIN) FD_SET(fds[i].fd, &readfds);
            if (fds[i].events & POLLOUT) FD_SET(fds[i].fd, &writefds);
            FD_SET(fds[i].fd, &exceptfds);
            
            if (fds[i].fd > maxfd) maxfd = fds[i].fd;
            fds[i].revents = 0;
        }

        result = select(maxfd + 1, &readfds, &writefds, &exceptfds, tvp);
        if (result <= 0) return result;

        for (i = 0; i < nfds; i++) {
            if (fds[i].fd == INVALID_SOCKET) continue;
            
            if (FD_ISSET(fds[i].fd, &readfds)) fds[i].revents |= POLLIN;
            if (FD_ISSET(fds[i].fd, &writefds)) fds[i].revents |= POLLOUT;
            if (FD_ISSET(fds[i].fd, &exceptfds)) fds[i].revents |= POLLERR;
        }

        return result;
    #endif
}

#ifdef __cplusplus
}
#endif

#else
#include <sys/poll.h>
#endif /* _WIN32 */

#endif /* POLL_H */
EOF

# =============================================================================
# 7. MQTT C ë¼ì´ë¸ŒëŸ¬ë¦¬
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && \
    mkdir -p build && \
    cd build && \
    cmake .. \
        -DCMAKE_SYSTEM_NAME=Windows \
        -DCMAKE_C_COMPILER=${CC} \
        -DCMAKE_CXX_COMPILER=${CXX} \
        -DCMAKE_RC_COMPILER=${WINDRES} \
        -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX} \
        -DPAHO_WITH_SSL=FALSE \
        -DPAHO_BUILD_STATIC=TRUE \
        -DPAHO_BUILD_SHARED=FALSE \
        -DPAHO_BUILD_DOCUMENTATION=FALSE \
        -DPAHO_BUILD_SAMPLES=FALSE \
        -DPAHO_BUILD_TESTS=FALSE \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_C_FLAGS="-O2 -D_WIN32_WINNT=0x0601 -DWIN32_LEAN_AND_MEAN" && \
    make paho-mqtt3c-static paho-mqtt3a-static -j$(nproc) && \
    find . -name "libpaho-mqtt3*.a" -exec cp {} ${MINGW_PREFIX}/lib/ \; && \
    cp src/libpaho-mqtt3c-static.a ${MINGW_PREFIX}/lib/libpaho-mqtt3c.a && \
    cp src/libpaho-mqtt3a-static.a ${MINGW_PREFIX}/lib/libpaho-mqtt3a.a && \
    cp ../src/MQTT*.h ${MINGW_PREFIX}/include/ && \
    rm -rf /tmp/paho.mqtt.c && \
    echo "MQTT C ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 8. MQTT C++ ë¼ì´ë¸ŒëŸ¬ë¦¬
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 --branch v1.3.2 https://github.com/eclipse/paho.mqtt.cpp.git && \
    cd paho.mqtt.cpp && \
    mkdir -p build && \
    cd build && \
    cmake .. \
        -DCMAKE_SYSTEM_NAME=Windows \
        -DCMAKE_C_COMPILER=${CC} \
        -DCMAKE_CXX_COMPILER=${CXX} \
        -DCMAKE_RC_COMPILER=${WINDRES} \
        -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX} \
        -DPAHO_WITH_SSL=FALSE \
        -DPAHO_BUILD_STATIC=TRUE \
        -DPAHO_BUILD_SHARED=FALSE \
        -DPAHO_BUILD_DOCUMENTATION=FALSE \
        -DPAHO_BUILD_SAMPLES=FALSE \
        -DPAHO_BUILD_TESTS=FALSE \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_PREFIX_PATH=${MINGW_PREFIX} \
        -DCMAKE_FIND_ROOT_PATH=${MINGW_PREFIX} \
        -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
        -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
        -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
        -DCMAKE_CXX_STANDARD=11 \
        -DCMAKE_CXX_FLAGS="-std=c++11 -D_WIN32_WINNT=0x0601 -DWIN32_LEAN_AND_MEAN" && \
    make -j$(nproc) && \
    make install && \
    rm -rf /tmp/paho.mqtt.cpp && \
    echo "MQTT C++ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 9. QuickJS
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 https://github.com/bellard/quickjs.git && \
    cd quickjs && \
    sed -i 's/CONFIG_LTO=y/CONFIG_LTO=n/' Makefile && \
    sed -i 's/-Werror//' Makefile && \
    export CFLAGS="-O2 -Wno-format -Wno-format-extra-args" && \
    make CC=${CC} AR=${AR} libquickjs.a && \
    cp quickjs.h quickjs-libc.h ${MINGW_PREFIX}/include/ && \
    cp libquickjs.a ${MINGW_PREFIX}/lib/ && \
    rm -rf /tmp/quickjs && \
    echo "QuickJS ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 10. BACnet Stack (ì™„ì „í•œ ê¸°ëŠ¥ + ì»´íŒŒì¼ ì—ëŸ¬ ìˆ˜ì •)
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    cd bacnet-stack && \
    echo "BACnet Stack ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

# ì™„ì „í•œ Windows config.h ìƒì„± (ëª¨ë“  ê¸°ëŠ¥ í¬í•¨)
RUN cd /tmp/bacnet-stack && \
    cat > src/bacnet/config.h << 'CONFIG_EOF'
#ifndef CONFIG_H
#define CONFIG_H

/* BACnet Stack Windows Configuration - ì™„ì „í•œ ê¸°ëŠ¥ */
#define BACNET_PROTOCOL_REVISION 22
#define MAX_APDU 1476
#define BACNET_INSTANCE_BITS 22
#define MAX_BITSTRING_BYTES 15
#define MAX_CHARACTER_STRING_BYTES 512
#define MAX_OCTET_STRING_BYTES 1024
#define MAX_MAC_LEN 7

/* Windows Platform */
#ifdef _WIN32
#ifndef WIN32_LEAN_AND_MEAN
#define WIN32_LEAN_AND_MEAN
#endif
#define NOMINMAX
#undef BACDL_ETHERNET
#define BACDL_BIP 1
#define BIP_ENABLED 1
#endif

/* Application Layer - ëª¨ë“  ê¸°ëŠ¥ í™œì„±í™” */
#define BACAPP_ALL 1
#define BACFILE 1
#define INTRINSIC_REPORTING 1
#define PRINT_ENABLED 1

/* Network Configuration */
#define BACNET_IP_BIP_PORT 0xBAC0
#define BACNET_CLIENT 1
#define BACNET_TSM_ENABLED 1

/* ì»´íŒŒì¼ ì—ëŸ¬ ìˆ˜ì • - DEPRECATED ë§¤í¬ë¡œ ë¬´ë ¥í™” */
#ifndef BACNET_STACK_DEPRECATED
#define BACNET_STACK_DEPRECATED(msg)
#endif

#ifndef min
#define min(a,b) ((a) < (b) ? (a) : (b))
#endif

#endif /* CONFIG_H */
CONFIG_EOF

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ (ì—ëŸ¬ ìˆ˜ì • í”Œëž˜ê·¸ í¬í•¨)
RUN cd /tmp/bacnet-stack && \
    mkdir -p /tmp/bacnet-win32 && \
    cd /tmp/bacnet-win32 && \
    echo "í•µì‹¬ BACnet íŒŒì¼ë“¤ ì»´íŒŒì¼ ì‹œìž‘..." && \
    for file in /tmp/bacnet-stack/src/bacnet/*.c; do \
        echo "Compiling $(basename $file)..."; \
        x86_64-w64-mingw32-gcc -c \
            -DBACDL_BIP=1 -DBACAPP_ALL -DPRINT_ENABLED=1 \
            -DBACNET_STACK_DEPRECATED= \
            -Wno-macro-redefined \
            -I/tmp/bacnet-stack/src \
            -I/tmp/bacnet-stack/src/bacnet \
            "$file" 2>/dev/null || echo "Failed: $(basename $file)"; \
    done && \
    echo "BACnet ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±..." && \
    x86_64-w64-mingw32-ar rcs libbacnet.a *.o && \
    BACNET_SIZE_KB=$(du -k libbacnet.a | cut -f1) && \
    if [ "$BACNET_SIZE_KB" -lt 300 ]; then \
        echo "âŒ BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë„ˆë¬´ ìž‘ìŒ: ${BACNET_SIZE_KB}KB"; \
        exit 1; \
    fi && \
    echo "âœ… BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²€ì¦ í†µê³¼: ${BACNET_SIZE_KB}KB" && \
    cp libbacnet.a ${MINGW_PREFIX}/lib/ && \
    mkdir -p ${MINGW_PREFIX}/include/bacnet && \
    cp /tmp/bacnet-stack/src/bacnet/*.h ${MINGW_PREFIX}/include/bacnet/ && \
    rm -rf /tmp/bacnet-stack /tmp/bacnet-win32 && \
    echo "BACnet Stack ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 11. í—¤ë” ì˜¨ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
# =============================================================================
RUN cd /tmp && \
    git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && \
    mkdir -p ${MINGW_PREFIX}/include/nlohmann && \
    cp single_include/nlohmann/json.hpp ${MINGW_PREFIX}/include/nlohmann/ && \
    rm -rf /tmp/json && \
    echo "nlohmann/json ì„¤ì¹˜ ì™„ë£Œ"

RUN wget https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.14.1/httplib.h \
         -O ${MINGW_PREFIX}/include/httplib.h && \
    echo "cpp-httplib ì„¤ì¹˜ ì™„ë£Œ"

RUN cd /tmp && \
    git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && \
    cp -r include/spdlog ${MINGW_PREFIX}/include/ && \
    cd /tmp && rm -rf spdlog && \
    echo "spdlog ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# 12. ë¹Œë“œ ë° ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
# =============================================================================
RUN cat > /usr/local/bin/build-pulseone << 'BUILDEOF'
#!/bin/bash
echo "ðŸ—ï¸ PulseOne Collector Windows ë¹Œë“œ ì‹œìž‘..."

if [ ! -d "/src/collector" ]; then
    echo "âŒ /src/collector ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
    echo "ðŸ’¡ ì‚¬ìš©ë²•: docker run -v $(pwd):/src pulseone-windows-builder build-pulseone"
    exit 1
fi

cd /src/collector

echo "ðŸ” ë¹Œë“œ í™˜ê²½ í™•ì¸..."
echo "  ìž‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
echo "  Makefile.windows: $(ls -la Makefile.windows 2>/dev/null && echo "ì¡´ìž¬" || echo "ì—†ìŒ")"

echo "ðŸ§¹ ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬..."
make -f Makefile.windows clean 2>/dev/null || true

echo "ðŸ”¨ PulseOne Collector ì»´íŒŒì¼..."
if make -f Makefile.windows all; then
    echo ""
    echo "âœ… ë¹Œë“œ ì„±ê³µ!"
    
    if [ -f "bin-windows/collector.exe" ]; then
        echo "ðŸ“¦ ê²°ê³¼ íŒŒì¼: bin-windows/collector.exe"
        echo "ðŸ“ íŒŒì¼ í¬ê¸°: $(du -h bin-windows/collector.exe | cut -f1)"
        echo "ðŸ” íŒŒì¼ íƒ€ìž…: $(file bin-windows/collector.exe | cut -d: -f2-)"
        echo ""
        echo "ðŸŽ‰ Windows ì‹¤í–‰ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ðŸ’¾ íŒŒì¼ ìœ„ì¹˜: $(realpath bin-windows/collector.exe)"
    else
        echo "âš ï¸ ë¹Œë“œëŠ” ì„±ê³µí–ˆì§€ë§Œ ì‹¤í–‰ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        echo "ðŸ“ bin-windows/ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
        ls -la bin-windows/ 2>/dev/null || echo "  (ë””ë ‰í† ë¦¬ ì—†ìŒ)"
    fi
else
    echo ""
    echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
    echo "ðŸ” ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
    echo "  1. Makefile.windows íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€"
    echo "  2. ì†ŒìŠ¤ ì½”ë“œì— ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ì—†ëŠ”ì§€"
    echo "  3. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ëª¨ë‘ ì„¤ì¹˜ë˜ì–´ ìžˆëŠ”ì§€"
    exit 1
fi
BUILDEOF

RUN chmod +x /usr/local/bin/build-pulseone

RUN cat > /usr/local/bin/check-all-libs << 'CHECKEOF'
#!/bin/bash
echo "ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸:"
echo "=============================="
for lib in sqlite3 ssl crypto modbus hiredis paho-mqtt3c paho-mqtt3a quickjs bacnet; do
   if [ -f "/usr/x86_64-w64-mingw32/lib/lib${lib}.a" ]; then
       size=$(du -h "/usr/x86_64-w64-mingw32/lib/lib${lib}.a" | cut -f1)
       printf "  âœ… %-20s %s\n" "lib${lib}.a" "($size)"
   else
       printf "  âŒ %-20s\n" "lib${lib}.a"
   fi
done

if [ -f "/usr/x86_64-w64-mingw32/lib/libpaho-mqttpp3-static.a" ]; then
   size=$(du -h "/usr/x86_64-w64-mingw32/lib/libpaho-mqttpp3-static.a" | cut -f1)
   printf "  âœ… %-20s %s\n" "libpaho-mqttpp3-static.a" "($size)"
else
   printf "  âŒ %-20s\n" "libpaho-mqttpp3-static.a"
fi

echo ""
echo "MQTT í—¤ë” íŒŒì¼ í™•ì¸:"
echo "=============================="
for header in MQTTClient.h MQTTAsync.h; do
   if [ -f "/usr/x86_64-w64-mingw32/include/$header" ]; then
       echo "  âœ… $header"
   else
       echo "  âŒ $header"
   fi
done

if [ -d "/usr/x86_64-w64-mingw32/include/mqtt" ]; then
   echo "  âœ… mqtt/ ë””ë ‰í† ë¦¬"
   echo "  ðŸ“ C++ í—¤ë” ê°œìˆ˜: $(find /usr/x86_64-w64-mingw32/include/mqtt/ -name "*.h" | wc -l)"
else
   echo "  âŒ mqtt/ ë””ë ‰í† ë¦¬"
fi

echo ""
echo "Modbus í—¤ë” íŒŒì¼ í™•ì¸:"
echo "=============================="
if [ -d "/usr/x86_64-w64-mingw32/include/modbus" ]; then
   echo "  âœ… modbus/ ë””ë ‰í† ë¦¬"
   echo "  ðŸ“ í—¤ë” ê°œìˆ˜: $(find /usr/x86_64-w64-mingw32/include/modbus/ -name "*.h" | wc -l)"
else
   echo "  âŒ modbus/ ë””ë ‰í† ë¦¬"
fi

echo ""
echo "BACnet í—¤ë” íŒŒì¼ í™•ì¸:"
echo "=============================="
if [ -d "/usr/x86_64-w64-mingw32/include/bacnet" ]; then
   echo "  âœ… bacnet/ ë””ë ‰í† ë¦¬"
   echo "  ðŸ“ í—¤ë” ê°œìˆ˜: $(find /usr/x86_64-w64-mingw32/include/bacnet/ -name "*.h" | wc -l)"
   for header in bacenum.h bacdef.h bip.h config.h; do
       if [ -f "/usr/x86_64-w64-mingw32/include/bacnet/$header" ]; then
           echo "  âœ… $header"
       else
           echo "  âŒ $header"
       fi
   done
   
   if [ -f "/usr/x86_64-w64-mingw32/include/bacnet/basic/sys/platform.h" ]; then
       echo "  âœ… basic/sys/platform.h"
   else
       echo "  âŒ basic/sys/platform.h"
   fi
else
   echo "  âŒ bacnet/ ë””ë ‰í† ë¦¬"
fi

echo ""
echo "ðŸš€ PulseOne ë¹Œë“œ ì¤€ë¹„ ì™„ë£Œ!"
echo "ðŸ’¡ ë¹Œë“œ ëª…ë ¹ì–´: build-pulseone"
CHECKEOF

RUN chmod +x /usr/local/bin/check-all-libs

# =============================================================================
# 13. í™˜ê²½ ì„¤ì •
# =============================================================================
ENV PKG_CONFIG_PATH="${MINGW_PREFIX}/lib/pkgconfig"
ENV CPPFLAGS="-I${MINGW_PREFIX}/include"
ENV LDFLAGS="-L${MINGW_PREFIX}/lib"

WORKDIR /src

RUN cat > /usr/local/bin/entrypoint.sh << 'ENTRYEOF'
#!/bin/bash
echo "================================================"
echo "  PulseOne Windows Cross-Compile Environment"
echo "  ì™„ì „í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ + í—¤ë” êµ¬ì¡°"
echo "================================================"
/usr/local/bin/check-all-libs
echo ""
echo "ðŸš€ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
echo "  build-pulseone       - PulseOne Collector ë¹Œë“œ"
echo "  check-all-libs       - ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ í™•ì¸"
echo ""
echo "ðŸ’¡ ë¹Œë“œ ë°©ë²•:"
echo "  docker run --rm -v \$(pwd):/src pulseone-windows-builder build-pulseone"
echo ""
exec "$@"
ENTRYEOF

RUN chmod +x /usr/local/bin/entrypoint.sh

# ìµœì¢… ê²€ì¦
RUN FINAL_SIZE_KB=$(du -k ${MINGW_PREFIX}/lib/libbacnet.a | cut -f1) && \
    if [ "$FINAL_SIZE_KB" -lt 400 ]; then \
        echo "âŒ BACnet ìµœì¢… ê²€ì¦ ì‹¤íŒ¨: ${FINAL_SIZE_KB}KB"; \
        exit 1; \
    fi && \
    echo "âœ… BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ìµœì¢… ê²€ì¦ ì™„ë£Œ: ${FINAL_SIZE_KB}KB"

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["bash"]