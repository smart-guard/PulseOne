# collector/Dockerfile.dev - BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨ ë²„ì „
FROM gcc:latest

# ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libpqxx-dev libpq-dev libsqlite3-dev \
    curl git nodejs npm pkg-config \
    wget unzip \
    libssl-dev uuid-dev \
    autotools-dev autoconf automake libtool \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜ (ì•ˆì •ì ì¸ ë²„ì „)
# =============================================================================

# 1. libmodbus ì„¤ì¹˜
RUN echo "ğŸ”§ Installing libmodbus..." && \
    cd /tmp && git clone --depth 1 --branch v3.1.10 https://github.com/stephane/libmodbus.git && \
    cd libmodbus && ./autogen.sh && ./configure --prefix=/usr/local && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/libmodbus && echo "âœ… libmodbus installed"

# 2. hiredis ì„¤ì¹˜
RUN echo "ğŸ”§ Installing hiredis..." && \
    cd /tmp && git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_SSL=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/hiredis && echo "âœ… hiredis installed"

# 3. Paho MQTT C ì„¤ì¹˜
RUN echo "ğŸ”§ Installing Paho MQTT C..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_WITH_SSL=TRUE -DPAHO_BUILD_DOCUMENTATION=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.c && echo "âœ… Paho MQTT C installed"

# 4. nlohmann/json ì„¤ì¹˜ (ì†ŒìŠ¤ì—ì„œ ë¹Œë“œ)
RUN echo "ğŸ”§ Installing nlohmann/json..." && \
    cd /tmp && git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DJSON_BuildTests=OFF && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/json && echo "âœ… nlohmann/json installed"

# 5. spdlog ì„¤ì¹˜ (ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬)
RUN echo "ğŸ”§ Installing spdlog..." && \
    cd /tmp && git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DSPDLOG_BUILD_SHARED=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/spdlog && echo "âœ… spdlog installed"

# 6. BACnet Stack ì™„ì „ ì„¤ì¹˜ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„± ğŸ¯
RUN echo "ğŸ”§ Installing BACnet Stack with library..." && \
    cd /tmp && git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    cd bacnet-stack && \
    echo "ğŸ“‹ Configuring BACnet build..." && \
    # BACnet ë¹Œë“œ ì„¤ì •
    export BACNET_PORT=linux && \
    export BACNET_DEFINES="-DPRINT_ENABLED=1 -DBACAPP_ALL -DBACFILE -DINTRINSIC_REPORTING" && \
    echo "ğŸ”¨ Building BACnet Stack..." && \
    make clean && \
    make -j$(nproc) all && \
    echo "ğŸ“¦ Creating BACnet library..." && \
    # ëª¨ë“  ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ìƒì„±
    find . -name "*.o" -exec ar rcs libbacnet.a {} + && \
    echo "ğŸ“‚ Installing BACnet files..." && \
    # í—¤ë” íŒŒì¼ ì„¤ì¹˜
    mkdir -p /usr/local/include/bacnet && \
    find . -name "*.h" -exec cp --parents {} /usr/local/include/bacnet/ \; && \
    # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
    cp libbacnet.a /usr/local/lib/ && \
    # ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë“¤ë„ ì„¤ì¹˜ (ê°œë³„ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
    find . -name "*.o" -exec cp --parents {} /usr/local/include/bacnet/ \; && \
    # ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹œ ì—…ë°ì´íŠ¸
    ldconfig && \
    echo "ğŸ§¹ Cleaning up..." && \
    cd / && rm -rf /tmp/bacnet-stack && \
    echo "âœ… BACnet Stack completely installed"

# 7. BACnet pkg-config íŒŒì¼ ìƒì„±
RUN echo "ğŸ“ Creating BACnet pkg-config file..." && \
    mkdir -p /usr/local/lib/pkgconfig && \
    cat > /usr/local/lib/pkgconfig/bacnet.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: BACnet Stack
Description: BACnet protocol stack library
Version: 1.0.0
Libs: -L${libdir} -lbacnet
Cflags: -I${includedir}/bacnet -DPRINT_ENABLED=1 -DBACAPP_ALL -DBACFILE -DINTRINSIC_REPORTING
EOF

# =============================================================================
# ê¸°ì¡´ PKG-CONFIG íŒŒì¼ë“¤
# =============================================================================
RUN echo "ğŸ“ Creating other pkg-config files..." && \
    # libmodbus
    cat > /usr/local/lib/pkgconfig/libmodbus.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: libmodbus
Description: Modbus library
Version: 3.1.10
Libs: -L${libdir} -lmodbus
Cflags: -I${includedir}
EOF

# =============================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# =============================================================================
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV BACNET_PORT=linux
ENV BACNET_DEFINES="-DPRINT_ENABLED=1 -DBACAPP_ALL -DBACFILE -DINTRINSIC_REPORTING"

# =============================================================================
# ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ ê°œì„ 
# =============================================================================
RUN echo '#!/bin/bash' > /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”§ PulseOne Collector ê°œë°œ ë¹Œë“œ"' >> /usr/local/bin/dev-build.sh && \
    echo 'cd /app/collector' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸:"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  libmodbus: $(pkg-config --exists libmodbus && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet: $(pkg-config --exists bacnet && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet library: $(ls -la /usr/local/lib/libbacnet.a 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT: $(ls -la /usr/local/lib/libpaho-mqtt3c.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo ""' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘:"' >> /usr/local/bin/dev-build.sh && \
    echo 'make clean && make debug' >> /usr/local/bin/dev-build.sh && \
    chmod +x /usr/local/bin/dev-build.sh

# BACnet ì„¤ì¹˜ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash' > /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ” BACnet ì„¤ì¹˜ í™•ì¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“‚ í—¤ë” íŒŒì¼ë“¤:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'find /usr/local/include/bacnet -name "*.h" | head -10' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'ls -la /usr/local/lib/libbacnet.a' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬ê¸°:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'du -h /usr/local/lib/libbacnet.a' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ§ª pkg-config í…ŒìŠ¤íŠ¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --cflags bacnet' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --libs bacnet' >> /usr/local/bin/check-bacnet.sh && \
    chmod +x /usr/local/bin/check-bacnet.sh

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["/bin/bash"]

# =============================================================================
# ë¹Œë“œ ì™„ë£Œ í›„ í™•ì¸ì‚¬í•­ ì¶œë ¥
# =============================================================================
RUN echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!" && \
    echo "ğŸ“¦ ì„¤ì¹˜ëœ BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬:" && \
    ls -la /usr/local/lib/libbacnet.a && \
    echo "ğŸ“‹ BACnet í—¤ë” íŒŒì¼ ê°œìˆ˜:" && \
    find /usr/local/include/bacnet -name "*.h" | wc -l && \
    echo "âœ… ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ"