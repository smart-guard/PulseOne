# collector/Dockerfile.dev - BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ + Redis ì„¤ì • ì™„ì „ ìˆ˜ì • ë²„ì „
FROM gcc:12

# ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libpqxx-dev libpq-dev libsqlite3-dev \
    sqlite3 sqlite3-doc \
    curl git nodejs npm pkg-config \
    wget unzip vim nano \
    libssl-dev uuid-dev \
    autotools-dev autoconf automake libtool \
    tree htop procps \
    && rm -rf /var/lib/apt/lists/*

# SQLite ì„¤ì¹˜ í™•ì¸
RUN echo "ğŸ” SQLite ì„¤ì¹˜ í™•ì¸:" && \
    sqlite3 --version && \
    echo "âœ… SQLite3 ì„¤ì¹˜ ì™„ë£Œ"

# =============================================================================
# í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜ (ì•ˆì •ì ì¸ ë²„ì „)
# =============================================================================

# 1. libmodbus ì„¤ì¹˜
RUN echo "ğŸ”§ Installing libmodbus..." && \
    cd /tmp && git clone --depth 1 --branch v3.1.10 https://github.com/stephane/libmodbus.git && \
    cd libmodbus && ./autogen.sh && ./configure --prefix=/usr/local && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/libmodbus && echo "âœ… libmodbus installed"

# 2. hiredis ì„¤ì¹˜
RUN echo "ğŸ”§ Installing hiredis..." && \
    cd /tmp && git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_SSL=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/hiredis && echo "âœ… hiredis installed"

# 3. Paho MQTT C ì„¤ì¹˜
RUN echo "ğŸ”§ Installing Paho MQTT C..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_WITH_SSL=TRUE -DPAHO_BUILD_DOCUMENTATION=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.c && echo "âœ… Paho MQTT C installed"

# 3-1. Paho MQTT C++ ì„¤ì¹˜
RUN echo "ğŸ”§ Installing Paho MQTT C++..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.2 https://github.com/eclipse/paho.mqtt.cpp.git && \
    cd paho.mqtt.cpp && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local \
             -DPAHO_WITH_SSL=TRUE \
             -DPAHO_BUILD_DOCUMENTATION=FALSE \
             -DPAHO_BUILD_SAMPLES=FALSE \
             -DPAHO_BUILD_TESTS=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.cpp && echo "âœ… Paho MQTT C++ installed"

# 4. nlohmann/json ì„¤ì¹˜ (ì†ŒìŠ¤ì—ì„œ ë¹Œë“œ)
RUN echo "ğŸ”§ Installing nlohmann/json..." && \
    cd /tmp && git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DJSON_BuildTests=OFF && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/json && echo "âœ… nlohmann/json installed"

# 5. spdlog ì„¤ì¹˜ (ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬)
RUN echo "ğŸ”§ Installing spdlog..." && \
    cd /tmp && git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DSPDLOG_BUILD_SHARED=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/spdlog && echo "âœ… spdlog installed"

# ğŸ”¥ 6. BACnet Stack ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ ë° ì„¤ì¹˜ (ì •í™•í•œ ê²½ë¡œ ì ìš©)
# ì‹¤ì œë¡œ ì„±ê³µí•œ ë°©ë²•ê³¼ ì •í™•íˆ ë™ì¼í•˜ê²Œ ì„¤ì¹˜
RUN echo "ğŸ”§ Installing BACnet Stack with correct build method..." && \
    cd /tmp && \
    git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    cd bacnet-stack && \
    \
    echo "ğŸ”¨ Building BACnet library with correct parameters..." && \
    make BACNET_PORT=linux BACDL_DEFINE=-DBACDL_BIP=1 library && \
    \
    echo "ğŸ“¦ Installing BACnet library..." && \
    # ğŸ”¥ ì •í™•í•œ ê²½ë¡œ: apps/lib/libbacnet.a
    echo "ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ìœ„ì¹˜ í™•ì¸:" && \
    find . -name "libbacnet.a" -type f && \
    echo "âœ… Found apps/lib/libbacnet.a - copying to /usr/local/lib/" && \
    cp apps/lib/libbacnet.a /usr/local/lib/ && \
    \
    echo "ğŸ“‚ Installing BACnet headers..." && \
    # ğŸ”¥ ì •í™•í•œ ë°©ë²•: src/bacnet ë””ë ‰í† ë¦¬ ì „ì²´ ë³µì‚¬
    cp -r src/bacnet /usr/local/include/ && \
    \
    echo "ğŸ”„ Updating library cache..." && \
    ldconfig && \
    \
    echo "ğŸ” ì„¤ì¹˜ í™•ì¸..." && \
    ls -la /usr/local/lib/libbacnet.a && \
    echo "ğŸ“‚ BACnet headers installed:" && \
    ls -la /usr/local/include/bacnet/ | head -10 && \
    echo "ğŸ“Š ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬ê¸°:" && \
    du -h /usr/local/lib/libbacnet.a && \
    \
    echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬..." && \
    cd / && rm -rf /tmp/bacnet-stack && \
    echo "âœ… BACnet Stack library and headers installed successfully"

# 7. BACnet pkg-config íŒŒì¼ ìƒì„± (ìˆ˜ì •ë¨)
RUN echo "ğŸ“ Creating BACnet pkg-config file..." && \
    mkdir -p /usr/local/lib/pkgconfig && \
    cat > /usr/local/lib/pkgconfig/bacnet.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: BACnet Stack
Description: BACnet protocol library for building automation
Version: 1.0.0
Libs: -L${libdir} -lbacnet -lm
Cflags: -I${includedir} -DPRINT_ENABLED=1 -DBACAPP_ALL -DINTRINSIC_REPORTING
EOF

# 8. libmodbus pkg-config íŒŒì¼ ìƒì„±
RUN echo "ğŸ“ Creating other pkg-config files..." && \
    cat > /usr/local/lib/pkgconfig/libmodbus.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: libmodbus
Description: Modbus library
Version: 3.1.10
Libs: -L${libdir} -lmodbus
Cflags: -I${includedir}
EOF

# 9. Paho MQTT C++ pkg-config íŒŒì¼ ìƒì„±
RUN echo "ğŸ“ Creating Paho MQTT C++ pkg-config file..." && \
    cat > /usr/local/lib/pkgconfig/paho-mqttpp3.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: Paho MQTT C++
Description: Eclipse Paho MQTT C++ Client Library
Version: 1.3.2
Requires: paho-mqtt3c
Libs: -L${libdir} -lpaho-mqttpp3
Cflags: -I${includedir}
EOF

# =============================================================================
# ğŸ”¥ Redis ì„¤ì • íŒŒì¼ ë° í™˜ê²½ ë³€ìˆ˜ ë¯¸ë¦¬ ì„¤ì •
# =============================================================================

# Docker ê°œë°œ í™˜ê²½ìš© Redis ì„¤ì • íŒŒì¼ ìƒì„±
RUN echo "ğŸ“ Creating Docker-specific Redis configuration..." && \
    mkdir -p /app/collector/config && \
    cat > /app/collector/config/redis_docker.env << 'EOF'
# Docker ê°œë°œ í™˜ê²½ìš© Redis ì„¤ì •
REDIS_HOST=host.docker.internal
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_SSL=false
REDIS_CONNECTION_TIMEOUT_MS=5000
REDIS_COMMAND_TIMEOUT_MS=3000
REDIS_MAX_CONNECTIONS=20
REDIS_MIN_CONNECTIONS=5
REDIS_RETRY_ATTEMPTS=3
REDIS_RETRY_DELAY_MS=1000

# ê°œë°œ ëª¨ë“œ ì„¤ì •
REDIS_TEST_MODE=true
REDIS_FLUSH_ON_START=false
REDIS_AUTO_PING=true
REDIS_PING_INTERVAL_S=30

# Docker Compose ì—°ê²° (ì„ íƒì )
REDIS_HOST_COMPOSE=redis
REDIS_HOST_EXTERNAL=host.docker.internal
EOF

# Docker í™˜ê²½ ê°ì§€ ë° ìë™ Redis ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash' > /usr/local/bin/setup-docker-redis.sh && \
    echo 'echo "ğŸ”§ Docker Redis ì„¤ì • ìŠ¤í¬ë¦½íŠ¸"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'REDIS_CONFIG_FILE="/app/collector/config/redis.env"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'DOCKER_REDIS_CONFIG="/app/collector/config/redis_docker.env"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '# Docker í™˜ê²½ ê°ì§€' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'if [ -f /.dockerenv ]; then' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    echo "âœ… Docker í™˜ê²½ ê°ì§€ë¨"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    ' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    # Dockerìš© Redis ì„¤ì • ë³µì‚¬' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    if [ -f "$DOCKER_REDIS_CONFIG" ]; then' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '        echo "ğŸ“‹ Docker ì „ìš© Redis ì„¤ì • ì ìš©..."' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '        cp "$DOCKER_REDIS_CONFIG" "$REDIS_CONFIG_FILE"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '        echo "âœ… Redis ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ: host.docker.internal:6379"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    else' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '        echo "âš ï¸  Docker Redis ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    fi' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    ' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    export REDIS_HOST=host.docker.internal' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    export REDIS_PORT=6379' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    echo "ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •: REDIS_HOST=$REDIS_HOST"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'else' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '    echo "â„¹ï¸  Docker í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì • ìœ ì§€"' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'fi' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '' >> /usr/local/bin/setup-docker-redis.sh && \
    echo '# Redis ì—°ê²° í…ŒìŠ¤íŠ¸' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'echo "ğŸ” Redis ì—°ê²° í…ŒìŠ¤íŠ¸..."' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'redis_host=${REDIS_HOST:-localhost}' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'redis_port=${REDIS_PORT:-6379}' >> /usr/local/bin/setup-docker-redis.sh && \
    echo 'timeout 3 bash -c "</dev/tcp/$redis_host/$redis_port" 2>/dev/null && echo "âœ… Redis ì—°ê²° ì„±ê³µ: $redis_host:$redis_port" || echo "âŒ Redis ì—°ê²° ì‹¤íŒ¨: $redis_host:$redis_port"' >> /usr/local/bin/setup-docker-redis.sh && \
    chmod +x /usr/local/bin/setup-docker-redis.sh

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV BACNET_PORT=linux
ENV BACDL_DEFINE="-DBACDL_BIP=1"

# ğŸ”¥ Redis ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì •
ENV REDIS_HOST=host.docker.internal
ENV REDIS_PORT=6379
ENV REDIS_DB=0
ENV REDIS_TEST_MODE=true

# ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (BACnet + Redis í™•ì¸ ê°œì„ )
RUN echo '#!/bin/bash' > /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”§ PulseOne Collector ê°œë°œ ë¹Œë“œ"' >> /usr/local/bin/dev-build.sh && \
    echo 'cd /app/collector' >> /usr/local/bin/dev-build.sh && \
    echo '' >> /usr/local/bin/dev-build.sh && \
    echo '# Docker Redis ì„¤ì • ìë™ ì ìš©' >> /usr/local/bin/dev-build.sh && \
    echo 'setup-docker-redis.sh' >> /usr/local/bin/dev-build.sh && \
    echo '' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸:"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  libmodbus: $(pkg-config --exists libmodbus && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  hiredis: $(ls -la /usr/local/lib/libhiredis* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet lib: $(ls -la /usr/local/lib/libbacnet.a 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet headers: $(ls -d /usr/local/include/bacnet 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT C: $(ls -la /usr/local/lib/libpaho-mqtt3c.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT C++: $(ls -la /usr/local/lib/libpaho-mqttpp*.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Redis ì„¤ì •: $REDIS_HOST:$REDIS_PORT"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo ""' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘:"' >> /usr/local/bin/dev-build.sh && \
    echo 'make clean && make debug' >> /usr/local/bin/dev-build.sh && \
    chmod +x /usr/local/bin/dev-build.sh

# BACnet ì„¤ì¹˜ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ (í–¥ìƒëœ ë²„ì „)
RUN echo '#!/bin/bash' > /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ” BACnet ì„¤ì¹˜ í™•ì¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo ""' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'ls -la /usr/local/lib/libbacnet.a 2>/dev/null || echo "âŒ libbacnet.a ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo ""' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“‚ í—¤ë” ë””ë ‰í† ë¦¬:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'ls -la /usr/local/include/bacnet/ 2>/dev/null | head -10 || echo "âŒ í—¤ë” ë””ë ‰í† ë¦¬ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo ""' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ” ì¤‘ìš”í•œ í—¤ë” íŒŒì¼ë“¤:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'for header in "bip.h" "datalink.h" "address.h" "bacdcode.h" "npdu.h" "apdu.h"; do' >> /usr/local/bin/check-bacnet.sh && \
    echo '  find /usr/local/include/bacnet -name "$header" 2>/dev/null && echo "âœ… $header found" || echo "âŒ $header missing"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'done' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo ""' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ§ª pkg-config í…ŒìŠ¤íŠ¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --cflags bacnet 2>/dev/null || echo "âŒ pkg-config ì„¤ì • ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --libs bacnet 2>/dev/null || echo "âŒ pkg-config ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo ""' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸ (nm ëª…ë ¹ì–´):"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'nm /usr/local/lib/libbacnet.a | grep -E "(bip_init|bvlc_send_pdu|address_init)" | head -5 || echo "âŒ ì£¼ìš” ì‹¬ë³¼ë“¤ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    chmod +x /usr/local/bin/check-bacnet.sh

# BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ (ì‹¤ì œ ê²½í—˜ ë°˜ì˜)
RUN echo '#!/bin/bash' > /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo "ğŸ” BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‹¬ë³¼ í…ŒìŠ¤íŠ¸:"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo ""' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo "ğŸ“Š ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ë³´:"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'ls -la /usr/local/lib/libbacnet.a 2>/dev/null || echo "âŒ libbacnet.a ì—†ìŒ"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'du -h /usr/local/lib/libbacnet.a 2>/dev/null || echo "âŒ íŒŒì¼ í¬ê¸° í™•ì¸ ë¶ˆê°€"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo ""' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo "ğŸ“‹ í•µì‹¬ BACnet í•¨ìˆ˜ë“¤ í™•ì¸:"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'SYMBOLS=("bip_init" "bvlc_send_pdu" "bip_send_pdu" "address_init" "address_own_device_id_set" "bip_send_mpdu")' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'for symbol in "${SYMBOLS[@]}"; do' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  if nm /usr/local/lib/libbacnet.a 2>/dev/null | grep -q "T $symbol"; then' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '    echo "âœ… $symbol - Found"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  else' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '    echo "âŒ $symbol - Missing"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  fi' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'done' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo ""' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo "ğŸ” ì „ì²´ ì‹¬ë³¼ ê°œìˆ˜:"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'nm /usr/local/lib/libbacnet.a 2>/dev/null | grep "T " | wc -l || echo "âŒ ì‹¬ë³¼ ì½ê¸° ì‹¤íŒ¨"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo ""' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'echo "ğŸ§ª ì‹¤ì œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ì»´íŒŒì¼):"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'cat > /tmp/test_bacnet.c << "TESTEOF"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '#include <stdio.h>' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'extern int bip_init(char *ifname);' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'int main() {' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '    printf("BACnet library linkage test passed\n");' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '    return 0;' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '}' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'TESTEOF' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'if gcc -o /tmp/test_bacnet /tmp/test_bacnet.c -lbacnet -lm 2>/dev/null; then' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  echo "âœ… BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ì„±ê³µ"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  /tmp/test_bacnet 2>/dev/null && echo "âœ… ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì„±ê³µ"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'else' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo '  echo "âŒ BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ì‹¤íŒ¨"' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'fi' >> /usr/local/bin/test-bacnet-symbols.sh && \
    echo 'rm -f /tmp/test_bacnet /tmp/test_bacnet.c 2>/dev/null' >> /usr/local/bin/test-bacnet-symbols.sh && \
    chmod +x /usr/local/bin/test-bacnet-symbols.sh

# Redis ì—°ê²° í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
RUN echo '#!/bin/bash' > /usr/local/bin/test-redis-connection.sh && \
    echo 'echo "ğŸ” Redis ì—°ê²° í…ŒìŠ¤íŠ¸"' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'echo "=================="' >> /usr/local/bin/test-redis-connection.sh && \
    echo '' >> /usr/local/bin/test-redis-connection.sh && \
    echo '# í™˜ê²½ ë³€ìˆ˜ í™•ì¸' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'REDIS_HOST=${REDIS_HOST:-host.docker.internal}' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'REDIS_PORT=${REDIS_PORT:-6379}' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'echo "ğŸŒ ì„¤ì •: $REDIS_HOST:$REDIS_PORT"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '' >> /usr/local/bin/test-redis-connection.sh && \
    echo '# ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'echo "ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸..."' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'timeout 3 bash -c "</dev/tcp/$REDIS_HOST/$REDIS_PORT" 2>/dev/null && {' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì„±ê³µ"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '} || {' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "   - Redis ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "   - í˜¸ìŠ¤íŠ¸ ì£¼ì†Œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    exit 1' >> /usr/local/bin/test-redis-connection.sh && \
    echo '}' >> /usr/local/bin/test-redis-connection.sh && \
    echo '' >> /usr/local/bin/test-redis-connection.sh && \
    echo '# hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'echo "ğŸ§ª hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸..."' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'cat > /tmp/test_redis.c << "TESTEOF"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '#include <stdio.h>' >> /usr/local/bin/test-redis-connection.sh && \
    echo '#include <hiredis/hiredis.h>' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'int main() {' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    printf("hiredis library linkage test passed\n");' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    return 0;' >> /usr/local/bin/test-redis-connection.sh && \
    echo '}' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'TESTEOF' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'if gcc -o /tmp/test_redis /tmp/test_redis.c -lhiredis 2>/dev/null; then' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "âœ… hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ì„±ê³µ"' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    /tmp/test_redis && echo "âœ… hiredis ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ì„±ê³µ"' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'else' >> /usr/local/bin/test-redis-connection.sh && \
    echo '    echo "âŒ hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í‚¹ ì‹¤íŒ¨"' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'fi' >> /usr/local/bin/test-redis-connection.sh && \
    echo 'rm -f /tmp/test_redis /tmp/test_redis.c 2>/dev/null' >> /usr/local/bin/test-redis-connection.sh && \
    chmod +x /usr/local/bin/test-redis-connection.sh

# Bash í”„ë¡¬í”„íŠ¸ ê°œì„  ë° ê°œë°œ í™˜ê²½ ë©”ì‹œì§€ (Redis ì •ë³´ ì¶”ê°€)
RUN echo 'export PS1="\[\033[01;32m\]\u@collector-dev\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "ğŸš€ PulseOne Collector Development Environment Ready!"' >> /root/.bashrc && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  - libmodbus (Modbus í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - Paho MQTT C (MQTT í†µì‹  - C)"' >> /root/.bashrc && \
    echo 'echo "  - Paho MQTT C++ (MQTT í†µì‹  - C++)"' >> /root/.bashrc && \
    echo 'echo "  - BACnet Stack (BACnet í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - hiredis (Redis í´ë¼ì´ì–¸íŠ¸) - ${REDIS_HOST:-host.docker.internal}:${REDIS_PORT:-6379}"' >> /root/.bashrc && \
    echo 'echo "  - nlohmann/json (JSON íŒŒì‹±)"' >> /root/.bashrc && \
    echo 'echo "  - spdlog (ë¡œê¹…)"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "ğŸ”§ ìœ ìš©í•œ ëª…ë ¹ì–´ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  dev-build.sh              - ê°œë°œ ë¹Œë“œ (Redis ì„¤ì • ìë™ ì ìš©)"' >> /root/.bashrc && \
    echo 'echo "  setup-docker-redis.sh     - Redis ì„¤ì • ìë™ êµ¬ì„±"' >> /root/.bashrc && \
    echo 'echo "  test-redis-connection.sh  - Redis ì—°ê²° í…ŒìŠ¤íŠ¸"' >> /root/.bashrc && \
    echo 'echo "  check-bacnet.sh           - BACnet ì„¤ì¹˜ í™•ì¸"' >> /root/.bashrc && \
    echo 'echo "  test-bacnet-symbols.sh    - BACnet ì‹¬ë³¼ í…ŒìŠ¤íŠ¸"' >> /root/.bashrc && \
    echo 'echo "  make help                 - Makefile ë„ì›€ë§"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV CC=gcc CXX=g++
ENV CFLAGS="-std=c11 -Wall -Wextra"
ENV CXXFLAGS="-std=c++17 -Wall -Wextra"

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ Redis ì„¤ì • ì ìš©
RUN echo '#!/bin/bash' > /docker-entrypoint.sh && \
    echo 'echo "ğŸš€ PulseOne Collector ì»¨í…Œì´ë„ˆ ì‹œì‘"' >> /docker-entrypoint.sh && \
    echo 'echo "================================="' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# Docker Redis ì„¤ì • ìë™ ì ìš©' >> /docker-entrypoint.sh && \
    echo 'if [ -f /usr/local/bin/setup-docker-redis.sh ]; then' >> /docker-entrypoint.sh && \
    echo '    /usr/local/bin/setup-docker-redis.sh' >> /docker-entrypoint.sh && \
    echo 'fi' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# ì „ë‹¬ëœ ëª…ë ¹ì–´ ì‹¤í–‰' >> /docker-entrypoint.sh && \
    echo 'exec "$@"' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# ê¸°ë³¸ ëª…ë ¹ì–´
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/bin/bash"]

# ë¹Œë“œ ì™„ë£Œ í›„ ìµœì¢… í™•ì¸
RUN echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!" && \
    echo "ğŸ“‹ ìµœì¢… í™•ì¸:" && \
    echo "  BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬:" && \
    ls -la /usr/local/lib/libbacnet.a 2>/dev/null && \
    echo "  BACnet í—¤ë” íŒŒì¼ ê°œìˆ˜:" && \
    find /usr/local/include/bacnet -name "*.h" 2>/dev/null | wc -l && \
    echo "  hiredis ë¼ì´ë¸ŒëŸ¬ë¦¬:" && \
    ls -la /usr/local/lib/libhiredis* 2>/dev/null | head -3 && \
    echo "  MQTT C++ í—¤ë” í™•ì¸:" && \
    find /usr/local/include -name "async_client.h" 2>/dev/null | wc -l && \
    echo "  Redis ì„¤ì •:" && \
    ls -la /app/collector/config/redis_docker.env 2>/dev/null && \
    echo "âœ… ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° Redis ì„¤ì • ì™„ë£Œ!"