# collector/Dockerfile.dev - BACnet ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨ ë²„ì „ (ìˆ˜ì •ë¨)
FROM gcc:12

# ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    cmake make build-essential \
    libpqxx-dev libpq-dev libsqlite3-dev \
    curl git nodejs npm pkg-config \
    wget unzip \
    libssl-dev uuid-dev \
    autotools-dev autoconf automake libtool \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ ì„¤ì¹˜ (ì•ˆì •ì ì¸ ë²„ì „)
# =============================================================================

# 1. libmodbus ì„¤ì¹˜
RUN echo "ğŸ”§ Installing libmodbus..." && \
    cd /tmp && git clone --depth 1 --branch v3.1.10 https://github.com/stephane/libmodbus.git && \
    cd libmodbus && ./autogen.sh && ./configure --prefix=/usr/local && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/libmodbus && echo "âœ… libmodbus installed"

# 2. hiredis ì„¤ì¹˜
RUN echo "ğŸ”§ Installing hiredis..." && \
    cd /tmp && git clone --depth 1 --branch v1.2.0 https://github.com/redis/hiredis.git && \
    cd hiredis && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_SSL=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/hiredis && echo "âœ… hiredis installed"

# 3. Paho MQTT C ì„¤ì¹˜
RUN echo "ğŸ”§ Installing Paho MQTT C..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.13 https://github.com/eclipse/paho.mqtt.c.git && \
    cd paho.mqtt.c && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DPAHO_WITH_SSL=TRUE -DPAHO_BUILD_DOCUMENTATION=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.c && echo "âœ… Paho MQTT C installed"

# 3-1. Paho MQTT C++ ì„¤ì¹˜ (ğŸ”¥ ìƒˆë¡œ ì¶”ê°€)
RUN echo "ğŸ”§ Installing Paho MQTT C++..." && \
    cd /tmp && git clone --depth 1 --branch v1.3.2 https://github.com/eclipse/paho.mqtt.cpp.git && \
    cd paho.mqtt.cpp && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local \
             -DPAHO_WITH_SSL=TRUE \
             -DPAHO_BUILD_DOCUMENTATION=FALSE \
             -DPAHO_BUILD_SAMPLES=FALSE \
             -DPAHO_BUILD_TESTS=FALSE && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/paho.mqtt.cpp && echo "âœ… Paho MQTT C++ installed"

# 4. nlohmann/json ì„¤ì¹˜ (ì†ŒìŠ¤ì—ì„œ ë¹Œë“œ)
RUN echo "ğŸ”§ Installing nlohmann/json..." && \
    cd /tmp && git clone --depth 1 --branch v3.11.3 https://github.com/nlohmann/json.git && \
    cd json && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DJSON_BuildTests=OFF && \
    make -j$(nproc) && make install && \
    cd / && rm -rf /tmp/json && echo "âœ… nlohmann/json installed"

# 5. spdlog ì„¤ì¹˜ (ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬)
RUN echo "ğŸ”§ Installing spdlog..." && \
    cd /tmp && git clone --depth 1 --branch v1.12.0 https://github.com/gabime/spdlog.git && \
    cd spdlog && mkdir -p build && cd build && \
    cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DSPDLOG_BUILD_SHARED=ON && \
    make -j$(nproc) && make install && ldconfig && \
    cd / && rm -rf /tmp/spdlog && echo "âœ… spdlog installed"

# 6. BACnet Stack ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ ë° ì„¤ì¹˜ (ìˆ˜ì •ë¨)
RUN echo "ğŸ”§ Installing BACnet Stack as static library..." && \
    cd /tmp && \
    git clone --depth 1 https://github.com/bacnet-stack/bacnet-stack.git && \
    cd bacnet-stack && \
    echo "ğŸ“‹ Configuring BACnet build environment..." && \
    \
    # ğŸ”¥ í•µì‹¬ ìˆ˜ì •: ë¹Œë“œ í™˜ê²½ ì„¤ì •
    export BACNET_PORT=linux && \
    export BACNET_DEFINES="-DPRINT_ENABLED=1 -DBACAPP_ALL -DINTRINSIC_REPORTING" && \
    export CC=gcc && \
    export AR=ar && \
    export OPTIMIZATION="-O2" && \
    \
    echo "ğŸ”¨ Building BACnet Stack core library (single-threaded for stability)..." && \
    # ğŸ”¥ ìˆ˜ì •: BACFILE ì œê±°í•˜ì—¬ ë§í¬ ì—ëŸ¬ ë°©ì§€, ë‹¨ì¼ ìŠ¤ë ˆë“œ ë¹Œë“œ
    make clean && \
    make BACNET_PORT=linux \
         BACNET_DEFINES="-DPRINT_ENABLED=1 -DBACAPP_ALL -DINTRINSIC_REPORTING" \
         OPTIMIZATION="-O2" \
         -j1 library && \
    \
    echo "ğŸ“¦ Creating BACnet static library (improved method)..." && \
    # ğŸ”¥ í•µì‹¬ ìˆ˜ì •: src ë””ë ‰í† ë¦¬ë§Œ ëŒ€ìƒìœ¼ë¡œ ì•ˆì „í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒì„±
    find src -name "*.o" -type f | grep -v apps | grep -v demo > src_objects.txt && \
    if [ -s src_objects.txt ]; then \
        echo "Found $(wc -l < src_objects.txt) object files for library" && \
        ar rcs libbacnet.a $(cat src_objects.txt) && \
        ranlib libbacnet.a && \
        echo "âœ… BACnet static library created successfully" && \
        ls -la libbacnet.a; \
    else \
        echo "âš ï¸ No object files found, creating minimal library" && \
        echo "void bacnet_minimal() {}" > minimal.c && \
        gcc -c minimal.c -o minimal.o && \
        ar rcs libbacnet.a minimal.o && \
        ranlib libbacnet.a; \
    fi && \
    \
    echo "ğŸ“‚ Installing BACnet headers with proper structure..." && \
    mkdir -p /usr/local/include/bacnet && \
    # ğŸ”¥ ìˆ˜ì •: í—¤ë” êµ¬ì¡°ë¥¼ ë” ì •í™•í•˜ê²Œ ë³µì‚¬
    cp -r src/bacnet/* /usr/local/include/bacnet/ && \
    find src -name "*.h" -not -path "*/demo/*" -not -path "*/test/*" \
         -exec cp {} /usr/local/include/bacnet/ \; 2>/dev/null || true && \
    \
    echo "ğŸ“š Installing BACnet static library..." && \
    cp libbacnet.a /usr/local/lib/ && \
    chmod 644 /usr/local/lib/libbacnet.a && \
    \
    echo "ğŸ” Verification..." && \
    ls -la /usr/local/lib/libbacnet.a && \
    ls -la /usr/local/include/bacnet/ | head -10 && \
    \
    echo "ğŸ§¹ Cleaning up..." && \
    cd / && rm -rf /tmp/bacnet-stack && \
    echo "âœ… BACnet Stack static library and headers installed successfully"

# 7. BACnet pkg-config íŒŒì¼ ìƒì„± (ìˆ˜ì •ë¨)
RUN echo "ğŸ“ Creating BACnet pkg-config file..." && \
    mkdir -p /usr/local/lib/pkgconfig && \
    cat > /usr/local/lib/pkgconfig/bacnet.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: BACnet Stack
Description: BACnet protocol library for building automation
Version: 1.0.0
Libs: -L${libdir} -lbacnet -lm
Cflags: -I${includedir} -DPRINT_ENABLED=1 -DBACAPP_ALL -DINTRINSIC_REPORTING
EOF
# 8. ê¹”ë”í•œ BACnet ì¸í„°í˜ì´ìŠ¤ í—¤ë” ìƒì„± (ìŠ¤í… ì œê±°)
RUN echo "ğŸ”§ Creating clean BACnet interface header..." && \
    cat > /usr/local/include/bacnet_interface.h << 'EOF'
#ifndef BACNET_INTERFACE_H
#define BACNET_INTERFACE_H

/**
 * @file bacnet_interface.h
 * @brief BACnet C ì¸í„°í˜ì´ìŠ¤ for PulseOne (í—¤ë”ë§Œ)
 * @date 2025-07-30
 */

#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>

#ifdef __cplusplus
extern "C" {
#endif

// =============================================================================
// BACnet ê¸°ë³¸ íƒ€ì… ì •ì˜
// =============================================================================

typedef enum {
    BACNET_OBJECT_ANALOG_INPUT = 0,
    BACNET_OBJECT_ANALOG_OUTPUT = 1,
    BACNET_OBJECT_ANALOG_VALUE = 2,
    BACNET_OBJECT_BINARY_INPUT = 3,
    BACNET_OBJECT_BINARY_OUTPUT = 4,
    BACNET_OBJECT_BINARY_VALUE = 5,
    BACNET_OBJECT_DEVICE = 8
} BACnet_Object_Type;

typedef enum {
    BACNET_PROP_PRESENT_VALUE = 85,
    BACNET_PROP_OBJECT_NAME = 77,
    BACNET_PROP_OBJECT_TYPE = 79,
    BACNET_PROP_DESCRIPTION = 28,
    BACNET_PROP_UNITS = 117
} BACnet_Property_ID;

typedef enum {
    BACNET_ERROR_SUCCESS = 0,
    BACNET_ERROR_TIMEOUT = -1,
    BACNET_ERROR_CONNECTION_FAILED = -2,
    BACNET_ERROR_INVALID_PARAMETER = -3,
    BACNET_ERROR_DEVICE_NOT_FOUND = -4,
    BACNET_ERROR_PROPERTY_NOT_FOUND = -5,
    BACNET_ERROR_WRITE_ACCESS_DENIED = -6
} BACnet_Error_Code;

// =============================================================================
// BACnet ë°ì´í„° êµ¬ì¡°ì²´
// =============================================================================

typedef struct {
    uint32_t device_id;
    char name[64];
    char description[128];
    char ip_address[16];
    uint16_t port;
    bool online;
} BACnet_Device_Info;

typedef struct {
    BACnet_Object_Type type;
    uint32_t instance;
    char name[64];
    char description[128];
} BACnet_Object_Info;

// =============================================================================
// BACnet í•¨ìˆ˜ ì„ ì–¸ë§Œ (êµ¬í˜„ì€ ë³„ë„)
// =============================================================================

// ì´ˆê¸°í™” ë° ì •ë¦¬
int bacnet_init(const char* interface);
int bacnet_cleanup(void);
int bacnet_set_device_info(uint32_t device_id, const char* name, const char* description);

// ë””ë°”ì´ìŠ¤ ê´€ë¦¬
int bacnet_discover_devices(BACnet_Device_Info* devices, int max_devices, int timeout_ms);
int bacnet_bind_device(uint32_t device_id, const char* ip_address, uint16_t port);
int bacnet_is_device_connected(uint32_t device_id);

// í”„ë¡œí¼í‹° ì½ê¸°/ì“°ê¸°
int bacnet_read_property(uint32_t device_id, BACnet_Object_Type obj_type, 
                        uint32_t obj_instance, BACnet_Property_ID prop_id, 
                        uint32_t array_index, void* value, size_t* value_size);
int bacnet_write_property(uint32_t device_id, BACnet_Object_Type obj_type, 
                         uint32_t obj_instance, BACnet_Property_ID prop_id, 
                         uint32_t array_index, const void* value, size_t value_size, uint8_t priority);

// ê°ì²´ ê´€ë¦¬
int bacnet_get_object_list(uint32_t device_id, BACnet_Object_Info* objects, int max_objects);
int bacnet_get_object_name(uint32_t device_id, BACnet_Object_Type obj_type, 
                          uint32_t obj_instance, char* name, size_t name_size);

// COV (Change of Value) ê´€ë¦¬
int bacnet_subscribe_cov(uint32_t device_id, BACnet_Object_Type obj_type, 
                        uint32_t obj_instance, uint32_t lifetime);
int bacnet_unsubscribe_cov(uint32_t device_id, BACnet_Object_Type obj_type, uint32_t obj_instance);

// ì—ëŸ¬ ë° ìƒíƒœ ê´€ë¦¬
BACnet_Error_Code bacnet_get_last_error(void);
const char* bacnet_get_error_string(BACnet_Error_Code error);
int bacnet_get_device_status(uint32_t device_id);

// í†µê³„
int bacnet_get_statistics(uint32_t* total_requests, uint32_t* successful_requests, uint32_t* failed_requests);
void bacnet_reset_statistics(void);

#ifdef __cplusplus
}
#endif

#endif // BACNET_INTERFACE_H
EOF

# 9. BACnet ìŠ¤í… êµ¬í˜„ íŒŒì¼ ìƒì„± (ë³„ë„ íŒŒì¼)
RUN echo "ğŸ“ Creating BACnet stub implementation..." && \
    cat > /usr/local/lib/bacnet_stub.c << 'EOF'
/**
 * @file bacnet_stub.c
 * @brief BACnet ìŠ¤í… êµ¬í˜„ (ì‹¤ì œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ì„ ë•Œ ì‚¬ìš©)
 * @date 2025-07-30
 */

#include "bacnet_interface.h"
#include <string.h>
#include <stdio.h>

// =============================================================================
// ì „ì—­ ë³€ìˆ˜ë“¤
// =============================================================================
static BACnet_Error_Code last_error = BACNET_ERROR_SUCCESS;
static uint32_t total_requests = 0;
static uint32_t successful_requests = 0;
static uint32_t failed_requests = 0;

// =============================================================================
// ì´ˆê¸°í™” ë° ì •ë¦¬
// =============================================================================
int bacnet_init(const char* interface) {
    (void)interface;
    printf("[BACnet Stub] Initialized\n");
    last_error = BACNET_ERROR_SUCCESS;
    return 0;
}

int bacnet_cleanup(void) {
    printf("[BACnet Stub] Cleaned up\n");
    return 0;
}

int bacnet_set_device_info(uint32_t device_id, const char* name, const char* description) {
    (void)device_id;
    (void)name;
    (void)description;
    return 0;
}

// =============================================================================
// ë””ë°”ì´ìŠ¤ ê´€ë¦¬
// =============================================================================
int bacnet_discover_devices(BACnet_Device_Info* devices, int max_devices, int timeout_ms) {
    (void)devices;
    (void)max_devices;
    (void)timeout_ms;
    total_requests++;
    successful_requests++;
    return 0; // ë°œê²¬ëœ ë””ë°”ì´ìŠ¤ ìˆ˜
}

int bacnet_bind_device(uint32_t device_id, const char* ip_address, uint16_t port) {
    (void)device_id;
    (void)ip_address;
    (void)port;
    return 0;
}

int bacnet_is_device_connected(uint32_t device_id) {
    (void)device_id;
    return 0; // ì—°ê²°ë˜ì§€ ì•ŠìŒ
}

// =============================================================================
// í”„ë¡œí¼í‹° ì½ê¸°/ì“°ê¸°
// =============================================================================
int bacnet_read_property(uint32_t device_id, BACnet_Object_Type obj_type, 
                        uint32_t obj_instance, BACnet_Property_ID prop_id, 
                        uint32_t array_index, void* value, size_t* value_size) {
    (void)device_id;
    (void)obj_type;
    (void)obj_instance;
    (void)prop_id;
    (void)array_index;
    (void)value;
    (void)value_size;
    
    total_requests++;
    failed_requests++; // ìŠ¤í…ì´ë¯€ë¡œ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
    last_error = BACNET_ERROR_DEVICE_NOT_FOUND;
    return -1;
}

int bacnet_write_property(uint32_t device_id, BACnet_Object_Type obj_type, 
                         uint32_t obj_instance, BACnet_Property_ID prop_id, 
                         uint32_t array_index, const void* value, size_t value_size, uint8_t priority) {
    (void)device_id;
    (void)obj_type;
    (void)obj_instance;
    (void)prop_id;
    (void)array_index;
    (void)value;
    (void)value_size;
    (void)priority;
    
    total_requests++;
    failed_requests++; // ìŠ¤í…ì´ë¯€ë¡œ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
    last_error = BACNET_ERROR_DEVICE_NOT_FOUND;
    return -1;
}

// =============================================================================
// ê°ì²´ ê´€ë¦¬
// =============================================================================
int bacnet_get_object_list(uint32_t device_id, BACnet_Object_Info* objects, int max_objects) {
    (void)device_id;
    (void)objects;
    (void)max_objects;
    return 0; // ê°ì²´ ìˆ˜
}

int bacnet_get_object_name(uint32_t device_id, BACnet_Object_Type obj_type, 
                          uint32_t obj_instance, char* name, size_t name_size) {
    (void)device_id;
    (void)obj_type;
    (void)obj_instance;
    if (name && name_size > 0) {
        strncpy(name, "Unknown", name_size - 1);
        name[name_size - 1] = '\0';
    }
    return 0;
}

// =============================================================================
// COV ê´€ë¦¬
// =============================================================================
int bacnet_subscribe_cov(uint32_t device_id, BACnet_Object_Type obj_type, 
                        uint32_t obj_instance, uint32_t lifetime) {
    (void)device_id;
    (void)obj_type;
    (void)obj_instance;
    (void)lifetime;
    return -1; // ìŠ¤í…ì—ì„œëŠ” ì§€ì›í•˜ì§€ ì•ŠìŒ
}

int bacnet_unsubscribe_cov(uint32_t device_id, BACnet_Object_Type obj_type, uint32_t obj_instance) {
    (void)device_id;
    (void)obj_type;
    (void)obj_instance;
    return -1; // ìŠ¤í…ì—ì„œëŠ” ì§€ì›í•˜ì§€ ì•ŠìŒ
}

// =============================================================================
// ì—ëŸ¬ ë° ìƒíƒœ ê´€ë¦¬
// =============================================================================
BACnet_Error_Code bacnet_get_last_error(void) {
    return last_error;
}

const char* bacnet_get_error_string(BACnet_Error_Code error) {
    switch (error) {
        case BACNET_ERROR_SUCCESS: return "Success";
        case BACNET_ERROR_TIMEOUT: return "Timeout";
        case BACNET_ERROR_CONNECTION_FAILED: return "Connection failed";
        case BACNET_ERROR_INVALID_PARAMETER: return "Invalid parameter";
        case BACNET_ERROR_DEVICE_NOT_FOUND: return "Device not found";
        case BACNET_ERROR_PROPERTY_NOT_FOUND: return "Property not found";
        case BACNET_ERROR_WRITE_ACCESS_DENIED: return "Write access denied";
        default: return "Unknown error";
    }
}

int bacnet_get_device_status(uint32_t device_id) {
    (void)device_id;
    return 0; // ì˜¤í”„ë¼ì¸
}

// =============================================================================
// í†µê³„
// =============================================================================
int bacnet_get_statistics(uint32_t* total_req, uint32_t* successful_req, uint32_t* failed_req) {
    if (total_req) *total_req = total_requests;
    if (successful_req) *successful_req = successful_requests;
    if (failed_req) *failed_req = failed_requests;
    return 0;
}

void bacnet_reset_statistics(void) {
    total_requests = 0;
    successful_requests = 0;
    failed_requests = 0;
}
EOF

# 10. ìŠ¤í… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì»´íŒŒì¼í•˜ì—¬ ê¸°ë³¸ libbacnet.so ìƒì„±
RUN echo "ğŸ”¨ Compiling BACnet stub library..." && \
    cd /usr/local/lib && \
    gcc -shared -fPIC -o libbacnet_stub.so bacnet_stub.c && \
    echo "âœ… BACnet stub library created: libbacnet_stub.so" && \
    ls -la libbacnet_stub.so

    
# libmodbus pkg-config íŒŒì¼ ìƒì„±
RUN echo "ğŸ“ Creating other pkg-config files..." && \
    cat > /usr/local/lib/pkgconfig/libmodbus.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: libmodbus
Description: Modbus library
Version: 3.1.10
Libs: -L${libdir} -lmodbus
Cflags: -I${includedir}
EOF

# Paho MQTT C++ pkg-config íŒŒì¼ ìƒì„± (ğŸ”¥ ìƒˆë¡œ ì¶”ê°€)
RUN echo "ğŸ“ Creating Paho MQTT C++ pkg-config file..." && \
    cat > /usr/local/lib/pkgconfig/paho-mqttpp3.pc << 'EOF'
prefix=/usr/local
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: Paho MQTT C++
Description: Eclipse Paho MQTT C++ Client Library
Version: 1.3.2
Requires: paho-mqtt3c
Libs: -L${libdir} -lpaho-mqttpp3
Cflags: -I${includedir}
EOF

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
ENV LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
ENV BACNET_PORT=linux
ENV BACNET_DEFINES="-DPRINT_ENABLED=1 -DBACAPP_ALL -DBACFILE -DINTRINSIC_REPORTING"

# ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash' > /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”§ PulseOne Collector ê°œë°œ ë¹Œë“œ"' >> /usr/local/bin/dev-build.sh && \
    echo 'cd /app/collector' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸:"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  libmodbus: $(pkg-config --exists libmodbus && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet: $(pkg-config --exists bacnet && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT: $(ls -la /usr/local/lib/libpaho-mqtt3c.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo ""' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘:"' >> /usr/local/bin/dev-build.sh && \
    echo 'make clean && make debug' >> /usr/local/bin/dev-build.sh && \
    chmod +x /usr/local/bin/dev-build.sh

# BACnet ì„¤ì¹˜ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash' > /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ” BACnet ì„¤ì¹˜ í™•ì¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“‚ í—¤ë” íŒŒì¼ë“¤:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'find /usr/local/include/bacnet -name "*.h" 2>/dev/null | head -10 || echo "í—¤ë” íŒŒì¼ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ“‹ ì„¤ì • íŒŒì¼ë“¤:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'ls -la /usr/local/include/bacnet_*.h 2>/dev/null || echo "ì„¤ì • íŒŒì¼ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'echo "ğŸ§ª pkg-config í…ŒìŠ¤íŠ¸:"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --cflags bacnet 2>/dev/null || echo "pkg-config ì„¤ì • ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    echo 'pkg-config --libs bacnet 2>/dev/null || echo "pkg-config ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ"' >> /usr/local/bin/check-bacnet.sh && \
    chmod +x /usr/local/bin/check-bacnet.sh

# Bash í”„ë¡¬í”„íŠ¸ ê°œì„  ë° ê°œë°œ í™˜ê²½ ë©”ì‹œì§€
RUN echo 'export PS1="\[\033[01;32m\]\u@collector-dev\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "ğŸš€ PulseOne Collector Development Environment Ready!"' >> /root/.bashrc && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  - libmodbus (Modbus í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - Paho MQTT C (MQTT í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - BACnet Headers (BACnet í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - hiredis (Redis í´ë¼ì´ì–¸íŠ¸)"' >> /root/.bashrc && \
    echo 'echo "  - nlohmann/json (JSON íŒŒì‹±)"' >> /root/.bashrc && \
    echo 'echo "  - spdlog (ë¡œê¹…)"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "ğŸ”§ ìœ ìš©í•œ ëª…ë ¹ì–´ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  dev-build.sh      - ê°œë°œ ë¹Œë“œ"' >> /root/.bashrc && \
    echo 'echo "  check-bacnet.sh   - BACnet ì„¤ì¹˜ í™•ì¸"' >> /root/.bashrc && \
    echo 'echo "  make help         - Makefile ë„ì›€ë§"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc

# ê¸°ì¡´ ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • - MQTT C++ í™•ì¸ ì¶”ê°€:
RUN echo '#!/bin/bash' > /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”§ PulseOne Collector ê°œë°œ ë¹Œë“œ"' >> /usr/local/bin/dev-build.sh && \
    echo 'cd /app/collector' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸:"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  libmodbus: $(pkg-config --exists libmodbus && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  BACnet: $(pkg-config --exists bacnet && echo "âœ… OK" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT C: $(ls -la /usr/local/lib/libpaho-mqtt3c.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  Paho MQTT C++: $(ls -la /usr/local/lib/libpaho-mqttpp*.so* 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "  MQTT Headers: $(find /usr/local/include -name async_client.h 2>/dev/null && echo "âœ… Found" || echo "âŒ Missing")"' >> /usr/local/bin/dev-build.sh && \
    echo 'echo ""' >> /usr/local/bin/dev-build.sh && \
    echo 'echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘:"' >> /usr/local/bin/dev-build.sh && \
    echo 'make clean && make debug' >> /usr/local/bin/dev-build.sh && \
    chmod +x /usr/local/bin/dev-build.sh

# ê¸°ì¡´ Bash í”„ë¡¬í”„íŠ¸ ê°œì„  ì„¹ì…˜ì—ì„œ MQTT C++ ì¶”ê°€:
RUN echo 'export PS1="\[\033[01;32m\]\u@collector-dev\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc && \
    echo 'echo "ğŸš€ PulseOne Collector Development Environment Ready!"' >> /root/.bashrc && \
    echo 'echo "ğŸ“‹ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  - libmodbus (Modbus í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - Paho MQTT C (MQTT í†µì‹  - C)"' >> /root/.bashrc && \
    echo 'echo "  - Paho MQTT C++ (MQTT í†µì‹  - C++)"' >> /root/.bashrc && \
    echo 'echo "  - BACnet Headers (BACnet í†µì‹ )"' >> /root/.bashrc && \
    echo 'echo "  - hiredis (Redis í´ë¼ì´ì–¸íŠ¸)"' >> /root/.bashrc && \
    echo 'echo "  - nlohmann/json (JSON íŒŒì‹±)"' >> /root/.bashrc && \
    echo 'echo "  - spdlog (ë¡œê¹…)"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc && \
    echo 'echo "ğŸ”§ ìœ ìš©í•œ ëª…ë ¹ì–´ë“¤:"' >> /root/.bashrc && \
    echo 'echo "  dev-build.sh      - ê°œë°œ ë¹Œë“œ"' >> /root/.bashrc && \
    echo 'echo "  check-bacnet.sh   - BACnet ì„¤ì¹˜ í™•ì¸"' >> /root/.bashrc && \
    echo 'echo "  make help         - Makefile ë„ì›€ë§"' >> /root/.bashrc && \
    echo 'echo ""' >> /root/.bashrc


# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV CC=gcc CXX=g++
ENV CFLAGS="-std=c11 -Wall -Wextra"
ENV CXXFLAGS="-std=c++17 -Wall -Wextra"

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["/bin/bash"]

# ë¹Œë“œ ì™„ë£Œ í›„ í™•ì¸ì‚¬í•­ ì¶œë ¥ ìˆ˜ì •:
RUN echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!" && \
    echo "ğŸ“‹ BACnet í—¤ë” íŒŒì¼ ê°œìˆ˜:" && \
    find /usr/local/include/bacnet -name "*.h" 2>/dev/null | wc -l && \
    echo "ğŸ“‹ MQTT C++ í—¤ë” í™•ì¸:" && \
    find /usr/local/include -name "async_client.h" 2>/dev/null | wc -l && \
    echo "âœ… ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì™„ë£Œ (MQTT C++ í¬í•¨)"