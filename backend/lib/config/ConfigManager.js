// ============================================================================
// config/ConfigManager.js
// ÌôòÍ≤ΩÎ≥ÄÏàò Ï†ÑÏö© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú (C++ ConfigManager Ìå®ÌÑ¥ Ï†ÅÏö©)
// ============================================================================

const path = require('path');
const fs = require('fs');
const dotenv = require('dotenv');

/**
 * ÌôòÍ≤ΩÎ≥ÄÏàò Í¥ÄÎ¶¨Ïûê ÌÅ¥ÎûòÏä§ (Ïã±Í∏ÄÌÜ§)
 * Î™®Îì† .env ÌååÏùºÎì§ÏùÑ ÌÜµÌï© Í¥ÄÎ¶¨ÌïòÍ≥† Ï†ÑÏó≠ ÌôòÍ≤ΩÎ≥ÄÏàò Ï†úÍ≥µ
 */
class ConfigManager {
    constructor() {
        this.configDir = __dirname;
        this.loaded = false;
        this.loadedFiles = [];
        this.env = new Map();
        this.lastLoad = new Map();
        this.logger = console;
        
        // ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº Ïö∞ÏÑ†ÏàúÏúÑ Ï†ïÏùò
        this.envFilePriority = [
            '.env',              // Í∏∞Î≥∏ ÌôòÍ≤ΩÎ≥ÄÏàò
            'database.env',      // Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï
            'redis.env',         // Redis ÏÑ§Ï†ï
            'timeseries.env',    // InfluxDB ÏÑ§Ï†ï
            'messaging.env',     // RabbitMQ ÏÑ§Ï†ï
            'security.env'       // Î≥¥Ïïà ÏÑ§Ï†ï
        ];
        
        // ÏûêÎèô Ï¥àÍ∏∞Ìôî
        this.initialize();
    }

    // ========================================================================
    // Ïã±Í∏ÄÌÜ§ Ìå®ÌÑ¥
    // ========================================================================

    static getInstance() {
        if (!ConfigManager.instance) {
            ConfigManager.instance = new ConfigManager();
        }
        return ConfigManager.instance;
    }

    // ========================================================================
    // Ï¥àÍ∏∞Ìôî Î∞è Î°úÎî©
    // ========================================================================

    /**
     * ÌôòÍ≤ΩÎ≥ÄÏàò Ï¥àÍ∏∞Ìôî Î∞è Î°úÎî©
     */
    initialize() {
        if (this.loaded) {
            return this.env;
        }

        this.logger.log('üîß ConfigManager ÌôòÍ≤ΩÎ≥ÄÏàò Î°úÎî© ÏãúÏûë...');

        try {
            // 1. Ïö∞ÏÑ†ÏàúÏúÑÏóê Îî∞Îùº ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº Î°úÎìú
            this.loadEnvironmentFiles();

            // 2. ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÎÇ¥Î∂Ä MapÏúºÎ°ú Î≥µÏÇ¨
            this.copyProcessEnv();

            this.loaded = true;
            this.logger.log(`‚úÖ ÌôòÍ≤ΩÎ≥ÄÏàò Î°úÎî© ÏôÑÎ£å (${this.loadedFiles.length}Í∞ú ÌååÏùº)`);
            
            // 3. Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑú ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ Ï∂úÎ†•
            if (this.get('NODE_ENV') === 'development') {
                this.printDebugInfo();
            }

            return this.env;

        } catch (error) {
            this.logger.error('‚ùå ConfigManager ÌôòÍ≤ΩÎ≥ÄÏàò Î°úÎî© Ïã§Ìå®:', error.message);
            throw error;
        }
    }

    /**
     * ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùºÎì§ Î°úÎìú (Ïö∞ÏÑ†ÏàúÏúÑ Í∏∞Î∞ò)
     */
    loadEnvironmentFiles() {
        // Ïö∞ÏÑ†ÏàúÏúÑ ÌååÏùºÎì§ Î®ºÏ†Ä Î°úÎìú
        this.envFilePriority.forEach(filename => {
            this.loadEnvFile(filename);
        });

        // Ï∂îÍ∞Ä .env ÌååÏùºÎì§ ÏûêÎèô ÌÉêÏßÄ Î∞è Î°úÎìú
        const additionalFiles = this.findAdditionalEnvFiles();
        additionalFiles.forEach(filename => {
            if (!this.envFilePriority.includes(filename)) {
                this.loadEnvFile(filename);
            }
        });
    }

    /**
     * Ï∂îÍ∞Ä ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÌÉêÏßÄ
     */
    findAdditionalEnvFiles() {
        const envFiles = [];
        
        try {
            const files = fs.readdirSync(this.configDir);
            
            // .envÎ°ú ÎÅùÎÇòÎäî ÌååÏùºÎì§ ÌïÑÌÑ∞ÎßÅ
            const additionalEnvFiles = files
                .filter(file => file.endsWith('.env'))
                .sort();
            
            envFiles.push(...additionalEnvFiles);

        } catch (error) {
            this.logger.warn('‚ö†Ô∏è config ÎîîÎ†âÌÜ†Î¶¨ ÏùΩÍ∏∞ Ïã§Ìå®:', error.message);
        }

        return envFiles;
    }

    /**
     * Í∞úÎ≥Ñ ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº Î°úÎìú
     */
    loadEnvFile(filename) {
        const filePath = path.join(this.configDir, filename);
        
        if (!fs.existsSync(filePath)) {
            if (filename === '.env') {
                this.logger.warn(`‚ö†Ô∏è Í∏∞Î≥∏ ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏóÜÏùå: ${filename}`);
            }
            return false;
        }

        try {
            const result = dotenv.config({ path: filePath });
            
            if (result.error) {
                this.logger.warn(`‚ö†Ô∏è ${filename} Î°úÎî© Ïò§Î•ò:`, result.error.message);
                return false;
            }

            this.loadedFiles.push(filename);
            this.lastLoad.set(filename, Date.now());
            this.logger.log(`‚úÖ Î°úÎìúÎê®: ${filename}`);
            return true;

        } catch (error) {
            this.logger.error(`‚ùå ${filename} Î°úÎî© Ïã§Ìå®:`, error.message);
            return false;
        }
    }

    /**
     * process.envÎ•º ÎÇ¥Î∂Ä MapÏúºÎ°ú Î≥µÏÇ¨
     */
    copyProcessEnv() {
        // Î™®Îì† ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÎÇ¥Î∂Ä MapÏúºÎ°ú Î≥µÏÇ¨
        Object.keys(process.env).forEach(key => {
            this.env.set(key, process.env[key]);
        });
    }

    // ========================================================================
    // ÌôòÍ≤ΩÎ≥ÄÏàò Ï°∞Ìöå Î©îÏÑúÎìúÎì§
    // ========================================================================

    /**
     * ÌôòÍ≤ΩÎ≥ÄÏàò Í∞í Ï°∞Ìöå (Í∏∞Î≥∏Í∞í ÏßÄÏõê)
     */
    get(key, defaultValue = undefined) {
        const value = this.env.get(key) || process.env[key];
        return value !== undefined ? value : defaultValue;
    }

    /**
     * ÌôòÍ≤ΩÎ≥ÄÏàò Í∞í ÏÑ§Ï†ï (Î©îÎ™®Î¶¨ÏÉÅÏóêÏÑúÎßå)
     */
    set(key, value) {
        this.env.set(key, value);
        process.env[key] = value;
    }

    /**
     * Boolean Í∞í Ï°∞Ìöå
     */
    getBoolean(key, defaultValue = false) {
        const value = this.get(key);
        if (value === undefined) return defaultValue;
        
        return value.toLowerCase() === 'true' || value === '1';
    }

    /**
     * Number Í∞í Ï°∞Ìöå
     */
    getNumber(key, defaultValue = 0) {
        const value = this.get(key);
        if (value === undefined) return defaultValue;
        
        const num = parseInt(value, 10);
        return isNaN(num) ? defaultValue : num;
    }

    /**
     * Î∞∞Ïó¥ Í∞í Ï°∞Ìöå (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)
     */
    getArray(key, defaultValue = []) {
        const value = this.get(key);
        if (!value) return defaultValue;
        
        return value.split(',').map(item => item.trim()).filter(item => item);
    }

    /**
     * ÌïÑÏàò ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏
     */
    require(key) {
        const value = this.get(key);
        if (value === undefined || value === '') {
            throw new Error(`ÌïÑÏàò ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå: ${key}`);
        }
        return value;
    }

    /**
     * Ïó¨Îü¨ ÌôòÍ≤ΩÎ≥ÄÏàò ÏùºÍ¥Ñ ÌôïÏù∏
     */
    requireAll(keys) {
        const missing = [];
        const values = {};

        keys.forEach(key => {
            try {
                values[key] = this.require(key);
            } catch (error) {
                missing.push(key);
            }
        });

        if (missing.length > 0) {
            throw new Error(`ÎàÑÎùΩÎêú ÌïÑÏàò ÌôòÍ≤ΩÎ≥ÄÏàòÎì§: ${missing.join(', ')}`);
        }

        return values;
    }

    // ========================================================================
    // ÏÑ§Ï†ï Í∑∏Î£πÎ≥Ñ Ï°∞Ìöå Î©îÏÑúÎìúÎì§
    // ========================================================================

    /**
     * ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getEnvironmentConfig() {
        const env = this.get('NODE_ENV', 'development');
        
        return {
            isDevelopment: env === 'development',
            isProduction: env === 'production',
            isTest: env === 'test',
            isStaging: env === 'staging',
            environment: env
        };
    }

    /**
     * Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getDatabaseConfig() {
        return {
            type: this.get('DATABASE_TYPE', 'SQLITE'),
            enabled: this.getBoolean('DATABASE_ENABLED', true),
            
            // SQLite
            sqlite: {
                enabled: this.getBoolean('SQLITE_ENABLED', true),
                path: this.get('SQLITE_DB_PATH', './data/db/pulseone.db'),
                timeout: this.getNumber('SQLITE_TIMEOUT_MS', 30000),
                journalMode: this.get('SQLITE_JOURNAL_MODE', 'WAL'),
                foreignKeys: this.getBoolean('SQLITE_FOREIGN_KEYS', true)
            },

            // PostgreSQL
            postgresql: {
                enabled: this.getBoolean('POSTGRESQL_ENABLED', false),
                host: this.get('POSTGRESQL_HOST', 'localhost'),
                port: this.getNumber('POSTGRESQL_PORT', 5432),
                database: this.get('POSTGRESQL_DATABASE', 'pulseone'),
                username: this.get('POSTGRESQL_USERNAME', 'postgres'),
                password: this.get('POSTGRESQL_PASSWORD', '')
            }
        };
    }

    /**
     * Redis ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getRedisConfig() {
        return {
            enabled: this.getBoolean('REDIS_PRIMARY_ENABLED', true),
            host: this.get('REDIS_PRIMARY_HOST', 'localhost'),
            port: this.getNumber('REDIS_PRIMARY_PORT', 6379),
            password: this.get('REDIS_PRIMARY_PASSWORD', ''),
            db: this.getNumber('REDIS_PRIMARY_DB', 0),
            poolSize: this.getNumber('REDIS_POOL_SIZE', 20),
            keyPrefix: this.get('REDIS_KEY_PREFIX', 'pulseone:'),
            testMode: this.getBoolean('REDIS_TEST_MODE', false)
        };
    }

    /**
     * ÏÑúÎ≤Ñ ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getServerConfig() {
        return {
            port: this.getNumber('BACKEND_PORT', 3000),
            host: this.get('BACKEND_HOST', '0.0.0.0'),
            env: this.get('NODE_ENV', 'development'),
            logLevel: this.get('LOG_LEVEL', 'info')
        };
    }

    /**
     * InfluxDB ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getInfluxConfig() {
        return {
            enabled: this.getBoolean('INFLUX_ENABLED', false),
            host: this.get('INFLUXDB_HOST', 'localhost'),
            port: this.getNumber('INFLUXDB_PORT', 8086),
            token: this.get('INFLUXDB_TOKEN', ''),
            org: this.get('INFLUXDB_ORG', 'pulseone'),
            bucket: this.get('INFLUXDB_BUCKET', 'timeseries')
        };
    }

    /**
     * RabbitMQ ÏÑ§Ï†ï Ï°∞Ìöå
     */
    getRabbitMQConfig() {
        return {
            enabled: this.getBoolean('RABBITMQ_ENABLED', false),
            host: this.get('RABBITMQ_HOST', 'localhost'),
            port: this.getNumber('RABBITMQ_PORT', 5672),
            user: this.get('RABBITMQ_USER', 'guest'),
            password: this.get('RABBITMQ_PASSWORD', 'guest'),
            vhost: this.get('RABBITMQ_VHOST', '/'),
            managementPort: this.getNumber('RABBITMQ_MANAGEMENT_PORT', 15672)
        };
    }

    // ========================================================================
    // Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìúÎì§
    // ========================================================================

    /**
     * ÌôòÍ≤ΩÎ≥ÄÏàò Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
     */
    validate(validationRules) {
        const errors = [];

        Object.entries(validationRules).forEach(([key, rules]) => {
            const value = this.get(key);

            // Required Ï≤¥ÌÅ¨
            if (rules.required && (value === undefined || value === '')) {
                errors.push(`${key}: ÌïÑÏàò Í∞íÏù¥ ÎàÑÎùΩÎê®`);
                return;
            }

            // Type Ï≤¥ÌÅ¨
            if (value && rules.type) {
                switch (rules.type) {
                    case 'number':
                        if (isNaN(Number(value))) {
                            errors.push(`${key}: Ïà´Ïûê ÌòïÏãùÏù¥ ÏïÑÎãò (ÌòÑÏû¨Í∞í: ${value})`);
                        }
                        break;
                    case 'boolean':
                        if (!['true', 'false', '1', '0'].includes(value.toLowerCase())) {
                            errors.push(`${key}: boolean ÌòïÏãùÏù¥ ÏïÑÎãò (ÌòÑÏû¨Í∞í: ${value})`);
                        }
                        break;
                    case 'email':
                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                            errors.push(`${key}: Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãò (ÌòÑÏû¨Í∞í: ${value})`);
                        }
                        break;
                }
            }

            // Enum Ï≤¥ÌÅ¨
            if (value && rules.enum && !rules.enum.includes(value)) {
                errors.push(`${key}: ÌóàÏö©ÎêòÏßÄ ÏïäÎäî Í∞í (ÌòÑÏû¨Í∞í: ${value}, ÌóàÏö©Í∞í: ${rules.enum.join(', ')})`);
            }
        });

        if (errors.length > 0) {
            throw new Error(`ÌôòÍ≤ΩÎ≥ÄÏàò Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù Ïã§Ìå®:\n${errors.join('\n')}`);
        }

        return true;
    }

    /**
     * ÎîîÎ≤ÑÍπÖÏö© Ï†ïÎ≥¥ Ï∂úÎ†•
     */
    printDebugInfo() {
        this.logger.log('\nüìã ConfigManager ÌôòÍ≤ΩÎ≥ÄÏàò ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥:');
        this.logger.log(`   Î°úÎî©Îêú ÌååÏùºÎì§: ${this.loadedFiles.join(', ')}`);
        this.logger.log(`   NODE_ENV: ${this.get('NODE_ENV')}`);
        this.logger.log(`   DATABASE_TYPE: ${this.get('DATABASE_TYPE')}`);
        this.logger.log(`   REDIS_PRIMARY_HOST: ${this.get('REDIS_PRIMARY_HOST')}`);
        this.logger.log(`   BACKEND_PORT: ${this.get('BACKEND_PORT')}`);
        this.logger.log('');
    }

    /**
     * Î™®Îì† ÌôòÍ≤ΩÎ≥ÄÏàò Ï°∞Ìöå (ÎîîÎ≤ÑÍπÖÏö©)
     */
    getAll() {
        const result = {};
        this.env.forEach((value, key) => {
            result[key] = value;
        });
        return result;
    }

    /**
     * Î°úÎìúÎêú ÌååÏùº Î™©Î°ù Ï°∞Ìöå
     */
    getLoadedFiles() {
        return [...this.loadedFiles];
    }

    /**
     * Ïû¨Î°úÎìú (Í∞úÎ∞ú Ï§ë ÏÑ§Ï†ï Î≥ÄÍ≤Ω Ïãú)
     */
    reload() {
        this.loaded = false;
        this.loadedFiles = [];
        this.env.clear();
        this.lastLoad.clear();
        return this.initialize();
    }
}

// Ïã±Í∏ÄÌÜ§ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ± Î∞è ÎÇ¥Î≥¥ÎÇ¥Í∏∞
const configManager = ConfigManager.getInstance();

// Í∏∞Ï°¥ Î∞©Ïãù Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú ÏßÅÏ†ë export (redis.js Îì±ÏóêÏÑú ÏÇ¨Ïö©)
module.exports = {
    // ConfigManager Ïù∏Ïä§ÌÑ¥Ïä§
    getInstance: () => configManager,

    // Í∏∞Ï°¥ Î∞©Ïãù Ìò∏ÌôòÏÑ± (redis.jsÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî Ïù¥Î¶ÑÎì§)
    REDIS_MAIN_HOST: configManager.get('REDIS_PRIMARY_HOST', 'localhost'),
    REDIS_MAIN_PORT: configManager.get('REDIS_PRIMARY_PORT', '6379'),
    REDIS_MAIN_PASSWORD: configManager.get('REDIS_PRIMARY_PASSWORD', ''),

    // ÏûêÏ£º ÏÇ¨Ïö©ÎêòÎäî ÌôòÍ≤ΩÎ≥ÄÏàòÎì§
    NODE_ENV: configManager.get('NODE_ENV', 'development'),
    LOG_LEVEL: configManager.get('LOG_LEVEL', 'info'),
    BACKEND_PORT: configManager.getNumber('BACKEND_PORT', 3000),
    DATABASE_TYPE: configManager.get('DATABASE_TYPE', 'SQLITE'),

    // Ìó¨Ìçº Ìï®ÏàòÎì§ (Ï†ÑÏó≠ÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•)
    get: (key, defaultValue) => configManager.get(key, defaultValue),
    getBoolean: (key, defaultValue) => configManager.getBoolean(key, defaultValue),
    getNumber: (key, defaultValue) => configManager.getNumber(key, defaultValue),
    require: (key) => configManager.require(key),
    
    // ÏÑ§Ï†ï Í∑∏Î£πÎì§
    getDatabaseConfig: () => configManager.getDatabaseConfig(),
    getRedisConfig: () => configManager.getRedisConfig(),
    getServerConfig: () => configManager.getServerConfig(),
    getInfluxConfig: () => configManager.getInfluxConfig(),
    getRabbitMQConfig: () => configManager.getRabbitMQConfig()
};