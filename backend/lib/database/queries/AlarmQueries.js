// =============================================================================
// backend/lib/database/queries/AlarmQueries.js
// Î™®Îì† ÏïåÎûå Í¥ÄÎ†® SQL ÏøºÎ¶¨Î•º Ìïú Í≥≥Ïóê Î™®Ïùå (C++ SQLQueries.h Ìå®ÌÑ¥)
// üîß INSERT Ïò§Î•ò ÏàòÏ†ï: ÌïÑÏàò Ïª¨ÎüºÎßå ÏÇ¨Ïö©ÌïòÏó¨ Ïª¨Îüº/Í∞í Í∞úÏàò ÏùºÏπò
// =============================================================================

class AlarmQueries {
    
    // =========================================================================
    // üî• AlarmRule ÏøºÎ¶¨Îì§ - INSERT Ïò§Î•ò ÏàòÏ†ïÎê®
    // =========================================================================
    static AlarmRule = {
        
        // Í∏∞Î≥∏ CRUD
        FIND_ALL: `
            SELECT * FROM alarm_rules 
            WHERE tenant_id = ?
            ORDER BY priority DESC, created_at DESC
        `,
        
        FIND_BY_ID: `
            SELECT * FROM alarm_rules 
            WHERE id = ? AND tenant_id = ?
        `,
        
        // üî• ÏàòÏ†ï: ÌïÑÏàò Ïª¨Îüº 15Í∞úÎßå ÏÇ¨Ïö©ÌïòÏó¨ INSERT Ïò§Î•ò Ìï¥Í≤∞
        CREATE: `
            INSERT INTO alarm_rules (
                tenant_id, name, description, target_type, target_id,
                alarm_type, severity, high_limit, low_limit, deadband,
                message_template, priority, is_enabled, auto_clear,
                notification_enabled
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `,
        
        // üî• ÏàòÏ†ï: ÏóÖÎç∞Ïù¥Ìä∏ÎèÑ ÎèôÏùºÌïú 15Í∞ú Ïª¨Îüº ÏÇ¨Ïö©
        UPDATE: `
            UPDATE alarm_rules SET
                name = ?, description = ?, target_type = ?, target_id = ?,
                alarm_type = ?, severity = ?, high_limit = ?, low_limit = ?,
                deadband = ?, message_template = ?, priority = ?, is_enabled = ?,
                auto_clear = ?, notification_enabled = ?, updated_at = CURRENT_TIMESTAMP
            WHERE id = ? AND tenant_id = ?
        `,
        
        DELETE: `
            DELETE FROM alarm_rules 
            WHERE id = ? AND tenant_id = ?
        `,
        
        EXISTS: `
            SELECT 1 FROM alarm_rules 
            WHERE id = ? AND tenant_id = ? 
            LIMIT 1
        `,
        
        EXISTS_SIMPLE: `
            SELECT 1 FROM alarm_rules 
            WHERE id = ? 
            LIMIT 1
        `,
        
        // ÌäπÌôî ÏøºÎ¶¨Îì§
        FIND_BY_TARGET: `
            SELECT * FROM alarm_rules 
            WHERE target_type = ? AND target_id = ? AND tenant_id = ? AND is_enabled = 1
            ORDER BY priority DESC
        `,
        
        FIND_ENABLED: `
            SELECT * FROM alarm_rules 
            WHERE is_enabled = 1 AND tenant_id = ?
            ORDER BY priority DESC, severity DESC
        `,
        
        FIND_BY_TYPE: `
            SELECT * FROM alarm_rules 
            WHERE alarm_type = ? AND tenant_id = ?
            ORDER BY priority DESC
        `,
        
        FIND_BY_SEVERITY: `
            SELECT * FROM alarm_rules 
            WHERE severity = ? AND tenant_id = ?
            ORDER BY priority DESC
        `,
        
        // ÌÜµÍ≥Ñ ÏøºÎ¶¨Îì§
        COUNT_TOTAL: `
            SELECT COUNT(*) as total_rules FROM alarm_rules 
            WHERE tenant_id = ?
        `,
        
        COUNT_ENABLED: `
            SELECT COUNT(*) as enabled_rules FROM alarm_rules 
            WHERE tenant_id = ? AND is_enabled = 1
        `,
        
        STATS_BY_SEVERITY: `
            SELECT 
                severity, 
                COUNT(*) as count,
                SUM(CASE WHEN is_enabled = 1 THEN 1 ELSE 0 END) as enabled_count
            FROM alarm_rules 
            WHERE tenant_id = ? 
            GROUP BY severity
            ORDER BY count DESC
        `,
        
        STATS_BY_TYPE: `
            SELECT 
                alarm_type, 
                COUNT(*) as count,
                SUM(CASE WHEN is_enabled = 1 THEN 1 ELSE 0 END) as enabled_count
            FROM alarm_rules 
            WHERE tenant_id = ? 
            GROUP BY alarm_type
            ORDER BY count DESC
        `,
        
        STATS_SUMMARY: `
            SELECT 
                COUNT(*) as total_rules,
                SUM(CASE WHEN is_enabled = 1 THEN 1 ELSE 0 END) as enabled_rules,
                COUNT(DISTINCT target_type) as target_types,
                COUNT(DISTINCT alarm_type) as alarm_types,
                COUNT(DISTINCT severity) as severity_levels
            FROM alarm_rules 
            WHERE tenant_id = ?
        `,
        
        // Í≤ÄÏÉâ ÏøºÎ¶¨
        SEARCH: `
            SELECT * FROM alarm_rules 
            WHERE tenant_id = ? AND (
                name LIKE ? OR 
                description LIKE ? OR
                target_type LIKE ?
            )
            ORDER BY priority DESC, created_at DESC
        `,
        
        // ÌïÑÌÑ∞ÎßÅ Ï°∞Í±¥Îì§ (ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞Ä)
        CONDITIONS: {
            TARGET_TYPE: ` AND target_type = ?`,
            ALARM_TYPE: ` AND alarm_type = ?`,
            SEVERITY: ` AND severity = ?`,
            IS_ENABLED: ` AND is_enabled = ?`,
            SEARCH: ` AND (name LIKE ? OR description LIKE ?)`,
            TENANT_ID: ` AND tenant_id = ?`,
            ORDER_BY_PRIORITY: ` ORDER BY priority DESC`,
            ORDER_BY_SEVERITY: ` ORDER BY 
                CASE severity 
                    WHEN 'critical' THEN 1 
                    WHEN 'high' THEN 2 
                    WHEN 'medium' THEN 3 
                    WHEN 'low' THEN 4 
                    ELSE 5 
                END`,
            LIMIT: ` LIMIT ?`,
            OFFSET: ` OFFSET ?`
        }
    };
    
    // =========================================================================
    // üî• AlarmOccurrence ÏøºÎ¶¨Îì§ - Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂§
    // =========================================================================
    static AlarmOccurrence = {
        
        FIND_ALL: `
            SELECT 
                ao.*,
                ar.name as rule_name,
                ar.severity as rule_severity,
                ar.target_type,
                ar.target_id
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.tenant_id = ?
            ORDER BY ao.occurrence_time DESC
        `,
        
        FIND_BY_ID: `
            SELECT 
                ao.*,
                ar.name as rule_name,
                ar.severity as rule_severity
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.id = ? AND ao.tenant_id = ?
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú alarm_occurrences Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂ò CREATE (13Í∞ú Ïª¨Îüº)
        CREATE: `
            INSERT INTO alarm_occurrences (
                rule_id, tenant_id, occurrence_time, trigger_value, 
                trigger_condition, alarm_message, severity, state,
                context_data, source_name, location, device_id, point_id
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂ò UPDATE ÏøºÎ¶¨
        UPDATE_STATE: `
            UPDATE alarm_occurrences SET
                state = ?, updated_at = CURRENT_TIMESTAMP
            WHERE id = ? AND tenant_id = ?
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏùò Ïª¨ÎüºÎ™Ö ÏÇ¨Ïö© (acknowledged_time, acknowledged_by)
        ACKNOWLEDGE: `
            UPDATE alarm_occurrences SET
                acknowledged_time = CURRENT_TIMESTAMP,
                acknowledged_by = ?,
                acknowledge_comment = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ? AND tenant_id = ?
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏùò Ïª¨ÎüºÎ™Ö ÏÇ¨Ïö© (cleared_time, cleared_value)
        CLEAR: `
            UPDATE alarm_occurrences SET
                cleared_time = CURRENT_TIMESTAMP,
                cleared_value = ?,
                clear_comment = ?,
                state = 'cleared',
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ? AND tenant_id = ?
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂ò ÌôúÏÑ± ÏïåÎûå Ï°∞Ìöå
        FIND_ACTIVE: `
            SELECT 
                ao.*,
                ar.name as rule_name,
                ar.target_type,
                ar.priority
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.tenant_id = ? AND ao.state = 'active'
            ORDER BY ar.priority DESC, ao.occurrence_time DESC
        `,
        
        // üî• ÏàòÏ†ï: acknowledged_time IS NULLÎ°ú ÎØ∏ÌôïÏù∏ Ï°∞Ìöå
        FIND_UNACKNOWLEDGED: `
            SELECT 
                ao.*,
                ar.name as rule_name
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.tenant_id = ? AND ao.acknowledged_time IS NULL
            ORDER BY ao.occurrence_time DESC
        `,
        
        // ÌäπÏ†ï Î£∞Ïùò ÏïåÎûå Ïù¥Î†•
        FIND_BY_RULE: `
            SELECT * FROM alarm_occurrences 
            WHERE rule_id = ? AND tenant_id = ?
            ORDER BY occurrence_time DESC
        `,
        
        // üî• ÏàòÏ†ï: Ïã§Ï†ú Ïä§ÌÇ§ÎßàÏóê ÎßûÏ∂ò ÌÜµÍ≥Ñ ÏøºÎ¶¨
        STATS_SUMMARY: `
            SELECT 
                COUNT(*) as total_occurrences,
                SUM(CASE WHEN state = 'active' THEN 1 ELSE 0 END) as active_alarms,
                SUM(CASE WHEN acknowledged_time IS NULL THEN 1 ELSE 0 END) as unacknowledged_alarms,
                SUM(CASE WHEN acknowledged_time IS NOT NULL THEN 1 ELSE 0 END) as acknowledged_alarms,
                SUM(CASE WHEN cleared_time IS NOT NULL THEN 1 ELSE 0 END) as cleared_alarms
            FROM alarm_occurrences 
            WHERE tenant_id = ?
        `,
        
        STATS_BY_SEVERITY: `
            SELECT 
                severity,
                COUNT(*) as count,
                SUM(CASE WHEN state = 'active' THEN 1 ELSE 0 END) as active_count
            FROM alarm_occurrences 
            WHERE tenant_id = ? 
            GROUP BY severity
            ORDER BY 
                CASE severity 
                    WHEN 'critical' THEN 1 
                    WHEN 'high' THEN 2 
                    WHEN 'medium' THEN 3 
                    WHEN 'low' THEN 4 
                    ELSE 5 
                END
        `,
        
        STATS_BY_TIME_RANGE: `
            SELECT 
                DATE(occurrence_time) as occurrence_date,
                COUNT(*) as daily_count,
                SUM(CASE WHEN state = 'active' THEN 1 ELSE 0 END) as active_count
            FROM alarm_occurrences 
            WHERE tenant_id = ? 
                AND occurrence_time >= ? 
                AND occurrence_time <= ?
            GROUP BY DATE(occurrence_time)
            ORDER BY occurrence_date DESC
        `,
        
        RECENT_OCCURRENCES: `
            SELECT 
                ao.*,
                ar.name as rule_name
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.tenant_id = ? 
            ORDER BY ao.occurrence_time DESC
            LIMIT ?
        `,
        
        // ÌäπÏ†ï Í∏∞Í∞Ñ ÎÇ¥ ÏïåÎûå
        FIND_BY_DATE_RANGE: `
            SELECT 
                ao.*,
                ar.name as rule_name,
                ar.severity as rule_severity
            FROM alarm_occurrences ao
            LEFT JOIN alarm_rules ar ON ao.rule_id = ar.id
            WHERE ao.tenant_id = ? 
                AND ao.occurrence_time >= ? 
                AND ao.occurrence_time <= ?
            ORDER BY ao.occurrence_time DESC
        `
    };
    
    // =========================================================================
    // üî• Í≥µÌÜµ Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìúÎì§
    // =========================================================================
    
    /**
     * ÎèôÏ†Å WHERE Ï†à ÏÉùÏÑ± (AlarmRuleÏö©)
     */
    static buildAlarmRuleWhereClause(baseQuery, filters = {}) {
        let query = baseQuery;
        const params = [];
        
        if (filters.tenant_id) {
            params.push(filters.tenant_id);
        }
        
        if (filters.target_type) {
            query += this.AlarmRule.CONDITIONS.TARGET_TYPE;
            params.push(filters.target_type);
        }
        
        if (filters.alarm_type) {
            query += this.AlarmRule.CONDITIONS.ALARM_TYPE;
            params.push(filters.alarm_type);
        }
        
        if (filters.severity) {
            query += this.AlarmRule.CONDITIONS.SEVERITY;
            params.push(filters.severity);
        }
        
        if (filters.is_enabled !== undefined) {
            query += this.AlarmRule.CONDITIONS.IS_ENABLED;
            params.push(filters.is_enabled ? 1 : 0);
        }
        
        if (filters.search) {
            query += this.AlarmRule.CONDITIONS.SEARCH;
            params.push(`%${filters.search}%`, `%${filters.search}%`);
        }
        
        return { query, params };
    }
    
    /**
     * ÌéòÏù¥Ïßï Ï†à Ï∂îÍ∞Ä
     */
    static addPagination(query, limit, offset) {
        if (limit) {
            query += this.AlarmRule.CONDITIONS.LIMIT;
            if (offset && offset > 0) {
                query += this.AlarmRule.CONDITIONS.OFFSET;
            }
        }
        return query;
    }

    /**
     * Ï†ïÎ†¨ Ï†à Ï∂îÍ∞Ä
     */
    static addSorting(query, sortBy = 'priority') {
        switch (sortBy) {
            case 'priority':
                return query + this.AlarmRule.CONDITIONS.ORDER_BY_PRIORITY;
            case 'severity':
                return query + this.AlarmRule.CONDITIONS.ORDER_BY_SEVERITY;
            default:
                return query + this.AlarmRule.CONDITIONS.ORDER_BY_PRIORITY;
        }
    }

    /**
     * üî• CREATE ÏøºÎ¶¨Ïóê ÏÇ¨Ïö©Ìï† ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞ ÏÉùÏÑ± (AlarmRule)
     * 15Í∞ú Í∞íÏùÑ Ï†ïÌôïÌûà Ï†úÍ≥µÌïòÎäî Ìó¨Ìçº Î©îÏÑúÎìú
     */
    static buildCreateParams(data) {
        return [
            data.tenant_id,                                                 // 1
            data.name,                                                      // 2
            data.description || '',                                         // 3
            data.target_type,                                               // 4
            data.target_id,                                                 // 5
            data.alarm_type,                                                // 6
            data.severity,                                                  // 7
            data.high_limit || null,                                        // 8
            data.low_limit || null,                                         // 9
            data.deadband || 0,                                             // 10
            data.message_template || `${data.name} alarm triggered`,       // 11
            data.priority || 100,                                           // 12
            data.is_enabled !== false ? 1 : 0,                            // 13
            data.auto_clear !== false ? 1 : 0,                            // 14
            data.notification_enabled !== false ? 1 : 0                    // 15
        ];
    }

    /**
     * üî• CREATE ÏøºÎ¶¨Ïóê ÏÇ¨Ïö©Ìï† AlarmOccurrence ÌååÎùºÎØ∏ÌÑ∞ ÏÉùÏÑ±
     * 13Í∞ú Í∞íÏùÑ Ï†ïÌôïÌûà Ï†úÍ≥µÌïòÎäî Ìó¨Ìçº Î©îÏÑúÎìú
     */
    static buildCreateOccurrenceParams(data) {
        return [
            data.rule_id,                                                   // 1
            data.tenant_id,                                                 // 2
            data.occurrence_time || new Date().toISOString(),              // 3
            data.trigger_value ? JSON.stringify(data.trigger_value) : null,// 4
            data.trigger_condition || '',                                   // 5
            data.alarm_message,                                             // 6
            data.severity,                                                  // 7
            data.state || 'active',                                         // 8
            data.context_data ? JSON.stringify(data.context_data) : null,  // 9
            data.source_name || null,                                       // 10
            data.location || null,                                          // 11
            data.device_id || null,                                         // 12
            data.point_id || null                                           // 13
        ];
    }

    /**
     * AlarmOccurrence ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
     */
    static validateOccurrenceRequiredFields(data) {
        const requiredFields = ['rule_id', 'tenant_id', 'alarm_message', 'severity'];
        const missingFields = [];
        
        for (const field of requiredFields) {
            if (!data[field]) {
                missingFields.push(field);
            }
        }
        
        if (missingFields.length > 0) {
            throw new Error(`ÌïÑÏàò ÌïÑÎìú ÎàÑÎùΩ: ${missingFields.join(', ')}`);
        }
        
        return true;
    }

    /**
     * üî• UPDATE ÏøºÎ¶¨Ïóê ÏÇ¨Ïö©Ìï† ÌååÎùºÎØ∏ÌÑ∞ ÏÉùÏÑ±
     * 16Í∞ú Í∞í (15Í∞ú ÌïÑÎìú + id + tenant_id)
     */
    static buildUpdateParams(data, id, tenantId) {
        return [
            data.name,                                                      // 1
            data.description || '',                                         // 2
            data.target_type,                                               // 3
            data.target_id,                                                 // 4
            data.alarm_type,                                                // 5
            data.severity,                                                  // 6
            data.high_limit || null,                                        // 7
            data.low_limit || null,                                         // 8
            data.deadband || 0,                                             // 9
            data.message_template || `${data.name} alarm triggered`,       // 10
            data.priority || 100,                                           // 11
            data.is_enabled !== false ? 1 : 0,                            // 12
            data.auto_clear !== false ? 1 : 0,                            // 13
            data.notification_enabled !== false ? 1 : 0,                   // 14
            id,                                                             // 15 (WHERE Ï°∞Í±¥)
            tenantId || data.tenant_id || 1                                 // 16 (WHERE Ï°∞Í±¥)
        ];
    }

    /**
     * ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
     */
    static validateRequiredFields(data) {
        const requiredFields = ['name', 'target_type', 'target_id', 'alarm_type', 'severity'];
        const missingFields = [];
        
        for (const field of requiredFields) {
            if (!data[field]) {
                missingFields.push(field);
            }
        }
        
        if (missingFields.length > 0) {
            throw new Error(`ÌïÑÏàò ÌïÑÎìú ÎàÑÎùΩ: ${missingFields.join(', ')}`);
        }
        
        return true;
    }

    /**
     * ÏïåÎûå Ïú†ÌòïÎ≥Ñ Í≤ÄÏ¶ù
     */
    static validateAlarmTypeSpecificFields(data) {
        switch (data.alarm_type) {
            case 'analog':
                if (!data.high_limit && !data.low_limit) {
                    throw new Error('ÏïÑÎÇ†Î°úÍ∑∏ ÏïåÎûåÏùÄ high_limit ÎòêÎäî low_limit Ï§ë ÌïòÎÇòÎäî ÌïÑÏàòÏûÖÎãàÎã§');
                }
                break;
            case 'digital':
                if (!data.trigger_condition) {
                    throw new Error('ÎîîÏßÄÌÑ∏ ÏïåÎûåÏùÄ trigger_conditionÏù¥ ÌïÑÏàòÏûÖÎãàÎã§');
                }
                break;
            case 'script':
                if (!data.condition_script) {
                    throw new Error('Ïä§ÌÅ¨Î¶ΩÌä∏ ÏïåÎûåÏùÄ condition_scriptÍ∞Ä ÌïÑÏàòÏûÖÎãàÎã§');
                }
                break;
        }
        return true;
    }
}

module.exports = AlarmQueries;